# ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆæ›¸ - ã‚½ã‚¯ãƒ–ãƒ„

## æ¦‚è¦

ã‚½ã‚¯ãƒ–ãƒ„ã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆæ›¸ã§ã™ã€‚NestJS + TypeORM + better-sqlite3æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯ã§ã®ç‰©ä»¶æ–°ç€ã€Œæœ‰ç„¡ã€ç›£è¦–ã‚·ã‚¹ãƒ†ãƒ ã®ãƒ‡ãƒ¼ã‚¿è¨­è¨ˆã‚’å®šç¾©ã—ã¾ã™ã€‚è‡ªå®…ã‚µãƒ¼ãƒãƒ¼ç’°å¢ƒã§ã®è»½é‡ãƒ»å®‰å®šå‹•ä½œã‚’é‡è¦–ã—ã€å°†æ¥ã®PostgreSQLç§»è¡Œã‚‚è€ƒæ…®ã—ãŸè¨­è¨ˆã¨ãªã£ã¦ã„ã¾ã™ã€‚

## ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æŠ€è¡“é¸å®š

### better-sqlite3 (ç¾åœ¨ã®é¸æŠ)

#### é¸å®šç†ç”±
- **Dockerç’°å¢ƒã§ã®å®‰å®šæ€§**: ãƒã‚¤ãƒ†ã‚£ãƒ–ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ãƒ“ãƒ«ãƒ‰å•é¡Œã®è§£æ±º
- **NestJSçµ±åˆ**: TypeORMã¨ã®å®Œå…¨äº’æ›æ€§
- **ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹**: sqlite3ã‚ˆã‚Š20-30%é«˜é€Ÿ
- **è‡ªå®…ã‚µãƒ¼ãƒãƒ¼æœ€é©åŒ–**: ãƒ•ã‚¡ã‚¤ãƒ«ãƒ™ãƒ¼ã‚¹ã®è»½é‡é‹ç”¨

#### ãƒ¡ãƒªãƒƒãƒˆ
- **è»½é‡**: 20-40MBã®ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡
- **é«˜é€Ÿ**: åŒæœŸAPIã«ã‚ˆã‚‹é«˜é€Ÿã‚¢ã‚¯ã‚»ã‚¹
- **å®‰å®šæ€§**: ãƒ—ãƒ­ãƒ€ã‚¯ã‚·ãƒ§ãƒ³å®Ÿç¸¾è±Šå¯Œ
- **ä¿å®ˆæ€§**: å˜ä¸€ãƒ•ã‚¡ã‚¤ãƒ«ã§ã®ç®¡ç†

#### ãƒ‡ãƒ¡ãƒªãƒƒãƒˆ
- **åŒæ™‚æ¥ç¶šåˆ¶é™**: èª­ã¿å–ã‚Šå°‚ç”¨ã®ä¸¦åˆ—ã‚¢ã‚¯ã‚»ã‚¹åˆ¶é™
- **ã‚¹ã‚±ãƒ¼ãƒ©ãƒ“ãƒªãƒ†ã‚£**: å¤§è¦æ¨¡ãƒ‡ãƒ¼ã‚¿ã«ã¯ä¸å‘ã
- **ãƒ¬ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³**: æ¨™æº–æ©Ÿèƒ½ãªã—

### PostgreSQL (å°†æ¥ã®ç§»è¡Œå…ˆ)

#### ç§»è¡Œã‚¿ã‚¤ãƒŸãƒ³ã‚°
- **ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°**: 100äººä»¥ä¸Š
- **ç›£è¦–URLæ•°**: 1,000ä»¶ä»¥ä¸Š
- **ãƒ‡ãƒ¼ã‚¿é‡**: 10GBä»¥ä¸Š

#### ç§»è¡Œãƒ¡ãƒªãƒƒãƒˆ
- **ä¸¦è¡Œå‡¦ç†**: è¤‡æ•°æ¥ç¶šã®å®Œå…¨ã‚µãƒãƒ¼ãƒˆ
- **é«˜å¯ç”¨æ€§**: ãƒ¬ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ»ã‚¯ãƒ©ã‚¹ã‚¿ãƒªãƒ³ã‚°
- **æ‹¡å¼µæ€§**: æ°´å¹³ãƒ»å‚ç›´ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°
- **æ©Ÿèƒ½æ€§**: é«˜åº¦ãªSQLæ©Ÿèƒ½

## ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ§‹æˆ

### ç¾åœ¨ã®æ§‹æˆ (better-sqlite3)

```
ğŸ“ data/
â”œâ”€â”€ ğŸ“„ sokubutsu.db          # ãƒ¡ã‚¤ãƒ³ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹
â”œâ”€â”€ ğŸ“„ sokubutsu.db-wal      # Write-Ahead Log
â”œâ”€â”€ ğŸ“„ sokubutsu.db-shm      # Shared Memory
â””â”€â”€ ğŸ“ backups/
    â”œâ”€â”€ ğŸ“„ daily_backup_YYYYMMDD.db
    â””â”€â”€ ğŸ“„ weekly_backup_YYYYMMDD.db
```

### å°†æ¥ã®æ§‹æˆ (PostgreSQL)

```
ğŸ—„ï¸ PostgreSQL Instance
â”œâ”€â”€ ğŸ“Š sokubutsu_main        # ãƒ¡ã‚¤ãƒ³ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹
â”œâ”€â”€ ğŸ“Š sokubutsu_logs        # ãƒ­ã‚°ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹
â””â”€â”€ ğŸ“Š sokubutsu_cache       # ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹
```

## ãƒ†ãƒ¼ãƒ–ãƒ«è¨­è¨ˆ

### 1. users ãƒ†ãƒ¼ãƒ–ãƒ«

ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã®ç®¡ç†

```sql
CREATE TABLE users (
    id                TEXT PRIMARY KEY,
    telegram_user_id  TEXT UNIQUE NOT NULL,
    telegram_username TEXT,
    first_name        TEXT,
    last_name         TEXT,
    url_limit         INTEGER DEFAULT 3,
    is_active         BOOLEAN DEFAULT true,
    created_at        DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at        DATETIME DEFAULT CURRENT_TIMESTAMP,
    last_active_at    DATETIME DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_users_telegram_user_id ON users(telegram_user_id);
CREATE INDEX idx_users_last_active_at ON users(last_active_at);
```

**ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰èª¬æ˜**:
- `id`: UUIDå½¢å¼ã®ä¸»ã‚­ãƒ¼
- `telegram_user_id`: Telegramå›ºæœ‰ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ID
- `url_limit`: ç™»éŒ²å¯èƒ½URLæ•°ã®ä¸Šé™
- `is_active`: ã‚¢ã‚«ã‚¦ãƒ³ãƒˆæœ‰åŠ¹æ€§ãƒ•ãƒ©ã‚°

### 2. urls ãƒ†ãƒ¼ãƒ–ãƒ«

ç›£è¦–URLæƒ…å ±ã®ç®¡ç†

```sql
CREATE TABLE urls (
    id              TEXT PRIMARY KEY,
    user_id         TEXT NOT NULL,
    url             TEXT NOT NULL,
    name            TEXT NOT NULL,
    status          TEXT DEFAULT 'active',
    check_interval  INTEGER DEFAULT 300,
    last_checked    DATETIME,
    last_content    TEXT,
    error_count     INTEGER DEFAULT 0,
    created_at      DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at      DATETIME DEFAULT CURRENT_TIMESTAMP,
    
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
);

CREATE INDEX idx_urls_user_id ON urls(user_id);
CREATE INDEX idx_urls_status ON urls(status);
CREATE INDEX idx_urls_last_checked ON urls(last_checked);
CREATE UNIQUE INDEX idx_urls_user_url ON urls(user_id, url);
```

**ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰èª¬æ˜**:
- `status`: 'active', 'paused', 'error'
- `check_interval`: ç›£è¦–é–“éš”ï¼ˆç§’ï¼‰
- `last_content`: å‰å›å–å¾—å†…å®¹ã®SHA-256ãƒãƒƒã‚·ãƒ¥
- `error_count`: é€£ç¶šã‚¨ãƒ©ãƒ¼å›æ•°

### 3. monitoring_logs ãƒ†ãƒ¼ãƒ–ãƒ«

ç›£è¦–å®Ÿè¡Œãƒ­ã‚°ã®ç®¡ç†

```sql
CREATE TABLE monitoring_logs (
    id                TEXT PRIMARY KEY,
    url_id            TEXT NOT NULL,
    timestamp         DATETIME DEFAULT CURRENT_TIMESTAMP,
    status            TEXT NOT NULL,
    new_items_found   BOOLEAN DEFAULT false,
    response_time     INTEGER,
    method            TEXT,
    memory_usage      INTEGER,
    message           TEXT,
    error_details     TEXT,
    
    FOREIGN KEY (url_id) REFERENCES urls(id) ON DELETE CASCADE
);

CREATE INDEX idx_monitoring_logs_url_id ON monitoring_logs(url_id);
CREATE INDEX idx_monitoring_logs_timestamp ON monitoring_logs(timestamp);
CREATE INDEX idx_monitoring_logs_status ON monitoring_logs(status);
```

**ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰èª¬æ˜**:
- `status`: 'success', 'error', 'bot_detected'
- `method`: 'http-only', 'jsdom', 'playwright'
- `response_time`: å‡¦ç†æ™‚é–“ï¼ˆãƒŸãƒªç§’ï¼‰
- `memory_usage`: ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡ï¼ˆMBï¼‰

### 4. notifications ãƒ†ãƒ¼ãƒ–ãƒ«

é€šçŸ¥å±¥æ­´ã®ç®¡ç†

```sql
CREATE TABLE notifications (
    id              TEXT PRIMARY KEY,
    user_id         TEXT NOT NULL,
    url_id          TEXT,
    type            TEXT NOT NULL,
    title           TEXT,
    message         TEXT NOT NULL,
    sent_at         DATETIME DEFAULT CURRENT_TIMESTAMP,
    telegram_message_id INTEGER,
    
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
    FOREIGN KEY (url_id) REFERENCES urls(id) ON DELETE SET NULL
);

CREATE INDEX idx_notifications_user_id ON notifications(user_id);
CREATE INDEX idx_notifications_sent_at ON notifications(sent_at);
CREATE INDEX idx_notifications_type ON notifications(type);
```

**ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰èª¬æ˜**:
- `type`: 'new_items', 'error', 'summary', 'system'
- `telegram_message_id`: Telegramé€ä¿¡ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ID

### 5. system_config ãƒ†ãƒ¼ãƒ–ãƒ«

ã‚·ã‚¹ãƒ†ãƒ è¨­å®šã®ç®¡ç†

```sql
CREATE TABLE system_config (
    key         TEXT PRIMARY KEY,
    value       TEXT NOT NULL,
    description TEXT,
    updated_at  DATETIME DEFAULT CURRENT_TIMESTAMP
);

-- åˆæœŸè¨­å®šãƒ‡ãƒ¼ã‚¿
INSERT INTO system_config (key, value, description) VALUES
('default_url_limit', '3', 'ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆURLç™»éŒ²ä¸Šé™'),
('max_url_limit', '10', 'æœ€å¤§URLç™»éŒ²ä¸Šé™'),
('default_check_interval', '300', 'ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆç›£è¦–é–“éš”ï¼ˆç§’ï¼‰'),
('min_check_interval', '60', 'æœ€å°ç›£è¦–é–“éš”ï¼ˆç§’ï¼‰'),
('max_error_count', '5', 'æœ€å¤§é€£ç¶šã‚¨ãƒ©ãƒ¼å›æ•°'),
('summary_interval', '3600', 'ã‚µãƒãƒªãƒ¼é€ä¿¡é–“éš”ï¼ˆç§’ï¼‰');
```

## ERå›³

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     users       â”‚       â”‚      urls       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ id (PK)         â”‚â—„â”€â”€â”€â”€â”€â”¤â”‚ id (PK)         â”‚
â”‚ telegram_user_idâ”‚       â”‚ user_id (FK)    â”‚
â”‚ telegram_usernameâ”‚      â”‚ url             â”‚
â”‚ first_name      â”‚       â”‚ name            â”‚
â”‚ last_name       â”‚       â”‚ status          â”‚
â”‚ url_limit       â”‚       â”‚ check_interval  â”‚
â”‚ is_active       â”‚       â”‚ last_checked    â”‚
â”‚ created_at      â”‚       â”‚ last_content    â”‚
â”‚ updated_at      â”‚       â”‚ error_count     â”‚
â”‚ last_active_at  â”‚       â”‚ created_at      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚ updated_at      â”‚
                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                   â”‚
                                   â”‚
                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                          â”‚ monitoring_logs â”‚
                          â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
                          â”‚ id (PK)         â”‚
                          â”‚ url_id (FK)     â”‚â—„â”€â”˜
                          â”‚ timestamp       â”‚
                          â”‚ status          â”‚
                          â”‚ new_items_found â”‚
                          â”‚ response_time   â”‚
                          â”‚ method          â”‚
                          â”‚ memory_usage    â”‚
                          â”‚ message         â”‚
                          â”‚ error_details   â”‚
                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ notifications   â”‚       â”‚ system_config   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ id (PK)         â”‚       â”‚ key (PK)        â”‚
â”‚ user_id (FK)    â”‚â—„â”€â”€â”€â”€â”€â”â”‚ value           â”‚
â”‚ url_id (FK)     â”‚      â”‚â”‚ description     â”‚
â”‚ type            â”‚      â”‚â”‚ updated_at      â”‚
â”‚ title           â”‚      â”‚â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚ message         â”‚      â”‚
â”‚ sent_at         â”‚      â”‚
â”‚ telegram_message_idâ”‚   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
         â”‚                â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## TypeORMã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£å®šç¾©

### User Entity

```typescript
@Entity('users')
export class User {
  @PrimaryGeneratedColumn('uuid')
  id: string;

  @Column({ name: 'telegram_user_id', unique: true })
  telegramUserId: string;

  @Column({ name: 'telegram_username', nullable: true })
  telegramUsername?: string;

  @Column({ name: 'first_name', nullable: true })
  firstName?: string;

  @Column({ name: 'last_name', nullable: true })
  lastName?: string;

  @Column({ name: 'url_limit', default: 3 })
  urlLimit: number;

  @Column({ name: 'is_active', default: true })
  isActive: boolean;

  @CreateDateColumn({ name: 'created_at' })
  createdAt: Date;

  @UpdateDateColumn({ name: 'updated_at' })
  updatedAt: Date;

  @Column({ name: 'last_active_at', default: () => 'CURRENT_TIMESTAMP' })
  lastActiveAt: Date;

  @OneToMany(() => Url, url => url.user)
  urls: Url[];

  @OneToMany(() => Notification, notification => notification.user)
  notifications: Notification[];
}
```

### Url Entity

```typescript
@Entity('urls')
export class Url {
  @PrimaryGeneratedColumn('uuid')
  id: string;

  @Column({ name: 'user_id' })
  userId: string;

  @Column()
  url: string;

  @Column()
  name: string;

  @Column({ default: 'active' })
  status: 'active' | 'paused' | 'error';

  @Column({ name: 'check_interval', default: 300 })
  checkInterval: number;

  @Column({ name: 'last_checked', nullable: true })
  lastChecked?: Date;

  @Column({ name: 'last_content', nullable: true })
  lastContent?: string;

  @Column({ name: 'error_count', default: 0 })
  errorCount: number;

  @CreateDateColumn({ name: 'created_at' })
  createdAt: Date;

  @UpdateDateColumn({ name: 'updated_at' })
  updatedAt: Date;

  @ManyToOne(() => User, user => user.urls, { onDelete: 'CASCADE' })
  @JoinColumn({ name: 'user_id' })
  user: User;

  @OneToMany(() => MonitoringLog, log => log.url)
  monitoringLogs: MonitoringLog[];
}
```

### MonitoringLog Entity

```typescript
@Entity('monitoring_logs')
export class MonitoringLog {
  @PrimaryGeneratedColumn('uuid')
  id: string;

  @Column({ name: 'url_id' })
  urlId: string;

  @CreateDateColumn()
  timestamp: Date;

  @Column()
  status: 'success' | 'error' | 'bot_detected';

  @Column({ name: 'new_items_found', default: false })
  newItemsFound: boolean;

  @Column({ name: 'response_time', nullable: true })
  responseTime?: number;

  @Column({ nullable: true })
  method?: 'http-only' | 'jsdom' | 'playwright';

  @Column({ name: 'memory_usage', nullable: true })
  memoryUsage?: number;

  @Column({ nullable: true })
  message?: string;

  @Column({ name: 'error_details', nullable: true })
  errorDetails?: string;

  @ManyToOne(() => Url, url => url.monitoringLogs, { onDelete: 'CASCADE' })
  @JoinColumn({ name: 'url_id' })
  url: Url;
}
```

## ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹æˆ¦ç•¥

### ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–

#### ä¸»è¦ã‚¯ã‚¨ãƒªãƒ‘ã‚¿ãƒ¼ãƒ³
1. **ãƒ¦ãƒ¼ã‚¶ãƒ¼åˆ¥URLå–å¾—**: `user_id`ã§ã®ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
2. **ç›£è¦–å¯¾è±¡URLå–å¾—**: `status = 'active'`ã§ã®ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
3. **ãƒ­ã‚°æ¤œç´¢**: `url_id`ã¨`timestamp`ã§ã®ç¯„å›²æ¤œç´¢
4. **é€šçŸ¥å±¥æ­´**: `user_id`ã¨`sent_at`ã§ã®ç¯„å›²æ¤œç´¢

#### ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹è¨­è¨ˆ
```sql
-- è¤‡åˆã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ï¼ˆé«˜é »åº¦ã‚¯ã‚¨ãƒªç”¨ï¼‰
CREATE INDEX idx_urls_user_status ON urls(user_id, status);
CREATE INDEX idx_monitoring_logs_url_timestamp ON monitoring_logs(url_id, timestamp DESC);
CREATE INDEX idx_notifications_user_sent_at ON notifications(user_id, sent_at DESC);

-- å˜ä¸€ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ï¼ˆä¸­é »åº¦ã‚¯ã‚¨ãƒªç”¨ï¼‰
CREATE INDEX idx_urls_last_checked ON urls(last_checked) WHERE status = 'active';
CREATE INDEX idx_monitoring_logs_status ON monitoring_logs(status);
```

### ã‚¯ã‚¨ãƒªæœ€é©åŒ–

#### åŠ¹ç‡çš„ãªã‚¯ã‚¨ãƒªä¾‹
```typescript
// ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªURLå–å¾—ï¼ˆã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹æ´»ç”¨ï¼‰
const activeUrls = await this.urlRepository.find({
  where: { 
    userId: user.id, 
    status: 'active' 
  },
  order: { lastChecked: 'ASC' }
});

// æœ€æ–°ãƒ­ã‚°å–å¾—ï¼ˆè¤‡åˆã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹æ´»ç”¨ï¼‰
const recentLogs = await this.monitoringLogRepository.find({
  where: { urlId: url.id },
  order: { timestamp: 'DESC' },
  take: 10
});
```

## ãƒ‡ãƒ¼ã‚¿ä¿æŒãƒãƒªã‚·ãƒ¼

### ãƒ­ã‚°ãƒ­ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³

#### monitoring_logs ãƒ†ãƒ¼ãƒ–ãƒ«
- **ä¿æŒæœŸé–“**: 30æ—¥
- **å‰Šé™¤ã‚¿ã‚¤ãƒŸãƒ³ã‚°**: æ—¥æ¬¡ãƒãƒƒãƒå‡¦ç†
- **ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–**: æœˆæ¬¡ã§ãƒ•ã‚¡ã‚¤ãƒ«å‡ºåŠ›

```sql
-- 30æ—¥ä»¥å‰ã®ãƒ­ã‚°å‰Šé™¤
DELETE FROM monitoring_logs 
WHERE timestamp < datetime('now', '-30 days');
```

#### notifications ãƒ†ãƒ¼ãƒ–ãƒ«
- **ä¿æŒæœŸé–“**: 90æ—¥
- **å‰Šé™¤ã‚¿ã‚¤ãƒŸãƒ³ã‚°**: é€±æ¬¡ãƒãƒƒãƒå‡¦ç†

```sql
-- 90æ—¥ä»¥å‰ã®é€šçŸ¥å‰Šé™¤
DELETE FROM notifications 
WHERE sent_at < datetime('now', '-90 days');
```

### ãƒ‡ãƒ¼ã‚¿ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–

#### æœˆæ¬¡ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–å‡¦ç†
```typescript
async archiveOldData() {
  // å¤ã„ãƒ­ã‚°ã‚’JSONãƒ•ã‚¡ã‚¤ãƒ«ã«å‡ºåŠ›
  const oldLogs = await this.getLogsOlderThan(30);
  await this.exportToFile(oldLogs, `archive_${date}.json`);
  
  // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‹ã‚‰å‰Šé™¤
  await this.deleteOldLogs(30);
}
```

## ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ»å¾©æ—§

### ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—æˆ¦ç•¥

#### è‡ªå‹•ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
```bash
#!/bin/bash
# daily_backup.sh

DB_PATH="/app/data/sokubutsu.db"
BACKUP_DIR="/app/data/backups"
DATE=$(date +%Y%m%d_%H%M%S)

# SQLiteãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
sqlite3 $DB_PATH ".backup $BACKUP_DIR/daily_backup_$DATE.db"

# 7æ—¥ä»¥å‰ã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—å‰Šé™¤
find $BACKUP_DIR -name "daily_backup_*.db" -mtime +7 -delete
```

#### é€±æ¬¡ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
```bash
#!/bin/bash
# weekly_backup.sh

# é€±æ¬¡ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ï¼ˆåœ§ç¸®ï¼‰
gzip -c $DB_PATH > $BACKUP_DIR/weekly_backup_$(date +%Y%m%d).db.gz

# 4é€±ä»¥å‰ã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—å‰Šé™¤
find $BACKUP_DIR -name "weekly_backup_*.db.gz" -mtime +28 -delete
```

### å¾©æ—§æ‰‹é †

#### ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹å¾©æ—§
```bash
# 1. ã‚µãƒ¼ãƒ“ã‚¹åœæ­¢
systemctl stop sokubutsu

# 2. ç¾åœ¨ã®DBã‚’ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
cp /app/data/sokubutsu.db /app/data/sokubutsu.db.corrupted

# 3. ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‹ã‚‰å¾©æ—§
cp /app/data/backups/daily_backup_YYYYMMDD.db /app/data/sokubutsu.db

# 4. æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯
sqlite3 /app/data/sokubutsu.db "PRAGMA integrity_check;"

# 5. ã‚µãƒ¼ãƒ“ã‚¹å†é–‹
systemctl start sokubutsu
```

## ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è€ƒæ…®äº‹é …

### ãƒ‡ãƒ¼ã‚¿æš—å·åŒ–

#### æ©Ÿå¯†ãƒ‡ãƒ¼ã‚¿ã®ä¿è­·
```typescript
// ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒãƒƒã‚·ãƒ¥åŒ–ï¼ˆå°†æ¥ã®æ©Ÿèƒ½æ‹¡å¼µç”¨ï¼‰
import * as bcrypt from 'bcrypt';

async hashPassword(password: string): Promise<string> {
  return bcrypt.hash(password, 12);
}

// Telegram Bot Tokenæš—å·åŒ–
import * as crypto from 'crypto';

encryptSensitiveData(data: string): string {
  const cipher = crypto.createCipher('aes-256-cbc', process.env.ENCRYPTION_KEY);
  return cipher.update(data, 'utf8', 'hex') + cipher.final('hex');
}
```

#### ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ•ã‚¡ã‚¤ãƒ«ä¿è­·
```bash
# ãƒ•ã‚¡ã‚¤ãƒ«æ¨©é™è¨­å®š
chmod 600 /app/data/sokubutsu.db
chown app:app /app/data/sokubutsu.db

# ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ•ã‚¡ã‚¤ãƒ«æš—å·åŒ–
gpg --symmetric --cipher-algo AES256 backup.db
```

### ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡

#### SQLã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³å¯¾ç­–
```typescript
// TypeORMã«ã‚ˆã‚‹è‡ªå‹•ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—
const user = await this.userRepository.findOne({
  where: { telegramUserId: userInput } // è‡ªå‹•ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—
});

// ç”ŸSQLã®å ´åˆã¯ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿åŒ–ã‚¯ã‚¨ãƒª
const result = await this.connection.query(
  'SELECT * FROM users WHERE telegram_user_id = ?',
  [userInput]
);
```

## ç›£è¦–ãƒ»ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹

### ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ç›£è¦–

#### ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ¡ãƒˆãƒªã‚¯ã‚¹
```typescript
// ã‚¯ã‚¨ãƒªå®Ÿè¡Œæ™‚é–“ç›£è¦–
@Injectable()
export class DatabaseMonitoringService {
  async monitorQueryPerformance() {
    const slowQueries = await this.connection.query(`
      SELECT sql, count(*) as execution_count
      FROM sqlite_stat1 
      WHERE execution_time > 1000
    `);
    
    if (slowQueries.length > 0) {
      this.logger.warn('Slow queries detected', { slowQueries });
    }
  }
}
```

#### ãƒ‡ã‚£ã‚¹ã‚¯ä½¿ç”¨é‡ç›£è¦–
```typescript
async checkDatabaseSize() {
  const stats = await fs.stat('/app/data/sokubutsu.db');
  const sizeInMB = stats.size / (1024 * 1024);
  
  if (sizeInMB > 100) { // 100MBè¶…éæ™‚
    this.logger.warn('Database size exceeded threshold', { 
      currentSize: sizeInMB 
    });
  }
}
```

### å®šæœŸãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹

#### ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æœ€é©åŒ–
```sql
-- æœˆæ¬¡å®Ÿè¡Œ
VACUUM; -- ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ•ã‚¡ã‚¤ãƒ«æœ€é©åŒ–
ANALYZE; -- çµ±è¨ˆæƒ…å ±æ›´æ–°
PRAGMA optimize; -- ã‚¯ã‚¨ãƒªãƒ—ãƒ©ãƒ³ãƒŠãƒ¼æœ€é©åŒ–
```

#### æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯
```typescript
async performIntegrityCheck() {
  const result = await this.connection.query('PRAGMA integrity_check');
  
  if (result[0].integrity_check !== 'ok') {
    this.logger.error('Database integrity check failed', { result });
    // ã‚¢ãƒ©ãƒ¼ãƒˆé€ä¿¡
  }
}
```

## PostgreSQLç§»è¡Œè¨ˆç”»

### ç§»è¡Œæº–å‚™

#### ã‚¹ã‚­ãƒ¼ãƒå¤‰æ›
```typescript
// SQLite â†’ PostgreSQLå‹å¤‰æ›
const typeMapping = {
  'TEXT': 'VARCHAR',
  'INTEGER': 'INTEGER',
  'DATETIME': 'TIMESTAMP',
  'BOOLEAN': 'BOOLEAN'
};
```

#### ãƒ‡ãƒ¼ã‚¿ç§»è¡Œã‚¹ã‚¯ãƒªãƒ—ãƒˆ
```typescript
async migrateToPostgreSQL() {
  // 1. PostgreSQLã‚¹ã‚­ãƒ¼ãƒä½œæˆ
  await this.createPostgreSQLSchema();
  
  // 2. ãƒ‡ãƒ¼ã‚¿ç§»è¡Œ
  await this.migrateUserData();
  await this.migrateUrlData();
  await this.migrateLogData();
  
  // 3. æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯
  await this.validateMigration();
  
  // 4. ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ä½œæˆ
  await this.createPostgreSQLIndexes();
}
```

### ç§»è¡Œå¾Œã®æœ€é©åŒ–

#### PostgreSQLç‰¹æœ‰ã®æœ€é©åŒ–
```sql
-- æ¥ç¶šãƒ—ãƒ¼ãƒ«è¨­å®š
max_connections = 100
shared_buffers = 256MB
effective_cache_size = 1GB

-- ãƒ‘ãƒ¼ãƒ†ã‚£ã‚·ãƒ§ãƒ‹ãƒ³ã‚°ï¼ˆãƒ­ã‚°ãƒ†ãƒ¼ãƒ–ãƒ«ï¼‰
CREATE TABLE monitoring_logs_y2024m01 PARTITION OF monitoring_logs
FOR VALUES FROM ('2024-01-01') TO ('2024-02-01');
```

## ãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±

- **ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒãƒ¼ã‚¸ãƒ§ãƒ³**: 2.0.0
- **better-sqlite3**: 9.x
- **TypeORM**: 0.3.x
- **SQLite**: 3.x
- **PostgreSQL**: 15.x (ç§»è¡Œæ™‚)

