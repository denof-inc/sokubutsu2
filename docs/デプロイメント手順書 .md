# ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆæ‰‹é †æ›¸ - è»½é‡ã‚½ã‚¯ãƒ–ãƒ„

## æ¦‚è¦

è»½é‡ã‚½ã‚¯ãƒ–ãƒ„ã¯ã€è‡ªå®…ã‚µãƒ¼ãƒãƒ¼ç’°å¢ƒã§ã®ç‰©ä»¶æ–°ç€ç›£è¦–ã«ç‰¹åŒ–ã—ãŸãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆæˆ¦ç•¥ã‚’æ¡ç”¨ã—ã¦ã„ã¾ã™ã€‚Dockerã‚’ä½¿ç”¨ã›ãšã€ãƒã‚¤ãƒ†ã‚£ãƒ–å®Ÿè¡Œã«ã‚ˆã‚‹è»½é‡ãƒ»é«˜é€Ÿãƒ»å®‰å®šå‹•ä½œã‚’å®Ÿç¾ã—ã€ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡30-60MBã€èµ·å‹•æ™‚é–“1-3ç§’ã®é«˜æ€§èƒ½ã‚’æä¾›ã—ã¾ã™ã€‚

## ç’°å¢ƒæ§‹æˆ

### å¯¾å¿œç’°å¢ƒ

#### è‡ªå®…ã‚µãƒ¼ãƒãƒ¼ç’°å¢ƒï¼ˆæ¨å¥¨ï¼‰

**ãƒãƒ¼ãƒ‰ã‚¦ã‚§ã‚¢è¦ä»¶**:
- **CPU**: Intel Core i5ä»¥ä¸Šï¼ˆ2ã‚³ã‚¢ä»¥ä¸Šï¼‰
- **ãƒ¡ãƒ¢ãƒª**: 2GBä»¥ä¸Šï¼ˆè»½é‡ã‚½ã‚¯ãƒ–ãƒ„ã¯30-60MBä½¿ç”¨ï¼‰
- **ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸**: 10GBä»¥ä¸Šã®ç©ºãå®¹é‡
- **ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯**: å®‰å®šã—ãŸã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆæ¥ç¶š

**OSè¦ä»¶**:
- **Ubuntu**: 20.04 LTSä»¥ä¸Š
- **Windows**: WSL2 + Ubuntu
- **macOS**: 12.0ä»¥ä¸Š
- **CentOS/RHEL**: 8ä»¥ä¸Š

**ã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢è¦ä»¶**:
- **Node.js**: 18.0ä»¥ä¸Šï¼ˆæ¨å¥¨: 20.18.0ï¼‰
- **npm/pnpm**: æœ€æ–°ç‰ˆ
- **PM2**: ãƒ—ãƒ­ã‚»ã‚¹ç®¡ç†
- **Nginx**: ãƒªãƒãƒ¼ã‚¹ãƒ—ãƒ­ã‚­ã‚·ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰

#### ã‚¯ãƒ©ã‚¦ãƒ‰ç’°å¢ƒï¼ˆå°†æ¥æ‹¡å¼µç”¨ï¼‰

**æœ€å°æ§‹æˆ**:
- **CPU**: 1vCPU
- **ãƒ¡ãƒ¢ãƒª**: 512MB
- **ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸**: 10GB SSD

**æ¨å¥¨æ§‹æˆ**:
- **CPU**: 2vCPU
- **ãƒ¡ãƒ¢ãƒª**: 1GB
- **ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸**: 20GB SSD

### ç’°å¢ƒåˆ¥è¨­å®š

#### é–‹ç™ºç’°å¢ƒ

```bash
# ç’°å¢ƒå¤‰æ•°è¨­å®š
export NODE_ENV=development
export PORT=3000
export LOG_LEVEL=debug
export DATABASE_PATH=./data/sokubutsu_dev.db
export CACHE_DIR=./cache/dev
export TELEGRAM_BOT_TOKEN=your_dev_bot_token
export MONITORING_INTERVAL=60  # 1åˆ†é–“éš”ï¼ˆé–‹ç™ºç”¨ï¼‰
```

#### ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ç’°å¢ƒ

```bash
# ç’°å¢ƒå¤‰æ•°è¨­å®š
export NODE_ENV=staging
export PORT=3001
export LOG_LEVEL=info
export DATABASE_PATH=./data/sokubutsu_staging.db
export CACHE_DIR=./cache/staging
export TELEGRAM_BOT_TOKEN=your_staging_bot_token
export MONITORING_INTERVAL=300  # 5åˆ†é–“éš”
```

#### æœ¬ç•ªç’°å¢ƒ

```bash
# ç’°å¢ƒå¤‰æ•°è¨­å®š
export NODE_ENV=production
export PORT=3000
export LOG_LEVEL=warn
export DATABASE_PATH=./data/sokubutsu.db
export CACHE_DIR=./cache/production
export TELEGRAM_BOT_TOKEN=your_production_bot_token
export MONITORING_INTERVAL=300  # 5åˆ†é–“éš”
export MAX_MEMORY_USAGE=100     # 100MBåˆ¶é™
export MAX_CPU_USAGE=50         # 50%åˆ¶é™
```

## ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ‰‹é †

### 1. ã‚·ã‚¹ãƒ†ãƒ æº–å‚™

#### Ubuntu/WSL2ç’°å¢ƒ

```bash
# ã‚·ã‚¹ãƒ†ãƒ æ›´æ–°
sudo apt update && sudo apt upgrade -y

# å¿…è¦ãªãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
sudo apt install -y curl wget git build-essential python3 python3-pip

# Node.js 20.x ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
sudo apt install -y nodejs

# pnpm ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
npm install -g pnpm

# PM2 ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
npm install -g pm2

# Nginx ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
sudo apt install -y nginx
```

#### macOSç’°å¢ƒ

```bash
# Homebrew ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼ˆæœªã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã®å ´åˆï¼‰
/bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"

# Node.js ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
brew install node@20

# pnpm ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
npm install -g pnpm

# PM2 ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
npm install -g pm2
```

#### Windowsç’°å¢ƒ

```powershell
# WSL2æœ‰åŠ¹åŒ–
wsl --install

# Ubuntu 22.04ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
wsl --install -d Ubuntu-22.04

# WSL2å†…ã§Ubuntuæ‰‹é †ã‚’å®Ÿè¡Œ
```

### 2. ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³é…ç½®

#### ãƒªãƒã‚¸ãƒˆãƒªã‚¯ãƒ­ãƒ¼ãƒ³

```bash
# ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä½œæˆ
mkdir -p /home/ubuntu/apps
cd /home/ubuntu/apps

# ãƒªãƒã‚¸ãƒˆãƒªã‚¯ãƒ­ãƒ¼ãƒ³
git clone https://github.com/denof-inc/sokubutsu2.git
cd sokubutsu2

# ãƒ–ãƒ©ãƒ³ãƒåˆ‡ã‚Šæ›¿ãˆï¼ˆè»½é‡ç‰ˆï¼‰
git checkout lightweight-version
```

#### ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

```bash
# ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
pnpm install --frozen-lockfile

# è»½é‡ã‚½ã‚¯ãƒ–ãƒ„å°‚ç”¨ä¾å­˜é–¢ä¿‚
pnpm add axios cheerio jsdom tough-cookie user-agents

# é–‹ç™ºä¾å­˜é–¢ä¿‚ï¼ˆé–‹ç™ºç’°å¢ƒã®ã¿ï¼‰
if [ "$NODE_ENV" = "development" ]; then
  pnpm add -D nodemon jest supertest
fi
```

#### ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ ä½œæˆ

```bash
# å¿…è¦ãªãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä½œæˆ
mkdir -p data cache logs backups temp

# æ¨©é™è¨­å®š
chmod 755 data cache logs backups temp
chmod 600 data/*.db 2>/dev/null || true
```

### 3. ç’°å¢ƒè¨­å®š

#### ç’°å¢ƒå¤‰æ•°ãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆ

```bash
# .env.production ä½œæˆ
cat > .env.production << 'EOF'
# ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³è¨­å®š
NODE_ENV=production
PORT=3000
LOG_LEVEL=warn

# ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­å®š
DATABASE_PATH=./data/sokubutsu.db
CACHE_DIR=./cache/production

# Telegram Botè¨­å®š
TELEGRAM_BOT_TOKEN=your_production_bot_token

# ç›£è¦–è¨­å®š
MONITORING_INTERVAL=300
MAX_CONCURRENT_CHECKS=5
REQUEST_TIMEOUT=30000

# ãƒªã‚½ãƒ¼ã‚¹åˆ¶é™
MAX_MEMORY_USAGE=100
MAX_CPU_USAGE=50

# Botå¯¾ç­–è¨­å®š
BOT_PROTECTION_ENABLED=true
USER_AGENT_ROTATION=true
PROXY_ROTATION=false

# ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­å®š
RATE_LIMIT_ENABLED=true
RATE_LIMIT_MAX=100
RATE_LIMIT_WINDOW=900000

# ãƒ­ã‚°è¨­å®š
LOG_FILE_ENABLED=true
LOG_FILE_PATH=./logs/sokubutsu.log
LOG_ROTATION_ENABLED=true
LOG_MAX_SIZE=10485760
LOG_MAX_FILES=5
EOF

# æ¨©é™è¨­å®š
chmod 600 .env.production
```

#### PM2è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆ

```bash
# ecosystem.config.js ä½œæˆ
cat > ecosystem.config.js << 'EOF'
module.exports = {
  apps: [
    {
      name: 'sokubutsu-lightweight',
      script: './src/main.js',
      instances: 1,
      exec_mode: 'fork',
      env_file: '.env.production',
      
      // ãƒªã‚½ãƒ¼ã‚¹åˆ¶é™
      max_memory_restart: '100M',
      
      // ãƒ­ã‚°è¨­å®š
      log_file: './logs/pm2.log',
      out_file: './logs/pm2-out.log',
      error_file: './logs/pm2-error.log',
      log_date_format: 'YYYY-MM-DD HH:mm:ss Z',
      
      // å†èµ·å‹•è¨­å®š
      watch: false,
      ignore_watch: ['node_modules', 'logs', 'data', 'cache', 'backups'],
      restart_delay: 5000,
      max_restarts: 10,
      min_uptime: '10s',
      
      // ç’°å¢ƒè¨­å®š
      env: {
        NODE_ENV: 'production',
        PORT: 3000
      },
      
      // ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯
      health_check_grace_period: 3000,
      health_check_fatal_exceptions: true,
      
      // ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼è¨­å®šï¼ˆå°†æ¥æ‹¡å¼µç”¨ï¼‰
      instances: 1,
      exec_mode: 'fork'
    }
  ]
};
EOF
```

#### Nginxè¨­å®šï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰

```bash
# Nginxè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆ
sudo tee /etc/nginx/sites-available/sokubutsu << 'EOF'
server {
    listen 80;
    server_name localhost;
    
    # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ˜ãƒƒãƒ€ãƒ¼
    add_header X-Frame-Options DENY;
    add_header X-Content-Type-Options nosniff;
    add_header X-XSS-Protection "1; mode=block";
    
    # ãƒ­ã‚°è¨­å®š
    access_log /var/log/nginx/sokubutsu_access.log;
    error_log /var/log/nginx/sokubutsu_error.log;
    
    # ãƒ—ãƒ­ã‚­ã‚·è¨­å®š
    location / {
        proxy_pass http://127.0.0.1:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
        
        # ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆè¨­å®š
        proxy_connect_timeout 30s;
        proxy_send_timeout 30s;
        proxy_read_timeout 30s;
    }
    
    # ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ
    location /health {
        proxy_pass http://127.0.0.1:3000/health;
        access_log off;
    }
    
    # é™çš„ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆå°†æ¥æ‹¡å¼µç”¨ï¼‰
    location /static/ {
        alias /home/ubuntu/apps/sokubutsu2/public/;
        expires 1y;
        add_header Cache-Control "public, immutable";
    }
}
EOF

# è¨­å®šæœ‰åŠ¹åŒ–
sudo ln -sf /etc/nginx/sites-available/sokubutsu /etc/nginx/sites-enabled/
sudo nginx -t
sudo systemctl reload nginx
```

### 4. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹åˆæœŸåŒ–

#### SQLite ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ä½œæˆ

```bash
# ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹åˆæœŸåŒ–ã‚¹ã‚¯ãƒªãƒ—ãƒˆå®Ÿè¡Œ
node scripts/init-database.js

# åˆæœŸãƒ‡ãƒ¼ã‚¿æŠ•å…¥ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
node scripts/seed-database.js

# ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¨©é™è¨­å®š
chmod 600 data/sokubutsu.db
```

#### åˆæœŸåŒ–ã‚¹ã‚¯ãƒªãƒ—ãƒˆä¾‹

```javascript
// scripts/init-database.js
const Database = require('better-sqlite3');
const path = require('path');

const dbPath = path.join(__dirname, '../data/sokubutsu.db');
const db = new Database(dbPath);

// WALãƒ¢ãƒ¼ãƒ‰è¨­å®š
db.pragma('journal_mode = WAL');
db.pragma('synchronous = NORMAL');
db.pragma('cache_size = -64000');
db.pragma('temp_store = MEMORY');

// ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆ
const createTables = `
  CREATE TABLE IF NOT EXISTS users (
    id TEXT PRIMARY KEY,
    username TEXT,
    first_name TEXT,
    last_name TEXT,
    language_code TEXT DEFAULT 'ja',
    is_active BOOLEAN DEFAULT true,
    url_limit INTEGER DEFAULT 3,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    last_active_at DATETIME DEFAULT CURRENT_TIMESTAMP
  );

  CREATE TABLE IF NOT EXISTS urls (
    id TEXT PRIMARY KEY,
    url TEXT NOT NULL,
    name TEXT NOT NULL,
    user_id TEXT NOT NULL,
    interval INTEGER DEFAULT 300,
    enabled BOOLEAN DEFAULT true,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    last_checked DATETIME,
    status TEXT DEFAULT 'pending',
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
  );

  CREATE TABLE IF NOT EXISTS monitoring_logs (
    id TEXT PRIMARY KEY,
    url_id TEXT NOT NULL,
    checked_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    new_count INTEGER DEFAULT 0,
    has_new BOOLEAN DEFAULT false,
    method TEXT NOT NULL,
    response_time INTEGER,
    status_code INTEGER,
    bot_protection BOOLEAN DEFAULT false,
    memory_usage REAL,
    error TEXT,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (url_id) REFERENCES urls(id) ON DELETE CASCADE
  );

  CREATE TABLE IF NOT EXISTS notifications (
    id TEXT PRIMARY KEY,
    user_id TEXT NOT NULL,
    url_id TEXT,
    type TEXT NOT NULL,
    title TEXT NOT NULL,
    message TEXT NOT NULL,
    sent_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    delivered BOOLEAN DEFAULT false,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
    FOREIGN KEY (url_id) REFERENCES urls(id) ON DELETE SET NULL
  );

  CREATE TABLE IF NOT EXISTS sessions (
    id TEXT PRIMARY KEY,
    domain TEXT NOT NULL,
    user_agent TEXT NOT NULL,
    cookies TEXT,
    last_access DATETIME DEFAULT CURRENT_TIMESTAMP,
    expires_at DATETIME,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP
  );
`;

// ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ä½œæˆ
const createIndexes = `
  CREATE INDEX IF NOT EXISTS idx_users_active ON users(is_active);
  CREATE INDEX IF NOT EXISTS idx_users_last_active ON users(last_active_at);
  
  CREATE INDEX IF NOT EXISTS idx_urls_user_id ON urls(user_id);
  CREATE INDEX IF NOT EXISTS idx_urls_enabled ON urls(enabled);
  CREATE INDEX IF NOT EXISTS idx_urls_status ON urls(status);
  CREATE INDEX IF NOT EXISTS idx_urls_last_checked ON urls(last_checked);
  CREATE UNIQUE INDEX IF NOT EXISTS idx_urls_user_url ON urls(user_id, url);
  
  CREATE INDEX IF NOT EXISTS idx_logs_url_id ON monitoring_logs(url_id);
  CREATE INDEX IF NOT EXISTS idx_logs_checked_at ON monitoring_logs(checked_at);
  CREATE INDEX IF NOT EXISTS idx_logs_has_new ON monitoring_logs(has_new);
  CREATE INDEX IF NOT EXISTS idx_logs_method ON monitoring_logs(method);
  
  CREATE INDEX IF NOT EXISTS idx_notifications_user_id ON notifications(user_id);
  CREATE INDEX IF NOT EXISTS idx_notifications_type ON notifications(type);
  CREATE INDEX IF NOT EXISTS idx_notifications_sent_at ON notifications(sent_at);
  CREATE INDEX IF NOT EXISTS idx_notifications_delivered ON notifications(delivered);
  
  CREATE INDEX IF NOT EXISTS idx_sessions_domain ON sessions(domain);
  CREATE INDEX IF NOT EXISTS idx_sessions_expires_at ON sessions(expires_at);
  CREATE UNIQUE INDEX IF NOT EXISTS idx_sessions_domain_ua ON sessions(domain, user_agent);
`;

try {
  db.exec(createTables);
  db.exec(createIndexes);
  console.log('Database initialized successfully');
} catch (error) {
  console.error('Database initialization failed:', error);
  process.exit(1);
} finally {
  db.close();
}
```

## ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆå®Ÿè¡Œ

### è‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤ã‚¹ã‚¯ãƒªãƒ—ãƒˆ

#### deploy.sh

```bash
#!/bin/bash
# deploy.sh - è»½é‡ã‚½ã‚¯ãƒ–ãƒ„è‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤ã‚¹ã‚¯ãƒªãƒ—ãƒˆ

set -e

# è¨­å®š
APP_NAME="sokubutsu-lightweight"
APP_DIR="/home/ubuntu/apps/sokubutsu2"
BACKUP_DIR="/home/ubuntu/backups"
LOG_FILE="/home/ubuntu/logs/deploy.log"

# ãƒ­ã‚°é–¢æ•°
log() {
    echo "$(date '+%Y-%m-%d %H:%M:%S') - $1" | tee -a "$LOG_FILE"
}

# ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
error_exit() {
    log "ERROR: $1"
    exit 1
}

# å‰ææ¡ä»¶ãƒã‚§ãƒƒã‚¯
check_prerequisites() {
    log "Checking prerequisites..."
    
    # Node.js ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãƒã‚§ãƒƒã‚¯
    NODE_VERSION=$(node --version | cut -d'v' -f2)
    if [ "$(printf '%s\n' "18.0.0" "$NODE_VERSION" | sort -V | head -n1)" != "18.0.0" ]; then
        error_exit "Node.js 18.0.0 or higher required. Current: $NODE_VERSION"
    fi
    
    # PM2 ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãƒã‚§ãƒƒã‚¯
    if ! command -v pm2 &> /dev/null; then
        error_exit "PM2 is not installed"
    fi
    
    # ãƒ‡ã‚£ã‚¹ã‚¯å®¹é‡ãƒã‚§ãƒƒã‚¯
    AVAILABLE_SPACE=$(df "$APP_DIR" | awk 'NR==2 {print $4}')
    if [ "$AVAILABLE_SPACE" -lt 1048576 ]; then  # 1GB
        error_exit "Insufficient disk space. Available: ${AVAILABLE_SPACE}KB"
    fi
    
    log "Prerequisites check passed"
}

# ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä½œæˆ
create_backup() {
    log "Creating backup..."
    
    TIMESTAMP=$(date +%Y%m%d_%H%M%S)
    BACKUP_PATH="$BACKUP_DIR/sokubutsu_$TIMESTAMP"
    
    mkdir -p "$BACKUP_PATH"
    
    # ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
    if [ -f "$APP_DIR/data/sokubutsu.db" ]; then
        cp "$APP_DIR/data/sokubutsu.db" "$BACKUP_PATH/"
        log "Database backed up to $BACKUP_PATH"
    fi
    
    # è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
    cp "$APP_DIR/.env.production" "$BACKUP_PATH/" 2>/dev/null || true
    cp "$APP_DIR/ecosystem.config.js" "$BACKUP_PATH/" 2>/dev/null || true
    
    # ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
    if [ -d "$APP_DIR/logs" ]; then
        cp -r "$APP_DIR/logs" "$BACKUP_PATH/"
    fi
    
    # ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—åœ§ç¸®
    cd "$BACKUP_DIR"
    tar -czf "sokubutsu_$TIMESTAMP.tar.gz" "sokubutsu_$TIMESTAMP"
    rm -rf "sokubutsu_$TIMESTAMP"
    
    log "Backup created: sokubutsu_$TIMESTAMP.tar.gz"
}

# ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³åœæ­¢
stop_application() {
    log "Stopping application..."
    
    if pm2 list | grep -q "$APP_NAME"; then
        pm2 stop "$APP_NAME" || true
        pm2 delete "$APP_NAME" || true
        log "Application stopped"
    else
        log "Application not running"
    fi
}

# ã‚³ãƒ¼ãƒ‰æ›´æ–°
update_code() {
    log "Updating code..."
    
    cd "$APP_DIR"
    
    # Gitæ›´æ–°
    git fetch origin
    git checkout lightweight-version
    git pull origin lightweight-version
    
    # ä¾å­˜é–¢ä¿‚æ›´æ–°
    pnpm install --frozen-lockfile
    
    log "Code updated successfully"
}

# ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ç§»è¡Œ
migrate_database() {
    log "Running database migrations..."
    
    cd "$APP_DIR"
    
    # ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚¹ã‚¯ãƒªãƒ—ãƒˆå®Ÿè¡Œ
    if [ -f "scripts/migrate.js" ]; then
        node scripts/migrate.js
        log "Database migration completed"
    else
        log "No migration script found, skipping"
    fi
}

# ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³èµ·å‹•
start_application() {
    log "Starting application..."
    
    cd "$APP_DIR"
    
    # PM2ã§ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³èµ·å‹•
    pm2 start ecosystem.config.js
    
    # èµ·å‹•ç¢ºèª
    sleep 5
    if pm2 list | grep -q "$APP_NAME.*online"; then
        log "Application started successfully"
    else
        error_exit "Application failed to start"
    fi
}

# ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯
health_check() {
    log "Performing health check..."
    
    # ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆç¢ºèª
    for i in {1..10}; do
        if curl -f http://localhost:3000/health > /dev/null 2>&1; then
            log "Health check passed"
            return 0
        fi
        log "Health check attempt $i failed, retrying..."
        sleep 5
    done
    
    error_exit "Health check failed after 10 attempts"
}

# å¤ã„ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
cleanup_old_backups() {
    log "Cleaning up old backups..."
    
    # 7æ—¥ä»¥ä¸Šå¤ã„ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’å‰Šé™¤
    find "$BACKUP_DIR" -name "sokubutsu_*.tar.gz" -mtime +7 -delete
    
    log "Old backups cleaned up"
}

# ãƒ¡ã‚¤ãƒ³å®Ÿè¡Œ
main() {
    log "Starting deployment of $APP_NAME"
    
    check_prerequisites
    create_backup
    stop_application
    update_code
    migrate_database
    start_application
    health_check
    cleanup_old_backups
    
    log "Deployment completed successfully"
    
    # ãƒ‡ãƒ—ãƒ­ã‚¤é€šçŸ¥ï¼ˆTelegramï¼‰
    if [ -n "$TELEGRAM_BOT_TOKEN" ] && [ -n "$TELEGRAM_CHAT_ID" ]; then
        curl -s -X POST "https://api.telegram.org/bot$TELEGRAM_BOT_TOKEN/sendMessage" \
            -d chat_id="$TELEGRAM_CHAT_ID" \
            -d text="ğŸš€ è»½é‡ã‚½ã‚¯ãƒ–ãƒ„ã®ãƒ‡ãƒ—ãƒ­ã‚¤ãŒå®Œäº†ã—ã¾ã—ãŸï¼"
    fi
}

# ã‚¹ã‚¯ãƒªãƒ—ãƒˆå®Ÿè¡Œ
main "$@"
```

#### å®Ÿè¡Œæ¨©é™è¨­å®š

```bash
chmod +x deploy.sh
```

### ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚¹ã‚¯ãƒªãƒ—ãƒˆ

#### rollback.sh

```bash
#!/bin/bash
# rollback.sh - è»½é‡ã‚½ã‚¯ãƒ–ãƒ„ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚¹ã‚¯ãƒªãƒ—ãƒˆ

set -e

APP_NAME="sokubutsu-lightweight"
APP_DIR="/home/ubuntu/apps/sokubutsu2"
BACKUP_DIR="/home/ubuntu/backups"
LOG_FILE="/home/ubuntu/logs/rollback.log"

log() {
    echo "$(date '+%Y-%m-%d %H:%M:%S') - $1" | tee -a "$LOG_FILE"
}

error_exit() {
    log "ERROR: $1"
    exit 1
}

# ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠ
select_backup() {
    log "Available backups:"
    ls -la "$BACKUP_DIR"/sokubutsu_*.tar.gz | awk '{print NR ". " $9}' | tee -a "$LOG_FILE"
    
    if [ -z "$1" ]; then
        echo "Usage: $0 <backup_number>"
        echo "Example: $0 1"
        exit 1
    fi
    
    BACKUP_FILE=$(ls "$BACKUP_DIR"/sokubutsu_*.tar.gz | sed -n "${1}p")
    
    if [ ! -f "$BACKUP_FILE" ]; then
        error_exit "Backup file not found: $BACKUP_FILE"
    fi
    
    log "Selected backup: $BACKUP_FILE"
}

# ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯å®Ÿè¡Œ
perform_rollback() {
    log "Starting rollback..."
    
    # ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³åœæ­¢
    pm2 stop "$APP_NAME" || true
    pm2 delete "$APP_NAME" || true
    
    # ç¾åœ¨ã®çŠ¶æ…‹ã‚’ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
    TIMESTAMP=$(date +%Y%m%d_%H%M%S)
    EMERGENCY_BACKUP="$BACKUP_DIR/emergency_$TIMESTAMP.tar.gz"
    
    cd "$APP_DIR"
    tar -czf "$EMERGENCY_BACKUP" data logs .env.production ecosystem.config.js
    log "Emergency backup created: $EMERGENCY_BACKUP"
    
    # ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ•ã‚¡ã‚¤ãƒ«å±•é–‹
    TEMP_DIR="/tmp/sokubutsu_restore_$$"
    mkdir -p "$TEMP_DIR"
    cd "$TEMP_DIR"
    tar -xzf "$BACKUP_FILE"
    
    # ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹å¾©å…ƒ
    if [ -f "sokubutsu.db" ]; then
        cp "sokubutsu.db" "$APP_DIR/data/"
        log "Database restored"
    fi
    
    # è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«å¾©å…ƒ
    if [ -f ".env.production" ]; then
        cp ".env.production" "$APP_DIR/"
        log "Environment file restored"
    fi
    
    if [ -f "ecosystem.config.js" ]; then
        cp "ecosystem.config.js" "$APP_DIR/"
        log "PM2 config restored"
    fi
    
    # ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
    rm -rf "$TEMP_DIR"
    
    # ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³èµ·å‹•
    cd "$APP_DIR"
    pm2 start ecosystem.config.js
    
    # èµ·å‹•ç¢ºèª
    sleep 5
    if pm2 list | grep -q "$APP_NAME.*online"; then
        log "Rollback completed successfully"
    else
        error_exit "Application failed to start after rollback"
    fi
}

# ãƒ¡ã‚¤ãƒ³å®Ÿè¡Œ
main() {
    select_backup "$1"
    perform_rollback
    
    # ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯é€šçŸ¥
    if [ -n "$TELEGRAM_BOT_TOKEN" ] && [ -n "$TELEGRAM_CHAT_ID" ]; then
        curl -s -X POST "https://api.telegram.org/bot$TELEGRAM_BOT_TOKEN/sendMessage" \
            -d chat_id="$TELEGRAM_CHAT_ID" \
            -d text="âš ï¸ è»½é‡ã‚½ã‚¯ãƒ–ãƒ„ãŒãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ã•ã‚Œã¾ã—ãŸã€‚ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—: $(basename $BACKUP_FILE)"
    fi
}

main "$@"
```

## ç›£è¦–ãƒ»ãƒ­ã‚°ç®¡ç†

### ã‚·ã‚¹ãƒ†ãƒ ç›£è¦–

#### ãƒªã‚½ãƒ¼ã‚¹ç›£è¦–ã‚¹ã‚¯ãƒªãƒ—ãƒˆ

```bash
#!/bin/bash
# monitor.sh - ã‚·ã‚¹ãƒ†ãƒ ãƒªã‚½ãƒ¼ã‚¹ç›£è¦–

APP_NAME="sokubutsu-lightweight"
LOG_FILE="/home/ubuntu/logs/monitor.log"
ALERT_THRESHOLD_MEMORY=80  # MB
ALERT_THRESHOLD_CPU=70     # %

log() {
    echo "$(date '+%Y-%m-%d %H:%M:%S') - $1" | tee -a "$LOG_FILE"
}

check_application_status() {
    if pm2 list | grep -q "$APP_NAME.*online"; then
        log "Application is running"
        return 0
    else
        log "WARNING: Application is not running"
        return 1
    fi
}

check_memory_usage() {
    MEMORY_USAGE=$(pm2 show "$APP_NAME" | grep "memory usage" | awk '{print $4}' | sed 's/M//')
    
    if [ -n "$MEMORY_USAGE" ] && [ "$MEMORY_USAGE" -gt "$ALERT_THRESHOLD_MEMORY" ]; then
        log "WARNING: High memory usage: ${MEMORY_USAGE}MB"
        return 1
    else
        log "Memory usage: ${MEMORY_USAGE}MB"
        return 0
    fi
}

check_cpu_usage() {
    CPU_USAGE=$(pm2 show "$APP_NAME" | grep "cpu usage" | awk '{print $4}' | sed 's/%//')
    
    if [ -n "$CPU_USAGE" ] && [ "$CPU_USAGE" -gt "$ALERT_THRESHOLD_CPU" ]; then
        log "WARNING: High CPU usage: ${CPU_USAGE}%"
        return 1
    else
        log "CPU usage: ${CPU_USAGE}%"
        return 0
    fi
}

check_disk_space() {
    DISK_USAGE=$(df /home/ubuntu | awk 'NR==2 {print $5}' | sed 's/%//')
    
    if [ "$DISK_USAGE" -gt 80 ]; then
        log "WARNING: High disk usage: ${DISK_USAGE}%"
        return 1
    else
        log "Disk usage: ${DISK_USAGE}%"
        return 0
    fi
}

check_database_health() {
    DB_PATH="/home/ubuntu/apps/sokubutsu2/data/sokubutsu.db"
    
    if [ -f "$DB_PATH" ]; then
        # ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯
        INTEGRITY_CHECK=$(sqlite3 "$DB_PATH" "PRAGMA integrity_check;" 2>/dev/null)
        
        if [ "$INTEGRITY_CHECK" = "ok" ]; then
            log "Database integrity: OK"
            return 0
        else
            log "ERROR: Database integrity check failed: $INTEGRITY_CHECK"
            return 1
        fi
    else
        log "ERROR: Database file not found"
        return 1
    fi
}

send_alert() {
    local message="$1"
    
    if [ -n "$TELEGRAM_BOT_TOKEN" ] && [ -n "$TELEGRAM_CHAT_ID" ]; then
        curl -s -X POST "https://api.telegram.org/bot$TELEGRAM_BOT_TOKEN/sendMessage" \
            -d chat_id="$TELEGRAM_CHAT_ID" \
            -d text="ğŸš¨ è»½é‡ã‚½ã‚¯ãƒ–ãƒ„ã‚¢ãƒ©ãƒ¼ãƒˆ: $message"
    fi
}

main() {
    log "Starting system monitoring"
    
    ALERTS=()
    
    if ! check_application_status; then
        ALERTS+=("ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãŒåœæ­¢ã—ã¦ã„ã¾ã™")
    fi
    
    if ! check_memory_usage; then
        ALERTS+=("ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡ãŒé«˜ã™ãã¾ã™")
    fi
    
    if ! check_cpu_usage; then
        ALERTS+=("CPUä½¿ç”¨ç‡ãŒé«˜ã™ãã¾ã™")
    fi
    
    if ! check_disk_space; then
        ALERTS+=("ãƒ‡ã‚£ã‚¹ã‚¯ä½¿ç”¨é‡ãŒé«˜ã™ãã¾ã™")
    fi
    
    if ! check_database_health; then
        ALERTS+=("ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«å•é¡ŒãŒã‚ã‚Šã¾ã™")
    fi
    
    if [ ${#ALERTS[@]} -gt 0 ]; then
        for alert in "${ALERTS[@]}"; do
            send_alert "$alert"
        done
    fi
    
    log "Monitoring completed"
}

main "$@"
```

#### Cronè¨­å®š

```bash
# ç›£è¦–ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®Cronè¨­å®š
crontab -e

# ä»¥ä¸‹ã‚’è¿½åŠ 
# 5åˆ†æ¯ã«ã‚·ã‚¹ãƒ†ãƒ ç›£è¦–
*/5 * * * * /home/ubuntu/apps/sokubutsu2/scripts/monitor.sh

# 1æ™‚é–“æ¯ã«ãƒ­ã‚°ãƒ­ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³
0 * * * * /home/ubuntu/apps/sokubutsu2/scripts/rotate-logs.sh

# æ¯æ—¥åˆå‰3æ™‚ã«ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
0 3 * * * /home/ubuntu/apps/sokubutsu2/scripts/backup.sh

# æ¯é€±æ—¥æ›œæ—¥åˆå‰4æ™‚ã«ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æœ€é©åŒ–
0 4 * * 0 /home/ubuntu/apps/sokubutsu2/scripts/optimize-db.sh
```

### ãƒ­ã‚°ç®¡ç†

#### ãƒ­ã‚°ãƒ­ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã‚¹ã‚¯ãƒªãƒ—ãƒˆ

```bash
#!/bin/bash
# rotate-logs.sh - ãƒ­ã‚°ãƒ­ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³

LOG_DIR="/home/ubuntu/apps/sokubutsu2/logs"
MAX_SIZE=10485760  # 10MB
MAX_FILES=5

rotate_log() {
    local log_file="$1"
    local base_name=$(basename "$log_file" .log)
    local dir_name=$(dirname "$log_file")
    
    if [ -f "$log_file" ] && [ $(stat -c%s "$log_file") -gt $MAX_SIZE ]; then
        # æ—¢å­˜ã®ãƒ­ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚·ãƒ•ãƒˆ
        for i in $(seq $((MAX_FILES-1)) -1 1); do
            if [ -f "${dir_name}/${base_name}.${i}.log" ]; then
                mv "${dir_name}/${base_name}.${i}.log" "${dir_name}/${base_name}.$((i+1)).log"
            fi
        done
        
        # ç¾åœ¨ã®ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ­ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³
        mv "$log_file" "${dir_name}/${base_name}.1.log"
        
        # æ–°ã—ã„ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆ
        touch "$log_file"
        chmod 644 "$log_file"
        
        # å¤ã„ãƒ•ã‚¡ã‚¤ãƒ«å‰Šé™¤
        find "$dir_name" -name "${base_name}.*.log" -type f | sort -V | tail -n +$((MAX_FILES+1)) | xargs rm -f
        
        echo "Rotated log: $log_file"
    fi
}

# å„ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ­ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³
rotate_log "$LOG_DIR/sokubutsu.log"
rotate_log "$LOG_DIR/pm2.log"
rotate_log "$LOG_DIR/pm2-out.log"
rotate_log "$LOG_DIR/pm2-error.log"
rotate_log "$LOG_DIR/deploy.log"
rotate_log "$LOG_DIR/monitor.log"

# PM2ãƒ­ã‚°ãƒªãƒ­ãƒ¼ãƒ‰
pm2 reloadLogs
```

## ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­å®š

### ãƒ•ã‚¡ã‚¤ã‚¢ã‚¦ã‚©ãƒ¼ãƒ«è¨­å®š

```bash
# UFWï¼ˆUncomplicated Firewallï¼‰è¨­å®š
sudo ufw enable

# SSHè¨±å¯
sudo ufw allow ssh

# HTTP/HTTPSè¨±å¯ï¼ˆNginxä½¿ç”¨æ™‚ï¼‰
sudo ufw allow 80
sudo ufw allow 443

# ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒãƒ¼ãƒˆï¼ˆå†…éƒ¨ã®ã¿ï¼‰
sudo ufw allow from 127.0.0.1 to any port 3000

# è¨­å®šç¢ºèª
sudo ufw status verbose
```

### SSL/TLSè¨­å®šï¼ˆLet's Encryptï¼‰

```bash
# Certbot ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
sudo apt install -y certbot python3-certbot-nginx

# SSLè¨¼æ˜æ›¸å–å¾—
sudo certbot --nginx -d your-domain.com

# è‡ªå‹•æ›´æ–°è¨­å®š
sudo crontab -e
# ä»¥ä¸‹ã‚’è¿½åŠ 
0 12 * * * /usr/bin/certbot renew --quiet
```

### ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¼·åŒ–

#### fail2banè¨­å®š

```bash
# fail2ban ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
sudo apt install -y fail2ban

# è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆ
sudo tee /etc/fail2ban/jail.local << 'EOF'
[DEFAULT]
bantime = 3600
findtime = 600
maxretry = 5

[sshd]
enabled = true
port = ssh
logpath = /var/log/auth.log

[nginx-http-auth]
enabled = true
port = http,https
logpath = /var/log/nginx/error.log

[nginx-limit-req]
enabled = true
port = http,https
logpath = /var/log/nginx/error.log
maxretry = 10
EOF

# fail2ban å†èµ·å‹•
sudo systemctl restart fail2ban
sudo systemctl enable fail2ban
```

## ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–

### ã‚·ã‚¹ãƒ†ãƒ æœ€é©åŒ–

#### ã‚«ãƒ¼ãƒãƒ«ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿èª¿æ•´

```bash
# /etc/sysctl.conf ã«è¿½åŠ 
sudo tee -a /etc/sysctl.conf << 'EOF'
# ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æœ€é©åŒ–
net.core.rmem_max = 16777216
net.core.wmem_max = 16777216
net.ipv4.tcp_rmem = 4096 87380 16777216
net.ipv4.tcp_wmem = 4096 65536 16777216

# ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‡ã‚£ã‚¹ã‚¯ãƒªãƒ—ã‚¿åˆ¶é™
fs.file-max = 65536

# ãƒ¡ãƒ¢ãƒªæœ€é©åŒ–
vm.swappiness = 10
vm.dirty_ratio = 15
vm.dirty_background_ratio = 5
EOF

# è¨­å®šé©ç”¨
sudo sysctl -p
```

#### ãƒ¦ãƒ¼ã‚¶ãƒ¼åˆ¶é™è¨­å®š

```bash
# /etc/security/limits.conf ã«è¿½åŠ 
sudo tee -a /etc/security/limits.conf << 'EOF'
ubuntu soft nofile 65536
ubuntu hard nofile 65536
ubuntu soft nproc 32768
ubuntu hard nproc 32768
EOF
```

### ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³æœ€é©åŒ–

#### Node.jsæœ€é©åŒ–

```bash
# .bashrc ã«è¿½åŠ 
echo 'export NODE_OPTIONS="--max-old-space-size=256"' >> ~/.bashrc
echo 'export UV_THREADPOOL_SIZE=4' >> ~/.bashrc
source ~/.bashrc
```

#### PM2æœ€é©åŒ–

```javascript
// ecosystem.config.js ã®æœ€é©åŒ–è¨­å®š
module.exports = {
  apps: [{
    name: 'sokubutsu-lightweight',
    script: './src/main.js',
    
    // Node.jsæœ€é©åŒ–
    node_args: [
      '--max-old-space-size=256',
      '--optimize-for-size',
      '--gc-interval=100'
    ],
    
    // ãƒ—ãƒ­ã‚»ã‚¹æœ€é©åŒ–
    instances: 1,
    exec_mode: 'fork',
    
    // ãƒ¡ãƒ¢ãƒªç®¡ç†
    max_memory_restart: '100M',
    kill_timeout: 5000,
    
    // ãƒ­ã‚°æœ€é©åŒ–
    log_type: 'json',
    merge_logs: true,
    
    // ç’°å¢ƒæœ€é©åŒ–
    env: {
      NODE_ENV: 'production',
      UV_THREADPOOL_SIZE: 4
    }
  }]
};
```

## ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### ä¸€èˆ¬çš„ãªå•é¡Œã¨è§£æ±ºç­–

#### ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³èµ·å‹•å¤±æ•—

```bash
# ãƒ­ã‚°ç¢ºèª
pm2 logs sokubutsu-lightweight

# ãƒ—ãƒ­ã‚»ã‚¹çŠ¶æ…‹ç¢ºèª
pm2 show sokubutsu-lightweight

# æ‰‹å‹•èµ·å‹•ãƒ†ã‚¹ãƒˆ
cd /home/ubuntu/apps/sokubutsu2
node src/main.js

# ä¾å­˜é–¢ä¿‚å†ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
pnpm install --frozen-lockfile
```

#### ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹å•é¡Œ

```bash
# ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯
sqlite3 data/sokubutsu.db "PRAGMA integrity_check;"

# ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ä¿®å¾©
sqlite3 data/sokubutsu.db "PRAGMA wal_checkpoint(TRUNCATE);"
sqlite3 data/sokubutsu.db "VACUUM;"

# ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‹ã‚‰å¾©å…ƒ
./scripts/rollback.sh 1
```

#### ãƒ¡ãƒ¢ãƒªä¸è¶³

```bash
# ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡ç¢ºèª
free -h
ps aux --sort=-%mem | head

# ã‚¹ãƒ¯ãƒƒãƒ—ãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆ
sudo fallocate -l 1G /swapfile
sudo chmod 600 /swapfile
sudo mkswap /swapfile
sudo swapon /swapfile

# æ°¸ç¶šåŒ–
echo '/swapfile none swap sw 0 0' | sudo tee -a /etc/fstab
```

#### ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯å•é¡Œ

```bash
# æ¥ç¶šãƒ†ã‚¹ãƒˆ
curl -I https://suumo.jp/

# DNSç¢ºèª
nslookup suumo.jp

# ãƒ•ã‚¡ã‚¤ã‚¢ã‚¦ã‚©ãƒ¼ãƒ«ç¢ºèª
sudo ufw status
sudo iptables -L

# ãƒ—ãƒ­ã‚­ã‚·è¨­å®šç¢ºèª
echo $http_proxy
echo $https_proxy
```

### ç·Šæ€¥æ™‚å¯¾å¿œ

#### ã‚µãƒ¼ãƒ“ã‚¹å¾©æ—§æ‰‹é †

```bash
# 1. ã‚µãƒ¼ãƒ“ã‚¹çŠ¶æ…‹ç¢ºèª
sudo systemctl status nginx
pm2 status

# 2. ãƒ­ã‚°ç¢ºèª
tail -f /home/ubuntu/apps/sokubutsu2/logs/sokubutsu.log
tail -f /var/log/nginx/error.log

# 3. ãƒ—ãƒ­ã‚»ã‚¹å†èµ·å‹•
pm2 restart sokubutsu-lightweight
sudo systemctl restart nginx

# 4. å®Œå…¨å†èµ·å‹•ï¼ˆæœ€çµ‚æ‰‹æ®µï¼‰
pm2 kill
sudo systemctl restart nginx
cd /home/ubuntu/apps/sokubutsu2
pm2 start ecosystem.config.js
```

#### ãƒ‡ãƒ¼ã‚¿å¾©æ—§æ‰‹é †

```bash
# 1. æœ€æ–°ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ç¢ºèª
ls -la /home/ubuntu/backups/sokubutsu_*.tar.gz

# 2. ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯å®Ÿè¡Œ
./scripts/rollback.sh 1

# 3. ãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§ç¢ºèª
sqlite3 data/sokubutsu.db "SELECT COUNT(*) FROM users;"
sqlite3 data/sokubutsu.db "SELECT COUNT(*) FROM urls;"

# 4. ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å†èµ·å‹•
pm2 restart sokubutsu-lightweight
```

## é‹ç”¨ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹

### å®šæœŸãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹

#### é€±æ¬¡ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹

```bash
#!/bin/bash
# weekly-maintenance.sh

# ãƒ­ã‚°ãƒ­ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³
./scripts/rotate-logs.sh

# ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æœ€é©åŒ–
sqlite3 data/sokubutsu.db "PRAGMA optimize;"
sqlite3 data/sokubutsu.db "PRAGMA wal_checkpoint(TRUNCATE);"

# å¤ã„ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
find cache/ -type f -mtime +7 -delete

# ã‚·ã‚¹ãƒ†ãƒ æ›´æ–°ç¢ºèª
sudo apt list --upgradable

# ãƒ‡ã‚£ã‚¹ã‚¯ä½¿ç”¨é‡ãƒ¬ãƒãƒ¼ãƒˆ
df -h > logs/disk-usage-$(date +%Y%m%d).log
```

#### æœˆæ¬¡ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹

```bash
#!/bin/bash
# monthly-maintenance.sh

# ã‚·ã‚¹ãƒ†ãƒ æ›´æ–°
sudo apt update && sudo apt upgrade -y

# Node.jsæ›´æ–°ç¢ºèª
npm outdated -g

# ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹çµ±è¨ˆæ›´æ–°
sqlite3 data/sokubutsu.db "ANALYZE;"

# å¤ã„ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
find backups/ -name "*.tar.gz" -mtime +30 -delete

# ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç›£æŸ»
sudo lynis audit system
```

### ç›£è¦–æŒ‡æ¨™

#### é‡è¦ãªãƒ¡ãƒˆãƒªã‚¯ã‚¹

1. **ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³æŒ‡æ¨™**:
   - ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡ï¼ˆç›®æ¨™: <100MBï¼‰
   - CPUä½¿ç”¨ç‡ï¼ˆç›®æ¨™: <50%ï¼‰
   - ãƒ¬ã‚¹ãƒãƒ³ã‚¹æ™‚é–“ï¼ˆç›®æ¨™: <5ç§’ï¼‰
   - ã‚¨ãƒ©ãƒ¼ç‡ï¼ˆç›®æ¨™: <1%ï¼‰

2. **ã‚·ã‚¹ãƒ†ãƒ æŒ‡æ¨™**:
   - ãƒ‡ã‚£ã‚¹ã‚¯ä½¿ç”¨é‡ï¼ˆè­¦å‘Š: >80%ï¼‰
   - ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯é…å»¶ï¼ˆè­¦å‘Š: >1ç§’ï¼‰
   - ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‡ã‚£ã‚¹ã‚¯ãƒªãƒ—ã‚¿ä½¿ç”¨é‡
   - ãƒ—ãƒ­ã‚»ã‚¹æ•°

3. **ãƒ“ã‚¸ãƒã‚¹æŒ‡æ¨™**:
   - ç›£è¦–URLæ•°
   - æ–°ç€ç™ºè¦‹ç‡
   - é€šçŸ¥é…ä¿¡æˆåŠŸç‡
   - ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£

### ã‚¢ãƒ©ãƒ¼ãƒˆè¨­å®š

#### é‡è¦åº¦åˆ¥ã‚¢ãƒ©ãƒ¼ãƒˆ

**Criticalï¼ˆå³åº§å¯¾å¿œï¼‰**:
- ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³åœæ­¢
- ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ç ´æ
- ãƒ¡ãƒ¢ãƒªä¸è¶³
- ãƒ‡ã‚£ã‚¹ã‚¯å®¹é‡ä¸è¶³

**Warningï¼ˆ24æ™‚é–“ä»¥å†…å¯¾å¿œï¼‰**:
- é«˜CPUä½¿ç”¨ç‡
- é«˜ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡
- ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯é…å»¶
- ã‚¨ãƒ©ãƒ¼ç‡ä¸Šæ˜‡

**Infoï¼ˆå®šæœŸç¢ºèªï¼‰**:
- æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²
- ã‚·ã‚¹ãƒ†ãƒ æ›´æ–°é€šçŸ¥
- ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—å®Œäº†
- ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹å®Œäº†

## ã¾ã¨ã‚

è»½é‡ã‚½ã‚¯ãƒ–ãƒ„ã®ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆæˆ¦ç•¥ã¯ã€è‡ªå®…ã‚µãƒ¼ãƒãƒ¼ç’°å¢ƒã§ã®ç‰©ä»¶ç›£è¦–ã«æœ€é©åŒ–ã•ã‚ŒãŸåŒ…æ‹¬çš„ãªã‚½ãƒªãƒ¥ãƒ¼ã‚·ãƒ§ãƒ³ã§ã™ã€‚

### ä¸»è¦ãªç‰¹å¾´

1. **è»½é‡è¨­è¨ˆ**: ãƒ¡ãƒ¢ãƒª30-60MBã€èµ·å‹•æ™‚é–“1-3ç§’ã®é«˜é€Ÿå‹•ä½œ
2. **å®‰å®šé‹ç”¨**: PM2 + è‡ªå‹•ç›£è¦–ã«ã‚ˆã‚‹24/7ç¨¼åƒ
3. **ç°¡å˜ç®¡ç†**: è‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤ + ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯æ©Ÿèƒ½
4. **åŒ…æ‹¬çš„ç›£è¦–**: ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ç›£è¦– + ã‚¢ãƒ©ãƒ¼ãƒˆé€šçŸ¥
5. **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£**: ãƒ•ã‚¡ã‚¤ã‚¢ã‚¦ã‚©ãƒ¼ãƒ« + SSL/TLS + fail2ban

### æœŸå¾…ã•ã‚Œã‚‹åŠ¹æœ

- **é‹ç”¨ã‚³ã‚¹ãƒˆ**: æœˆé¡0-500å††ï¼ˆé›»æ°—ä»£ã®ã¿ï¼‰
- **å®‰å®šæ€§**: 99.9%ä»¥ä¸Šã®ã‚¢ãƒƒãƒ—ã‚¿ã‚¤ãƒ 
- **ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹**: 1-3ç§’ã®é«˜é€Ÿãƒ¬ã‚¹ãƒãƒ³ã‚¹
- **ä¿å®ˆæ€§**: è‡ªå‹•åŒ–ã«ã‚ˆã‚‹é‹ç”¨è² è·è»½æ¸›

### æŠ€è¡“çš„å„ªä½æ€§

1. **ãƒã‚¤ãƒ†ã‚£ãƒ–å®Ÿè¡Œ**: Dockerä¸è¦ã®è»½é‡ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£
2. **è‡ªå‹•åŒ–**: ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ»ç›£è¦–ãƒ»ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã®å®Œå…¨è‡ªå‹•åŒ–
3. **æ‹¡å¼µæ€§**: å°†æ¥ã®ã‚¯ãƒ©ã‚¦ãƒ‰ç§»è¡Œæº–å‚™å®Œäº†
4. **ä¿¡é ¼æ€§**: å¤šå±¤ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ— + ç·Šæ€¥æ™‚å¾©æ—§æ‰‹é †

ã“ã®åŒ…æ‹¬çš„ãªãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆæˆ¦ç•¥ã«ã‚ˆã‚Šã€è‡ªå®…ã‚µãƒ¼ãƒãƒ¼ç’°å¢ƒã§ã®é•·æœŸå®‰å®šé‹ç”¨ã¨åŠ¹ç‡çš„ãªç‰©ä»¶ç›£è¦–ã‚µãƒ¼ãƒ“ã‚¹ã‚’å®Ÿç¾ã§ãã¾ã™ã€‚

