# 新着物件通知サービス「ソクブツ」要件定義書

- **ドキュメントバージョン**: 1.0  
- **作成日**: 2025年7月25日  
- **作成者**: Google Tech Lead (AI)  
- **承認者**: Project Manager  

---

## 1. 概要

### 1.1 プロジェクト目的
本プロジェクトは、不動産ポータルサイトの物件リストページを定期的に監視し、新着物件が掲載された際に即座にユーザーへ通知するサービス「ソクブツ」を開発することを目的とする。これにより、ユーザーのビジネス機会損失を防ぎ、競争優位性を確立する。

### 1.2 プロジェクトスコープ

- **スコープ内**
  - 機能要件・非機能要件に記載されたすべての機能開発
  - 自宅サーバー（WSL2）上でのシステム構築と運用

- **スコープ外**
  - iOS/Androidネイティブアプリ開発
  - 本ドキュメントに記載のない機能

### 1.3 用語定義

| 用語         | 説明                                                                 |
|--------------|----------------------------------------------------------------------|
| 監視エンジン | Playwrightを使用し、指定URLのコンテンツを取得・比較するコアモジュール         |
| MVP          | Minimum Viable Product。3日以内のリリースを目指す最小限の機能セット         |
| CI/CD        | 継続的インテグレーション / 継続的デリバリー。コード変更を自動でテスト・デプロイ |

---

## 2. システム構成（アーキテクチャ）

### 2.1 MVP時点のアーキテクチャ

初期開発のスピードを最優先し、データベースには軽量なSQLiteを採用。
[自宅サーバー (WSL2)]
+––––––––––––––––––––––––––––––––+
| [Docker]                                                       |
|                                                                |
|   +––––––––––––––––––––––––––––+   |
|   |   NestJS App (TypeScript)                              |   |
|   |   - API (Telegram)                                     |   |
|   |   - Scheduler (node-cron)                              |   |
|   |   - Scraper (Playwright)                               |   |
|   |   - DB Driver: SQLite <–– [sqlite_database.db file]  |   |
|   +––––––––––––––––––––––––––––+   |
|         |        ^                                             |
|         |        |                                             |
|         v        | (Scrape)                                    |
|   [Internet] <—+—————––> [Telegram API]           |
|   - at-home.co.jp                                              |
|                                                                |
+––––––––––––––––––––––––––––––––+

### 2.2 v1.0以降のアーキテクチャ

サービスの成長とデータ整合性の要求に応じ、データベースをPostgreSQLへ移行。
[自宅サーバー (WSL2)]
+––––––––––––––––––––––––––––––––+
| [Docker]                                                       |
|                                                                |
|   +———————+   +———————+            |
|   |   NestJS App        |   |   PostgreSQL DB     |            |
|   | (TypeScript)        |<->| (データ永続化)        |            |
|   +———————+   +———————+            |
|         |        ^                                             |
(以下、MVPと同じ)

---

## 3. 機能要件

### 3.1 監視機能 (F-01)

- **F-01-01**: 登録されたURLを5分周期で巡回。周期は将来的に設定変更可能。
- **F-01-02**: Playwrightで物件一覧領域のHTML構造のハッシュ値を計算し、前回と比較。
- **F-01-03**: ハッシュ値に差があれば「新着あり」と判定。
- **F-01-04**: タイムアウトやHTTPエラー時、エラー内容を管理者に通知。

### 3.2 通知機能 (F-02)

- **F-02-01**: 新着発見時、登録ユーザーへTelegramで即時通知。
- **F-02-02**: 1時間に1回、各URLの監視ステータスをTelegramで通知。
- **F-02-03**: 監視エラーは管理者に通知（URL・種別・時刻含む）。

### 3.3 ユーザー操作機能 (F-03)

Telegram Bot コマンド：

- `/start`: ユーザー登録と利用開始  
- `/add <URL> <名前>`: 新規監視URL登録  
- `/list`: 登録済みURL一覧表示  
- `/pause <URL-ID>`: URL監視を一時停止  
- `/resume <URL-ID>`: URL監視を再開  
- `/delete <URL-ID>`: URL削除  

---

## 4. 非機能要件

### 4.1 性能

- **N-01-01**: 1URLあたりの監視処理を95%のケースで1分以内に完了する。

### 4.2 可用性・信頼性

- **N-02-01**: 24時間365日稼働を前提。
- **N-02-02**: Dockerコンテナに`restart: always`設定。
- **N-02-03**: DBはDockerボリュームで永続化。

### 4.3 拡張性

- **N-03-01**: サイトごとにモジュール化し、追加容易な構成に。
- **N-03-02**: SQLite → PostgreSQLへの移行パスを準備。

### 4.4 セキュリティ

- **N-04-01**: Bot検知回避のため、以下のPlaywright設定を実施：
  - 最新User-Agent使用  
  - アクセスごとにランダム待機時間  
  - 人間的な操作を模倣する処理  
- **N-04-02**: APIトークンは`.env`で管理し、Gitに含めない。

### 4.5 保守性・運用性

- **N-05-01**: 開発〜本番までDocker環境を統一。
- **N-05-02**: GitHub ActionsでLint/テスト/ビルドを自動実行。
- **N-05-03**: Jestを使ったTDDを実施（ユニット＆結合テスト）。

---

## 5. 技術スタック

| 領域            | 採用技術              | バージョン/備考           |
|-----------------|-----------------------|----------------------------|
| 実行環境        | Docker on WSL2        | 長期安定稼働のため         |
| 言語            | TypeScript            | 5.x                        |
| バックエンド    | NestJS                | 10.x                       |
| データベース    | SQLite (MVP) → PostgreSQL (v1.0) | フェーズドアプローチ     |
| スクレイピング  | Puppeteer + Stealth   | 21.x                       |
| テスト          | Jest                  | 29.x                       |
| CI/CD           | GitHub Actions        | -                          |
| プロセス管理    | PM2                   | コンテナ内でオプション検討 |

---

## 6. 開発ロードマップ

### フェーズ1: MVPリリース（目標: 3日以内）
- 単一URLの監視・通知機能
- Docker環境構築
- .envファイルによる手動設定

### フェーズ2: v1.0機能開発 & DB移行
- PostgreSQLへ移行
- 複数ユーザー・URL対応
- Telegramコマンドによる操作
- 管理者機能（DBクライアントで）

### フェーズ3: v2.0（サービス成長期）
- 監視URLの共有機能
- 複数サイト対応
- 課金システム連携

---