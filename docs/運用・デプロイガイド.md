# ã‚½ã‚¯ãƒ–ãƒ„é‹ç”¨ãƒ»ãƒ‡ãƒ—ãƒ­ã‚¤ã‚¬ã‚¤ãƒ‰

## ğŸ¯ ã“ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«ã¤ã„ã¦

ã“ã®ã‚¬ã‚¤ãƒ‰ã¯ã€ã‚½ã‚¯ãƒ–ãƒ„ã‚·ã‚¹ãƒ†ãƒ ã®æœ¬ç•ªç’°å¢ƒã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆã¨ç¶™ç¶šçš„ãªé‹ç”¨ã®ãŸã‚ã®åŒ…æ‹¬çš„ãªæ‰‹é †æ›¸ã§ã™ã€‚è‡ªå®…ã‚µãƒ¼ãƒãƒ¼ï¼ˆWSL2ï¼‰ç’°å¢ƒã§ã®æœ€é©åŒ–ã•ã‚ŒãŸé‹ç”¨æ–¹æ³•ã‚’æä¾›ã—ã¾ã™ã€‚

## ğŸ—ï¸ ã‚¤ãƒ³ãƒ•ãƒ©ã‚¹ãƒˆãƒ©ã‚¯ãƒãƒ£æ¦‚è¦

### é‹ç”¨ç’°å¢ƒ
- **ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ **: è‡ªå®…ã‚µãƒ¼ãƒãƒ¼ï¼ˆWSL2 on Windowsï¼‰
- **ã‚³ãƒ³ãƒ†ãƒŠ**: Docker + docker-compose
- **ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹**: SQLiteï¼ˆæœ¬ç•ªç’°å¢ƒï¼‰
- **ç›£è¦–**: vibelogger + Telegramé€šçŸ¥
- **ãƒ—ãƒ­ã‚»ã‚¹ç®¡ç†**: Docker restart policies

### æ¨å¥¨ãƒãƒ¼ãƒ‰ã‚¦ã‚§ã‚¢ä»•æ§˜
- **CPU**: Intel i5-9400Tä»¥ä¸Šï¼ˆ6ã‚³ã‚¢æ¨å¥¨ï¼‰
- **ãƒ¡ãƒ¢ãƒª**: 8GBä»¥ä¸Šï¼ˆé‹ç”¨æ™‚2GBã€é–‹ç™ºæ™‚4GBï¼‰
- **ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸**: SSD 50GBä»¥ä¸Šã®ç©ºãå®¹é‡
- **ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯**: å®‰å®šã—ãŸã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆæ¥ç¶š

## ğŸš€ WSL2ç’°å¢ƒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—

### 1. WSL2ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãƒ»è¨­å®š

#### WSL2æœ‰åŠ¹åŒ–
```powershell
# PowerShellï¼ˆç®¡ç†è€…æ¨©é™ï¼‰ã§å®Ÿè¡Œ
dism.exe /online /enable-feature /featurename:Microsoft-Windows-Subsystem-Linux /all /norestart
dism.exe /online /enable-feature /featurename:VirtualMachinePlatform /all /norestart

# å†èµ·å‹•å¾Œ
wsl --set-default-version 2
```

#### Ubuntuã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
```powershell
# Microsoft Storeã‹ã‚‰Ubuntu 22.04 LTSã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
wsl --install -d Ubuntu-22.04

# ç¢ºèª
wsl --list --verbose
```

#### WSL2ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–
```bash
# ~/.wslconfig (Windowså´)
[wsl2]
memory=4GB
processors=4
swap=2GB
localhostForwarding=true
```

### 2. Ubuntuç’°å¢ƒæ§‹ç¯‰

#### ã‚·ã‚¹ãƒ†ãƒ æ›´æ–°
```bash
sudo apt update && sudo apt upgrade -y
sudo apt install -y build-essential curl git vim
```

#### Node.js ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
```bash
# Node.js 18.x ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
sudo apt-get install -y nodejs

# ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç¢ºèª
node --version
npm --version
```

#### Dockerã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
```bash
# Dockerå…¬å¼ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
curl -fsSL https://get.docker.com -o get-docker.sh
sudo sh get-docker.sh

# ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’dockerã‚°ãƒ«ãƒ¼ãƒ—ã«è¿½åŠ 
sudo usermod -aG docker $USER
newgrp docker

# docker-composeã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
sudo curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
sudo chmod +x /usr/local/bin/docker-compose
```

## ğŸ“¦ ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆæ‰‹é †

### Webhookå…¬é–‹ï¼ˆCloudflare Tunnelï¼‰

æœ¬ç•ªã¯ãƒ­ãƒ³ã‚°ãƒãƒ¼ãƒªãƒ³ã‚°ã§ã¯ãªã Webhook ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚å®¶åº­å›ç·šã§ã‚‚ãƒãƒ¼ãƒˆé–‹æ”¾ä¸è¦ã§å¸¸æ™‚HTTPSå…¬é–‹ã§ãã‚‹ **Cloudflare Tunnelï¼ˆç„¡æ–™ï¼‰** ã‚’æ¨å¥¨ã—ã¾ã™ã€‚

1) Cloudflareã§ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚’ç®¡ç†ï¼ˆFreeå¯ï¼‰
2) ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã§ Named Tunnel ã‚’ä½œæˆ â†’ ç™ºè¡Œã•ã‚ŒãŸ **TUNNEL_TOKEN** ã‚’æ§ãˆã‚‹
3) Public Hostname ã‚’ä½œæˆ
   - ä¾‹: `bot.example.com` â†’ Service: `http://localhost:3002`ï¼ˆcloudflaredã‚’ãƒ›ã‚¹ãƒˆã§å‹•ã‹ã™å ´åˆï¼‰
4) `.env` ã« `ADMIN_PUBLIC_URL=https://bot.example.com` ã‚’è¨­å®š
5) cloudflared ã‚’èµ·å‹•ï¼ˆã„ãšã‚Œã‹ï¼‰
   - æ‰‹è»½: `cloudflared tunnel run --token <TUNNEL_TOKEN>`
   - å¸¸æ™‚é‹ç”¨: systemd ã‚‚ã—ãã¯ docker-compose ã§ `cloudflared` ã‚µãƒ¼ãƒ“ã‚¹åŒ–
6) ã‚¢ãƒ—ãƒªã‚’ `docker compose up -d` ã§èµ·å‹• â†’ èµ·å‹•æ™‚ã« `/telegram/webhook` ã‚’Webhookç™»éŒ²

ç¢ºèª: `curl -s https://api.telegram.org/bot<token>/getWebhookInfo` ã® `url` ãŒ `https://bot.example.com/telegram/webhook`

è£œè¶³: Cloudflareã§ã‚¾ãƒ¼ãƒ³ï¼ˆãƒ‰ãƒ¡ã‚¤ãƒ³ï¼‰ã‚’ç®¡ç†ã—ã¦ã„ãªã„å ´åˆã¯ã€Public Hostname ã§å®‰å®šã—ãŸã‚«ã‚¹ã‚¿ãƒ ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚’ä½¿ãˆã¾ã›ã‚“ã€‚ä»¥ä¸‹ã®ã€ŒTailscale Funnelã€ã‚’åˆ©ç”¨ã—ã¦ãã ã•ã„ã€‚

### Webhookå…¬é–‹ï¼ˆã‚¾ãƒ¼ãƒ³æœªå§”è­²æ™‚ã®ä»£æ›¿ï¼šTailscale Funnelï¼‰

Cloudflareã§ã‚¾ãƒ¼ãƒ³ã‚’ç®¡ç†ã—ã¦ã„ãªã„ã€DNSã‚’ã™ãã«å¤‰æ›´ã§ããªã„å ´åˆã§ã‚‚ã€**Tailscale Funnelï¼ˆç„¡æ–™ï¼‰**ã§å®‰å®šHTTPSã®å…¬é–‹URLã‚’å–å¾—ã§ãã¾ã™ï¼ˆLetâ€™s Encryptè‡ªå‹•ç™ºè¡Œï¼‰ã€‚ãƒãƒ¼ãƒˆé–‹æ”¾ä¸è¦ãƒ»ãƒ«ãƒ¼ã‚¿ãƒ¼è¨­å®šä¸è¦ã§ã™ã€‚

æ‰‹é †ï¼ˆWSL2ã®Ubuntuã§å®Ÿè¡Œï¼‰:

1) Tailscaleã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
```bash
curl -fsSL https://tailscale.com/install.sh | sh
```

2) ãƒ­ã‚°ã‚¤ãƒ³ï¼ˆåˆå›ã®ã¿ï¼‰
```bash
sudo tailscale up
```

3) Webhookå…¬é–‹ï¼ˆç®¡ç†ç”»é¢ 3002 ã‚’å¤–éƒ¨å…¬é–‹ï¼‰
```bash
# 3002ç•ªã§å‹•ãAdminServerã‚’HTTPSã§å…¬é–‹
tailscale serve --https=443 http://localhost:3002

# Funnelã‚’ã‚ªãƒ³ï¼ˆã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆã¸å…¬é–‹ï¼‰
tailscale funnel 443 on
```

4) è¡¨ç¤ºã•ã‚ŒãŸURLï¼ˆä¾‹: `https://<host>.<tailnet>.ts.net`ï¼‰ã‚’ `.env.production` ã® `ADMIN_PUBLIC_URL` ã«è¨­å®š

5) ãƒ‡ãƒ—ãƒ­ã‚¤
```bash
docker compose up -d
```

6) æ¤œè¨¼
```bash
curl -s https://api.telegram.org/bot$TELEGRAM_BOT_TOKEN/getWebhookInfo | jq
# url ãŒ https://<host>.<tailnet>.ts.net/telegram/webhook ã«ãªã£ã¦ã„ã‚‹ã“ã¨
```

é‹ç”¨ãƒ¡ãƒ¢:
- Tailscale Funnelæ¡ç”¨æ™‚ã¯ã€`docker compose up -d sokubutsu-mvp` ã®ã‚ˆã†ã«ã‚¢ãƒ—ãƒªã®ã¿èµ·å‹•ã™ã‚Œã°OKï¼ˆ`cloudflared`ã‚µãƒ¼ãƒ“ã‚¹ã¯ä¸è¦ï¼‰ã€‚
- è¨¼æ˜æ›¸ã¯TailscaleãŒè‡ªå‹•ç®¡ç†ï¼ˆLetâ€™s Encryptï¼‰ã€‚Webhookã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆæœªä½¿ç”¨ã§ã‚‚é‹ç”¨å¯èƒ½ã€‚
- å®‰å®šURLã¯ `<host>.<tailnet>.ts.net` ã¨ãªã‚‹ãŸã‚ã€DNSã®ã‚¾ãƒ¼ãƒ³ç§»ç®¡ã¯ä¸è¦ã€‚

### æœ¬ç•ªã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—æœ€æ–°ç‰ˆï¼ˆãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆï¼‰

- ç’°å¢ƒå¤‰æ•°ï¼ˆ.env.productionï¼‰
  - `MULTI_USER_MODE=true`
  - `TELEGRAM_BOT_TOKEN=<æœ¬ç•ªç”¨>`
  - `TELEGRAM_CHAT_ID=<æœ¬ç•ªç”¨>`
  - `ADMIN_PUBLIC_URL=<Cloudflareã¾ãŸã¯Tailscaleã®å…¬é–‹URL>`
  - `WEBHOOK_GUARDIAN_ENABLED=true`
  - `WEBHOOK_GUARDIAN_INTERVAL=10`ï¼ˆæœ¬ç•ªã¯10åˆ†æ¨å¥¨ï¼‰
- èµ·å‹•
  - `docker compose up -d sokubutsu-mvp`
- æ¤œè¨¼
  - Webhook: `curl -s "https://api.telegram.org/bot$TELEGRAM_BOT_TOKEN/getWebhookInfo"`
  - Health: `curl -I "${ADMIN_PUBLIC_URL%/}/health"`
  - Botã‚³ãƒãƒ³ãƒ‰: Telegramã§ `/help`, `/status` ãŒå¿œç­”
- é‹ç”¨
  - è‡ªå·±ä¿®å¾©ã‚¬ãƒ¼ãƒ‰ãŒå®šæœŸæ¤œè¨¼â†’ä¸ä¸€è‡´ãªã‚‰è‡ªå‹•å†è¨­å®š
  - æ—©æœŸæ¤œè¨¼æ™‚ã®ã¿ `WEBHOOK_GUARDIAN_INTERVAL=1` ã«ã—ã¦çŸ­å‘¨æœŸã§æŒ™å‹•ç¢ºèªï¼ˆæœ¬ç•ªæˆ»ã—ã‚’å¿˜ã‚Œãšã«ï¼‰

### é‹ç”¨ç”¨ãƒ¯ãƒ³ãƒ©ã‚¤ãƒŠãƒ¼ï¼ˆå®‰å…¨ç‰ˆï¼‰

Webhookã‚’æœŸå¾…URLã«å†è¨­å®šï¼ˆã‚³ãƒ³ãƒ†ãƒŠå†…ã®ç’°å¢ƒå¤‰æ•°ã‚’ç”¨ã„ã‚‹ãŸã‚ãƒˆãƒ¼ã‚¯ãƒ³ã‚’è¡¨ç¤ºã—ã¾ã›ã‚“ï¼‰:

```bash
docker exec -i sokubutsu-mvp sh -lc '\
  EXP="${ADMIN_PUBLIC_URL%/}/telegram/webhook"; \
  BASE="https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}"; \
  curl -fsS -X POST -d "url=$EXP" "$BASE/setWebhook" | jq'
```

ç¾åœ¨ã®Webhookç¢ºèª:

```bash
curl -fsS "https://api.telegram.org/bot$TELEGRAM_BOT_TOKEN/getWebhookInfo" | jq
```

Funnel/å…¬é–‹URLåˆ°é”æ€§ç¢ºèª:

```bash
curl -I "${ADMIN_PUBLIC_URL%/}/health"
```

### 1. æœ¬ç•ªç’°å¢ƒæº–å‚™

#### ãƒªãƒã‚¸ãƒˆãƒªã‚¯ãƒ­ãƒ¼ãƒ³
```bash
# æœ¬ç•ªç”¨ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä½œæˆ
mkdir -p ~/production/sokubutsu
cd ~/production/sokubutsu

# ãƒªãƒã‚¸ãƒˆãƒªã‚¯ãƒ­ãƒ¼ãƒ³
git clone https://github.com/denof-inc/sokubutsu2.git .
git checkout main
```

## ğŸ” æ’ä¹…å¯¾ç­–ï¼ˆç„¡å¿œç­”ãƒ»æ‰‹å‹•ä½œæ¥­ã®æœ€å°åŒ–ï¼‰

- Webhookè‡ªå·±ä¿®å¾©ã‚¬ãƒ¼ãƒ‰: æ—¢å®šã§æœ‰åŠ¹ï¼ˆ`.env.production` ã§ `WEBHOOK_GUARDIAN_ENABLED=true`ï¼‰ã€‚URLä¸ä¸€è‡´ã¯è‡ªå‹•å¾©æ—§ã€‚
- Webhookå…¥å‡ºåŠ›ãƒ­ã‚°: `admin.webhook.request/response` ã‚’å¸¸æ™‚è¨˜éŒ²ã€‚å±Šã„ã¦ã„ãªã„/è¿”ã›ã¦ã„ãªã„ã‚’å³åˆ¤åˆ¥ã€‚
- é€ä¿¡å¤±æ•—ãƒªãƒˆãƒ©ã‚¤: `sendMessage` ã¯æŒ‡æ•°ãƒãƒƒã‚¯ã‚ªãƒ•ã§3å›ãƒªãƒˆãƒ©ã‚¤ã€æœ€çµ‚å¤±æ•—ã‚‚è½ã¡ãšã«ç›£è¦–ç¶™ç¶šã€‚
- è‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤ã‚¹ã‚¯ãƒªãƒ—ãƒˆï¼ˆTailscaleå«ã‚€ï¼‰:
  - `scripts/ops/deploy-all.sh` â€¦ ãƒ“ãƒ«ãƒ‰â†’èµ·å‹•â†’Funnelæœ‰åŠ¹åŒ–â†’Webhookè¨­å®šâ†’æ¤œè¨¼ã‚’ä¸€æ‹¬å®Ÿè¡Œ
  - `scripts/ops/ensure-funnel.sh` â€¦ Tailscale Serve/Funnel ã‚’ 3002 ã«å¯¾ã—ã¦æœ‰åŠ¹åŒ–ã—ã€å…¬é–‹URLã‚’ `.env*` ã«åŒæœŸ
  - `scripts/ops/ensure-webhook.sh` â€¦ ã‚³ãƒ³ãƒ†ãƒŠå†…éƒ¨ã®ç’°å¢ƒå¤‰æ•°ã§ Telegram Webhook ã‚’è¨­å®šã— `getWebhookInfo` ã‚’å‡ºåŠ›
  - `scripts/ops/verify.sh` â€¦ Health / WebhookInfo / Webhookå…¥å‡ºåŠ›ãƒ­ã‚°ã‚’ã¾ã¨ã‚ã¦ç¢ºèª

æ¨å¥¨é‹ç”¨:
- æ›´æ–°æ™‚: `bash scripts/ops/deploy-all.sh`
- ä¸èª¿æ™‚ã®å³æ™‚ç¢ºèª: `bash scripts/ops/verify.sh`

ï¼ˆä»»æ„ï¼‰èµ·å‹•æ™‚ã®è‡ªå‹•åŒ–:
- macOS/Linuxã§ã¯ systemd/launchd ã§ `ensure-funnel.sh` ã‚’èµ·å‹•æ™‚ã«å®Ÿè¡Œã™ã‚‹ã¨ã€å†èµ·å‹•å¾Œã‚‚è‡ªå‹•ã§å…¬é–‹URLã‚’å¾©æ—§ã§ãã¾ã™ã€‚
- ä¾‹: systemd unitï¼ˆ/etc/systemd/system/tailscale-funnel.serviceï¼‰
  - `ExecStart=/usr/local/bin/bash /path/to/repo/scripts/ops/ensure-funnel.sh`

### ãƒªãƒ³ã‚¯/æ”¹è¡Œã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ•´å½¢ãƒãƒªã‚·ãƒ¼ï¼ˆé‹ç”¨ä»•æ§˜ï¼‰
- `parse_mode: 'HTML'`
- æ”¹è¡Œã¯ `\n` ã§çµåˆï¼ˆ`\\n` ã®ä½¿ç”¨ç¦æ­¢ï¼‰
- ç›£è¦–åã¯ã€Œç›£è¦–URLã€ã¸ãƒªãƒ³ã‚¯ï¼ˆ`<a href="URL">ç›£è¦–å</a>`ï¼‰

#### ç’°å¢ƒè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆ
```bash
# æœ¬ç•ªç”¨.envä½œæˆ
cp .env.example .env.production

# å¿…è¦ãªç’°å¢ƒå¤‰æ•°è¨­å®š
nano .env.production
```

```bash
# .env.productionå†…å®¹ä¾‹
NODE_ENV=production
TELEGRAM_BOT_TOKEN=your_production_bot_token
TELEGRAM_CHAT_ID=your_production_chat_id
DATABASE_PATH=./data/production.db
LOG_LEVEL=info
MONITORING_INTERVAL=5
```

### 2. Dockeræœ¬ç•ªãƒ‡ãƒ—ãƒ­ã‚¤

#### æœ¬ç•ªç”¨docker-composeè¨­å®š
```yaml
# docker-compose.prod.yml
version: '3.8'
services:
  sokubutsu:
    build:
      context: .
      dockerfile: Dockerfile.prod
    container_name: sokubutsu-mvp
    restart: always
    env_file:
      - .env.production
    volumes:
      - ./data:/app/data
      - ./logs:/app/logs
    ports:
      - "3000:3000"
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '0.5'
        reservations:
          memory: 256M
          cpus: '0.25'
    healthcheck:
      test: ["CMD", "node", "healthcheck.js"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
```

#### æœ¬ç•ªç”¨Dockerfile
```dockerfile
# Dockerfile.prod
FROM node:18-alpine AS builder

WORKDIR /app
COPY package*.json ./
RUN npm ci --only=production

FROM node:18-alpine

RUN apk add --no-cache chromium
ENV PUPPETEER_SKIP_CHROMIUM_DOWNLOAD=true
ENV PUPPETEER_EXECUTABLE_PATH=/usr/bin/chromium-browser

WORKDIR /app
COPY --from=builder /app/node_modules ./node_modules
COPY . .

RUN npm run build

USER node
EXPOSE 3000

HEALTHCHECK --interval=30s --timeout=10s --retries=3 --start-period=40s \
  CMD node healthcheck.js

CMD ["npm", "run", "start:prod"]
```

#### ãƒ‡ãƒ—ãƒ­ã‚¤å®Ÿè¡Œ
```bash
# æœ¬ç•ªãƒ“ãƒ«ãƒ‰ãƒ»èµ·å‹•
docker-compose -f docker-compose.prod.yml up -d --build

# èµ·å‹•ç¢ºèª
docker-compose -f docker-compose.prod.yml logs -f sokubutsu

# ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ç¢ºèª
docker-compose -f docker-compose.prod.yml ps
```

### 3. SSLè¨¼æ˜æ›¸è¨­å®šï¼ˆHTTPSå¯¾å¿œï¼‰

#### Let's Encrypt + nginx-proxyè¨­å®š
```yaml
# docker-compose.ssl.yml
version: '3.8'
services:
  nginx-proxy:
    image: jwilder/nginx-proxy
    container_name: nginx-proxy
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - /var/run/docker.sock:/tmp/docker.sock:ro
      - ./nginx/certs:/etc/nginx/certs
    restart: always

  letsencrypt:
    image: jrcs/letsencrypt-nginx-proxy-companion
    container_name: letsencrypt
    volumes_from:
      - nginx-proxy
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    restart: always

  sokubutsu:
    extends:
      file: docker-compose.prod.yml
      service: sokubutsu
    environment:
      - VIRTUAL_HOST=your-domain.com
      - LETSENCRYPT_HOST=your-domain.com
      - LETSENCRYPT_EMAIL=your-email@example.com
```

## ğŸ“Š ç›£è¦–ãƒ»ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹

### 1. ãƒ­ã‚°ç›£è¦–

#### ãƒ­ã‚°è¨­å®š
```typescript
// src/logger.ts
import { createLogger } from 'vibelogger';

export const logger = createLogger({
  level: process.env.LOG_LEVEL || 'info',
  output: {
    console: true,
    file: {
      path: './logs/sokubutsu.log',
      rotation: 'daily',
      maxFiles: 30
    }
  },
  structured: true
});
```

#### ãƒ­ã‚°ç¢ºèªã‚³ãƒãƒ³ãƒ‰
```bash
# ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ­ã‚°ç›£è¦–
docker-compose -f docker-compose.prod.yml logs -f sokubutsu

# ç‰¹å®šæœŸé–“ã®ãƒ­ã‚°ç¢ºèª
docker-compose -f docker-compose.prod.yml logs --since "2025-01-01" sokubutsu

# ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ç›´æ¥ç¢ºèª
tail -f logs/sokubutsu.log

# ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã®ã¿ãƒ•ã‚£ãƒ«ã‚¿
docker-compose logs sokubutsu 2>&1 | grep -i error
```

### 2. ã‚·ã‚¹ãƒ†ãƒ ç›£è¦–

#### ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯å®Ÿè£…
```typescript
// healthcheck.js
const http = require('http');

const options = {
  host: 'localhost',
  port: 3000,
  path: '/health',
  timeout: 2000
};

const request = http.request(options, (res) => {
  if (res.statusCode === 200) {
    process.exit(0);
  } else {
    process.exit(1);
  }
});

request.on('error', () => process.exit(1));
request.end();
```

#### ãƒªã‚½ãƒ¼ã‚¹ä½¿ç”¨é‡ç›£è¦–
```bash
# Dockerã‚³ãƒ³ãƒ†ãƒŠã®çµ±è¨ˆæƒ…å ±
docker stats sokubutsu-mvp

# ã‚·ã‚¹ãƒ†ãƒ ãƒªã‚½ãƒ¼ã‚¹ç¢ºèª
htop
free -h
df -h

# ãƒ—ãƒ­ã‚»ã‚¹ç›£è¦–
ps aux | grep node
```

#### ç›£è¦–ã‚¹ã‚¯ãƒªãƒ—ãƒˆï¼ˆcronè¨­å®šï¼‰
```bash
# monitoring.sh
#!/bin/bash
CONTAINER_NAME="sokubutsu-mvp"
LOG_FILE="/home/user/logs/monitoring.log"

# ã‚³ãƒ³ãƒ†ãƒŠç¨¼åƒç¢ºèª
if ! docker ps | grep -q $CONTAINER_NAME; then
    echo "$(date): Container $CONTAINER_NAME is down. Restarting..." >> $LOG_FILE
    docker-compose -f /home/user/production/sokubutsu/docker-compose.prod.yml up -d
fi

# ãƒ‡ã‚£ã‚¹ã‚¯ä½¿ç”¨é‡ç¢ºèªï¼ˆ80%ä»¥ä¸Šã§è­¦å‘Šï¼‰
DISK_USAGE=$(df / | awk 'NR==2 {print $(NF-1)}' | sed 's/%//')
if [ $DISK_USAGE -gt 80 ]; then
    echo "$(date): Disk usage is ${DISK_USAGE}%" >> $LOG_FILE
fi
```

```bash
# cronã‚¸ãƒ§ãƒ–è¨­å®š
crontab -e

# 5åˆ†ã”ã¨ã«ç›£è¦–ã‚¹ã‚¯ãƒªãƒ—ãƒˆå®Ÿè¡Œ
*/5 * * * * /home/user/scripts/monitoring.sh

# æ¯æ—¥åˆå‰2æ™‚ã«ãƒ­ã‚°ãƒ­ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³
0 2 * * * find /home/user/logs -name "*.log" -mtime +30 -delete
```

### 3. ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ»å¾©æ—§

#### ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
```bash
# backup.sh
#!/bin/bash
BACKUP_DIR="/home/user/backups"
DATE=$(date +%Y%m%d_%H%M%S)

# ãƒ‡ãƒ¼ã‚¿ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
tar -czf $BACKUP_DIR/sokubutsu_data_$DATE.tar.gz -C /home/user/production/sokubutsu data/

# å¤ã„ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—å‰Šé™¤ï¼ˆ30æ—¥ä»¥ä¸Šï¼‰
find $BACKUP_DIR -name "sokubutsu_data_*.tar.gz" -mtime +30 -delete

echo "Backup completed: sokubutsu_data_$DATE.tar.gz"
```

#### å¾©æ—§æ‰‹é †
```bash
# ã‚µãƒ¼ãƒ“ã‚¹åœæ­¢
docker-compose -f docker-compose.prod.yml down

# ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‹ã‚‰å¾©å…ƒ
cd ~/production/sokubutsu
tar -xzf ~/backups/sokubutsu_data_YYYYMMDD_HHMMSS.tar.gz

# ã‚µãƒ¼ãƒ“ã‚¹å†é–‹
docker-compose -f docker-compose.prod.yml up -d

# å¾©æ—§ç¢ºèª
docker-compose -f docker-compose.prod.yml logs sokubutsu
```

## ğŸ”§ ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### 1. ã‚ˆãã‚ã‚‹å•é¡Œã¨è§£æ±ºç­–

#### ã‚³ãƒ³ãƒ†ãƒŠèµ·å‹•ã—ãªã„
```bash
# ãƒ­ã‚°ç¢ºèª
docker-compose -f docker-compose.prod.yml logs sokubutsu

# ã‚¤ãƒ¡ãƒ¼ã‚¸å†ãƒ“ãƒ«ãƒ‰
docker-compose -f docker-compose.prod.yml down
docker-compose -f docker-compose.prod.yml build --no-cache
docker-compose -f docker-compose.prod.yml up -d
```

#### ãƒ¡ãƒ¢ãƒªä¸è¶³ã‚¨ãƒ©ãƒ¼
```bash
# ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡ç¢ºèª
free -h
docker stats

# Swapé ˜åŸŸè¿½åŠ 
sudo fallocate -l 2G /swapfile
sudo chmod 600 /swapfile
sudo mkswap /swapfile
sudo swapon /swapfile

# æ°¸ç¶šåŒ–
echo '/swapfile none swap sw 0 0' | sudo tee -a /etc/fstab
```

#### Puppeteerã‚¨ãƒ©ãƒ¼ï¼ˆWSL2ç’°å¢ƒï¼‰
```bash
# Chromeä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
sudo apt-get update
sudo apt-get install -y chromium-browser

# ç’°å¢ƒå¤‰æ•°è¨­å®š
export PUPPETEER_SKIP_CHROMIUM_DOWNLOAD=true
export PUPPETEER_EXECUTABLE_PATH=/usr/bin/chromium-browser
```

#### ãƒ‡ã‚£ã‚¹ã‚¯å®¹é‡ä¸è¶³
```bash
# ä¸è¦ãªDockerãƒªã‚½ãƒ¼ã‚¹å‰Šé™¤
docker system prune -a

# å¤ã„ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«å‰Šé™¤
find logs/ -name "*.log" -mtime +7 -delete

# ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚µã‚¤ã‚ºç¢ºèª
ls -lah data/
```

### 2. ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–

#### Dockerè¨­å®šæœ€é©åŒ–
```yaml
# docker-compose.prod.yml
services:
  sokubutsu:
    # ãƒªã‚½ãƒ¼ã‚¹åˆ¶é™
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '0.5'
    
    # ãƒ­ã‚°ãƒ‰ãƒ©ã‚¤ãƒãƒ¼è¨­å®š
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
```

#### WSL2ãƒ¡ãƒ¢ãƒªåˆ¶é™
```ini
# ~/.wslconfig
[wsl2]
memory=4GB
processors=4
swap=2GB
localhostForwarding=true
kernelCommandLine=cgroup_no_v1=memory systemd.unified_cgroup_hierarchy=1
```

## ğŸ”„ ç¶™ç¶šçš„ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆ

### 1. GitHub Actions CI/CDè¨­å®š

```yaml
# .github/workflows/deploy.yml
name: Deploy to Production

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: self-hosted
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Deploy to production
      run: |
        docker-compose -f docker-compose.prod.yml down
        docker-compose -f docker-compose.prod.yml build --no-cache
        docker-compose -f docker-compose.prod.yml up -d
        
    - name: Health check
      run: |
        sleep 30
        curl -f http://localhost:3000/health || exit 1
        
    - name: Notify deployment
      run: |
        # Telegramé€šçŸ¥ç­‰
```

### 2. ãƒ­ãƒ¼ãƒªãƒ³ã‚°ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆ
```bash
# zero-downtime-deploy.sh
#!/bin/bash
set -e

echo "Starting zero-downtime deployment..."

# æ–°ã—ã„ã‚³ãƒ³ãƒ†ãƒŠèµ·å‹•
docker-compose -f docker-compose.prod.yml up -d --scale sokubutsu=2 --no-recreate

# ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯å¾…æ©Ÿ
sleep 30

# å¤ã„ã‚³ãƒ³ãƒ†ãƒŠåœæ­¢
docker-compose -f docker-compose.prod.yml up -d --scale sokubutsu=1 --no-recreate

echo "Deployment completed successfully"
```

## ğŸ“š é‹ç”¨ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

### æ—¥æ¬¡ãƒã‚§ãƒƒã‚¯é …ç›®
- [ ] ã‚µãƒ¼ãƒ“ã‚¹ç¨¼åƒçŠ¶æ³ç¢ºèª
- [ ] ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ç¢ºèª
- [ ] ãƒ‡ã‚£ã‚¹ã‚¯ä½¿ç”¨é‡ç¢ºèª
- [ ] ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡ç¢ºèª

### é€±æ¬¡ãƒã‚§ãƒƒã‚¯é …ç›®
- [ ] ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ç¢ºèª
- [ ] ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ãƒ­ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³
- [ ] ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆç¢ºèª
- [ ] ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æŒ‡æ¨™ãƒ¬ãƒ“ãƒ¥ãƒ¼

### æœˆæ¬¡ãƒã‚§ãƒƒã‚¯é …ç›®
- [ ] å¤ã„ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ•ã‚¡ã‚¤ãƒ«å‰Šé™¤
- [ ] ã‚·ã‚¹ãƒ†ãƒ å…¨ä½“ã®å¥å…¨æ€§ç¢ºèª
- [ ] å®¹é‡è¨ˆç”»è¦‹ç›´ã—
- [ ] ç½å®³å¾©æ—§æ‰‹é †ãƒ†ã‚¹ãƒˆ

## ğŸ“ ç·Šæ€¥æ™‚å¯¾å¿œæ‰‹é †

### ã‚µãƒ¼ãƒ“ã‚¹å®Œå…¨åœæ­¢æ™‚
```bash
# 1. çŠ¶æ³ç¢ºèª
docker-compose -f docker-compose.prod.yml ps
docker-compose -f docker-compose.prod.yml logs --tail=100 sokubutsu

# 2. å¼·åˆ¶å†èµ·å‹•
docker-compose -f docker-compose.prod.yml down
docker-compose -f docker-compose.prod.yml up -d --force-recreate

# 3. ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯
curl -f http://localhost:3000/health
```

### ãƒ‡ãƒ¼ã‚¿ç ´ææ™‚
```bash
# 1. ã‚µãƒ¼ãƒ“ã‚¹åœæ­¢
docker-compose -f docker-compose.prod.yml down

# 2. æœ€æ–°ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‹ã‚‰å¾©æ—§
tar -xzf ~/backups/sokubutsu_data_latest.tar.gz

# 3. ã‚µãƒ¼ãƒ“ã‚¹å†é–‹
  docker-compose -f docker-compose.prod.yml up -d
```

---

## ğŸ”§ ãƒ–ãƒ©ãƒ³ãƒå¤‰æ›´ãŒå®Ÿæ©Ÿã«åæ˜ ã•ã‚Œãªã„ã¨ã

- åŸå› ã«ãªã‚Šã‚„ã™ã„ãƒã‚¤ãƒ³ãƒˆ:
  - æœ¬ç•ªæ©Ÿã§ `main` ä»¥å¤–ã®ãƒ–ãƒ©ãƒ³ãƒã‚’è¿½ã£ã¦ã„ãªã„ï¼ˆCIã¯ `main` ã®ã¿ãƒ‡ãƒ—ãƒ­ã‚¤ï¼‰
  - Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’å†ãƒ“ãƒ«ãƒ‰ã—ã¦ã„ãªã„ï¼ˆ`build: .` ã ãŒã‚­ãƒ£ãƒƒã‚·ãƒ¥ã§å¤ã„ `dist` ã‚’ä½¿ç”¨ï¼‰
  - Telegramã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã®ã‚³ãƒãƒ³ãƒ‰ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãŒã‚­ãƒ£ãƒƒã‚·ãƒ¥ã•ã‚Œã¦ã„ã‚‹ï¼ˆã‚µãƒ¼ãƒå´ã®æŒ™å‹•ã¯æ›´æ–°æ¸ˆã¿ã§ã‚‚ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«å³æ™‚åæ˜ ã•ã‚Œãªã„ï¼‰

- åæ˜ æ‰‹é †ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«/å®Ÿæ©Ÿã§ã‚«ãƒ¬ãƒ³ãƒˆãƒ–ãƒ©ãƒ³ãƒã‚’å³åæ˜ ï¼‰
  1) å¯¾è±¡ãƒ–ãƒ©ãƒ³ãƒã«ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ: `git checkout <branch>` â†’ `git pull`
  2) å†ãƒ“ãƒ«ãƒ‰ï¼†å†èµ·å‹•: `bash scripts/deploy-local.sh`
     - `--no-cache --pull` ã§ç¢ºå®Ÿã«å†ãƒ“ãƒ«ãƒ‰ã—ã¾ã™
  3) å‹•ä½œç¢ºèª
     - Webhook: `curl -s "https://api.telegram.org/bot$TELEGRAM_BOT_TOKEN/getWebhookInfo"`
     - å¥åº·: `curl -I "${ADMIN_PUBLIC_URL%/}/health"`
     - Bot: `/help`, `/status`, `/check` ã®å¿œç­”

- CIã§ã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚¤ãƒ¡ãƒ¼ã‚¸ï¼ˆãƒ–ãƒ©ãƒ³ãƒã”ã¨ï¼‰
  - GitHub ActionsãŒ `ghcr.io/<repo>:branch-<ãƒ–ãƒ©ãƒ³ãƒå>` ã‚’è‡ªå‹•ãƒ“ãƒ«ãƒ‰ãƒ»ãƒ—ãƒƒã‚·ãƒ¥
  - å®Ÿæ©Ÿã§ãƒ†ã‚¹ãƒˆã™ã‚‹å ´åˆã¯ compose ã‚’ `image: ghcr.io/...:branch-<ãƒ–ãƒ©ãƒ³ãƒå>` ã«åˆ‡æ›¿ â†’ `docker compose pull && up -d`

ãƒ¡ãƒ¢: Telegramã®ã‚³ãƒãƒ³ãƒ‰ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã¯ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒæ®‹ã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãŒå³æ›´æ–°ã•ã‚Œãªã„å ´åˆã§ã‚‚ã€ç›´æ¥ `/help` ç­‰ã®ã‚³ãƒãƒ³ãƒ‰ã¯æœ€æ–°ãƒ­ã‚¸ãƒƒã‚¯ã§å‹•ä½œã—ã¾ã™ã€‚

**æ›´æ–°æ—¥**: 2025å¹´8æœˆ26æ—¥  
**ãƒãƒ¼ã‚¸ãƒ§ãƒ³**: 2.0ï¼ˆWSL2 + Dockeræœ¬ç•ªé‹ç”¨å¯¾å¿œï¼‰
