# ã‚·ã‚¹ãƒ†ãƒ è¨­è¨ˆæ›¸ - è»½é‡ã‚½ã‚¯ãƒ–ãƒ„

## æ¦‚è¦

è»½é‡ã‚½ã‚¯ãƒ–ãƒ„ã¯ã€è‡ªå®…ã‚µãƒ¼ãƒãƒ¼ç’°å¢ƒã§ã®ç‰©ä»¶æ–°ç€ã€Œæœ‰ç„¡ã€ç›£è¦–ã«ç‰¹åŒ–ã—ãŸé©æ–°çš„ãªã‚·ã‚¹ãƒ†ãƒ ã§ã™ã€‚HTTP-first + æ®µéšçš„ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯æˆ¦ç•¥ã«ã‚ˆã‚Šã€å¾“æ¥æ¯”90%ã®ãƒ¡ãƒ¢ãƒªå‰Šæ¸›ã¨95%ã®å‡¦ç†æ™‚é–“çŸ­ç¸®ã‚’å®Ÿç¾ã—ã¾ã™ã€‚

## ã‚·ã‚¹ãƒ†ãƒ å…¨ä½“ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

### é«˜ãƒ¬ãƒ™ãƒ«ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    è»½é‡ã‚½ã‚¯ãƒ–ãƒ„ãƒ»ã‚·ã‚¹ãƒ†ãƒ                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ğŸ  è‡ªå®…ã‚µãƒ¼ãƒãƒ¼ç’°å¢ƒ (Intel i5-9400T, 7.7GB RAM, WSL2)      â”‚
â”‚                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚   Telegram Bot  â”‚  â”‚  Express.js API â”‚  â”‚  Scheduler  â”‚  â”‚
â”‚  â”‚   (é€šçŸ¥ãƒ»åˆ¶å¾¡)   â”‚  â”‚   (REST API)    â”‚  â”‚  (å®šæœŸå®Ÿè¡Œ)  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚           â”‚                     â”‚                     â”‚     â”‚
â”‚           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                                 â”‚                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚              è»½é‡ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°ã‚¨ãƒ³ã‚¸ãƒ³                  â”‚  â”‚
â”‚  â”‚                                                         â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚ HTTP-only   â”‚  â”‚   jsdom     â”‚  â”‚   Playwright    â”‚  â”‚  â”‚
â”‚  â”‚  â”‚ (70%æˆåŠŸ)   â”‚â†’ â”‚ (20%æˆåŠŸ)   â”‚â†’ â”‚  (10%æˆåŠŸ)      â”‚  â”‚  â”‚
â”‚  â”‚  â”‚ 20-40MB     â”‚  â”‚ 50-80MB     â”‚  â”‚  200-300MB      â”‚  â”‚  â”‚
â”‚  â”‚  â”‚ 1-3ç§’       â”‚  â”‚ 3-8ç§’       â”‚  â”‚  10-20ç§’        â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                 â”‚                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                Botå¯¾ç­–ã‚·ã‚¹ãƒ†ãƒ                           â”‚  â”‚
â”‚  â”‚                                                         â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚ Botæ¤œçŸ¥å›é¿ â”‚â†’ â”‚ Googleæ¤œç´¢  â”‚â†’ â”‚ ç›®çš„ã‚µã‚¤ãƒˆ      â”‚  â”‚  â”‚
â”‚  â”‚  â”‚ (è»½é‡ç‰ˆ)    â”‚  â”‚ (å®Ÿéš›å®Ÿè¡Œ)  â”‚  â”‚ (ã‚»ãƒƒã‚·ãƒ§ãƒ³ç¶™æ‰¿) â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                 â”‚                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                ãƒ‡ãƒ¼ã‚¿ç®¡ç†å±¤                             â”‚  â”‚
â”‚  â”‚                                                         â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚ SQLite3     â”‚  â”‚ File Cache  â”‚  â”‚ Session Store   â”‚  â”‚  â”‚
â”‚  â”‚  â”‚ (better)    â”‚  â”‚ (JSON)      â”‚  â”‚ (Memory)        â”‚  â”‚  â”‚
â”‚  â”‚  â”‚ 10-20MB     â”‚  â”‚ 5-10MB      â”‚  â”‚ 5-15MB          â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼å›³

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Telegram    â”‚    â”‚ Express.js  â”‚    â”‚ Scheduler   â”‚
â”‚ User Input  â”‚â”€â”€â”€â–¶â”‚ API Server  â”‚â—€â”€â”€â”€â”‚ Cron Jobs   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              è»½é‡ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°ã‚¨ãƒ³ã‚¸ãƒ³                  â”‚
â”‚                                                         â”‚
â”‚  URL â†’ Botå¯¾ç­– â†’ HTTP-only â†’ jsdom â†’ Playwright        â”‚
â”‚   â”‚      â”‚         â”‚          â”‚         â”‚              â”‚
â”‚   â”‚      â”‚         â”œâ”€ æˆåŠŸ â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€ çµæœ        â”‚
â”‚   â”‚      â”‚         â”‚          â”œâ”€ æˆåŠŸ â”€â”€â”¼â”€ çµæœ        â”‚
â”‚   â”‚      â”‚         â”‚          â”‚         â””â”€ æˆåŠŸ â†’ çµæœ â”‚
â”‚   â”‚      â”‚         â””â”€ å¤±æ•— â”€â”€â”€â”˜                        â”‚
â”‚   â”‚      â””â”€ ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†ãƒ»User-Agentãƒ­ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³     â”‚
â”‚   â””â”€ URLæ¤œè¨¼ãƒ»ãƒ‰ãƒ¡ã‚¤ãƒ³åˆ¶é™                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ãƒ‡ãƒ¼ã‚¿å‡¦ç†                           â”‚
â”‚                                                         â”‚
â”‚  æ–°ç€æ¤œå‡º â†’ ãƒ­ã‚°è¨˜éŒ² â†’ é€šçŸ¥åˆ¤å®š â†’ Telegramé€ä¿¡          â”‚
â”‚     â”‚          â”‚          â”‚           â”‚                â”‚
â”‚     â”‚          â”‚          â””â”€ æ–°ç€æœ‰ â”€â”€â”˜                â”‚
â”‚     â”‚          â””â”€ SQLite3ä¿å­˜                          â”‚
â”‚     â””â”€ æ–°ç€ãƒãƒ¼ã‚«ãƒ¼æ¤œå‡ºãƒ­ã‚¸ãƒƒã‚¯                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯è©³ç´°

### é¸å®šç†ç”±ã¨ãƒ¡ãƒªãƒƒãƒˆãƒ»ãƒ‡ãƒ¡ãƒªãƒƒãƒˆ

#### Express.js (è»½é‡ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯)

**é¸å®šç†ç”±**:
- NestJSã‹ã‚‰ã®è»½é‡åŒ–ï¼ˆãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡60%å‰Šæ¸›ï¼‰
- è‡ªå®…ã‚µãƒ¼ãƒãƒ¼ç’°å¢ƒã§ã®é«˜é€Ÿèµ·å‹•
- ã‚·ãƒ³ãƒ—ãƒ«ãªè¦ä»¶ã«æœ€é©

**ãƒ¡ãƒªãƒƒãƒˆ**:
- ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡: 15-25MBï¼ˆNestJS: 40-60MBï¼‰
- èµ·å‹•æ™‚é–“: 1-2ç§’ï¼ˆNestJS: 5-8ç§’ï¼‰
- å­¦ç¿’ã‚³ã‚¹ãƒˆãŒä½ã„
- è±Šå¯ŒãªãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢

**ãƒ‡ãƒ¡ãƒªãƒƒãƒˆ**:
- å‹å®‰å…¨æ€§ãŒNestJSã‚ˆã‚ŠåŠ£ã‚‹
- å¤§è¦æ¨¡é–‹ç™ºæ™‚ã®æ§‹é€ åŒ–ãŒå›°é›£
- ä¾å­˜æ€§æ³¨å…¥ãŒæ‰‹å‹•

#### better-sqlite3 (è»½é‡ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹)

**é¸å®šç†ç”±**:
- PostgreSQLã‹ã‚‰ã®å¤§å¹…è»½é‡åŒ–
- ãƒ•ã‚¡ã‚¤ãƒ«ãƒ™ãƒ¼ã‚¹ã®ç°¡å˜ç®¡ç†
- è‡ªå®…ã‚µãƒ¼ãƒãƒ¼ç’°å¢ƒã«æœ€é©

**ãƒ¡ãƒªãƒƒãƒˆ**:
- ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡: 10-20MBï¼ˆPostgreSQL: 50-100MBï¼‰
- è¨­å®šä¸è¦ï¼ˆãƒ•ã‚¡ã‚¤ãƒ«ãƒ™ãƒ¼ã‚¹ï¼‰
- é«˜é€Ÿãªèª­ã¿æ›¸ã
- ACIDæº–æ‹ 

**ãƒ‡ãƒ¡ãƒªãƒƒãƒˆ**:
- åŒæ™‚æ¥ç¶šæ•°åˆ¶é™ï¼ˆ50-100ï¼‰
- åˆ†æ•£å‡¦ç†ä¸å¯
- é«˜åº¦ãªã‚¯ã‚¨ãƒªæ©Ÿèƒ½åˆ¶é™

#### axios + cheerio (HTTP-first)

**é¸å®šç†ç”±**:
- Playwrightã‹ã‚‰ã®å¤§å¹…è»½é‡åŒ–
- 70%ã®ã‚µã‚¤ãƒˆã§ååˆ†ãªæˆåŠŸç‡
- æ–°ç€ã€Œæœ‰ç„¡ã€ã®ã¿ã®è¦ä»¶ã«æœ€é©

**ãƒ¡ãƒªãƒƒãƒˆ**:
- ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡: 20-40MBï¼ˆPlaywright: 200-300MBï¼‰
- å‡¦ç†æ™‚é–“: 1-3ç§’ï¼ˆPlaywright: 10-20ç§’ï¼‰
- Botæ¤œçŸ¥ã•ã‚Œã«ãã„
- å®‰å®šæ€§ãŒé«˜ã„

**ãƒ‡ãƒ¡ãƒªãƒƒãƒˆ**:
- JavaScripté‡è¦ã‚µã‚¤ãƒˆå¯¾å¿œä¸å¯
- å‹•çš„ã‚³ãƒ³ãƒ†ãƒ³ãƒ„åˆ¶é™
- è¤‡é›‘ãªSPAå¯¾å¿œå›°é›£

#### jsdom (è»½é‡JavaScriptå®Ÿè¡Œ)

**é¸å®šç†ç”±**:
- Playwrightã®ä¸­é–“é¸æŠè‚¢
- å‹•çš„ã‚³ãƒ³ãƒ†ãƒ³ãƒ„å¯¾å¿œ
- é©åº¦ãªè»½é‡æ€§

**ãƒ¡ãƒªãƒƒãƒˆ**:
- ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡: 50-80MB
- åŸºæœ¬çš„ãªJavaScriptå®Ÿè¡Œå¯èƒ½
- Playwrightã‚ˆã‚Šé«˜é€Ÿ
- Node.jsç’°å¢ƒã§å®Œçµ

**ãƒ‡ãƒ¡ãƒªãƒƒãƒˆ**:
- è¤‡é›‘ãªJavaScriptåˆ¶é™
- ãƒ–ãƒ©ã‚¦ã‚¶å›ºæœ‰æ©Ÿèƒ½æœªå¯¾å¿œ
- ãƒ‡ãƒãƒƒã‚°ãŒå›°é›£

### ä»£æ›¿æŠ€è¡“ã¨ã®æ¯”è¼ƒ

| æŠ€è¡“é ˜åŸŸ | ç¾åœ¨é¸æŠ | ä»£æ›¿æ¡ˆ1 | ä»£æ›¿æ¡ˆ2 | é¸å®šç†ç”± |
|----------|----------|---------|---------|----------|
| ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ | Express.js | NestJS | Fastify | è»½é‡æ€§é‡è¦– |
| ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ | better-sqlite3 | PostgreSQL | MongoDB | ãƒ•ã‚¡ã‚¤ãƒ«ãƒ™ãƒ¼ã‚¹ç°¡å˜ç®¡ç† |
| ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚° | HTTP-first | Playwright | Puppeteer | æ®µéšçš„ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ |
| é€šçŸ¥ | Telegram Bot | Discord | Slack | å€‹äººåˆ©ç”¨æœ€é© |
| ãƒ—ãƒ­ã‚»ã‚¹ç®¡ç† | PM2 | systemd | Docker | è»½é‡ãƒ—ãƒ­ã‚»ã‚¹ç®¡ç† |

## ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«è¨­è¨ˆ

### 4ã¤ã®ã‚³ã‚¢ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«

#### 1. API Server Module

**è²¬å‹™**:
- REST APIæä¾›
- ãƒªã‚¯ã‚¨ã‚¹ãƒˆå‡¦ç†
- ãƒ¬ã‚¹ãƒãƒ³ã‚¹ç”Ÿæˆ
- ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°

**æ§‹æˆ**:
```
src/api/
â”œâ”€â”€ controllers/
â”‚   â”œâ”€â”€ health.controller.js
â”‚   â”œâ”€â”€ url.controller.js
â”‚   â””â”€â”€ monitoring.controller.js
â”œâ”€â”€ middleware/
â”‚   â”œâ”€â”€ auth.middleware.js
â”‚   â”œâ”€â”€ validation.middleware.js
â”‚   â””â”€â”€ rate-limit.middleware.js
â”œâ”€â”€ routes/
â”‚   â”œâ”€â”€ health.routes.js
â”‚   â”œâ”€â”€ url.routes.js
â”‚   â””â”€â”€ monitoring.routes.js
â””â”€â”€ app.js
```

**ä¾å­˜é–¢ä¿‚**:
- Database Module (ãƒ‡ãƒ¼ã‚¿ã‚¢ã‚¯ã‚»ã‚¹)
- Scraping Module (ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°å®Ÿè¡Œ)
- Notification Module (é€šçŸ¥é€ä¿¡)

#### 2. Scraping Engine Module

**è²¬å‹™**:
- æ®µéšçš„ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°å®Ÿè¡Œ
- Botå¯¾ç­–é©ç”¨
- æ–°ç€æ¤œå‡ºãƒ­ã‚¸ãƒƒã‚¯
- ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–

**æ§‹æˆ**:
```
src/scraping/
â”œâ”€â”€ engines/
â”‚   â”œâ”€â”€ http-only.engine.js
â”‚   â”œâ”€â”€ jsdom.engine.js
â”‚   â””â”€â”€ playwright.engine.js
â”œâ”€â”€ bot-protection/
â”‚   â”œâ”€â”€ session.manager.js
â”‚   â”œâ”€â”€ user-agent.rotator.js
â”‚   â””â”€â”€ google-bypass.js
â”œâ”€â”€ detectors/
â”‚   â”œâ”€â”€ new-listing.detector.js
â”‚   â””â”€â”€ content.analyzer.js
â””â”€â”€ scraping.service.js
```

**ä¾å­˜é–¢ä¿‚**:
- Database Module (ãƒ­ã‚°ä¿å­˜)
- å¤–éƒ¨ãƒ©ã‚¤ãƒ–ãƒ©ãƒª (axios, cheerio, jsdom)

#### 3. Database Module

**è²¬å‹™**:
- ãƒ‡ãƒ¼ã‚¿æ°¸ç¶šåŒ–
- ã‚¯ã‚¨ãƒªå®Ÿè¡Œ
- ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ç®¡ç†
- ã‚­ãƒ£ãƒƒã‚·ãƒ¥ç®¡ç†

**æ§‹æˆ**:
```
src/database/
â”œâ”€â”€ entities/
â”‚   â”œâ”€â”€ url.entity.js
â”‚   â”œâ”€â”€ monitoring-log.entity.js
â”‚   â”œâ”€â”€ user.entity.js
â”‚   â””â”€â”€ notification.entity.js
â”œâ”€â”€ repositories/
â”‚   â”œâ”€â”€ url.repository.js
â”‚   â”œâ”€â”€ monitoring-log.repository.js
â”‚   â”œâ”€â”€ user.repository.js
â”‚   â””â”€â”€ notification.repository.js
â”œâ”€â”€ cache/
â”‚   â”œâ”€â”€ file.cache.js
â”‚   â””â”€â”€ memory.cache.js
â””â”€â”€ database.service.js
```

**ä¾å­˜é–¢ä¿‚**:
- better-sqlite3 (SQLite3ãƒ‰ãƒ©ã‚¤ãƒ)
- fs (ãƒ•ã‚¡ã‚¤ãƒ«ã‚­ãƒ£ãƒƒã‚·ãƒ¥)

#### 4. Notification Module

**è²¬å‹™**:
- Telegram Botç®¡ç†
- é€šçŸ¥é€ä¿¡
- ã‚³ãƒãƒ³ãƒ‰å‡¦ç†
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†

**æ§‹æˆ**:
```
src/notification/
â”œâ”€â”€ telegram/
â”‚   â”œâ”€â”€ bot.service.js
â”‚   â”œâ”€â”€ command.handler.js
â”‚   â””â”€â”€ message.formatter.js
â”œâ”€â”€ templates/
â”‚   â”œâ”€â”€ new-listing.template.js
â”‚   â”œâ”€â”€ error.template.js
â”‚   â””â”€â”€ summary.template.js
â””â”€â”€ notification.service.js
```

**ä¾å­˜é–¢ä¿‚**:
- node-telegram-bot-api (Telegram Bot)
- Database Module (ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ»é€šçŸ¥ãƒ‡ãƒ¼ã‚¿)

### ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«é–“ä¾å­˜é–¢ä¿‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   API Server    â”‚â”€â”€â”€â–¶â”‚   Database      â”‚
â”‚   Module        â”‚    â”‚   Module        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                       â–²
         â–¼                       â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚   Scraping      â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚   Engine Module â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Notification   â”‚â”€â”€â”€â–¶â”‚   Database      â”‚
â”‚   Module        â”‚    â”‚   Module        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### è²¬å‹™åˆ†é›¢ã®æ˜ç¢ºåŒ–

| ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ« | ä¸»è¦è²¬å‹™ | å‰¯æ¬¡è²¬å‹™ | ç¦æ­¢äº‹é … |
|------------|----------|----------|----------|
| API Server | HTTPå‡¦ç† | å…¥åŠ›æ¤œè¨¼ | ç›´æ¥DBæ“ä½œ |
| Scraping Engine | ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚° | Botå¯¾ç­– | é€šçŸ¥é€ä¿¡ |
| Database | ãƒ‡ãƒ¼ã‚¿ç®¡ç† | ã‚­ãƒ£ãƒƒã‚·ãƒ¥ | ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ |
| Notification | é€šçŸ¥é€ä¿¡ | ã‚³ãƒãƒ³ãƒ‰å‡¦ç† | ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚° |

## ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­è¨ˆ

### Botæ¤œçŸ¥å›é¿æˆ¦ç•¥

#### 3æ®µéšã‚¢ã‚¯ã‚»ã‚¹ãƒ‘ã‚¿ãƒ¼ãƒ³

**Stage 1: Botæ¤œçŸ¥ãƒ†ã‚¹ãƒˆï¼ˆè»½é‡ç‰ˆï¼‰**
```javascript
// è»½é‡Botæ¤œçŸ¥å›é¿
const botTestUrl = 'https://bot.sannysoft.com';
await axios.get(botTestUrl, {
  headers: generateHumanHeaders(),
  timeout: 10000
});
await randomDelay(2000, 4000);
```

**Stage 2: Googleæ¤œç´¢å®Ÿè¡Œ**
```javascript
// å®Ÿéš›ã®Googleæ¤œç´¢
const googleUrl = 'https://www.google.com';
await axios.get(googleUrl, {
  headers: inheritHeaders(),
  timeout: 15000
});
await randomDelay(3000, 6000);
```

**Stage 3: ç›®çš„ã‚µã‚¤ãƒˆã‚¢ã‚¯ã‚»ã‚¹**
```javascript
// ã‚»ãƒƒã‚·ãƒ§ãƒ³ç¶™æ‰¿ã§ã‚¢ã‚¯ã‚»ã‚¹
const targetResponse = await axios.get(targetUrl, {
  headers: inheritHeaders(),
  jar: sessionCookieJar,
  timeout: 20000
});
```

#### ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†

**Cookieç¶™æ‰¿ã‚·ã‚¹ãƒ†ãƒ **:
```javascript
const tough = require('tough-cookie');
const cookieJar = new tough.CookieJar();

// ãƒ‰ãƒ¡ã‚¤ãƒ³åˆ¥ã‚»ãƒƒã‚·ãƒ§ãƒ³åˆ†é›¢
const sessionStore = new Map();
sessionStore.set(domain, {
  cookieJar: cookieJar,
  userAgent: selectedUserAgent,
  lastAccess: Date.now(),
  sessionId: generateSessionId()
});
```

**ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆç®¡ç†**:
```javascript
const SESSION_TIMEOUT = 30 * 60 * 1000; // 30åˆ†

setInterval(() => {
  for (const [domain, session] of sessionStore) {
    if (Date.now() - session.lastAccess > SESSION_TIMEOUT) {
      sessionStore.delete(domain);
      logger.info(`Session expired for domain: ${domain}`);
    }
  }
}, 5 * 60 * 1000); // 5åˆ†æ¯ãƒã‚§ãƒƒã‚¯
```

#### User-Agentãƒ­ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³

**8ç¨®é¡ã®User-Agent**:
```javascript
const userAgents = [
  // Windows Chrome
  'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36',
  // Windows Firefox
  'Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:121.0) Gecko/20100101 Firefox/121.0',
  // Windows Edge
  'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36 Edg/120.0.0.0',
  // Mac Chrome
  'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36',
  // Mac Firefox
  'Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:121.0) Gecko/20100101 Firefox/121.0',
  // Mac Safari
  'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/17.2 Safari/605.1.15',
  // Linux Chrome
  'Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36',
  // Linux Firefox
  'Mozilla/5.0 (X11; Linux x86_64; rv:121.0) Gecko/20100101 Firefox/121.0'
];

// ãƒ‰ãƒ¡ã‚¤ãƒ³åˆ¥å›ºå®šå‰²ã‚Šå½“ã¦
function getUserAgentForDomain(domain) {
  const hash = crypto.createHash('md5').update(domain).digest('hex');
  const index = parseInt(hash.substring(0, 8), 16) % userAgents.length;
  return userAgents[index];
}
```

#### äººé–“ã‚‰ã—ã„ã‚¢ã‚¯ã‚»ã‚¹ãƒ‘ã‚¿ãƒ¼ãƒ³

**æ­£è¦åˆ†å¸ƒã«ã‚ˆã‚‹å¾…æ©Ÿæ™‚é–“**:
```javascript
function generateHumanDelay(min = 5000, max = 15000) {
  // Box-Mullerå¤‰æ›ã«ã‚ˆã‚‹æ­£è¦åˆ†å¸ƒ
  const u1 = Math.random();
  const u2 = Math.random();
  const z0 = Math.sqrt(-2 * Math.log(u1)) * Math.cos(2 * Math.PI * u2);
  
  const mean = (min + max) / 2;
  const stdDev = (max - min) / 6;
  const delay = Math.max(min, Math.min(max, mean + z0 * stdDev));
  
  return Math.round(delay);
}
```

### ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£

#### å…¥åŠ›å€¤æ¤œè¨¼

**URLæ¤œè¨¼**:
```javascript
const urlValidation = {
  isURL: true,
  custom: {
    options: (value) => {
      const allowedDomains = [
        'suumo.jp',
        'homes.co.jp', 
        'athome.co.jp',
        'chintai.mynavi.jp'
      ];
      
      try {
        const url = new URL(value);
        return allowedDomains.some(domain => 
          url.hostname === domain || url.hostname.endsWith('.' + domain)
        );
      } catch {
        return false;
      }
    }
  }
};
```

**ãƒ¬ãƒ¼ãƒˆåˆ¶é™**:
```javascript
const rateLimit = require('express-rate-limit');

const apiLimiter = rateLimit({
  windowMs: 15 * 60 * 1000, // 15åˆ†
  max: 100, // æœ€å¤§100ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
  message: {
    error: {
      code: 'RATE_LIMITED',
      message: 'Too many requests from this IP'
    }
  },
  standardHeaders: true,
  legacyHeaders: false
});
```

#### èªè¨¼ãƒ»èªå¯

**Telegram Botèªè¨¼**:
```javascript
function verifyTelegramAuth(req, res, next) {
  const { userId, username } = req.body;
  
  if (!userId || !username) {
    return res.status(401).json({
      error: {
        code: 'UNAUTHORIZED',
        message: 'Telegram authentication required'
      }
    });
  }
  
  // Telegram User IDæ¤œè¨¼
  if (!/^\d+$/.test(userId)) {
    return res.status(401).json({
      error: {
        code: 'INVALID_USER_ID',
        message: 'Invalid Telegram User ID format'
      }
    });
  }
  
  req.user = { userId, username };
  next();
}
```

#### ãƒ‡ãƒ¼ã‚¿æš—å·åŒ–

**æ©Ÿå¯†ãƒ‡ãƒ¼ã‚¿æš—å·åŒ–**:
```javascript
const crypto = require('crypto');

class EncryptionService {
  constructor() {
    this.algorithm = 'aes-256-gcm';
    this.key = crypto.scryptSync(process.env.ENCRYPTION_KEY, 'salt', 32);
  }
  
  encrypt(text) {
    const iv = crypto.randomBytes(16);
    const cipher = crypto.createCipher(this.algorithm, this.key, iv);
    
    let encrypted = cipher.update(text, 'utf8', 'hex');
    encrypted += cipher.final('hex');
    
    const authTag = cipher.getAuthTag();
    
    return {
      encrypted,
      iv: iv.toString('hex'),
      authTag: authTag.toString('hex')
    };
  }
  
  decrypt(encryptedData) {
    const decipher = crypto.createDecipher(
      this.algorithm, 
      this.key, 
      Buffer.from(encryptedData.iv, 'hex')
    );
    
    decipher.setAuthTag(Buffer.from(encryptedData.authTag, 'hex'));
    
    let decrypted = decipher.update(encryptedData.encrypted, 'hex', 'utf8');
    decrypted += decipher.final('utf8');
    
    return decrypted;
  }
}
```

## ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ»é‹ç”¨è¨­è¨ˆ

### ä¸¦åˆ—å‡¦ç†ãƒ»ã‚­ãƒ£ãƒƒã‚·ãƒ¥æˆ¦ç•¥

#### ä¸¦åˆ—ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°

**Worker Poolå®Ÿè£…**:
```javascript
const { Worker, isMainThread, parentPort, workerData } = require('worker_threads');

class ScrapingWorkerPool {
  constructor(maxWorkers = 3) {
    this.maxWorkers = maxWorkers;
    this.workers = [];
    this.queue = [];
    this.activeJobs = 0;
  }
  
  async execute(url, options) {
    return new Promise((resolve, reject) => {
      this.queue.push({ url, options, resolve, reject });
      this.processQueue();
    });
  }
  
  processQueue() {
    if (this.queue.length === 0 || this.activeJobs >= this.maxWorkers) {
      return;
    }
    
    const job = this.queue.shift();
    this.activeJobs++;
    
    const worker = new Worker(__filename, {
      workerData: { url: job.url, options: job.options }
    });
    
    worker.on('message', (result) => {
      this.activeJobs--;
      job.resolve(result);
      worker.terminate();
      this.processQueue();
    });
    
    worker.on('error', (error) => {
      this.activeJobs--;
      job.reject(error);
      worker.terminate();
      this.processQueue();
    });
  }
}
```

#### å¤šå±¤ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚·ã‚¹ãƒ†ãƒ 

**L1: ãƒ¡ãƒ¢ãƒªã‚­ãƒ£ãƒƒã‚·ãƒ¥**:
```javascript
class MemoryCache {
  constructor(maxSize = 1000, ttl = 300000) { // 5åˆ†TTL
    this.cache = new Map();
    this.maxSize = maxSize;
    this.ttl = ttl;
  }
  
  set(key, value) {
    if (this.cache.size >= this.maxSize) {
      const firstKey = this.cache.keys().next().value;
      this.cache.delete(firstKey);
    }
    
    this.cache.set(key, {
      value,
      timestamp: Date.now()
    });
  }
  
  get(key) {
    const item = this.cache.get(key);
    if (!item) return null;
    
    if (Date.now() - item.timestamp > this.ttl) {
      this.cache.delete(key);
      return null;
    }
    
    return item.value;
  }
}
```

**L2: ãƒ•ã‚¡ã‚¤ãƒ«ã‚­ãƒ£ãƒƒã‚·ãƒ¥**:
```javascript
const fs = require('fs').promises;
const path = require('path');

class FileCache {
  constructor(cacheDir = './cache') {
    this.cacheDir = cacheDir;
    this.ensureCacheDir();
  }
  
  async ensureCacheDir() {
    try {
      await fs.mkdir(this.cacheDir, { recursive: true });
    } catch (error) {
      // ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒæ—¢ã«å­˜åœ¨ã™ã‚‹å ´åˆã¯ç„¡è¦–
    }
  }
  
  async set(key, value, ttl = 3600000) { // 1æ™‚é–“TTL
    const filePath = path.join(this.cacheDir, `${key}.json`);
    const data = {
      value,
      timestamp: Date.now(),
      ttl
    };
    
    await fs.writeFile(filePath, JSON.stringify(data));
  }
  
  async get(key) {
    try {
      const filePath = path.join(this.cacheDir, `${key}.json`);
      const data = JSON.parse(await fs.readFile(filePath, 'utf8'));
      
      if (Date.now() - data.timestamp > data.ttl) {
        await fs.unlink(filePath);
        return null;
      }
      
      return data.value;
    } catch (error) {
      return null;
    }
  }
}
```

### ãƒ­ã‚°ãƒ»ç›£è¦–ã‚·ã‚¹ãƒ†ãƒ 

#### æ§‹é€ åŒ–ãƒ­ã‚°

**Winstonè¨­å®š**:
```javascript
const winston = require('winston');

const logger = winston.createLogger({
  level: process.env.LOG_LEVEL || 'info',
  format: winston.format.combine(
    winston.format.timestamp(),
    winston.format.errors({ stack: true }),
    winston.format.json()
  ),
  defaultMeta: { 
    service: 'sokubutsu-lightweight',
    version: '2.0.0'
  },
  transports: [
    new winston.transports.File({ 
      filename: 'logs/error.log', 
      level: 'error',
      maxsize: 10 * 1024 * 1024, // 10MB
      maxFiles: 5
    }),
    new winston.transports.File({ 
      filename: 'logs/combined.log',
      maxsize: 10 * 1024 * 1024, // 10MB
      maxFiles: 10
    })
  ]
});

// é–‹ç™ºç’°å¢ƒã§ã¯ã‚³ãƒ³ã‚½ãƒ¼ãƒ«å‡ºåŠ›ã‚‚è¿½åŠ 
if (process.env.NODE_ENV !== 'production') {
  logger.add(new winston.transports.Console({
    format: winston.format.simple()
  }));
}
```

#### ãƒ¡ãƒˆãƒªã‚¯ã‚¹åé›†

**Prometheusäº’æ›ãƒ¡ãƒˆãƒªã‚¯ã‚¹**:
```javascript
const client = require('prom-client');

// ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ¡ãƒˆãƒªã‚¯ã‚¹åé›†
const collectDefaultMetrics = client.collectDefaultMetrics;
collectDefaultMetrics({ timeout: 5000 });

// ã‚«ã‚¹ã‚¿ãƒ ãƒ¡ãƒˆãƒªã‚¯ã‚¹
const httpRequestDuration = new client.Histogram({
  name: 'http_request_duration_seconds',
  help: 'Duration of HTTP requests in seconds',
  labelNames: ['method', 'route', 'status_code']
});

const scrapingDuration = new client.Histogram({
  name: 'scraping_duration_seconds',
  help: 'Duration of scraping operations in seconds',
  labelNames: ['method', 'domain', 'success']
});

const scrapingCounter = new client.Counter({
  name: 'scraping_total',
  help: 'Total number of scraping operations',
  labelNames: ['method', 'domain', 'result']
});

const memoryUsage = new client.Gauge({
  name: 'memory_usage_bytes',
  help: 'Current memory usage in bytes',
  labelNames: ['type']
});

// ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡å®šæœŸæ›´æ–°
setInterval(() => {
  const usage = process.memoryUsage();
  memoryUsage.set({ type: 'heap_used' }, usage.heapUsed);
  memoryUsage.set({ type: 'heap_total' }, usage.heapTotal);
  memoryUsage.set({ type: 'external' }, usage.external);
  memoryUsage.set({ type: 'rss' }, usage.rss);
}, 10000); // 10ç§’æ¯
```

### ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯æ©Ÿèƒ½

#### åŒ…æ‹¬çš„ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯

**ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯å®Ÿè£…**:
```javascript
class HealthCheckService {
  constructor(databaseService, scrapingService) {
    this.databaseService = databaseService;
    this.scrapingService = scrapingService;
  }
  
  async getBasicHealth() {
    return {
      status: 'healthy',
      timestamp: new Date().toISOString(),
      uptime: process.uptime(),
      version: process.env.npm_package_version || '2.0.0'
    };
  }
  
  async getDetailedHealth() {
    const checks = await Promise.allSettled([
      this.checkDatabase(),
      this.checkMemory(),
      this.checkScraping(),
      this.checkBotProtection()
    ]);
    
    const results = {
      database: checks[0].status === 'fulfilled' ? checks[0].value : { status: 'error', error: checks[0].reason.message },
      memory: checks[1].status === 'fulfilled' ? checks[1].value : { status: 'error', error: checks[1].reason.message },
      scraping: checks[2].status === 'fulfilled' ? checks[2].value : { status: 'error', error: checks[2].reason.message },
      botProtection: checks[3].status === 'fulfilled' ? checks[3].value : { status: 'error', error: checks[3].reason.message }
    };
    
    const overallStatus = Object.values(results).every(check => check.status === 'ok') ? 'healthy' : 'unhealthy';
    
    return {
      status: overallStatus,
      timestamp: new Date().toISOString(),
      checks: results
    };
  }
  
  async checkDatabase() {
    const start = Date.now();
    try {
      await this.databaseService.query('SELECT 1');
      const responseTime = Date.now() - start;
      
      return {
        status: 'ok',
        responseTime: `${responseTime}ms`,
        connections: this.databaseService.getConnectionCount()
      };
    } catch (error) {
      return {
        status: 'error',
        error: error.message
      };
    }
  }
  
  async checkMemory() {
    const usage = process.memoryUsage();
    const threshold = 100 * 1024 * 1024; // 100MB
    
    return {
      status: usage.heapUsed < threshold ? 'ok' : 'warning',
      heapUsed: `${(usage.heapUsed / 1024 / 1024).toFixed(1)}MB`,
      threshold: `${(threshold / 1024 / 1024).toFixed(1)}MB`
    };
  }
  
  async checkScraping() {
    const stats = this.scrapingService.getStats();
    
    return {
      status: 'ok',
      activeJobs: stats.activeJobs,
      successRate: `${stats.successRate.toFixed(1)}%`
    };
  }
  
  async checkBotProtection() {
    const sessions = this.scrapingService.getActiveSessions();
    
    return {
      status: 'ok',
      sessionsActive: sessions.length,
      lastRotation: sessions.length > 0 ? sessions[0].lastRotation : null
    };
  }
}
```

## æ‹¡å¼µæ€§è¨­è¨ˆ

### æ°´å¹³ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°å¯¾å¿œ

#### ãƒ­ãƒ¼ãƒ‰ãƒãƒ©ãƒ³ã‚µãƒ¼å¯¾å¿œ

**PM2 Cluster Mode**:
```javascript
// ecosystem.config.js
module.exports = {
  apps: [{
    name: 'sokubutsu-lightweight',
    script: './src/app.js',
    instances: 'max', // CPUæ•°ã«å¿œã˜ã¦è‡ªå‹•èª¿æ•´
    exec_mode: 'cluster',
    env: {
      NODE_ENV: 'production',
      PORT: 3000
    },
    max_memory_restart: '100M',
    error_file: './logs/pm2-error.log',
    out_file: './logs/pm2-out.log',
    log_file: './logs/pm2-combined.log',
    time: true
  }]
};
```

#### ã‚»ãƒƒã‚·ãƒ§ãƒ³å…±æœ‰

**Redisçµ±åˆæº–å‚™**:
```javascript
class SessionStore {
  constructor(redisClient = null) {
    this.redisClient = redisClient;
    this.localStore = new Map(); // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ç”¨
  }
  
  async set(key, value, ttl = 1800) {
    if (this.redisClient) {
      await this.redisClient.setex(key, ttl, JSON.stringify(value));
    } else {
      this.localStore.set(key, {
        value,
        expiry: Date.now() + (ttl * 1000)
      });
    }
  }
  
  async get(key) {
    if (this.redisClient) {
      const value = await this.redisClient.get(key);
      return value ? JSON.parse(value) : null;
    } else {
      const item = this.localStore.get(key);
      if (!item) return null;
      
      if (Date.now() > item.expiry) {
        this.localStore.delete(key);
        return null;
      }
      
      return item.value;
    }
  }
}
```

### ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

#### ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°ã‚¨ãƒ³ã‚¸ãƒ³ãƒ—ãƒ©ã‚°ã‚¤ãƒ³

**ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹**:
```javascript
class ScrapingPlugin {
  constructor(name, priority = 50) {
    this.name = name;
    this.priority = priority; // ä½ã„æ•°å€¤ã»ã©é«˜å„ªå…ˆåº¦
  }
  
  // å¯¾å¿œå¯èƒ½ã‹ãƒã‚§ãƒƒã‚¯
  canHandle(url, options) {
    throw new Error('canHandle method must be implemented');
  }
  
  // ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°å®Ÿè¡Œ
  async scrape(url, options) {
    throw new Error('scrape method must be implemented');
  }
  
  // ãƒªã‚½ãƒ¼ã‚¹ä½¿ç”¨é‡äºˆæ¸¬
  getResourceEstimate() {
    return {
      memory: 0, // MB
      cpu: 0,    // %
      time: 0    // ms
    };
  }
}

// HTTP-onlyãƒ—ãƒ©ã‚°ã‚¤ãƒ³å®Ÿè£…ä¾‹
class HttpOnlyPlugin extends ScrapingPlugin {
  constructor() {
    super('http-only', 10); // æœ€é«˜å„ªå…ˆåº¦
  }
  
  canHandle(url, options) {
    // é™çš„ã‚µã‚¤ãƒˆã®åˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯
    const staticSitePatterns = [
      /suumo\.jp.*ichiran/,
      /homes\.co\.jp.*list/,
      /athome\.co\.jp.*list/
    ];
    
    return staticSitePatterns.some(pattern => pattern.test(url));
  }
  
  async scrape(url, options) {
    const response = await axios.get(url, {
      headers: options.headers,
      timeout: options.timeout || 10000
    });
    
    const $ = cheerio.load(response.data);
    const newMarkers = ['.new', '.æ–°ç€', '.TODAY', '.today'];
    
    let newCount = 0;
    newMarkers.forEach(selector => {
      newCount += $(selector).length;
    });
    
    return {
      success: true,
      newCount,
      hasNew: newCount > 0,
      method: 'http-only',
      responseTime: response.responseTime,
      statusCode: response.status
    };
  }
  
  getResourceEstimate() {
    return {
      memory: 25, // MB
      cpu: 5,     // %
      time: 2000  // ms
    };
  }
}
```

#### é€šçŸ¥ãƒ—ãƒ©ã‚°ã‚¤ãƒ³

**é€šçŸ¥ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹**:
```javascript
class NotificationPlugin {
  constructor(name) {
    this.name = name;
  }
  
  async send(message, recipient, options = {}) {
    throw new Error('send method must be implemented');
  }
  
  async validateRecipient(recipient) {
    throw new Error('validateRecipient method must be implemented');
  }
}

// Discordé€šçŸ¥ãƒ—ãƒ©ã‚°ã‚¤ãƒ³å®Ÿè£…ä¾‹
class DiscordPlugin extends NotificationPlugin {
  constructor(webhookUrl) {
    super('discord');
    this.webhookUrl = webhookUrl;
  }
  
  async send(message, recipient, options = {}) {
    const payload = {
      content: message,
      username: 'ã‚½ã‚¯ãƒ–ãƒ„',
      avatar_url: options.avatarUrl
    };
    
    await axios.post(this.webhookUrl, payload);
  }
  
  async validateRecipient(recipient) {
    // Discord Webhook URLã®æ¤œè¨¼
    return /^https:\/\/discord\.com\/api\/webhooks\//.test(recipient);
  }
}
```

### å°†æ¥ã®æŠ€è¡“èª²é¡Œ

#### ãƒã‚¤ã‚¯ãƒ­ã‚µãƒ¼ãƒ“ã‚¹åŒ–æº–å‚™

**ã‚µãƒ¼ãƒ“ã‚¹åˆ†é›¢è¨ˆç”»**:
```
ç¾åœ¨ã®ãƒ¢ãƒãƒªã‚¹æ§‹æˆ:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         è»½é‡ã‚½ã‚¯ãƒ–ãƒ„                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚   API   â”‚ â”‚Scraping â”‚ â”‚  Notify â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

å°†æ¥ã®ãƒã‚¤ã‚¯ãƒ­ã‚µãƒ¼ãƒ“ã‚¹æ§‹æˆ:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  API Gatewayâ”‚ â”‚  Scraping   â”‚ â”‚ Notificationâ”‚
â”‚   Service   â”‚ â”‚   Service   â”‚ â”‚   Service   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚               â”‚               â”‚
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚  Database   â”‚
              â”‚   Service   â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### é«˜å¯ç”¨æ€§ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

**å†—é•·åŒ–è¨ˆç”»**:
```javascript
// å°†æ¥ã®å†—é•·åŒ–è¨­å®š
const haConfig = {
  loadBalancer: {
    algorithm: 'round-robin',
    healthCheck: {
      interval: 30000,
      timeout: 5000,
      retries: 3
    }
  },
  database: {
    primary: 'sqlite://./data/primary.db',
    replica: 'sqlite://./data/replica.db',
    syncInterval: 60000
  },
  cache: {
    redis: {
      cluster: [
        'redis://localhost:6379',
        'redis://localhost:6380',
        'redis://localhost:6381'
      ]
    }
  }
};
```

#### ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–

**å°†æ¥ã®æœ€é©åŒ–é …ç›®**:
1. **JITã‚³ãƒ³ãƒ‘ã‚¤ãƒ«**: V8ã‚¨ãƒ³ã‚¸ãƒ³ã®æœ€é©åŒ–æ´»ç”¨
2. **ãƒ¯ãƒ¼ã‚«ãƒ¼ãƒ—ãƒ¼ãƒ«**: CPUé›†ç´„çš„å‡¦ç†ã®åˆ†æ•£
3. **ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°å‡¦ç†**: å¤§é‡ãƒ‡ãƒ¼ã‚¿ã®åŠ¹ç‡çš„å‡¦ç†
4. **CDNçµ±åˆ**: é™çš„ãƒªã‚½ãƒ¼ã‚¹ã®é…ä¿¡æœ€é©åŒ–
5. **ã‚¨ãƒƒã‚¸ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°**: ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·å‰Šæ¸›

## è‡ªå®…ã‚µãƒ¼ãƒãƒ¼ç’°å¢ƒæœ€é©åŒ–

### WSL2ç’°å¢ƒã§ã®æœ€é©åŒ–

#### ãƒ¡ãƒ¢ãƒªç®¡ç†

**WSL2ãƒ¡ãƒ¢ãƒªåˆ¶é™è¨­å®š**:
```ini
# .wslconfig (Windowså´)
[wsl2]
memory=4GB
processors=4
swap=1GB
localhostForwarding=true
```

**Node.jsãƒ¡ãƒ¢ãƒªåˆ¶é™**:
```bash
# èµ·å‹•æ™‚ã‚ªãƒ—ã‚·ãƒ§ãƒ³
node --max-old-space-size=512 --max-semi-space-size=64 src/app.js
```

#### ãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ æœ€é©åŒ–

**SQLiteãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹è¨­å®š**:
```javascript
const database = new Database('./data/sokubutsu.db', {
  // WALãƒ¢ãƒ¼ãƒ‰ï¼ˆWrite-Ahead Loggingï¼‰
  pragma: {
    journal_mode: 'WAL',
    synchronous: 'NORMAL',
    cache_size: -64000, // 64MB
    temp_store: 'MEMORY',
    mmap_size: 268435456 // 256MB
  }
});
```

#### ãƒ—ãƒ­ã‚»ã‚¹ç®¡ç†

**systemdã‚µãƒ¼ãƒ“ã‚¹è¨­å®š**:
```ini
# /etc/systemd/system/sokubutsu.service
[Unit]
Description=Sokubutsu Lightweight Property Monitor
After=network.target

[Service]
Type=simple
User=ubuntu
WorkingDirectory=/home/ubuntu/sokubutsu2
ExecStart=/usr/bin/node --max-old-space-size=512 src/app.js
Restart=always
RestartSec=10
Environment=NODE_ENV=production
Environment=PORT=3000

# ãƒªã‚½ãƒ¼ã‚¹åˆ¶é™
MemoryLimit=100M
CPUQuota=200%

[Install]
WantedBy=multi-user.target
```

### ç›£è¦–ãƒ»ã‚¢ãƒ©ãƒ¼ãƒˆè¨­å®š

#### ãƒªã‚½ãƒ¼ã‚¹ç›£è¦–

**ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡ç›£è¦–**:
```javascript
setInterval(() => {
  const usage = process.memoryUsage();
  const heapUsedMB = usage.heapUsed / 1024 / 1024;
  
  if (heapUsedMB > 80) { // 80MBè¶…éã§ã‚¢ãƒ©ãƒ¼ãƒˆ
    logger.warn('High memory usage detected', {
      heapUsed: `${heapUsedMB.toFixed(1)}MB`,
      threshold: '80MB'
    });
    
    // ã‚¬ãƒ™ãƒ¼ã‚¸ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³å¼·åˆ¶å®Ÿè¡Œ
    if (global.gc) {
      global.gc();
    }
  }
}, 30000); // 30ç§’æ¯
```

#### è‡ªå‹•å¾©æ—§æ©Ÿèƒ½

**ãƒ—ãƒ­ã‚»ã‚¹ç›£è¦–ãƒ»å†èµ·å‹•**:
```javascript
process.on('uncaughtException', (error) => {
  logger.error('Uncaught Exception', { error: error.stack });
  
  // ã‚°ãƒ¬ãƒ¼ã‚¹ãƒ•ãƒ«ã‚·ãƒ£ãƒƒãƒˆãƒ€ã‚¦ãƒ³
  gracefulShutdown();
});

process.on('unhandledRejection', (reason, promise) => {
  logger.error('Unhandled Rejection', { 
    reason: reason.stack || reason,
    promise 
  });
});

function gracefulShutdown() {
  logger.info('Starting graceful shutdown');
  
  // æ–°ã—ã„ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®å—ä»˜åœæ­¢
  server.close(() => {
    logger.info('HTTP server closed');
    
    // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šã‚¯ãƒ­ãƒ¼ã‚º
    database.close();
    
    // ãƒ—ãƒ­ã‚»ã‚¹çµ‚äº†
    process.exit(0);
  });
  
  // å¼·åˆ¶çµ‚äº†ã‚¿ã‚¤ãƒãƒ¼
  setTimeout(() => {
    logger.error('Forced shutdown');
    process.exit(1);
  }, 10000);
}
```

## ã¾ã¨ã‚

è»½é‡ã‚½ã‚¯ãƒ–ãƒ„ã®ã‚·ã‚¹ãƒ†ãƒ è¨­è¨ˆã¯ã€è‡ªå®…ã‚µãƒ¼ãƒãƒ¼ç’°å¢ƒã§ã®ç‰©ä»¶æ–°ç€ç›£è¦–ã«æœ€é©åŒ–ã•ã‚ŒãŸé©æ–°çš„ãªã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã§ã™ã€‚

### ä¸»è¦ãªè¨­è¨ˆåŸå‰‡

1. **è»½é‡æ€§å„ªå…ˆ**: ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡30-60MBã®è¶…è»½é‡è¨­è¨ˆ
2. **æ®µéšçš„å‡¦ç†**: HTTP-first + ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯æˆ¦ç•¥
3. **é«˜åº¦ãªBotå¯¾ç­–**: GoogleçµŒç”±ã‚¢ã‚¯ã‚»ã‚¹ + ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†
4. **è‡ªå®…ã‚µãƒ¼ãƒãƒ¼æœ€é©åŒ–**: WSL2ç’°å¢ƒã§ã®å®‰å®šå‹•ä½œ
5. **æ‹¡å¼µæ€§ç¢ºä¿**: ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ + ãƒã‚¤ã‚¯ãƒ­ã‚µãƒ¼ãƒ“ã‚¹æº–å‚™

### æœŸå¾…ã•ã‚Œã‚‹åŠ¹æœ

- **ãƒªã‚½ãƒ¼ã‚¹ä½¿ç”¨é‡**: å¾“æ¥æ¯”90%å‰Šæ¸›
- **å‡¦ç†æ™‚é–“**: å¾“æ¥æ¯”95%çŸ­ç¸®
- **Botå›é¿ç‡**: 90%ä»¥ä¸Š
- **ç¨¼åƒç‡**: 99%ä»¥ä¸Š
- **é‹ç”¨ã‚³ã‚¹ãƒˆ**: å¹´é–“627,000å††å‰Šæ¸›

### æŠ€è¡“çš„å„ªä½æ€§

1. **é©æ–°çš„ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°**: 3æ®µéšãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯æˆ¦ç•¥
2. **é«˜åº¦ãªBotå¯¾ç­–**: äººé–“ã‚‰ã—ã„ã‚¢ã‚¯ã‚»ã‚¹ãƒ‘ã‚¿ãƒ¼ãƒ³
3. **æœ€é©åŒ–ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ç®¡ç†**: SQLite3 + ãƒ•ã‚¡ã‚¤ãƒ«ã‚­ãƒ£ãƒƒã‚·ãƒ¥
4. **åŒ…æ‹¬çš„ãªç›£è¦–**: ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ç›£è¦– + è‡ªå‹•å¾©æ—§
5. **å°†æ¥æ‹¡å¼µæ€§**: ãƒã‚¤ã‚¯ãƒ­ã‚µãƒ¼ãƒ“ã‚¹åŒ–æº–å‚™å®Œäº†

ã“ã®è¨­è¨ˆã«ã‚ˆã‚Šã€3æ—¥ãƒªãƒªãƒ¼ã‚¹ç›®æ¨™ã®é”æˆã¨é•·æœŸå®‰å®šé‹ç”¨ã®ä¸¡ç«‹ãŒå¯èƒ½ã«ãªã‚Šã€è‡ªå®…ã‚µãƒ¼ãƒãƒ¼ç’°å¢ƒã§ã®ç‰©ä»¶ç›£è¦–ã‚·ã‚¹ãƒ†ãƒ ã¨ã—ã¦æœ€é©ãªè§£æ±ºç­–ã‚’æä¾›ã—ã¾ã™ã€‚

