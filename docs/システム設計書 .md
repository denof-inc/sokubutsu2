# システム設計書 - ソクブツ

## 概要

ソクブツは、自宅サーバー環境での物件新着「有無」監視に特化したシステムです。

### MVP戦略（現在の実装方針）
**軽量Node.js + TypeScript**を基盤とし、HTTP-first戦略により最小限の依存関係で高速・安定動作を実現します。

#### **実装済み機能（2024年7月29日現在）**
- ✅ **SimpleScraper**: HTTP-onlyスクレイピング（athome.co.jp対応）
- ✅ **SimpleStorage**: JSON形式データ永続化
- ✅ **MonitoringScheduler**: 5分間隔監視スケジューラー
- ✅ **基盤機能**: logger, telegram, config完備

#### **実装予定機能（今日中）**
- ❌ **PropertyMonitor**: 新着物件検知ロジック
- ❌ **通知統合**: Telegram新着通知機能

### 将来拡張戦略
NestJS + TypeScript重厚スタックへの段階的移行により、HTTP-first + 段階的フォールバック戦略を含む本格的なシステムを構築します。

### 技術選択の理由
- **MVP**: 軽量性・理解しやすさ・高速起動を重視
- **本格版**: 拡張性・保守性・エンタープライズ機能を重視

## システム全体アーキテクチャ

### 高レベルアーキテクチャ

```
┌─────────────────────────────────────────────────────────────┐
│                    ソクブツ・システム                        │
├─────────────────────────────────────────────────────────────┤
│  🏠 自宅サーバー環境 (Intel i5-9400T, 7.7GB RAM, WSL2)      │
│                                                             │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────┐  │
│  │   Telegram Bot  │  │   NestJS API    │  │  Scheduler  │  │
│  │   (通知・制御)   │  │   (REST API)    │  │  (定期実行)  │  │
│  └─────────────────┘  └─────────────────┘  └─────────────┘  │
│           │                     │                     │     │
│           └─────────────────────┼─────────────────────┘     │
│                                 │                           │
│  ┌─────────────────────────────────────────────────────────┐  │
│  │              スクレイピングエンジン                      │  │
│  │                                                         │  │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────────┐  │  │
│  │  │ HTTP-only   │  │   jsdom     │  │   Playwright    │  │  │
│  │  │ (70%成功)   │→ │ (20%成功)   │→ │  (10%成功)      │  │  │
│  │  │ 30-50MB     │  │ 80-120MB    │  │  200-300MB      │  │  │
│  │  │ 2-5秒       │  │ 5-10秒      │  │  15-25秒        │  │  │
│  │  └─────────────┘  └─────────────┘  └─────────────────┘  │  │
│  └─────────────────────────────────────────────────────────┘  │
│                                 │                           │
│  ┌─────────────────────────────────────────────────────────┐  │
│  │                Bot対策システム                          │  │
│  │                                                         │  │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────────┐  │  │
│  │  │ Bot検知回避 │→ │ Google検索  │→ │ 目的サイト      │  │  │
│  │  │ (NestJS)    │  │ (実際実行)  │  │ (セッション継承) │  │  │
│  │  └─────────────┘  └─────────────┘  └─────────────────┘  │  │
│  └─────────────────────────────────────────────────────────┘  │
│                                 │                           │
│  ┌─────────────────────────────────────────────────────────┐  │
│  │                データ管理層                             │  │
│  │                                                         │  │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────────┐  │  │
│  │  │ TypeORM +   │  │ File Cache  │  │ Session Store   │  │  │
│  │  │better-sqlite3│  │ (JSON)      │  │ (Memory)        │  │  │
│  │  │ 20-40MB     │  │ 10-20MB     │  │ 10-30MB         │  │  │
│  │  └─────────────┘  └─────────────┘  └─────────────────┘  │  │
│  └─────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
```

### データフロー図

```
┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│ Telegram    │    │ NestJS      │    │ Scheduler   │
│ User Input  │───▶│ API Server  │◀───│ Cron Jobs   │
└─────────────┘    └─────────────┘    └─────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────┐
│              スクレイピングエンジン                      │
│                                                         │
│  URL → Bot対策 → HTTP-only → jsdom → Playwright        │
│   │      │         │          │         │              │
│   │      │         ├─ 成功 ───┼─────────┼─ 結果        │
│   │      │         │          ├─ 成功 ──┼─ 結果        │
│   │      │         │          │         └─ 成功 → 結果 │
│   │      │         └─ 失敗 ───┘                        │
│   │      └─ セッション管理・User-Agentローテーション     │
│   └─ URL検証・ドメイン制限                              │
└─────────────────────────────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────┐
│                    データ処理                           │
│                                                         │
│  新着判定 → ハッシュ比較 → 結果保存 → 通知判定          │
│     │          │           │          │                │
│     │          │           │          └─ Telegram送信  │
│     │          │           └─ TypeORM保存              │
│     │          └─ SHA-256ハッシュ計算                   │
│     └─ DOM要素抽出・正規化                              │
└─────────────────────────────────────────────────────────┘
```

## 技術スタック詳細

### バックエンド技術

#### NestJS (TypeScript)
**選定理由**:
- RFP要件の完全遵守
- 企業レベルの型安全性
- 依存性注入による高い保守性
- デコレータベースの直感的な開発

**メリット**:
- TypeScriptネイティブサポート
- 豊富なエコシステム
- 自動API文書生成 (Swagger)
- テスタビリティの高さ

**デメリット**:
- Express.jsより若干重い
- 学習コストが高い

#### TypeORM + better-sqlite3
**選定理由**:
- NestJSとの完全統合
- 型安全なクエリビルダー
- マイグレーション管理
- PostgreSQL移行準備

**メリット**:
- エンティティベースの直感的な設計
- 自動スキーマ同期
- リレーション管理の簡素化
- 開発効率の向上

**デメリット**:
- 生SQLより若干のオーバーヘッド
- 複雑なクエリの制約

### フロントエンド技術

#### Telegram Bot API
**選定理由**:
- ユーザーフレンドリーなUI
- プッシュ通知の確実性
- 開発・保守コストの低さ
- クロスプラットフォーム対応

**メリット**:
- 即座の通知配信
- リッチなメッセージ形式
- ユーザー認証の簡素化
- 無料での利用

### スクレイピング技術

#### HTTP-first + 段階的フォールバック戦略
**選定理由**:
- 軽量・高速処理の優先
- 自宅サーバーリソース制約への対応
- 段階的品質保証

**実装戦略**:
```
URL → HTTP-only → jsdom → Playwright → 失敗
      ↓ 70%成功   ↓ 20%成功  ↓ 10%成功
      2-5秒      5-10秒    15-25秒
      30-50MB    80-120MB  200-300MB
```

#### 各段階の詳細

**第1段階: HTTP-only (axios + cheerio)**
- **成功率**: 70%（athome.co.jp等のSSRサイト）
- **実行時間**: 2-5秒
- **メモリ使用量**: 30-50MB
- **適用条件**: サーバーサイドレンダリング済みサイト

**第2段階: jsdom**
- **成功率**: 20%（JavaScript軽度依存サイト）
- **実行時間**: 5-10秒
- **メモリ使用量**: 80-120MB
- **適用条件**: 軽度なJavaScript実行が必要

**第3段階: Playwright**
- **成功率**: 10%（重度JavaScript依存サイト）
- **実行時間**: 15-25秒
- **メモリ使用量**: 200-300MB
- **適用条件**: 複雑なSPA、重度JavaScript依存

#### athome.co.jp最適化（2024年7月29日実証）

**実証結果**:
- **処理方式**: HTTP-only（axios + cheerio）で完全対応
- **取得件数**: 最新3件（総337件中）
- **実行時間**: 2-5秒（従来の17.1秒から70-85%短縮）
- **メモリ使用**: 30-50MB（従来の200-300MBから80-85%削減）

**重要な発見**:
- athome.co.jpはサーバーサイドレンダリング済み
- Google経由処理は過剰最適化（特別扱い不要）
- HTTP-first戦略で十分な性能を実現

**確定仕様**:
- **監視範囲**: 最新3件（新着物件の99%をカバー）
- **検知方式**: タイトル+価格+所在地ハッシュ方式
- **監視間隔**: 5分間隔（設定可能）
- **パフォーマンス**: 2-5秒実行、30-50MB使用（従来比70-85%改善）

#### Bot対策システム
**Google経由アクセスパターン**:
```typescript
// Bot対策シーケンス
1. Bot検知テストサイト訪問
2. Google検索実行
3. 目的サイトへの自然な遷移
4. セッション情報の継承
```

## モジュール設計

### 1. CoreModule (基盤モジュール)
**責務**:
- アプリケーション初期化
- 共通設定管理
- ログ設定
- エラーハンドリング

**主要コンポーネント**:
- ConfigService: 環境変数管理
- LoggerService: 構造化ログ
- ExceptionFilter: 統一エラー処理

### 2. UrlModule (URL管理モジュール)
**責務**:
- 監視URL CRUD操作
- URL検証・正規化
- ユーザー制限管理
- 状態管理

**主要コンポーネント**:
- UrlController: REST API
- UrlService: ビジネスロジック
- UrlEntity: データモデル
- UrlRepository: データアクセス

### 3. ScrapingModule (スクレイピングモジュール)
**責務**:
- 段階的スクレイピング実行
- Bot対策システム
- 新着判定ロジック
- パフォーマンス最適化

**主要コンポーネント**:
- ScrapingService: スクレイピング実行
- BotProtectionService: Bot対策
- ContentAnalyzer: 新着判定
- CacheManager: 結果キャッシュ

### 4. NotificationModule (通知モジュール)
**責務**:
- Telegram Bot統合
- メッセージ送信
- コマンド処理
- ユーザー管理

**主要コンポーネント**:
- TelegramService: Bot API統合
- NotificationService: 通知ロジック
- CommandHandler: コマンド処理
- UserService: ユーザー管理

### モジュール間依存関係

```
CoreModule (基盤)
    ↑
UrlModule ←→ ScrapingModule ←→ NotificationModule
    ↓           ↓                    ↓
TypeORM    CacheManager      Telegram API
```

## セキュリティ設計

### Bot検知回避戦略

#### 1. Google経由アクセスパターン
```typescript
async botProtectionSequence(targetUrl: string) {
  // 1. Bot検知テストサイト
  await page.goto('https://bot.sannysoft.com');
  await page.waitForTimeout(3000);
  
  // 2. Google検索
  await page.goto('https://www.google.com');
  await page.waitForNetworkIdle();
  
  // 3. 目的サイトアクセス
  await page.goto(targetUrl);
  return page;
}
```

#### 2. User-Agentローテーション
- Chrome、Firefox、Safari の実際のUA
- バージョン番号の定期更新
- OS情報の多様化

#### 3. セッション管理
- Cookie情報の継承
- LocalStorage状態の保持
- セッションタイムアウト管理

### アプリケーションセキュリティ

#### 入力値検証
```typescript
@IsUrl()
@IsNotEmpty()
@MaxLength(2048)
url: string;

@IsString()
@Length(1, 100)
name: string;
```

#### レート制限
- IP単位: 60req/min
- ユーザー単位: 100req/hour
- スクレイピング: 5分間隔

#### データ暗号化
- 環境変数の暗号化
- データベース接続文字列の保護
- Telegram Bot Tokenの安全な管理

## パフォーマンス・運用設計

### 並列処理・キャッシュ戦略

#### 並列スクレイピング
```typescript
// 最大3つのURLを並列処理
const results = await Promise.allSettled(
  urls.map(url => this.scrapingService.checkUrl(url))
);
```

#### 多層キャッシュ
1. **メモリキャッシュ**: 頻繁アクセスデータ (5分)
2. **ファイルキャッシュ**: スクレイピング結果 (1時間)
3. **データベースキャッシュ**: 履歴データ (永続)

### ログ・監視システム

#### 構造化ログ
```typescript
logger.info('Scraping completed', {
  urlId: url.id,
  method: 'http-only',
  responseTime: 2500,
  newItemsFound: false,
  memoryUsage: 45
});
```

#### メトリクス収集
- API応答時間
- スクレイピング成功率
- メモリ使用量
- エラー発生率

### ヘルスチェック機能

#### 4つのエンドポイント
1. `/health`: 基本ヘルスチェック
2. `/health/detailed`: 詳細状態
3. `/health/ready`: Kubernetes readiness
4. `/health/live`: Kubernetes liveness

## 拡張性設計

### 水平スケーリング対応

#### ステートレス設計
- セッション情報の外部化
- ファイルキャッシュの共有化
- データベース接続プール

#### ロードバランシング準備
- ヘルスチェック対応
- グレースフルシャットダウン
- セッションアフィニティ不要

### PostgreSQL移行準備

#### マイグレーション戦略
```typescript
// Phase 1: better-sqlite3 (現在)
// Phase 2: PostgreSQL移行
// Phase 3: 読み取り専用レプリカ
```

#### データ移行スクリプト
- スキーマ変換
- データ整合性チェック
- ロールバック機能

### 将来の技術課題

#### マイクロサービス化
- API Gateway導入
- サービス間通信 (gRPC)
- 分散トレーシング

#### 高可用性アーキテクチャ
- 複数インスタンス運用
- データベースレプリケーション
- 障害自動復旧

## 自宅サーバー最適化

### WSL2環境対応

#### メモリ管理
- ガベージコレクション最適化
- メモリリーク監視
- スワップ使用量制限

#### CPU効率化
- 非同期処理の活用
- CPU集約的処理の分散
- アイドル時間の最大化

### リソース監視

#### 閾値設定
- メモリ使用量: 250MB上限
- CPU使用率: 10%平均
- ディスク使用量: 1GB上限

#### アラート機能
- リソース使用量超過
- エラー率上昇
- 応答時間劣化

## 運用・保守

### バックアップ戦略
- データベース: 日次自動バックアップ
- 設定ファイル: Git管理
- ログファイル: 週次ローテーション

### 監視・アラート
- システムメトリクス監視
- エラーログ監視
- 外部サービス死活監視

### 保守作業
- 依存関係の定期更新
- セキュリティパッチ適用
- パフォーマンスチューニング

## バージョン情報

- **システムバージョン**: 2.0.0
- **NestJS**: 10.x
- **TypeScript**: 5.x
- **Node.js**: 20.x
- **TypeORM**: 0.3.x
- **better-sqlite3**: 9.x

