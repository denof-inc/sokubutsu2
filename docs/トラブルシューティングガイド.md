# ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚¬ã‚¤ãƒ‰ - è»½é‡ã‚½ã‚¯ãƒ–ãƒ„

## æ¦‚è¦

è»½é‡ã‚½ã‚¯ãƒ–ãƒ„ã¯ã€è‡ªå®…ã‚µãƒ¼ãƒãƒ¼ç’°å¢ƒã§ã®ç‰©ä»¶æ–°ç€ç›£è¦–ã«ç‰¹åŒ–ã—ãŸã‚·ã‚¹ãƒ†ãƒ ã§ã™ã€‚ã“ã®ã‚¬ã‚¤ãƒ‰ã§ã¯ã€é–‹ç™ºãƒ»é‹ç”¨ä¸­ã«ç™ºç”Ÿã™ã‚‹å¯èƒ½æ€§ã®ã‚ã‚‹å•é¡Œã¨è§£æ±ºç­–ã‚’åŒ…æ‹¬çš„ã«èª¬æ˜ã—ã¾ã™ã€‚è»½é‡ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ï¼ˆãƒ¡ãƒ¢ãƒª30-60MBã€èµ·å‹•æ™‚é–“1-3ç§’ï¼‰ç‰¹æœ‰ã®å•é¡Œã«ã‚‚å¯¾å¿œã—ã¦ã„ã¾ã™ã€‚

## å•é¡Œåˆ†é¡ã¨å„ªå…ˆåº¦

### ç·Šæ€¥åº¦åˆ†é¡

**ğŸ”´ Criticalï¼ˆå³åº§å¯¾å¿œï¼‰**:
- ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å®Œå…¨åœæ­¢
- ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ç ´æ
- ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ä¾µå®³
- ãƒ‡ãƒ¼ã‚¿æå¤±

**ğŸŸ¡ Highï¼ˆ24æ™‚é–“ä»¥å†…ï¼‰**:
- ç›£è¦–æ©Ÿèƒ½åœæ­¢
- é€šçŸ¥é…ä¿¡å¤±æ•—
- ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹å¤§å¹…åŠ£åŒ–
- ãƒ¡ãƒ¢ãƒªãƒªãƒ¼ã‚¯

**ğŸŸ¢ Mediumï¼ˆ1é€±é–“ä»¥å†…ï¼‰**:
- è»½å¾®ãªæ©Ÿèƒ½ä¸å…·åˆ
- ãƒ­ã‚°å‡ºåŠ›å•é¡Œ
- è¨­å®šãƒŸã‚¹
- ä¾å­˜é–¢ä¿‚è­¦å‘Š

**âšª Lowï¼ˆå®šæœŸãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹æ™‚ï¼‰**:
- æœ€é©åŒ–æ”¹å–„
- ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ›´æ–°
- éé‡è¦ãªè­¦å‘Š
- å°†æ¥çš„ãªæŠ€è¡“çš„è² å‚µ

## ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œæ™‚ã®å•é¡Œ

### èµ·å‹•å¤±æ•—

#### ç—‡çŠ¶
```bash
$ pnpm start
Error: Cannot find module 'better-sqlite3'
```

#### åŸå› ã¨è§£æ±ºç­–

**åŸå› 1: ä¾å­˜é–¢ä¿‚æœªã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«**
```bash
# è§£æ±ºç­–
pnpm install --frozen-lockfile

# ç¢ºèª
pnpm list better-sqlite3
```

**åŸå› 2: Node.js ãƒãƒ¼ã‚¸ãƒ§ãƒ³ä¸é©åˆ**
```bash
# ç¾åœ¨ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç¢ºèª
node --version

# 18.0æœªæº€ã®å ´åˆã€ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆ
# Ubuntu/WSL2
curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
sudo apt install -y nodejs

# macOS
brew upgrade node@20

# ç¢ºèª
node --version  # v20.18.0ä»¥ä¸Šã§ã‚ã‚‹ã“ã¨ã‚’ç¢ºèª
```

**åŸå› 3: ç’°å¢ƒå¤‰æ•°æœªè¨­å®š**
```bash
# .env.production ãƒ•ã‚¡ã‚¤ãƒ«ç¢ºèª
ls -la .env.production

# ãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã—ãªã„å ´åˆ
cp .env.example .env.production
nano .env.production

# å¿…é ˆç’°å¢ƒå¤‰æ•°è¨­å®š
NODE_ENV=production
DATABASE_PATH=./data/sokubutsu.db
TELEGRAM_BOT_TOKEN=your_bot_token
```

**åŸå› 4: ãƒãƒ¼ãƒˆç«¶åˆ**
```bash
# ãƒãƒ¼ãƒˆä½¿ç”¨çŠ¶æ³ç¢ºèª
lsof -i :3000
netstat -tulpn | grep :3000

# ãƒ—ãƒ­ã‚»ã‚¹çµ‚äº†
kill -9 <PID>

# åˆ¥ãƒãƒ¼ãƒˆä½¿ç”¨
PORT=3001 pnpm start
```

### ãƒ¡ãƒ¢ãƒªé–¢é€£å•é¡Œ

#### ç—‡çŠ¶
```bash
FATAL ERROR: Ineffective mark-compacts near heap limit Allocation failed - JavaScript heap out of memory
```

#### åŸå› ã¨è§£æ±ºç­–

**åŸå› 1: ãƒ¡ãƒ¢ãƒªåˆ¶é™è¨­å®šä¸é©åˆ‡**
```bash
# Node.js ãƒ¡ãƒ¢ãƒªåˆ¶é™ç¢ºèª
echo $NODE_OPTIONS

# è»½é‡ã‚½ã‚¯ãƒ–ãƒ„ç”¨æœ€é©åŒ–è¨­å®š
export NODE_OPTIONS="--max-old-space-size=256 --optimize-for-size"

# æ°¸ç¶šåŒ–ï¼ˆ.bashrc ã¾ãŸã¯ .zshrc ã«è¿½åŠ ï¼‰
echo 'export NODE_OPTIONS="--max-old-space-size=256 --optimize-for-size"' >> ~/.bashrc
source ~/.bashrc
```

**åŸå› 2: ãƒ¡ãƒ¢ãƒªãƒªãƒ¼ã‚¯**
```bash
# ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡ç›£è¦–
while true; do
  ps aux | grep "node.*sokubutsu" | grep -v grep
  sleep 10
done

# PM2ä½¿ç”¨æ™‚
pm2 monit

# ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡ãŒç¶™ç¶šçš„ã«å¢—åŠ ã™ã‚‹å ´åˆã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å†èµ·å‹•
pm2 restart sokubutsu-lightweight
```

**åŸå› 3: ã‚·ã‚¹ãƒ†ãƒ ãƒ¡ãƒ¢ãƒªä¸è¶³**
```bash
# ã‚·ã‚¹ãƒ†ãƒ ãƒ¡ãƒ¢ãƒªç¢ºèª
free -h

# ã‚¹ãƒ¯ãƒƒãƒ—ãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆï¼ˆä¸€æ™‚çš„å¯¾å‡¦ï¼‰
sudo fallocate -l 1G /swapfile
sudo chmod 600 /swapfile
sudo mkswap /swapfile
sudo swapon /swapfile

# æ°¸ç¶šåŒ–
echo '/swapfile none swap sw 0 0' | sudo tee -a /etc/fstab
```

### CPUä½¿ç”¨ç‡å•é¡Œ

#### ç—‡çŠ¶
```bash
# CPUä½¿ç”¨ç‡ãŒç¶™ç¶šçš„ã«50%ä»¥ä¸Š
top -p $(pgrep -f "node.*sokubutsu")
```

#### åŸå› ã¨è§£æ±ºç­–

**åŸå› 1: ç„¡é™ãƒ«ãƒ¼ãƒ—ã¾ãŸã¯éåŠ¹ç‡ãªã‚³ãƒ¼ãƒ‰**
```bash
# ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒªãƒ³ã‚°å®Ÿè¡Œ
node --prof src/main.js

# ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«è§£æ
node --prof-process isolate-*.log > profile.txt
less profile.txt

# å•é¡Œã®ã‚ã‚‹é–¢æ•°ã‚’ç‰¹å®šã—ã€ã‚³ãƒ¼ãƒ‰ä¿®æ­£
```

**åŸå› 2: åŒæ™‚å®Ÿè¡Œæ•°éå¤š**
```bash
# è¨­å®šç¢ºèª
grep -r "MAX_CONCURRENT" .env.production

# åŒæ™‚å®Ÿè¡Œæ•°å‰Šæ¸›
echo "MAX_CONCURRENT_CHECKS=3" >> .env.production

# ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å†èµ·å‹•
pm2 restart sokubutsu-lightweight
```

**åŸå› 3: Botå¯¾ç­–å‡¦ç†ã®è² è·**
```bash
# Botå¯¾ç­–ç„¡åŠ¹åŒ–ï¼ˆä¸€æ™‚çš„ï¼‰
echo "BOT_PROTECTION_ENABLED=false" >> .env.production

# è»½é‡Botå¯¾ç­–ã«å¤‰æ›´
echo "BOT_PROTECTION_LEVEL=light" >> .env.production

# ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å†èµ·å‹•
pm2 restart sokubutsu-lightweight
```

## ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹é–¢é€£ã®å•é¡Œ

### ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šã‚¨ãƒ©ãƒ¼

#### ç—‡çŠ¶
```bash
Error: SQLITE_CANTOPEN: unable to open database file
```

#### åŸå› ã¨è§£æ±ºç­–

**åŸå› 1: ãƒ•ã‚¡ã‚¤ãƒ«æ¨©é™å•é¡Œ**
```bash
# ãƒ•ã‚¡ã‚¤ãƒ«æ¨©é™ç¢ºèª
ls -la data/sokubutsu.db

# æ¨©é™ä¿®æ­£
chmod 600 data/sokubutsu.db
chown $USER:$USER data/sokubutsu.db

# ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ¨©é™ç¢ºèª
ls -la data/
chmod 755 data/
```

**åŸå› 2: ãƒ‡ã‚£ã‚¹ã‚¯å®¹é‡ä¸è¶³**
```bash
# ãƒ‡ã‚£ã‚¹ã‚¯ä½¿ç”¨é‡ç¢ºèª
df -h

# ä¸è¦ãƒ•ã‚¡ã‚¤ãƒ«å‰Šé™¤
# å¤ã„ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«
find logs/ -name "*.log" -mtime +7 -delete

# å¤ã„ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ•ã‚¡ã‚¤ãƒ«
find cache/ -type f -mtime +1 -delete

# å¤ã„ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ•ã‚¡ã‚¤ãƒ«
find backups/ -name "*.tar.gz" -mtime +30 -delete
```

**åŸå› 3: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ•ã‚¡ã‚¤ãƒ«ç ´æ**
```bash
# æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯
sqlite3 data/sokubutsu.db "PRAGMA integrity_check;"

# ç ´æã—ã¦ã„ã‚‹å ´åˆ
# 1. ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‹ã‚‰å¾©å…ƒ
ls -la backups/sokubutsu_*.tar.gz
./scripts/rollback.sh 1

# 2. ã¾ãŸã¯æ–°è¦ä½œæˆ
mv data/sokubutsu.db data/sokubutsu.db.corrupted
pnpm db:init
pnpm db:seed
```

### ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ­ãƒƒã‚¯å•é¡Œ

#### ç—‡çŠ¶
```bash
Error: SQLITE_BUSY: database is locked
```

#### åŸå› ã¨è§£æ±ºç­–

**åŸå› 1: è¤‡æ•°ãƒ—ãƒ­ã‚»ã‚¹ã‹ã‚‰ã®åŒæ™‚ã‚¢ã‚¯ã‚»ã‚¹**
```bash
# å®Ÿè¡Œä¸­ã®ãƒ—ãƒ­ã‚»ã‚¹ç¢ºèª
ps aux | grep "node.*sokubutsu"

# é‡è¤‡ãƒ—ãƒ­ã‚»ã‚¹çµ‚äº†
pkill -f "node.*sokubutsu"

# PM2ã§ç®¡ç†ã•ã‚Œã¦ã„ã‚‹å ´åˆ
pm2 delete all
pm2 start ecosystem.config.js
```

**åŸå› 2: WALãƒ•ã‚¡ã‚¤ãƒ«ã®å•é¡Œ**
```bash
# WALãƒ•ã‚¡ã‚¤ãƒ«ç¢ºèª
ls -la data/sokubutsu.db*

# WALãƒ•ã‚¡ã‚¤ãƒ«ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
sqlite3 data/sokubutsu.db "PRAGMA wal_checkpoint(TRUNCATE);"

# å¿…è¦ã«å¿œã˜ã¦WALãƒ•ã‚¡ã‚¤ãƒ«å‰Šé™¤
rm -f data/sokubutsu.db-wal data/sokubutsu.db-shm
```

**åŸå› 3: é•·æ™‚é–“å®Ÿè¡Œä¸­ã®ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³**
```bash
# ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å†èµ·å‹•
pm2 restart sokubutsu-lightweight

# ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šãƒ—ãƒ¼ãƒ«è¨­å®šç¢ºèª
grep -r "connection" src/services/database.js

# æ¥ç¶šã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆè¨­å®šè¿½åŠ 
# database.js ã«ä»¥ä¸‹ã‚’è¿½åŠ 
const db = new Database(dbPath, {
  timeout: 5000,  // 5ç§’ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ
  pragma: {
    busy_timeout: 30000  // 30ç§’å¾…æ©Ÿ
  }
});
```

### ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹å•é¡Œ

#### ç—‡çŠ¶
```bash
# ã‚¯ã‚¨ãƒªå®Ÿè¡Œæ™‚é–“ãŒ5ç§’ä»¥ä¸Š
```

#### åŸå› ã¨è§£æ±ºç­–

**åŸå› 1: ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ä¸è¶³**
```bash
# ã‚¯ã‚¨ãƒªãƒ—ãƒ©ãƒ³ç¢ºèª
sqlite3 data/sokubutsu.db "EXPLAIN QUERY PLAN SELECT * FROM monitoring_logs WHERE url_id = 'test';"

# ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ç¢ºèª
sqlite3 data/sokubutsu.db ".indices monitoring_logs"

# å¿…è¦ã«å¿œã˜ã¦ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹è¿½åŠ 
sqlite3 data/sokubutsu.db "CREATE INDEX IF NOT EXISTS idx_logs_url_checked ON monitoring_logs(url_id, checked_at DESC);"
```

**åŸå› 2: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚µã‚¤ã‚ºè‚¥å¤§åŒ–**
```bash
# ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚µã‚¤ã‚ºç¢ºèª
ls -lh data/sokubutsu.db

# å¤ã„ãƒ‡ãƒ¼ã‚¿ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
sqlite3 data/sokubutsu.db "DELETE FROM monitoring_logs WHERE created_at < datetime('now', '-30 days');"

# ãƒã‚­ãƒ¥ãƒ¼ãƒ å®Ÿè¡Œ
sqlite3 data/sokubutsu.db "VACUUM;"

# çµ±è¨ˆæƒ…å ±æ›´æ–°
sqlite3 data/sokubutsu.db "ANALYZE;"
```

**åŸå› 3: WALãƒ•ã‚¡ã‚¤ãƒ«è‚¥å¤§åŒ–**
```bash
# WALãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºç¢ºèª
ls -lh data/sokubutsu.db-wal

# WALãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆå®Ÿè¡Œ
sqlite3 data/sokubutsu.db "PRAGMA wal_checkpoint(TRUNCATE);"

# è‡ªå‹•ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆè¨­å®š
sqlite3 data/sokubutsu.db "PRAGMA wal_autocheckpoint=1000;"
```

## ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°é–¢é€£ã®å•é¡Œ

### Botæ¤œçŸ¥ãƒ»ãƒ–ãƒ­ãƒƒã‚¯

#### ç—‡çŠ¶
```bash
# ãƒ­ã‚°ã«ä»¥ä¸‹ã®ã‚ˆã†ãªã‚¨ãƒ©ãƒ¼
Error: Request failed with status 403
Error: Captcha detected
Error: Access denied
```

#### åŸå› ã¨è§£æ±ºç­–

**åŸå› 1: User-Agentæ¤œçŸ¥**
```bash
# User-Agentç¢ºèª
grep -r "User-Agent" src/services/scraping.js

# User-Agentãƒ­ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³æœ‰åŠ¹åŒ–
echo "USER_AGENT_ROTATION=true" >> .env.production

# æ‰‹å‹•ã§User-Agentæ›´æ–°
# src/utils/user-agents.js ã‚’ç·¨é›†
const userAgents = [
  'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36',
  'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36',
  // æœ€æ–°ã®User-Agentã‚’è¿½åŠ 
];
```

**åŸå› 2: ã‚¢ã‚¯ã‚»ã‚¹é »åº¦éå¤š**
```bash
# ç›£è¦–é–“éš”ç¢ºèª
grep "MONITORING_INTERVAL" .env.production

# é–“éš”ã‚’å»¶é•·
sed -i 's/MONITORING_INTERVAL=300/MONITORING_INTERVAL=600/' .env.production

# åŒæ™‚å®Ÿè¡Œæ•°å‰Šæ¸›
sed -i 's/MAX_CONCURRENT_CHECKS=5/MAX_CONCURRENT_CHECKS=2/' .env.production

# ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å†èµ·å‹•
pm2 restart sokubutsu-lightweight
```

**åŸå› 3: Botå¯¾ç­–ä¸ååˆ†**
```bash
# Botå¯¾ç­–å¼·åŒ–
echo "BOT_PROTECTION_LEVEL=strict" >> .env.production

# GoogleçµŒç”±ã‚¢ã‚¯ã‚»ã‚¹æœ‰åŠ¹åŒ–
echo "GOOGLE_BYPASS_ENABLED=true" >> .env.production

# ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†æœ‰åŠ¹åŒ–
echo "SESSION_MANAGEMENT=true" >> .env.production

# ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å†èµ·å‹•
pm2 restart sokubutsu-lightweight
```

### ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°å¤±æ•—

#### ç—‡çŠ¶
```bash
# ãƒ­ã‚°ã«ä»¥ä¸‹ã®ã‚ˆã†ãªã‚¨ãƒ©ãƒ¼
Error: Timeout waiting for page load
Error: Element not found
Error: Network error
```

#### åŸå› ã¨è§£æ±ºç­–

**åŸå› 1: ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯å•é¡Œ**
```bash
# æ¥ç¶šãƒ†ã‚¹ãƒˆ
curl -I https://suumo.jp/

# DNSç¢ºèª
nslookup suumo.jp

# ãƒ—ãƒ­ã‚­ã‚·è¨­å®šç¢ºèª
echo $http_proxy
echo $https_proxy

# ãƒ—ãƒ­ã‚­ã‚·ç„¡åŠ¹åŒ–ï¼ˆå¿…è¦ã«å¿œã˜ã¦ï¼‰
unset http_proxy https_proxy
```

**åŸå› 2: ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆè¨­å®šä¸é©åˆ‡**
```bash
# ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆè¨­å®šç¢ºèª
grep -r "timeout" src/services/scraping.js

# ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆå»¶é•·
sed -i 's/REQUEST_TIMEOUT=10000/REQUEST_TIMEOUT=30000/' .env.production

# ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å†èµ·å‹•
pm2 restart sokubutsu-lightweight
```

**åŸå› 3: ã‚µã‚¤ãƒˆæ§‹é€ å¤‰æ›´**
```bash
# ã‚»ãƒ¬ã‚¯ã‚¿ç¢ºèª
grep -r "selector" src/services/scraping.js

# æ‰‹å‹•ã§ã‚µã‚¤ãƒˆç¢ºèª
curl -s "https://suumo.jp/test-url" | grep -i "ç‰©ä»¶"

# ã‚»ãƒ¬ã‚¯ã‚¿æ›´æ–°ï¼ˆå¿…è¦ã«å¿œã˜ã¦ï¼‰
# src/config/selectors.js ã‚’ç·¨é›†
```

### ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡å¢—åŠ 

#### ç—‡çŠ¶
```bash
# ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°å®Ÿè¡Œå¾Œã«ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡ãŒå¢—åŠ ã—ç¶šã‘ã‚‹
```

#### åŸå› ã¨è§£æ±ºç­–

**åŸå› 1: DOMã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ãƒ¡ãƒ¢ãƒªãƒªãƒ¼ã‚¯**
```bash
# JSDOMä½¿ç”¨æ™‚ã®ãƒ¡ãƒ¢ãƒªãƒªãƒ¼ã‚¯å¯¾ç­–
# src/services/scraping.js ã‚’ç¢ºèª

// ä¿®æ­£ä¾‹
const { JSDOM } = require('jsdom');

async function scrapePage(html) {
  const dom = new JSDOM(html);
  try {
    // ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°å‡¦ç†
    const result = extractData(dom.window.document);
    return result;
  } finally {
    // æ˜ç¤ºçš„ã«ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
    dom.window.close();
  }
}
```

**åŸå› 2: ã‚­ãƒ£ãƒƒã‚·ãƒ¥è‚¥å¤§åŒ–**
```bash
# ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚µã‚¤ã‚ºç¢ºèª
du -sh cache/

# ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªã‚¢
rm -rf cache/*
mkdir -p cache/production

# ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚µã‚¤ã‚ºåˆ¶é™è¨­å®š
echo "CACHE_MAX_SIZE=50" >> .env.production  # 50MBåˆ¶é™
```

**åŸå› 3: éåŒæœŸå‡¦ç†ã®æœªå®Œäº†**
```bash
# éåŒæœŸå‡¦ç†ç¢ºèª
grep -r "Promise\|async\|await" src/services/scraping.js

# Promise.allSettledä½¿ç”¨ã§ç¢ºå®Ÿã«å®Œäº†å¾…æ©Ÿ
// ä¿®æ­£ä¾‹
const results = await Promise.allSettled(
  urls.map(url => scrapePage(url))
);
```

## Telegram Boté–¢é€£ã®å•é¡Œ

### Botå¿œç­”ãªã—

#### ç—‡çŠ¶
```bash
# Telegramã§ã‚³ãƒãƒ³ãƒ‰é€ä¿¡ã—ã¦ã‚‚å¿œç­”ãŒãªã„
```

#### åŸå› ã¨è§£æ±ºç­–

**åŸå› 1: Bot Tokenç„¡åŠ¹**
```bash
# Bot Tokenç¢ºèª
grep "TELEGRAM_BOT_TOKEN" .env.production

# Tokenæœ‰åŠ¹æ€§ç¢ºèª
curl "https://api.telegram.org/bot<YOUR_BOT_TOKEN>/getMe"

# æ­£å¸¸ãªå¿œç­”ä¾‹
{"ok":true,"result":{"id":123456789,"is_bot":true,"first_name":"SokubutsuBot"}}

# ã‚¨ãƒ©ãƒ¼ã®å ´åˆã€æ–°ã—ã„Tokenã‚’å–å¾—
# @BotFatherã« /newbot ã‚³ãƒãƒ³ãƒ‰ã§æ–°è¦ä½œæˆ
```

**åŸå› 2: Webhookè¨­å®šå•é¡Œ**
```bash
# WebhookçŠ¶æ…‹ç¢ºèª
curl "https://api.telegram.org/bot<YOUR_BOT_TOKEN>/getWebhookInfo"

# Webhookå‰Šé™¤ï¼ˆpollingä½¿ç”¨æ™‚ï¼‰
curl -X POST "https://api.telegram.org/bot<YOUR_BOT_TOKEN>/deleteWebhook"

# ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å†èµ·å‹•
pm2 restart sokubutsu-lightweight
```

**åŸå› 3: ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯åˆ¶é™**
```bash
# Telegram APIæ¥ç¶šãƒ†ã‚¹ãƒˆ
curl -I https://api.telegram.org/

# ãƒ•ã‚¡ã‚¤ã‚¢ã‚¦ã‚©ãƒ¼ãƒ«ç¢ºèª
sudo ufw status

# å¿…è¦ã«å¿œã˜ã¦HTTPSè¨±å¯
sudo ufw allow out 443
```

### é€šçŸ¥é€ä¿¡å¤±æ•—

#### ç—‡çŠ¶
```bash
# ãƒ­ã‚°ã«ä»¥ä¸‹ã®ã‚ˆã†ãªã‚¨ãƒ©ãƒ¼
Error: Telegram API error: 400 Bad Request
Error: Chat not found
```

#### åŸå› ã¨è§£æ±ºç­–

**åŸå› 1: Chat IDä¸æ­£**
```bash
# Chat IDç¢ºèª
sqlite3 data/sokubutsu.db "SELECT id, username FROM users;"

# Chat IDå–å¾—æ–¹æ³•
# 1. ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒBotã« /start ã‚³ãƒãƒ³ãƒ‰é€ä¿¡
# 2. ãƒ­ã‚°ã§Chat IDã‚’ç¢ºèª
# 3. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«æ­£ã—ãä¿å­˜ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
```

**åŸå› 2: ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å½¢å¼ã‚¨ãƒ©ãƒ¼**
```bash
# ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é•·ã•ç¢ºèªï¼ˆ4096æ–‡å­—åˆ¶é™ï¼‰
grep -r "sendMessage" src/services/telegram.js

# é•·ã„ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®åˆ†å‰²å‡¦ç†è¿½åŠ 
function splitMessage(text, maxLength = 4000) {
  if (text.length <= maxLength) return [text];
  
  const chunks = [];
  let start = 0;
  
  while (start < text.length) {
    chunks.push(text.slice(start, start + maxLength));
    start += maxLength;
  }
  
  return chunks;
}
```

**åŸå› 3: ãƒ¬ãƒ¼ãƒˆåˆ¶é™**
```bash
# ãƒ¬ãƒ¼ãƒˆåˆ¶é™ã‚¨ãƒ©ãƒ¼ç¢ºèª
grep -i "rate limit\|too many" logs/sokubutsu.log

# é€ä¿¡é–“éš”èª¿æ•´
echo "TELEGRAM_RATE_LIMIT=1000" >> .env.production  # 1ç§’é–“éš”

# ãƒãƒƒãƒé€ä¿¡å®Ÿè£…
// src/services/telegram.js
class TelegramService {
  constructor() {
    this.messageQueue = [];
    this.processing = false;
  }
  
  async sendMessage(chatId, text) {
    this.messageQueue.push({ chatId, text });
    if (!this.processing) {
      this.processQueue();
    }
  }
  
  async processQueue() {
    this.processing = true;
    while (this.messageQueue.length > 0) {
      const { chatId, text } = this.messageQueue.shift();
      await this.sendMessageDirect(chatId, text);
      await new Promise(resolve => setTimeout(resolve, 1000)); // 1ç§’å¾…æ©Ÿ
    }
    this.processing = false;
  }
}
```

## ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹é–¢é€£ã®å•é¡Œ

### ãƒ¬ã‚¹ãƒãƒ³ã‚¹æ™‚é–“é…å»¶

#### ç—‡çŠ¶
```bash
# APIå¿œç­”æ™‚é–“ãŒ5ç§’ä»¥ä¸Š
curl -w "@curl-format.txt" -o /dev/null -s "http://localhost:3000/health"
```

#### åŸå› ã¨è§£æ±ºç­–

**åŸå› 1: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¯ã‚¨ãƒªæœ€é©åŒ–ä¸è¶³**
```bash
# ã‚¹ãƒ­ãƒ¼ã‚¯ã‚¨ãƒªç‰¹å®š
# SQLiteã§ã‚¯ã‚¨ãƒªãƒ—ãƒ©ãƒ³ç¢ºèª
sqlite3 data/sokubutsu.db "EXPLAIN QUERY PLAN SELECT * FROM monitoring_logs ORDER BY checked_at DESC LIMIT 10;"

# ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹è¿½åŠ 
sqlite3 data/sokubutsu.db "CREATE INDEX IF NOT EXISTS idx_logs_checked_desc ON monitoring_logs(checked_at DESC);"

# çµ±è¨ˆæƒ…å ±æ›´æ–°
sqlite3 data/sokubutsu.db "ANALYZE;"
```

**åŸå› 2: åŒæœŸå‡¦ç†ã®ãƒ–ãƒ­ãƒƒã‚­ãƒ³ã‚°**
```bash
# éåŒæœŸå‡¦ç†ç¢ºèª
grep -r "\.sync\|Sync(" src/

# åŒæœŸå‡¦ç†ã‚’éåŒæœŸã«å¤‰æ›´
// ä¿®æ­£å‰
const result = fs.readFileSync('data.json');

// ä¿®æ­£å¾Œ
const result = await fs.promises.readFile('data.json');
```

**åŸå› 3: ãƒ¡ãƒ¢ãƒªä¸è¶³ã«ã‚ˆã‚‹ã‚¹ãƒ¯ãƒƒãƒ—**
```bash
# ã‚¹ãƒ¯ãƒƒãƒ—ä½¿ç”¨é‡ç¢ºèª
free -h
swapon --show

# ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡æœ€é©åŒ–
export NODE_OPTIONS="--max-old-space-size=256"

# ä¸è¦ãªãƒ—ãƒ­ã‚»ã‚¹çµ‚äº†
ps aux --sort=-%mem | head -10
```

### é«˜CPUä½¿ç”¨ç‡

#### ç—‡çŠ¶
```bash
# CPUä½¿ç”¨ç‡ãŒç¶™ç¶šçš„ã«70%ä»¥ä¸Š
top -p $(pgrep -f "node.*sokubutsu")
```

#### åŸå› ã¨è§£æ±ºç­–

**åŸå› 1: ç„¡é™ãƒ«ãƒ¼ãƒ—**
```bash
# ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒªãƒ³ã‚°å®Ÿè¡Œ
node --prof --prof-process-on-exit src/main.js

# CPUé›†ç´„çš„ãªå‡¦ç†ç‰¹å®š
grep -r "while\|for\|setInterval" src/

# å‡¦ç†é–“éš”èª¿æ•´
// ä¿®æ­£ä¾‹
setInterval(() => {
  // å‡¦ç†
}, 5000); // 5ç§’é–“éš”ã«å»¶é•·
```

**åŸå› 2: æ­£è¦è¡¨ç¾ã®éåŠ¹ç‡æ€§**
```bash
# æ­£è¦è¡¨ç¾ç¢ºèª
grep -r "RegExp\|\/.*\/" src/

# æ­£è¦è¡¨ç¾æœ€é©åŒ–
// ä¿®æ­£å‰ï¼ˆéåŠ¹ç‡ï¼‰
const regex = new RegExp(pattern, 'g');
text.match(regex);

// ä¿®æ­£å¾Œï¼ˆåŠ¹ç‡çš„ï¼‰
const regex = /pattern/g;
regex.test(text);
```

**åŸå› 3: å¤§é‡ãƒ‡ãƒ¼ã‚¿å‡¦ç†**
```bash
# å¤§é‡ãƒ‡ãƒ¼ã‚¿å‡¦ç†ã®åˆ†å‰²
// ä¿®æ­£ä¾‹
async function processLargeDataset(data) {
  const batchSize = 100;
  for (let i = 0; i < data.length; i += batchSize) {
    const batch = data.slice(i, i + batchSize);
    await processBatch(batch);
    
    // CPUä¼‘æ†©
    await new Promise(resolve => setTimeout(resolve, 10));
  }
}
```

## ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯é–¢é€£ã®å•é¡Œ

### æ¥ç¶šã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ

#### ç—‡çŠ¶
```bash
Error: connect ETIMEDOUT
Error: socket hang up
```

#### åŸå› ã¨è§£æ±ºç­–

**åŸå› 1: ãƒ•ã‚¡ã‚¤ã‚¢ã‚¦ã‚©ãƒ¼ãƒ«è¨­å®š**
```bash
# ãƒ•ã‚¡ã‚¤ã‚¢ã‚¦ã‚©ãƒ¼ãƒ«çŠ¶æ…‹ç¢ºèª
sudo ufw status verbose

# å¿…è¦ãªãƒãƒ¼ãƒˆè¨±å¯
sudo ufw allow out 80
sudo ufw allow out 443

# ç‰¹å®šãƒ‰ãƒ¡ã‚¤ãƒ³ã¸ã®æ¥ç¶šãƒ†ã‚¹ãƒˆ
curl -v https://suumo.jp/
```

**åŸå› 2: DNSè§£æ±ºå•é¡Œ**
```bash
# DNSè¨­å®šç¢ºèª
cat /etc/resolv.conf

# DNSå¤‰æ›´ï¼ˆGoogle DNSä½¿ç”¨ï¼‰
echo "nameserver 8.8.8.8" | sudo tee /etc/resolv.conf
echo "nameserver 8.8.4.4" | sudo tee -a /etc/resolv.conf

# DNS ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªã‚¢
sudo systemctl restart systemd-resolved
```

**åŸå› 3: ãƒ—ãƒ­ã‚­ã‚·è¨­å®š**
```bash
# ãƒ—ãƒ­ã‚­ã‚·ç’°å¢ƒå¤‰æ•°ç¢ºèª
env | grep -i proxy

# ãƒ—ãƒ­ã‚­ã‚·ç„¡åŠ¹åŒ–
unset http_proxy https_proxy HTTP_PROXY HTTPS_PROXY

# ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å†èµ·å‹•
pm2 restart sokubutsu-lightweight
```

### SSL/TLSè¨¼æ˜æ›¸ã‚¨ãƒ©ãƒ¼

#### ç—‡çŠ¶
```bash
Error: unable to verify the first certificate
Error: certificate has expired
```

#### åŸå› ã¨è§£æ±ºç­–

**åŸå› 1: è¨¼æ˜æ›¸æœŸé™åˆ‡ã‚Œ**
```bash
# è¨¼æ˜æ›¸ç¢ºèª
openssl s_client -connect suumo.jp:443 -servername suumo.jp

# ã‚·ã‚¹ãƒ†ãƒ è¨¼æ˜æ›¸æ›´æ–°
sudo apt update && sudo apt upgrade ca-certificates

# Node.jsè¨¼æ˜æ›¸è¨­å®š
export NODE_TLS_REJECT_UNAUTHORIZED=0  # ä¸€æ™‚çš„å¯¾å‡¦ï¼ˆéæ¨å¥¨ï¼‰
```

**åŸå› 2: ä¸­é–“è¨¼æ˜æ›¸å•é¡Œ**
```bash
# è¨¼æ˜æ›¸ãƒã‚§ãƒ¼ãƒ³ç¢ºèª
curl -vI https://suumo.jp/

# è¨¼æ˜æ›¸ãƒãƒ³ãƒ‰ãƒ«æ›´æ–°
sudo update-ca-certificates
```

## ãƒ­ã‚°ãƒ»ãƒ‡ãƒãƒƒã‚°é–¢é€£ã®å•é¡Œ

### ãƒ­ã‚°å‡ºåŠ›ã•ã‚Œãªã„

#### ç—‡çŠ¶
```bash
# ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ãŒç©ºã¾ãŸã¯æ›´æ–°ã•ã‚Œãªã„
ls -la logs/
```

#### åŸå› ã¨è§£æ±ºç­–

**åŸå› 1: ãƒ­ã‚°ãƒ¬ãƒ™ãƒ«è¨­å®š**
```bash
# ãƒ­ã‚°ãƒ¬ãƒ™ãƒ«ç¢ºèª
grep "LOG_LEVEL" .env.production

# ãƒ‡ãƒãƒƒã‚°ãƒ¬ãƒ™ãƒ«ã«å¤‰æ›´
sed -i 's/LOG_LEVEL=warn/LOG_LEVEL=debug/' .env.production

# ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å†èµ·å‹•
pm2 restart sokubutsu-lightweight
```

**åŸå› 2: ãƒ•ã‚¡ã‚¤ãƒ«æ¨©é™å•é¡Œ**
```bash
# ãƒ­ã‚°ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ¨©é™ç¢ºèª
ls -la logs/

# æ¨©é™ä¿®æ­£
chmod 755 logs/
chmod 644 logs/*.log

# ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆ
touch logs/sokubutsu.log
chmod 644 logs/sokubutsu.log
```

**åŸå› 3: ãƒ‡ã‚£ã‚¹ã‚¯å®¹é‡ä¸è¶³**
```bash
# ãƒ‡ã‚£ã‚¹ã‚¯ä½¿ç”¨é‡ç¢ºèª
df -h

# å¤ã„ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«å‰Šé™¤
find logs/ -name "*.log" -mtime +7 -delete

# ãƒ­ã‚°ãƒ­ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³è¨­å®š
# logrotateè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆ
sudo tee /etc/logrotate.d/sokubutsu << 'EOF'
/home/ubuntu/apps/sokubutsu2/logs/*.log {
    daily
    missingok
    rotate 7
    compress
    notifempty
    create 644 ubuntu ubuntu
}
EOF
```

### ãƒ‡ãƒãƒƒã‚°æƒ…å ±ä¸è¶³

#### ç—‡çŠ¶
```bash
# ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒä¸ååˆ†
Error: Something went wrong
```

#### åŸå› ã¨è§£æ±ºç­–

**åŸå› 1: ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ä¸é©åˆ‡**
```bash
# ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°æ”¹å–„
// ä¿®æ­£å‰
try {
  await someOperation();
} catch (error) {
  console.log('Error occurred');
}

// ä¿®æ­£å¾Œ
try {
  await someOperation();
} catch (error) {
  console.error('Operation failed:', {
    message: error.message,
    stack: error.stack,
    timestamp: new Date().toISOString(),
    context: { /* é–¢é€£æƒ…å ± */ }
  });
}
```

**åŸå› 2: ãƒ­ã‚°æ§‹é€ åŒ–ä¸è¶³**
```bash
# æ§‹é€ åŒ–ãƒ­ã‚°å®Ÿè£…
const logger = {
  info: (message, data = {}) => {
    console.log(JSON.stringify({
      level: 'info',
      message,
      timestamp: new Date().toISOString(),
      ...data
    }));
  },
  error: (message, error, data = {}) => {
    console.error(JSON.stringify({
      level: 'error',
      message,
      error: {
        message: error.message,
        stack: error.stack
      },
      timestamp: new Date().toISOString(),
      ...data
    }));
  }
};
```

## ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£é–¢é€£ã®å•é¡Œ

### ä¸æ­£ã‚¢ã‚¯ã‚»ã‚¹æ¤œçŸ¥

#### ç—‡çŠ¶
```bash
# ãƒ­ã‚°ã«ä¸å¯©ãªã‚¢ã‚¯ã‚»ã‚¹è¨˜éŒ²
grep -i "unauthorized\|forbidden\|attack" logs/sokubutsu.log
```

#### åŸå› ã¨è§£æ±ºç­–

**åŸå› 1: èªè¨¼ä¸å‚™**
```bash
# APIèªè¨¼ç¢ºèª
grep -r "auth\|token" src/

# åŸºæœ¬èªè¨¼è¿½åŠ 
// middleware/auth.js
function authenticate(req, res, next) {
  const token = req.headers.authorization;
  if (!token || !validateToken(token)) {
    return res.status(401).json({ error: 'Unauthorized' });
  }
  next();
}
```

**åŸå› 2: ãƒ¬ãƒ¼ãƒˆåˆ¶é™ãªã—**
```bash
# ãƒ¬ãƒ¼ãƒˆåˆ¶é™å®Ÿè£…
npm install express-rate-limit

// app.js
const rateLimit = require('express-rate-limit');

const limiter = rateLimit({
  windowMs: 15 * 60 * 1000, // 15åˆ†
  max: 100, // æœ€å¤§100ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
  message: 'Too many requests'
});

app.use('/api/', limiter);
```

**åŸå› 3: å…¥åŠ›å€¤æ¤œè¨¼ä¸è¶³**
```bash
# å…¥åŠ›å€¤æ¤œè¨¼è¿½åŠ 
npm install joi

// validation/schemas.js
const Joi = require('joi');

const urlSchema = Joi.object({
  url: Joi.string().uri().required(),
  name: Joi.string().min(1).max(100).required(),
  interval: Joi.number().min(300).max(3600).required()
});

// ä½¿ç”¨ä¾‹
const { error, value } = urlSchema.validate(req.body);
if (error) {
  return res.status(400).json({ error: error.details[0].message });
}
```

### æ©Ÿå¯†æƒ…å ±æ¼æ´©

#### ç—‡çŠ¶
```bash
# ãƒ­ã‚°ã«æ©Ÿå¯†æƒ…å ±ãŒå‡ºåŠ›ã•ã‚Œã¦ã„ã‚‹
grep -r "password\|token\|secret" logs/
```

#### åŸå› ã¨è§£æ±ºç­–

**åŸå› 1: ãƒ­ã‚°å‡ºåŠ›æ™‚ã®æ©Ÿå¯†æƒ…å ±å«æœ‰**
```bash
# ãƒ­ã‚°ã‚µãƒ‹ã‚¿ã‚¤ã‚ºå®Ÿè£…
function sanitizeLog(data) {
  const sensitiveFields = ['password', 'token', 'secret', 'key'];
  const sanitized = { ...data };
  
  for (const field of sensitiveFields) {
    if (sanitized[field]) {
      sanitized[field] = '***REDACTED***';
    }
  }
  
  return sanitized;
}

// ä½¿ç”¨ä¾‹
logger.info('User data', sanitizeLog(userData));
```

**åŸå› 2: ç’°å¢ƒå¤‰æ•°ã®ä¸é©åˆ‡ãªç®¡ç†**
```bash
# .env ãƒ•ã‚¡ã‚¤ãƒ«æ¨©é™ç¢ºèª
ls -la .env*

# æ¨©é™ä¿®æ­£
chmod 600 .env.production

# Gitè¿½è·¡é™¤å¤–ç¢ºèª
grep -r "\.env" .gitignore

# å¿…è¦ã«å¿œã˜ã¦è¿½åŠ 
echo ".env*" >> .gitignore
```

## ç·Šæ€¥æ™‚å¯¾å¿œæ‰‹é †

### ã‚µãƒ¼ãƒ“ã‚¹å®Œå…¨åœæ­¢

#### å³åº§å®Ÿè¡Œæ‰‹é †

```bash
# 1. ç¾åœ¨ã®çŠ¶æ³ç¢ºèª
pm2 status
ps aux | grep node

# 2. ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³åœæ­¢
pm2 stop all
pm2 delete all

# 3. ç·Šæ€¥ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä½œæˆ
TIMESTAMP=$(date +%Y%m%d_%H%M%S)
tar -czf "emergency_backup_$TIMESTAMP.tar.gz" data/ logs/ .env.production

# 4. å•é¡Œèª¿æŸ»
tail -100 logs/sokubutsu.log
tail -100 logs/pm2-error.log

# 5. å¾©æ—§è©¦è¡Œ
pm2 start ecosystem.config.js

# 6. å‹•ä½œç¢ºèª
curl http://localhost:3000/health
```

### ãƒ‡ãƒ¼ã‚¿ç ´æå¯¾å¿œ

#### å¾©æ—§æ‰‹é †

```bash
# 1. è¢«å®³çŠ¶æ³ç¢ºèª
sqlite3 data/sokubutsu.db "PRAGMA integrity_check;"

# 2. æœ€æ–°ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ç¢ºèª
ls -la backups/sokubutsu_*.tar.gz | tail -5

# 3. ã‚µãƒ¼ãƒ“ã‚¹åœæ­¢
pm2 stop sokubutsu-lightweight

# 4. ç ´æãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ä¿å­˜
mv data/sokubutsu.db data/sokubutsu.db.corrupted_$(date +%Y%m%d_%H%M%S)

# 5. ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‹ã‚‰å¾©å…ƒ
./scripts/rollback.sh 1

# 6. æ•´åˆæ€§ç¢ºèª
sqlite3 data/sokubutsu.db "PRAGMA integrity_check;"

# 7. ã‚µãƒ¼ãƒ“ã‚¹å†é–‹
pm2 start sokubutsu-lightweight

# 8. å‹•ä½œç¢ºèª
curl http://localhost:3000/health
```

### ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ä¾µå®³å¯¾å¿œ

#### å¯¾å¿œæ‰‹é †

```bash
# 1. å³åº§ã«ã‚µãƒ¼ãƒ“ã‚¹åœæ­¢
pm2 stop all

# 2. ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯é®æ–­
sudo ufw deny in
sudo ufw deny out

# 3. ãƒ­ã‚°ä¿å…¨
cp -r logs/ security_incident_$(date +%Y%m%d_%H%M%S)/

# 4. ä¾µå®³ç¯„å›²èª¿æŸ»
grep -r "unauthorized\|attack\|intrusion" logs/
last -n 50  # ãƒ­ã‚°ã‚¤ãƒ³å±¥æ­´ç¢ºèª

# 5. ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒ»ãƒˆãƒ¼ã‚¯ãƒ³å¤‰æ›´
# Telegram Bot Tokenå†ç”Ÿæˆ
# ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´ï¼ˆè©²å½“ã™ã‚‹å ´åˆï¼‰

# 6. ã‚·ã‚¹ãƒ†ãƒ æ›´æ–°
sudo apt update && sudo apt upgrade -y

# 7. è¨­å®šè¦‹ç›´ã—
# ãƒ•ã‚¡ã‚¤ã‚¢ã‚¦ã‚©ãƒ¼ãƒ«è¨­å®šå¼·åŒ–
# èªè¨¼æ©Ÿèƒ½è¿½åŠ 
# ãƒ­ã‚°ç›£è¦–å¼·åŒ–

# 8. æ®µéšçš„å¾©æ—§
# ãƒ†ã‚¹ãƒˆç’°å¢ƒã§å‹•ä½œç¢ºèªå¾Œã€æœ¬ç•ªç’°å¢ƒå¾©æ—§
```

## äºˆé˜²ä¿å®ˆ

### å®šæœŸãƒã‚§ãƒƒã‚¯é …ç›®

#### æ—¥æ¬¡ãƒã‚§ãƒƒã‚¯

```bash
#!/bin/bash
# daily-check.sh

echo "=== è»½é‡ã‚½ã‚¯ãƒ–ãƒ„æ—¥æ¬¡ãƒã‚§ãƒƒã‚¯ $(date) ==="

# 1. ã‚µãƒ¼ãƒ“ã‚¹çŠ¶æ…‹ç¢ºèª
echo "1. ã‚µãƒ¼ãƒ“ã‚¹çŠ¶æ…‹:"
pm2 status | grep sokubutsu-lightweight

# 2. ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡ç¢ºèª
echo "2. ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡:"
ps aux | grep "node.*sokubutsu" | grep -v grep | awk '{print $4 "% " $6/1024 "MB"}'

# 3. ãƒ‡ã‚£ã‚¹ã‚¯ä½¿ç”¨é‡ç¢ºèª
echo "3. ãƒ‡ã‚£ã‚¹ã‚¯ä½¿ç”¨é‡:"
df -h | grep -E "/$|/home"

# 4. ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ç¢ºèª
echo "4. æœ€æ–°ã‚¨ãƒ©ãƒ¼:"
tail -10 logs/sokubutsu.log | grep -i error || echo "ã‚¨ãƒ©ãƒ¼ãªã—"

# 5. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ•´åˆæ€§
echo "5. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ•´åˆæ€§:"
sqlite3 data/sokubutsu.db "PRAGMA integrity_check;" | head -1

# 6. ç›£è¦–URLæ•°ç¢ºèª
echo "6. ç›£è¦–URLæ•°:"
sqlite3 data/sokubutsu.db "SELECT COUNT(*) FROM urls WHERE enabled=1;"

echo "=== ãƒã‚§ãƒƒã‚¯å®Œäº† ==="
```

#### é€±æ¬¡ãƒã‚§ãƒƒã‚¯

```bash
#!/bin/bash
# weekly-check.sh

echo "=== è»½é‡ã‚½ã‚¯ãƒ–ãƒ„é€±æ¬¡ãƒã‚§ãƒƒã‚¯ $(date) ==="

# 1. ãƒ­ã‚°ãƒ­ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³
echo "1. ãƒ­ã‚°ãƒ­ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œ"
./scripts/rotate-logs.sh

# 2. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æœ€é©åŒ–
echo "2. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æœ€é©åŒ–"
sqlite3 data/sokubutsu.db "PRAGMA optimize;"
sqlite3 data/sokubutsu.db "PRAGMA wal_checkpoint(TRUNCATE);"

# 3. å¤ã„ãƒ‡ãƒ¼ã‚¿ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
echo "3. å¤ã„ãƒ‡ãƒ¼ã‚¿ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—"
sqlite3 data/sokubutsu.db "DELETE FROM monitoring_logs WHERE created_at < datetime('now', '-30 days');"

# 4. ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
echo "4. ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—"
find cache/ -type f -mtime +7 -delete

# 5. ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä½œæˆ
echo "5. ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä½œæˆ"
./scripts/backup.sh

# 6. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ›´æ–°ç¢ºèª
echo "6. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ›´æ–°ç¢ºèª"
sudo apt list --upgradable | grep -i security

echo "=== é€±æ¬¡ãƒã‚§ãƒƒã‚¯å®Œäº† ==="
```

#### æœˆæ¬¡ãƒã‚§ãƒƒã‚¯

```bash
#!/bin/bash
# monthly-check.sh

echo "=== è»½é‡ã‚½ã‚¯ãƒ–ãƒ„æœˆæ¬¡ãƒã‚§ãƒƒã‚¯ $(date) ==="

# 1. ã‚·ã‚¹ãƒ†ãƒ æ›´æ–°
echo "1. ã‚·ã‚¹ãƒ†ãƒ æ›´æ–°"
sudo apt update && sudo apt upgrade -y

# 2. Node.jsæ›´æ–°ç¢ºèª
echo "2. Node.jsæ›´æ–°ç¢ºèª"
npm outdated -g

# 3. ä¾å­˜é–¢ä¿‚æ›´æ–°
echo "3. ä¾å­˜é–¢ä¿‚æ›´æ–°ç¢ºèª"
cd /home/ubuntu/apps/sokubutsu2
pnpm outdated

# 4. ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹åˆ†æ
echo "4. ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹åˆ†æ"
sqlite3 data/sokubutsu.db "
SELECT 
  method,
  COUNT(*) as count,
  AVG(response_time) as avg_response_time,
  AVG(memory_usage) as avg_memory_usage
FROM monitoring_logs 
WHERE created_at > datetime('now', '-30 days')
GROUP BY method;
"

# 5. å¤ã„ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
echo "5. å¤ã„ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—"
find backups/ -name "*.tar.gz" -mtime +90 -delete

# 6. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç›£æŸ»
echo "6. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç›£æŸ»"
sudo lynis audit system --quick

echo "=== æœˆæ¬¡ãƒã‚§ãƒƒã‚¯å®Œäº† ==="
```

### ç›£è¦–ã‚¢ãƒ©ãƒ¼ãƒˆè¨­å®š

#### ã‚·ã‚¹ãƒ†ãƒ ç›£è¦–

```bash
# monitor-alerts.sh
#!/bin/bash

ALERT_EMAIL="admin@example.com"
TELEGRAM_BOT_TOKEN="your_bot_token"
TELEGRAM_CHAT_ID="your_chat_id"

send_alert() {
  local message="$1"
  local level="$2"
  
  # Telegramé€šçŸ¥
  curl -s -X POST "https://api.telegram.org/bot$TELEGRAM_BOT_TOKEN/sendMessage" \
    -d chat_id="$TELEGRAM_CHAT_ID" \
    -d text="ğŸš¨ è»½é‡ã‚½ã‚¯ãƒ–ãƒ„ã‚¢ãƒ©ãƒ¼ãƒˆ [$level]: $message"
  
  # ãƒ­ã‚°è¨˜éŒ²
  echo "$(date): [$level] $message" >> logs/alerts.log
}

# ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡ãƒã‚§ãƒƒã‚¯
MEMORY_USAGE=$(ps aux | grep "node.*sokubutsu" | grep -v grep | awk '{sum+=$4} END {print sum}')
if (( $(echo "$MEMORY_USAGE > 80" | bc -l) )); then
  send_alert "ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡ãŒ80%ã‚’è¶…ãˆã¾ã—ãŸ: ${MEMORY_USAGE}%" "WARNING"
fi

# ãƒ‡ã‚£ã‚¹ã‚¯ä½¿ç”¨é‡ãƒã‚§ãƒƒã‚¯
DISK_USAGE=$(df / | awk 'NR==2 {print $5}' | sed 's/%//')
if [ "$DISK_USAGE" -gt 85 ]; then
  send_alert "ãƒ‡ã‚£ã‚¹ã‚¯ä½¿ç”¨é‡ãŒ85%ã‚’è¶…ãˆã¾ã—ãŸ: ${DISK_USAGE}%" "WARNING"
fi

# ã‚µãƒ¼ãƒ“ã‚¹çŠ¶æ…‹ãƒã‚§ãƒƒã‚¯
if ! pm2 list | grep -q "sokubutsu-lightweight.*online"; then
  send_alert "è»½é‡ã‚½ã‚¯ãƒ–ãƒ„ã‚µãƒ¼ãƒ“ã‚¹ãŒåœæ­¢ã—ã¦ã„ã¾ã™" "CRITICAL"
fi

# ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯
INTEGRITY_CHECK=$(sqlite3 data/sokubutsu.db "PRAGMA integrity_check;" 2>/dev/null)
if [ "$INTEGRITY_CHECK" != "ok" ]; then
  send_alert "ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯ã«å¤±æ•—ã—ã¾ã—ãŸ" "CRITICAL"
fi
```

## ã¾ã¨ã‚

è»½é‡ã‚½ã‚¯ãƒ–ãƒ„ã®ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚¬ã‚¤ãƒ‰ã¯ã€è‡ªå®…ã‚µãƒ¼ãƒãƒ¼ç’°å¢ƒã§ã®ç‰©ä»¶ç›£è¦–ã‚·ã‚¹ãƒ†ãƒ é‹ç”¨ã«ç‰¹åŒ–ã—ãŸåŒ…æ‹¬çš„ãªã‚½ãƒªãƒ¥ãƒ¼ã‚·ãƒ§ãƒ³ã§ã™ã€‚

### ä¸»è¦ãªç‰¹å¾´

1. **è»½é‡ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£å¯¾å¿œ**: ãƒ¡ãƒ¢ãƒª30-60MBç’°å¢ƒç‰¹æœ‰ã®å•é¡Œã«å¯¾å¿œ
2. **æ®µéšçš„å¯¾å¿œ**: ç·Šæ€¥åº¦åˆ¥ã®å„ªå…ˆé †ä½ä»˜ã‘
3. **äºˆé˜²ä¿å®ˆ**: å®šæœŸãƒã‚§ãƒƒã‚¯ã«ã‚ˆã‚‹å•é¡Œã®äº‹å‰ç™ºè¦‹
4. **è‡ªå‹•åŒ–**: ç›£è¦–ãƒ»ã‚¢ãƒ©ãƒ¼ãƒˆãƒ»å¾©æ—§ã®è‡ªå‹•åŒ–
5. **åŒ…æ‹¬çš„ã‚«ãƒãƒ¬ãƒƒã‚¸**: ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‹ã‚‰ã‚¤ãƒ³ãƒ•ãƒ©ã¾ã§å…¨é ˜åŸŸå¯¾å¿œ

### æœŸå¾…ã•ã‚Œã‚‹åŠ¹æœ

- **ãƒ€ã‚¦ãƒ³ã‚¿ã‚¤ãƒ å‰Šæ¸›**: 99.9%ä»¥ä¸Šã®ã‚¢ãƒƒãƒ—ã‚¿ã‚¤ãƒ ç¶­æŒ
- **å•é¡Œè§£æ±ºæ™‚é–“çŸ­ç¸®**: å¹³å‡å¾©æ—§æ™‚é–“50%å‰Šæ¸›
- **é‹ç”¨è² è·è»½æ¸›**: è‡ªå‹•åŒ–ã«ã‚ˆã‚‹75%ã®ä½œæ¥­å‰Šæ¸›
- **å®‰å®šæ€§å‘ä¸Š**: äºˆé˜²ä¿å®ˆã«ã‚ˆã‚‹å•é¡Œã®äº‹å‰å›é¿

### æŠ€è¡“çš„å„ªä½æ€§

1. **å®Ÿè·µçš„è§£æ±ºç­–**: å®Ÿéš›ã®é‹ç”¨çµŒé¨“ã«åŸºã¥ãå…·ä½“çš„ãªæ‰‹é †
2. **è‡ªå‹•åŒ–ã‚¹ã‚¯ãƒªãƒ—ãƒˆ**: ã‚³ãƒ”ãƒšã§å³åº§ã«å®Ÿè¡Œå¯èƒ½
3. **æ®µéšçš„å¯¾å¿œ**: å•é¡Œã®é‡è¦åº¦ã«å¿œã˜ãŸé©åˆ‡ãªå¯¾å¿œ
4. **äºˆé˜²é‡è¦–**: å•é¡Œç™ºç”Ÿå‰ã®æ¤œçŸ¥ãƒ»å¯¾å‡¦æ©Ÿèƒ½

ã“ã®åŒ…æ‹¬çš„ãªãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚¬ã‚¤ãƒ‰ã«ã‚ˆã‚Šã€è»½é‡ã‚½ã‚¯ãƒ–ãƒ„ã®å®‰å®šé‹ç”¨ã¨åŠ¹ç‡çš„ãªå•é¡Œè§£æ±ºã‚’å®Ÿç¾ã—ã€ç‰©ä»¶ç›£è¦–ã‚µãƒ¼ãƒ“ã‚¹ã®ç¶™ç¶šçš„ãªæä¾›ã‚’ä¿è¨¼ã—ã¾ã™ã€‚

