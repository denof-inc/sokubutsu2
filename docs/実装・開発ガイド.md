# ã‚½ã‚¯ãƒ–ãƒ„å®Ÿè£…ãƒ»é–‹ç™ºã‚¬ã‚¤ãƒ‰

## ğŸ¯ ã“ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«ã¤ã„ã¦

ã“ã®ã‚¬ã‚¤ãƒ‰ã¯ã€ã‚½ã‚¯ãƒ–ãƒ„ã‚·ã‚¹ãƒ†ãƒ ã®é–‹ç™ºç’°å¢ƒæ§‹ç¯‰ã‹ã‚‰å®Ÿè£…ã¾ã§ã€åŒ…æ‹¬çš„ãªé–‹ç™ºã‚¬ã‚¤ãƒ‰ã§ã™ã€‚æ–°è¦å‚å…¥è€…ãŒè¿·ã‚ãšé–‹ç™ºã«å‚åŠ ã§ãã‚‹ã‚ˆã†ã€æ®µéšçš„ãªæ‰‹é †ã¨ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹ã‚’æä¾›ã—ã¾ã™ã€‚

## ğŸ“‹ ã‚·ã‚¹ãƒ†ãƒ æ¦‚è¦

### åŸºæœ¬ä»•æ§˜
- âœ… athome.co.jpã®æ–°ç€ç‰©ä»¶ç›£è¦–ï¼ˆPuppeteer-firstæˆ¦ç•¥ï¼‰
- âœ… ãƒãƒ«ãƒãƒ¦ãƒ¼ã‚¶ãƒ¼Telegramé€šçŸ¥æ©Ÿèƒ½
- âœ… 5åˆ†é–“éš”ã®è‡ªå‹•ç›£è¦–ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ©ãƒ¼
- âœ… Dockerç’°å¢ƒã§ã®æœ¬æ ¼é‹ç”¨

### æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯
- **è¨€èª**: TypeScript 5.x (ESM, strict mode)
- **å®Ÿè¡Œç’°å¢ƒ**: Node.js 18+
- **ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹**: SQLite (better-sqlite3) + TypeORM
- **ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°**: Puppeteer + Stealth Plugin
- **é€šçŸ¥**: Telegraf (Telegram Bot API)
- **ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ©ãƒ¼**: node-cron
- **ãƒ†ã‚¹ãƒˆ**: Jest 29.x + ts-jest
- **ã‚³ãƒ³ãƒ†ãƒŠ**: Docker + docker-compose

### ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æŒ‡æ¨™
- **å®Ÿè¡Œæ™‚é–“**: 5.4ç§’ï¼ˆPuppeteerä½¿ç”¨ï¼‰
- **ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡**: 200-300MB
- **æˆåŠŸç‡**: 25%å®‰å®šç¨¼åƒï¼ˆå®Ÿè¨¼æ¸ˆã¿ï¼‰
- **ç›£è¦–é–“éš”**: 5åˆ†ï¼ˆè¨­å®šå¤‰æ›´å¯èƒ½ï¼‰

## ğŸš€ ç’°å¢ƒæ§‹ç¯‰æ‰‹é †

### å‰ææ¡ä»¶

#### ãƒãƒ¼ãƒ‰ã‚¦ã‚§ã‚¢è¦ä»¶
- **CPU**: 2ã‚³ã‚¢ä»¥ä¸Š
- **ãƒ¡ãƒ¢ãƒª**: 4GBä»¥ä¸Šï¼ˆé–‹ç™ºæ™‚ï¼‰ã€2GBä»¥ä¸Šï¼ˆé‹ç”¨æ™‚ï¼‰
- **ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸**: 5GBä»¥ä¸Šã®ç©ºãå®¹é‡

#### ã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢è¦ä»¶
- **Node.js**: 18.0.0ä»¥ä¸Š
- **npm**: 9.0.0ä»¥ä¸Š
- **Docker**: 20.0.0ä»¥ä¸Šï¼ˆæœ¬æ ¼é‹ç”¨ã®å ´åˆï¼‰
- **Git**: 2.30ä»¥ä¸Š

### 1. ãƒªãƒã‚¸ãƒˆãƒªã‚¯ãƒ­ãƒ¼ãƒ³
```bash
git clone https://github.com/denof-inc/sokubutsu2.git
cd sokubutsu2

# ãƒ–ãƒ©ãƒ³ãƒç¢ºèª
git status
git log --oneline -3
```

### 2. ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
```bash
# ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
npm install

# é–‹ç™ºç’°å¢ƒç¢ºèª
npm run --version
node --version
```

### 3. ç’°å¢ƒè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆ
```bash
# .envãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆ
cp .env.example .env

# å¿…è¦ãªç’°å¢ƒå¤‰æ•°ã‚’è¨­å®š
# TELEGRAM_BOT_TOKEN=your_bot_token_here
# TELEGRAM_CHAT_ID=your_chat_id_here
```

### 4. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
```bash
# ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹åˆæœŸåŒ–
npm run typeorm:migration:run

# é–‹ç™ºãƒ‡ãƒ¼ã‚¿ç¢ºèª
npm run start:dev:db-check
```

## ğŸ—ï¸ ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£è©³ç´°

### ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆ
```
src/
â”œâ”€â”€ main.ts                 # ãƒ¡ã‚¤ãƒ³ã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆ
â”œâ”€â”€ main-multiuser.ts       # ãƒãƒ«ãƒãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¢ãƒ¼ãƒ‰
â”œâ”€â”€ config.ts               # è¨­å®šç®¡ç†
â”œâ”€â”€ types.ts                # å‹å®šç¾©
â”œâ”€â”€ logger.ts               # ãƒ­ã‚°ç®¡ç† (vibelogger)
â”œâ”€â”€ performance.ts          # ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ç›£è¦–
â”œâ”€â”€ scraper.ts              # Puppeteerã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°
â”œâ”€â”€ telegram.ts             # Telegramé€šçŸ¥
â”œâ”€â”€ storage.ts              # ãƒ‡ãƒ¼ã‚¿ä¿å­˜
â”œâ”€â”€ scheduler.ts            # ç›£è¦–ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ©ãƒ¼
â”œâ”€â”€ property-monitor.ts     # ç‰©ä»¶ç›£è¦–ãƒ­ã‚¸ãƒƒã‚¯
â”œâ”€â”€ admin/                  # ç®¡ç†ç”»é¢æ©Ÿèƒ½
â”œâ”€â”€ database/               # DBè¨­å®šãƒ»ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
â”œâ”€â”€ entities/               # TypeORMã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£
â”œâ”€â”€ services/               # ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯å±¤
â”œâ”€â”€ telegram/               # Telegramé–¢é€£
â”œâ”€â”€ types/                  # å‹å®šç¾©æ‹¡å¼µ
â”œâ”€â”€ utils/                  # ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
â””â”€â”€ __tests__/              # ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«
```

### è¨­è¨ˆåŸå‰‡
- **ESMå„ªå…ˆ**: ES Modulesçµ±ä¸€
- **TypeScript strict**: å³æ ¼å‹ãƒã‚§ãƒƒã‚¯
- **è»½é‡æ€§é‡è¦–**: æœ€å°é™ã®ä¾å­˜é–¢ä¿‚
- **ãƒ†ã‚¹ãƒˆé§†å‹•**: 80%ä»¥ä¸Šã®ã‚«ãƒãƒ¬ãƒƒã‚¸ç¶­æŒ
- **ãƒ­ã‚°æ§‹é€ åŒ–**: vibeloggerä½¿ç”¨

## ğŸ’» é–‹ç™ºãƒ•ãƒ­ãƒ¼

### 1. é–‹ç™ºç’°å¢ƒèµ·å‹•
```bash
# é–‹ç™ºã‚µãƒ¼ãƒãƒ¼èµ·å‹•
npm run start:dev

# ãƒ•ã‚¡ã‚¤ãƒ«ç›£è¦–ä»˜ãèµ·å‹•
npm run dev:watch

# ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰
npm run dev:debug
```

### 1.1 Webhookã‚’ä½¿ã†é–‹ç™ºï¼ˆæœ¬ç•ªã•ãªãŒã‚‰ã®æ¤œè¨¼ï¼‰
- ç›®çš„: Telegramã®Webhookå—ä¿¡ã‚’å«ã‚€E2Eæ¤œè¨¼ã‚’ã€ãƒ­ãƒ¼ã‚«ãƒ«ã§ã‚‚æœ¬ç•ªåŒç­‰ã§è¡Œã†
- å…¬é–‹æ‰‹æ®µ: Tailscale Funnelï¼ˆç„¡æ–™ï¼‰

æ‰‹é †ï¼ˆMacé–‹ç™ºç’°å¢ƒï¼‰:
```bash
# 1) Tailscaleæº–å‚™ï¼ˆGUIã‚¢ãƒ—ãƒªæ¨å¥¨ï¼‰
brew install --cask tailscale
open -a Tailscale   # ãƒ­ã‚°ã‚¤ãƒ³

# 2) Funnelæœ‰åŠ¹åŒ–ï¼ˆ443ãŒåŸ‹ã¾ã£ã¦ã„ã‚Œã° --https=8443 ã‚’ä½¿ã†ï¼‰
tailscale funnel --bg 3002
tailscale funnel status   # URLã‚’æ§ãˆã‚‹ï¼ˆä¾‹: https://<host>.<tailnet>.ts.netï¼‰

# 3) .env / .env.production ã«è¨­å®š
ADMIN_PUBLIC_URL=https://<host>.<tailnet>.ts.net
MULTI_USER_MODE=true

# 4) Dockerã§ã‚¢ãƒ—ãƒªèµ·å‹•ï¼ˆã‚¢ãƒ—ãƒªã®ã¿ï¼‰
docker compose up -d sokubutsu-mvp

# 5) æ¤œè¨¼
curl -s "https://api.telegram.org/bot$TELEGRAM_BOT_TOKEN/getWebhookInfo" | jq
curl -I "${ADMIN_PUBLIC_URL%/}/health"
```

è£œè¶³:
- dev/prodã§Bot/Chatã¯åˆ†é›¢ï¼ˆWebhookå–ã‚Šåˆã„é˜²æ­¢ï¼‰
- è¿½åŠ æ¸ˆã¿ã®ã€ŒWebhookè‡ªå·±ä¿®å¾©ã‚¬ãƒ¼ãƒ‰ã€ã«ã‚ˆã‚Šã€ä¸ä¸€è‡´ã‚„è§£é™¤ãŒã‚ã£ã¦ã‚‚è‡ªå‹•å†è¨­å®šã•ã‚Œã¾ã™

### 2. ä¸»è¦é–‹ç™ºã‚³ãƒãƒ³ãƒ‰
```bash
# ãƒ“ãƒ«ãƒ‰
npm run build

# ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
npm run test
npm run test:watch

# å“è³ªãƒã‚§ãƒƒã‚¯
npm run lint
npm run typecheck

# æ‰‹å‹•ãƒ†ã‚¹ãƒˆ
npm run test:manual
```

### 3. ã‚³ãƒ¼ãƒ‰å“è³ªåŸºæº–
```bash
# å“è³ªãƒã‚§ãƒƒã‚¯çµ±åˆå®Ÿè¡Œ
npm run quality:check

# å“è³ªãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
npm run quality:report
```

## ğŸ”§ å®Ÿè£…ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹

### TypeScriptè¦ç´„
- `any`å‹ã®ä½¿ç”¨ç¦æ­¢
- strict modeå¿…é ˆ
- ESLintãƒ«ãƒ¼ãƒ«å³å®ˆ
- ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã®é©åˆ‡ãªå®šç¾©

### ã‚³ãƒ¼ãƒ‰æ§‹æˆ
```typescript
// è‰¯ã„ä¾‹: é©åˆ‡ãªå‹å®šç¾©
interface PropertyData {
  title: string;
  price: string;
  location: string;
  detectedAt: Date;
}

// æ‚ªã„ä¾‹: anyå‹ã®ä½¿ç”¨
const data: any = getPropertyData();
```

### ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
```typescript
// é©åˆ‡ãªã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
try {
  const result = await scrapeProperties(url);
  logger.info('scraping.success', { url, count: result.length });
  return result;
} catch (error) {
  logger.error('scraping.failed', { url, error: error.message });
  throw new ScrapingError('Failed to scrape properties', { cause: error });
}
```

### ãƒ­ã‚°å‡ºåŠ›è¦ç´„
```typescript
// vibeloggerã®æ§‹é€ åŒ–ãƒ­ã‚°ä½¿ç”¨
logger.info('property.detected', {
  url,
  propertyCount: properties.length,
  executionTime: Date.now() - startTime,
  memoryUsage: process.memoryUsage().heapUsed
});
```

## ğŸ¯ ã‚¯ã‚¤ãƒƒã‚¯ã‚¹ã‚¿ãƒ¼ãƒˆï¼ˆ30åˆ†ï¼‰

### MVPãƒ¢ãƒ¼ãƒ‰ï¼ˆæœ€å°æ§‹æˆï¼‰
```bash
# 1. ç’°å¢ƒæº–å‚™
git clone [repo]
cd sokubutsu2
npm install

# 2. è¨­å®š
cp .env.example .env
# TELEGRAM_BOT_TOKEN, TELEGRAM_CHAT_ID ã‚’è¨­å®š

# 3. èµ·å‹•ãƒ†ã‚¹ãƒˆ
npm run start:dev

# 4. æ‰‹å‹•ãƒ†ã‚¹ãƒˆ
npm run test:manual
```

### æœ¬æ ¼é–‹ç™ºãƒ¢ãƒ¼ãƒ‰
```bash
# 1. ãƒ•ãƒ«ç’°å¢ƒæ§‹ç¯‰
npm run setup:full

# 2. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹åˆæœŸåŒ–
npm run db:setup

# 3. é–‹ç™ºã‚µãƒ¼ãƒãƒ¼èµ·å‹•
npm run start:dev:full

# 4. ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
npm run test:all
```

## ğŸ› ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### ã‚ˆãã‚ã‚‹å•é¡Œã¨è§£æ±ºç­–

#### 1. Puppeteerã‚¨ãƒ©ãƒ¼
```bash
# Chromeä¾å­˜é–¢ä¿‚ã‚¨ãƒ©ãƒ¼
sudo apt-get install -y chromium-browser

# WSL2ã§ã®å®Ÿè¡Œã‚¨ãƒ©ãƒ¼
export DISPLAY=:0.0
```

#### 2. TypeScriptã‚¨ãƒ©ãƒ¼
```bash
# ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«è§£æ±ºã‚¨ãƒ©ãƒ¼
npm run clean
npm install
npm run build
```

#### 3. Telegramã‚¨ãƒ©ãƒ¼
```bash
# Bot ãƒˆãƒ¼ã‚¯ãƒ³ã‚¨ãƒ©ãƒ¼
# .envãƒ•ã‚¡ã‚¤ãƒ«ã®TELEGRAM_BOT_TOKENã‚’ç¢ºèª
# BotãŒã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‹ãƒã‚§ãƒƒã‚¯
```

##### Webhookä¸ä¸€è‡´ãƒ»æœªè¨­å®šã®å³æ™‚å¾©æ—§
èµ·å‹•ç›´å¾Œã®ä¸€æ™‚çš„ãªå¤±æ•—ã‚„å¤–éƒ¨è¦å› ã§WebhookãŒå¤–ã‚ŒãŸå ´åˆã¯ã€è‡ªå·±ä¿®å¾©ã‚¬ãƒ¼ãƒ‰ãŒå®šæœŸæ¤œè¨¼â†’è‡ªå‹•å†è¨­å®šã—ã¾ã™ã€‚å³æ™‚å¾©æ—§ã—ãŸã„å ´åˆã¯ä»¥ä¸‹ã‚’å®Ÿè¡Œï¼ˆãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç”»é¢ã«å‡ºã•ãšå®‰å…¨ï¼‰ã€‚

```bash
docker exec -i sokubutsu-mvp sh -lc '\
  EXP="${ADMIN_PUBLIC_URL%/}/telegram/webhook"; \
  BASE="https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}"; \
  curl -fsS -X POST -d "url=$EXP" "$BASE/setWebhook" | jq'

# ç¾åœ¨ã®Webhookç¢ºèª
curl -fsS "https://api.telegram.org/bot$TELEGRAM_BOT_TOKEN/getWebhookInfo" | jq
```

#### 4. Dockeré–¢é€£
```bash
# ã‚³ãƒ³ãƒ†ãƒŠèµ·å‹•ã‚¨ãƒ©ãƒ¼
docker-compose down
docker-compose up --build

# ãƒãƒ¼ãƒˆç«¶åˆã‚¨ãƒ©ãƒ¼
lsof -i :3000
kill -9 [PID]
```

## ğŸ“Š ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ç›£è¦–

### ç›£è¦–æŒ‡æ¨™
```typescript
// ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æ¸¬å®šä¾‹
const startTime = Date.now();
const startMemory = process.memoryUsage().heapUsed;

// å‡¦ç†å®Ÿè¡Œ

const metrics = {
  executionTime: Date.now() - startTime,
  memoryUsage: process.memoryUsage().heapUsed - startMemory,
  success: true,
  timestamp: new Date()
};
```

### æœ€é©åŒ–ã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³
- **ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡**: 300MBä»¥ä¸‹ã‚’ç¶­æŒ
- **å®Ÿè¡Œæ™‚é–“**: 10ç§’ä»¥ä¸‹ã‚’ç›®æ¨™
- **æˆåŠŸç‡**: 20%ä»¥ä¸Šã‚’ç¶­æŒ
- **CPUä½¿ç”¨ç‡**: 50%ä»¥ä¸‹ã‚’ç¶­æŒ

## ğŸš¢ ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆ

### Dockeræœ¬ç•ªç’°å¢ƒ
```bash
# æœ¬ç•ªãƒ“ãƒ«ãƒ‰
npm run build:prod

# Dockerèµ·å‹•
docker-compose -f docker-compose.prod.yml up -d

# çŠ¶æ…‹ç¢ºèª
docker-compose logs -f sokubutsu
```

### ç›£è¦–ãƒ»ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹
```bash
# ãƒ­ã‚°ç¢ºèª
docker logs -f sokubutsu-container

# ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ç¢ºèª
docker stats sokubutsu-container

# å†èµ·å‹•
docker-compose restart sokubutsu
```

## ğŸ“š å‚è€ƒè³‡æ–™

### é–¢é€£ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ
- [ã‚·ã‚¹ãƒ†ãƒ è¨­è¨ˆæ›¸](./ã‚·ã‚¹ãƒ†ãƒ è¨­è¨ˆæ›¸%20.md) - ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£è©³ç´°
- [ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆæ›¸](./ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆæ›¸%20.md) - DBæ§‹é€ 
- [æ–°ç€ç‰©ä»¶ç›£è¦–ãƒ­ã‚¸ãƒƒã‚¯](./æ–°ç€ç‰©ä»¶ç›£è¦–ãƒ­ã‚¸ãƒƒã‚¯.md) - ç›£è¦–ä»•æ§˜
- [requirements.md](./requirements.md) - è¦ä»¶å®šç¾©

### å¤–éƒ¨ãƒªã‚½ãƒ¼ã‚¹
- [TypeScript Documentation](https://www.typescriptlang.org/docs/)
- [Jest Testing Framework](https://jestjs.io/docs/getting-started)
- [Docker Documentation](https://docs.docker.com/)
- [Telegram Bot API](https://core.telegram.org/bots/api)

---

**æ›´æ–°æ—¥**: 2025å¹´8æœˆ26æ—¥  
**ãƒãƒ¼ã‚¸ãƒ§ãƒ³**: 2.0ï¼ˆPuppeteer-firstæˆ¦ç•¥å¯¾å¿œï¼‰
