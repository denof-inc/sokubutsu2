# ソクブツ実装・開発ガイド

## 🎯 このドキュメントについて

このガイドは、ソクブツシステムの開発環境構築から実装まで、包括的な開発ガイドです。新規参入者が迷わず開発に参加できるよう、段階的な手順とベストプラクティスを提供します。

## 📋 システム概要

### 基本仕様
- ✅ athome.co.jpの新着物件監視（Puppeteer-first戦略）
- ✅ マルチユーザーTelegram通知機能
- ✅ 5分間隔の自動監視スケジューラー
- ✅ Docker環境での本格運用

### 技術スタック
- **言語**: TypeScript 5.x (ESM, strict mode)
- **実行環境**: Node.js 18+
- **データベース**: SQLite (better-sqlite3) + TypeORM
- **スクレイピング**: Puppeteer + Stealth Plugin
- **通知**: Telegraf (Telegram Bot API)
- **スケジューラー**: node-cron
- **テスト**: Jest 29.x + ts-jest
- **コンテナ**: Docker + docker-compose

### パフォーマンス指標
- **実行時間**: 5.4秒（Puppeteer使用）
- **メモリ使用量**: 200-300MB
- **成功率**: 25%安定稼働（実証済み）
- **監視間隔**: 5分（設定変更可能）

## 🚀 環境構築手順

### 前提条件

#### ハードウェア要件
- **CPU**: 2コア以上
- **メモリ**: 4GB以上（開発時）、2GB以上（運用時）
- **ストレージ**: 5GB以上の空き容量

#### ソフトウェア要件
- **Node.js**: 18.0.0以上
- **npm**: 9.0.0以上
- **Docker**: 20.0.0以上（本格運用の場合）
- **Git**: 2.30以上

### 1. リポジトリクローン
```bash
git clone https://github.com/denof-inc/sokubutsu2.git
cd sokubutsu2

# ブランチ確認
git status
git log --oneline -3
```

### 2. 依存関係インストール
```bash
# 依存関係インストール
npm install

# 開発環境確認
npm run --version
node --version
```

### 3. 環境設定ファイル作成
```bash
# .envファイル作成
cp .env.example .env

# 必要な環境変数を設定
# TELEGRAM_BOT_TOKEN=your_bot_token_here
# TELEGRAM_CHAT_ID=your_chat_id_here
```

### 4. データベースセットアップ
```bash
# データベース初期化
npm run typeorm:migration:run

# 開発データ確認
npm run start:dev:db-check
```

## 🏗️ アーキテクチャ詳細

### ディレクトリ構成
```
src/
├── main.ts                 # メインエントリーポイント
├── main-multiuser.ts       # マルチユーザーモード
├── config.ts               # 設定管理
├── types.ts                # 型定義
├── logger.ts               # ログ管理 (vibelogger)
├── performance.ts          # パフォーマンス監視
├── scraper.ts              # Puppeteerスクレイピング
├── telegram.ts             # Telegram通知
├── storage.ts              # データ保存
├── scheduler.ts            # 監視スケジューラー
├── property-monitor.ts     # 物件監視ロジック
├── admin/                  # 管理画面機能
├── database/               # DB設定・マイグレーション
├── entities/               # TypeORMエンティティ
├── services/               # ビジネスロジック層
├── telegram/               # Telegram関連
├── types/                  # 型定義拡張
├── utils/                  # ユーティリティ
└── __tests__/              # テストファイル
```

### 設計原則
- **ESM優先**: ES Modules統一
- **TypeScript strict**: 厳格型チェック
- **軽量性重視**: 最小限の依存関係
- **テスト駆動**: 80%以上のカバレッジ維持
- **ログ構造化**: vibelogger使用

## 💻 開発フロー

### 1. 開発環境起動
```bash
# 開発サーバー起動
npm run start:dev

# ファイル監視付き起動
npm run dev:watch

# デバッグモード
npm run dev:debug
```

### 1.1 Webhookを使う開発（本番さながらの検証）
- 目的: TelegramのWebhook受信を含むE2E検証を、ローカルでも本番同等で行う
- 公開手段: Tailscale Funnel（無料）

手順（Mac開発環境）:
```bash
# 1) Tailscale準備（GUIアプリ推奨）
brew install --cask tailscale
open -a Tailscale   # ログイン

# 2) Funnel有効化（443が埋まっていれば --https=8443 を使う）
tailscale funnel --bg 3002
tailscale funnel status   # URLを控える（例: https://<host>.<tailnet>.ts.net）

# 3) .env / .env.production に設定
ADMIN_PUBLIC_URL=https://<host>.<tailnet>.ts.net
MULTI_USER_MODE=true

# 4) Dockerでアプリ起動（アプリのみ）
docker compose up -d sokubutsu-mvp

# 5) 検証
curl -s "https://api.telegram.org/bot$TELEGRAM_BOT_TOKEN/getWebhookInfo" | jq
curl -I "${ADMIN_PUBLIC_URL%/}/health"
```

補足:
- dev/prodでBot/Chatは分離（Webhook取り合い防止）
- 追加済みの「Webhook自己修復ガード」により、不一致や解除があっても自動再設定されます

### 2. 主要開発コマンド
```bash
# ビルド
npm run build

# テスト実行
npm run test
npm run test:watch

# 品質チェック
npm run lint
npm run typecheck

# 手動テスト
npm run test:manual
```

### 3. コード品質基準
```bash
# 品質チェック統合実行
npm run quality:check

# 品質レポート生成
npm run quality:report
```

## 🔧 実装ベストプラクティス

### TypeScript規約
- `any`型の使用禁止
- strict mode必須
- ESLintルール厳守
- インターフェースの適切な定義

### コード構成
```typescript
// 良い例: 適切な型定義
interface PropertyData {
  title: string;
  price: string;
  location: string;
  detectedAt: Date;
}

// 悪い例: any型の使用
const data: any = getPropertyData();
```

### エラーハンドリング
```typescript
// 適切なエラーハンドリング
try {
  const result = await scrapeProperties(url);
  logger.info('scraping.success', { url, count: result.length });
  return result;
} catch (error) {
  logger.error('scraping.failed', { url, error: error.message });
  throw new ScrapingError('Failed to scrape properties', { cause: error });
}
```

### ログ出力規約
```typescript
// vibeloggerの構造化ログ使用
logger.info('property.detected', {
  url,
  propertyCount: properties.length,
  executionTime: Date.now() - startTime,
  memoryUsage: process.memoryUsage().heapUsed
});
```

## 🎯 クイックスタート（30分）

### MVPモード（最小構成）
```bash
# 1. 環境準備
git clone [repo]
cd sokubutsu2
npm install

# 2. 設定
cp .env.example .env
# TELEGRAM_BOT_TOKEN, TELEGRAM_CHAT_ID を設定

# 3. 起動テスト
npm run start:dev

# 4. 手動テスト
npm run test:manual
```

### 本格開発モード
```bash
# 1. フル環境構築
npm run setup:full

# 2. データベース初期化
npm run db:setup

# 3. 開発サーバー起動
npm run start:dev:full

# 4. テスト実行
npm run test:all
```

## 🐛 トラブルシューティング

### よくある問題と解決策

#### 1. Puppeteerエラー
```bash
# Chrome依存関係エラー
sudo apt-get install -y chromium-browser

# WSL2での実行エラー
export DISPLAY=:0.0
```

#### 2. TypeScriptエラー
```bash
# モジュール解決エラー
npm run clean
npm install
npm run build
```

#### 3. Telegramエラー
```bash
# Bot トークンエラー
# .envファイルのTELEGRAM_BOT_TOKENを確認
# Botがアクティブかチェック
```

##### Webhook不一致・未設定の即時復旧
起動直後の一時的な失敗や外部要因でWebhookが外れた場合は、自己修復ガードが定期検証→自動再設定します。即時復旧したい場合は以下を実行（トークンを画面に出さず安全）。

```bash
docker exec -i sokubutsu-mvp sh -lc '\
  EXP="${ADMIN_PUBLIC_URL%/}/telegram/webhook"; \
  BASE="https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}"; \
  curl -fsS -X POST -d "url=$EXP" "$BASE/setWebhook" | jq'

# 現在のWebhook確認
curl -fsS "https://api.telegram.org/bot$TELEGRAM_BOT_TOKEN/getWebhookInfo" | jq
```

#### 4. Docker関連
```bash
# コンテナ起動エラー
docker-compose down
docker-compose up --build

# ポート競合エラー
lsof -i :3000
kill -9 [PID]
```

## 📊 パフォーマンス監視

### 監視指標
```typescript
// パフォーマンス測定例
const startTime = Date.now();
const startMemory = process.memoryUsage().heapUsed;

// 処理実行

const metrics = {
  executionTime: Date.now() - startTime,
  memoryUsage: process.memoryUsage().heapUsed - startMemory,
  success: true,
  timestamp: new Date()
};
```

### 最適化ガイドライン
- **メモリ使用量**: 300MB以下を維持
- **実行時間**: 10秒以下を目標
- **成功率**: 20%以上を維持
- **CPU使用率**: 50%以下を維持

## 🚢 デプロイメント

### Docker本番環境
```bash
# 本番ビルド
npm run build:prod

# Docker起動
docker-compose -f docker-compose.prod.yml up -d

# 状態確認
docker-compose logs -f sokubutsu
```

### 監視・メンテナンス
```bash
# ログ確認
docker logs -f sokubutsu-container

# パフォーマンス確認
docker stats sokubutsu-container

# 再起動
docker-compose restart sokubutsu
```

## 📚 参考資料

### 関連ドキュメント
- [システム設計書](./システム設計書%20.md) - アーキテクチャ詳細
- [データベース設計書](./データベース設計書%20.md) - DB構造
- [新着物件監視ロジック](./新着物件監視ロジック.md) - 監視仕様
- [requirements.md](./requirements.md) - 要件定義

### 外部リソース
- [TypeScript Documentation](https://www.typescriptlang.org/docs/)
- [Jest Testing Framework](https://jestjs.io/docs/getting-started)
- [Docker Documentation](https://docs.docker.com/)
- [Telegram Bot API](https://core.telegram.org/bots/api)

---

**更新日**: 2025年8月26日  
**バージョン**: 2.0（Puppeteer-first戦略対応）
