# ソクブツテスト完全ガイド

## 🎯 このドキュメントについて

このガイドは、ソクブツプロジェクトにおける包括的なテスト戦略と実行手順を定義します。Jest + ESM環境での高品質なテスト実装と、継続的な品質保証のためのベストプラクティスを提供します。

## 📋 テスト戦略概要

### テスト方針
- **テストカバレッジ**: 80%以上を維持
- **TDD推奨**: Red-Green-Refactorサイクル
- **自動化**: CI/CDパイプラインとの統合
- **品質重視**: ESLint + TypeScript strict mode

### テスト分類
1. **ユニットテスト**: 個別関数・クラスのテスト
2. **統合テスト**: モジュール間連携のテスト
3. **E2Eテスト**: エンドツーエンドシナリオテスト
4. **パフォーマンステスト**: 実行時間・メモリ使用量の検証

## 🚀 環境設定・セットアップ

### Jest + ESM設定

#### package.json設定
```json
{
  "type": "module",
  "scripts": {
    "test": "NODE_OPTIONS='--experimental-vm-modules' jest",
    "test:watch": "NODE_OPTIONS='--experimental-vm-modules' jest --watch",
    "test:coverage": "NODE_OPTIONS='--experimental-vm-modules' jest --coverage",
    "test:verbose": "NODE_OPTIONS='--experimental-vm-modules' jest --verbose"
  },
  "jest": {
    "preset": "ts-jest/presets/default-esm",
    "extensionsToTreatAsEsm": [".ts"],
    "globals": {
      "ts-jest": {
        "useESM": true
      }
    },
    "transform": {
      "^.+\\.ts$": "ts-jest"
    },
    "moduleNameMapping": {
      "^(\\.{1,2}/.*)\\.js$": "$1"
    },
    "testEnvironment": "node",
    "coverageDirectory": "coverage",
    "collectCoverageFrom": [
      "src/**/*.ts",
      "!src/**/*.d.ts",
      "!src/__tests__/**"
    ],
    "coverageThreshold": {
      "global": {
        "branches": 80,
        "functions": 80,
        "lines": 80,
        "statements": 80
      }
    }
  }
}
```

#### TypeScript設定（tsconfig.json）
```json
{
  "compilerOptions": {
    "target": "ES2022",
    "module": "ESNext",
    "moduleResolution": "node",
    "allowSyntheticDefaultImports": true,
    "esModuleInterop": true,
    "strict": true,
    "skipLibCheck": true,
    "forceConsistentCasingInFileNames": true
  },
  "ts-node": {
    "esm": true
  }
}
```

### 環境別テスト設定

#### ローカル開発環境
```bash
# 基本テスト実行
npm run test

# ファイル監視モード
npm run test:watch

# カバレッジ付き実行
npm run test:coverage
```

#### CI/CD環境（GitHub Actions）
```yaml
# .github/workflows/test.yml
name: Test
on: [push, pull_request]
jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version: '18'
      - run: npm ci
      - run: npm run test:ci
      - run: npm run lint
      - run: npm run typecheck
```

## 📝 テスト実装ガイド

### 1. ユニットテストの基本パターン

#### 関数テストの例
```typescript
// src/__tests__/utils.test.ts
import { describe, it, expect } from '@jest/globals';
import { calculateHash, formatPrice } from '../utils/helpers.js';

describe('ユーティリティ関数', () => {
  describe('calculateHash', () => {
    it('同じ入力に対して同じハッシュを返す', () => {
      const input = 'test data';
      const hash1 = calculateHash(input);
      const hash2 = calculateHash(input);
      
      expect(hash1).toBe(hash2);
      expect(hash1).toHaveLength(32);
    });

    it('異なる入力に対して異なるハッシュを返す', () => {
      const hash1 = calculateHash('data1');
      const hash2 = calculateHash('data2');
      
      expect(hash1).not.toBe(hash2);
    });
  });

  describe('formatPrice', () => {
    it('価格文字列を正しくフォーマットする', () => {
      expect(formatPrice('1000万円')).toBe(10000000);
      expect(formatPrice('500万円')).toBe(5000000);
      expect(formatPrice('不明')).toBeNull();
    });
  });
});
```

#### クラステストの例
```typescript
// src/__tests__/scraper.test.ts
import { describe, it, expect, beforeEach, afterEach, jest } from '@jest/globals';
import { PropertyScraper } from '../scraper.js';

describe('PropertyScraper', () => {
  let scraper: PropertyScraper;

  beforeEach(() => {
    scraper = new PropertyScraper();
  });

  afterEach(() => {
    jest.clearAllMocks();
  });

  describe('scrapeProperties', () => {
    it('有効なURLから物件データを取得できる', async () => {
      const mockHtml = '<div class="property">テスト物件 1000万円</div>';
      jest.spyOn(scraper as any, 'fetchHtml').mockResolvedValue(mockHtml);

      const result = await scraper.scrapeProperties('https://test.com');

      expect(result).toHaveLength(1);
      expect(result[0]).toMatchObject({
        title: expect.stringContaining('テスト物件'),
        price: expect.stringContaining('1000万円')
      });
    });

    it('無効なURLでエラーをスローする', async () => {
      await expect(scraper.scrapeProperties('invalid-url'))
        .rejects.toThrow('Invalid URL format');
    });
  });
});
```

### 2. 統合テストパターン

#### サービス間連携テスト
```typescript
// src/__tests__/integration/property-monitor.test.ts
import { describe, it, expect, beforeAll, afterAll } from '@jest/globals';
import { PropertyMonitor } from '../property-monitor.js';
import { TelegramService } from '../telegram.js';
import { DatabaseService } from '../database/database.service.js';

describe('PropertyMonitor統合テスト', () => {
  let monitor: PropertyMonitor;
  let telegram: TelegramService;
  let database: DatabaseService;

  beforeAll(async () => {
    database = new DatabaseService();
    telegram = new TelegramService('test-token');
    monitor = new PropertyMonitor(database, telegram);
    
    await database.initialize();
  });

  afterAll(async () => {
    await database.close();
  });

  it('新着物件を検知してTelegram通知を送信する', async () => {
    const spy = jest.spyOn(telegram, 'sendNotification');
    
    await monitor.checkForNewProperties('https://test-url.com');
    
    expect(spy).toHaveBeenCalledWith(
      expect.objectContaining({
        type: 'new_property',
        data: expect.any(Object)
      })
    );
  });
});
```

### 3. モックとスタブの活用

注: 現行実装は **grammy (Bot) + Webhook** を採用しています。以下の Telegraf ベースの例は過去バージョンの参考例です。実プロジェクトのテストでは `grammy` の `Bot` を `jest.unstable_mockModule` でモック化し、`TelegramNotifier` に対して検証するパターンに置き換えています。

#### 外部APIモック
```typescript
// src/__tests__/telegram.test.ts
import { describe, it, expect, jest } from '@jest/globals';
import { Telegraf } from 'telegraf';
import { TelegramService } from '../telegram.js';

// Telegrafモック
jest.mock('telegraf');
const MockedTelegraf = Telegraf as jest.MockedClass<typeof Telegraf>;

describe('TelegramService', () => {
  it('メッセージ送信が正常に動作する', async () => {
    const mockBot = {
      telegram: {
        sendMessage: jest.fn().mockResolvedValue({ message_id: 123 })
      }
    };
    MockedTelegraf.mockImplementation(() => mockBot as any);

    const service = new TelegramService('test-token');
    await service.sendMessage('test-chat', 'Hello World');

    expect(mockBot.telegram.sendMessage).toHaveBeenCalledWith(
      'test-chat',
      'Hello World',
      expect.any(Object)
    );
  });
});
```

#### データベースモック
```typescript
// src/__tests__/storage.test.ts
import { describe, it, expect, beforeEach, jest } from '@jest/globals';
import { Repository } from 'typeorm';
import { StorageService } from '../storage.js';
import { PropertyEntity } from '../entities/Property.js';

describe('StorageService', () => {
  let service: StorageService;
  let mockRepository: jest.Mocked<Repository<PropertyEntity>>;

  beforeEach(() => {
    mockRepository = {
      save: jest.fn(),
      find: jest.fn(),
      findOne: jest.fn(),
      delete: jest.fn(),
    } as any;

    service = new StorageService(mockRepository);
  });

  it('物件データを正常に保存する', async () => {
    const propertyData = {
      title: 'テスト物件',
      price: '1000万円',
      location: '東京都'
    };

    mockRepository.save.mockResolvedValue(propertyData as any);

    const result = await service.saveProperty(propertyData);

    expect(mockRepository.save).toHaveBeenCalledWith(propertyData);
    expect(result).toEqual(propertyData);
  });
});
```

### 4. パフォーマンステスト

#### 実行時間テスト
```typescript
// src/__tests__/performance.test.ts
import { describe, it, expect } from '@jest/globals';
import { PropertyScraper } from '../scraper.js';

describe('パフォーマンステスト', () => {
  it('スクレイピング処理が10秒以内に完了する', async () => {
    const scraper = new PropertyScraper();
    const startTime = Date.now();

    await scraper.scrapeProperties('https://test-url.com');

    const executionTime = Date.now() - startTime;
    expect(executionTime).toBeLessThan(10000); // 10秒以内
  }, 15000); // タイムアウト15秒
});
```

#### メモリ使用量テスト
```typescript
// src/__tests__/memory.test.ts
import { describe, it, expect } from '@jest/globals';
import { PropertyMonitor } from '../property-monitor.js';

describe('メモリ使用量テスト', () => {
  it('メモリ使用量が300MB以下である', async () => {
    const monitor = new PropertyMonitor();
    const initialMemory = process.memoryUsage().heapUsed;

    await monitor.runFullMonitoringCycle();

    const finalMemory = process.memoryUsage().heapUsed;
    const memoryIncrease = finalMemory - initialMemory;
    
    expect(memoryIncrease).toBeLessThan(300 * 1024 * 1024); // 300MB
  });
});
```

## 🔧 テスト実行環境

### ローカル開発環境

#### 基本コマンド
```bash
# 全テスト実行
npm run test

# 特定ファイルテスト
npm run test src/__tests__/scraper.test.ts

# 監視モード
npm run test:watch

# デバッグモード
npm run test:debug
```

#### カバレッジレポート
```bash
# カバレッジ付きテスト
npm run test:coverage

# HTMLレポート生成
npm run test:coverage:html

# カバレッジ確認
open coverage/lcov-report/index.html
```

### Docker環境でのテスト

#### テスト用Docker設定
```dockerfile
# Dockerfile.test
FROM node:18-alpine

WORKDIR /app
COPY package*.json ./
RUN npm ci

COPY . .
RUN npm run build

CMD ["npm", "run", "test:ci"]
```

#### Docker Composeでのテスト
```yaml
# docker-compose.test.yml
version: '3.8'
services:
  test:
    build:
      context: .
      dockerfile: Dockerfile.test
    volumes:
      - ./coverage:/app/coverage
    environment:
      - NODE_ENV=test
```

```bash
# Docker環境でテスト実行
docker-compose -f docker-compose.test.yml up --build
```

### CI/CD統合

#### GitHub Actions設定
```yaml
# .github/workflows/test.yml
name: Test & Quality Check

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        node-version: [18, 20]
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Setup Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v3
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci
    
    - name: Run linter
      run: npm run lint
    
    - name: Run type check
      run: npm run typecheck
    
    - name: Run tests
      run: npm run test:coverage
    
    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v3
      with:
        file: ./coverage/lcov.info
```

## 🐛 デバッグ・トラブルシューティング

### よくある問題と解決策

#### 1. ESMモジュール解決エラー
```bash
# エラー例
Error: Cannot use import statement outside a module

# 解決策
export NODE_OPTIONS='--experimental-vm-modules'
npm run test
```

#### 2. Jest設定問題
```bash
# エラー例
Jest encountered an unexpected token

# 解決策: jest.config.jsの確認
module.exports = {
  preset: 'ts-jest/presets/default-esm',
  extensionsToTreatAsEsm: ['.ts'],
  globals: {
    'ts-jest': {
      useESM: true
    }
  }
};
```

#### 3. モックが正しく動作しない
```typescript
// 正しいモック方法
jest.mock('../telegram.js', () => ({
  TelegramService: jest.fn().mockImplementation(() => ({
    sendMessage: jest.fn().mockResolvedValue('success')
  }))
}));
```

#### 4. 非同期テストのタイムアウト
```typescript
// タイムアウト設定
it('長時間実行テスト', async () => {
  // テストコード
}, 30000); // 30秒タイムアウト
```

### テストデバッグツール

#### VSCodeデバッグ設定
```json
// .vscode/launch.json
{
  "version": "0.2.0",
  "configurations": [
    {
      "name": "Debug Jest Tests",
      "type": "node",
      "request": "launch",
      "program": "${workspaceFolder}/node_modules/.bin/jest",
      "args": ["--runInBand", "--no-cache"],
      "console": "integratedTerminal",
      "internalConsoleOptions": "neverOpen"
    }
  ]
}
```

#### Chrome DevToolsでのデバッグ
```bash
# Node.js インスペクタモードでテスト実行
node --inspect-brk node_modules/.bin/jest --runInBand
```

## 📊 品質指標とレポート

### カバレッジ目標
- **ライン カバレッジ**: 80%以上
- **ブランチ カバレッジ**: 75%以上
- **ファンクション カバレッジ**: 85%以上
- **ステートメント カバレッジ**: 80%以上

### 品質チェックリスト
- [ ] 全テストがパスしている
- [ ] カバレッジが目標値を上回っている
- [ ] ESLintエラーがない
- [ ] TypeScriptエラーがない
- [ ] パフォーマンステストがパスしている

### 継続的改善
```bash
# 週次品質レポート生成
npm run test:coverage
npm run lint:report
npm run performance:report

# レポート統合
npm run quality:report:full
```

## 📚 参考資料

### 公式ドキュメント
- [Jest Documentation](https://jestjs.io/docs/getting-started)
- [TypeScript Jest](https://kulshekhar.github.io/ts-jest/)
- [ESM Support](https://jestjs.io/docs/ecmascript-modules)

### ベストプラクティス
- [JavaScript Testing Best Practices](https://github.com/goldbergyoni/javascript-testing-best-practices)
- [Node.js Testing Guide](https://nodejs.org/en/docs/guides/testing/)

---

**更新日**: 2025年8月26日  
**バージョン**: 2.0（ESM + Jest 29.x対応）
