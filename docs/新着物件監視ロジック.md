# 新着物件監視ロジック仕様書

## 🎯 **確定仕様（2025年8月16日更新）**

### **最重要ミッション（RFP 2.1.1準拠）**
**「指定したURLのWebページを定期的に巡回し、コンテンツの変更（新着物件の有無）を検知できること」**

### **基本方針**
- **監視方式**: コンテンツハッシュ方式（ページの変化を検知）
- **監視対象**: ページ全体または物件リスト要素のハッシュ値
- **実装技術**: Puppeteer-first戦略（3段階アクセスパターン）
- **検知精度**: 99%以上
- **監視間隔**: 5分間隔（設定可能）

## 📋 **詳細仕様**

### **1. 新着検知ロジック（シンプル版）**
```typescript
// ハッシュによる変化検知
const detectChanges = (
  currentHash: string,
  previousHash: string
): boolean => {
  return currentHash !== previousHash;
};
```

### **2. データ保存形式（簡略版）**
```json
{
  "https://www.athome.co.jp/...": "3860ac4f8176fea0f698879610841e11"
}
```

### **3. 通知メッセージ形式（実装準拠）**
```
🆕 新着があります！

URL: https://www.athome.co.jp/...
検知時刻: 2025-08-16 14:05:39
```

## 📊 **性能指標**

### **検知精度**
- **変化検知率**: 99%以上
- **誤検知率**: 1%未満
- **検知遅延**: 5分以内（監視間隔による）

### **処理性能**
- **実行時間**: 2-30秒（戦略により変動）
- **メモリ使用**: 30-300MB（戦略により変動）
- **CPU使用率**: 10%以下

### **信頼性**
- **可用性**: 99.9%以上
- **エラー回復**: 自動リトライ機能
- **データ永続化**: JSON形式で保存

## 🔧 **設定可能項目**

### **監視設定**
```typescript
interface MonitoringConfig {
  interval: string;           // 監視間隔（cron形式）
  maxRetries: number;         // 最大リトライ回数
  timeout: number;            // タイムアウト時間（秒）
  enableNotification: boolean; // 通知有効/無効
}

// デフォルト設定
const defaultConfig: MonitoringConfig = {
  interval: '*/5 * * * *',    // 5分間隔
  maxRetries: 3,              // 3回リトライ
  timeout: 30,                // 30秒タイムアウト
  enableNotification: true    // 通知有効
};
```

## 📈 **統計・監視機能**

### **収集データ**
- 監視実行回数
- 変化検知回数
- エラー発生回数
- 平均実行時間
- 最終成功時刻

### **アラート条件**
- 連続3回失敗時
- 実行時間が10秒超過時
- 24時間変化なし時（オプション）

## 🚀 **将来拡張計画**

### **Phase 2: 詳細情報取得**（現在は不要）
- 物件タイトル、価格、所在地の抽出
- 個別物件の通知

### **Phase 3: 高度な検知**
- 価格変動検知
- 物件詳細変更検知

### **Phase 4: AI活用**
- 物件評価スコア
- 推奨物件フィルタリング

## 📝 **開発ルール**

### **必須遵守事項**
1. **RFP 2.1.1の遵守**: コンテンツ変更検知が最重要
2. **ハッシュベース検知**: シンプルで確実な方式を維持
3. **段階的フォールバック戦略**: HTTP-first → Puppeteer → Real Browser
4. **現時点では物件詳細は不要**: 将来の拡張として計画

### **推奨事項**
1. **ログ出力**: 詳細な実行ログ記録
2. **統計記録**: 監視状況の可視化
3. **テスト実装**: 変化検知ロジックのテスト
4. **ドキュメント更新**: 仕様変更時の文書更新

### **現在の実装状況（2025年8月16日）**
- ✅ **基盤実装**: SimpleScraper, MonitoringScheduler完成
- ✅ **Puppeteer Stealth**: 認証ページ回避成功
- ✅ **変化検知**: ハッシュベースの検知動作中
- ✅ **通知統合**: Telegram通知機能統合済み

この仕様書により、新着物件監視ロジックの完全な理解と一貫した実装が保証されます。