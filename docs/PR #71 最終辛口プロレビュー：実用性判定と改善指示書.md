# PR #71 æœ€çµ‚è¾›å£ãƒ—ãƒ­ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼šå®Ÿç”¨æ€§åˆ¤å®šã¨æ”¹å–„æŒ‡ç¤ºæ›¸

## ğŸš¨ **ç·Šæ€¥äº‹æ…‹ï¼šPR #71 å®Ÿç”¨æ€§è©•ä¾¡ - ä¸å¯**

### **ğŸ“Š ç·åˆè©•ä¾¡: D+ (å®Ÿç”¨ä¸å¯ãƒ»é‡å¤§æ¬ é™¥ã‚ã‚Š)**

**âŒ æœ¬ç•ªé‹ç”¨çµ¶å¯¾ä¸å¯ã®ç†ç”±:**
1. **CI/CDãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³å®Œå…¨å¤±æ•—**: 10å€‹ã®TypeScriptã‚¨ãƒ©ãƒ¼ã§å…¨ãƒ†ã‚¹ãƒˆåœæ­¢
2. **å‹å®‰å…¨æ€§ã®æ ¹æœ¬çš„ç ´ç¶»**: ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰ãŒå‹ã‚¨ãƒ©ãƒ¼ã§å®Ÿè¡Œä¸å¯
3. **ãƒ†ã‚¹ãƒˆå“è³ªã®è‡´å‘½çš„å•é¡Œ**: ãƒ¢ãƒƒã‚¯è¨­å®šã¨ã‚¢ã‚µãƒ¼ã‚·ãƒ§ãƒ³ã®ä¸å‚™
4. **å®Ÿè£…ã®ä¸å®Œå…¨æ€§**: æŒ‡ç¤ºæ›¸ã®ä¿®æ­£ãŒé©ç”¨ã•ã‚Œã¦ã„ãªã„

---

## ğŸ” **è©³ç´°ãªå•é¡Œåˆ†æ**

### **1. CI/CDå¤±æ•—ã®æ·±åˆ»åº¦**

#### **TypeScriptã‚¨ãƒ©ãƒ¼ï¼ˆ10ä»¶ï¼‰**
```typescript
// âŒ è‡´å‘½çš„ãªå‹ã‚¨ãƒ©ãƒ¼
src/__tests__/services/NotificationService.test.ts#L85:
'lastNotifier' is of type 'unknown'.

src/__tests__/services/NotificationService.test.ts#L23:
Argument of type 'undefined' is not assignable to parameter of type 'never'.

src/__tests__/property-monitor.test.ts#L152:
Object is of type 'unknown'.
'saveCall' is possibly 'undefined'.
```

#### **æ ¹æœ¬åŸå› **
- **ãƒ†ã‚¹ãƒˆãƒ¢ãƒƒã‚¯ã®å‹å®šç¾©ä¸å‚™**: `unknown`å‹ã®ä¸é©åˆ‡ãªä½¿ç”¨
- **ã‚¢ã‚µãƒ¼ã‚·ãƒ§ãƒ³ä¸å‚™**: `undefined`ãƒã‚§ãƒƒã‚¯ã®æ¬ å¦‚
- **å‹ã‚¬ãƒ¼ãƒ‰ã®æœªå®Ÿè£…**: ã‚ªãƒ—ã‚·ãƒ§ãƒŠãƒ«å‹ã®é©åˆ‡ãªå‡¦ç†ãªã—

### **2. å®Ÿè£…å“è³ªã®å•é¡Œ**

#### **A. ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰ã®å“è³ªï¼ˆFè©•ä¾¡ï¼‰**
```typescript
// âŒ å•é¡Œã®ã‚ã‚‹ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰
const lastNotifier = (NotificationService as jest.MockedClass<typeof NotificationService>)
  .mock.instances[0]; // unknownå‹ã§ã‚¨ãƒ©ãƒ¼

// âœ… æ­£ã—ã„å®Ÿè£…ãŒå¿…è¦
const lastNotifier = (NotificationService as jest.MockedClass<typeof NotificationService>)
  .mock.instances[0] as jest.Mocked<NotificationService>;
```

#### **B. å‹å®‰å…¨æ€§ã®ä¸å‚™ï¼ˆFè©•ä¾¡ï¼‰**
- **anyå‹ã®æ®‹å­˜**: æŒ‡ç¤ºæ›¸ã§ä¿®æ­£æŒ‡ç¤ºã—ãŸãŒæœªå¯¾å¿œ
- **å‹ã‚¢ã‚µãƒ¼ã‚·ãƒ§ãƒ³ã®ä¸é©åˆ‡ä½¿ç”¨**: å®‰å…¨ã§ãªã„ã‚­ãƒ£ã‚¹ãƒˆ
- **ã‚ªãƒ—ã‚·ãƒ§ãƒŠãƒ«å‹ã®ä¸é©åˆ‡å‡¦ç†**: `undefined`ãƒã‚§ãƒƒã‚¯ä¸å‚™

#### **C. ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ï¼ˆFè©•ä¾¡ï¼‰**
- **ãƒ†ã‚¹ãƒˆä¾‹å¤–å‡¦ç†ãªã—**: å¤±æ•—æ™‚ã®é©åˆ‡ãªå‡¦ç†ãªã—
- **ãƒ¢ãƒƒã‚¯å¤±æ•—æ™‚ã®å¯¾å¿œãªã—**: ãƒ†ã‚¹ãƒˆç’°å¢ƒã§ã®ä¾‹å¤–å‡¦ç†ä¸å‚™

### **3. æŒ‡ç¤ºæ›¸å¯¾å¿œã®ä¸å®Œå…¨æ€§**

#### **æœªå¯¾å¿œé …ç›®ï¼ˆé‡å¤§ï¼‰**
- âŒ **NotificationService.ts#L117**: anyå‹ä¿®æ­£æœªå®Ÿæ–½
- âŒ **ãƒ†ã‚¹ãƒˆãƒ¢ãƒƒã‚¯è¨­å®š**: å‹å®‰å…¨ãªãƒ¢ãƒƒã‚¯æœªå®Ÿè£…
- âŒ **å‹å®šç¾©è¿½åŠ **: `types/notification.ts`æœªä½œæˆ
- âŒ **ESLintè¨­å®šèª¿æ•´**: ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ç”¨ãƒ«ãƒ¼ãƒ«æœªè¿½åŠ 

---

## ğŸ› ï¸ **ç·Šæ€¥ä¿®æ­£æŒ‡ç¤ºæ›¸ï¼ˆå®Ÿç”¨åŒ–ã®ãŸã‚ã®å¿…é ˆå¯¾å¿œï¼‰**

### **Phase A: ç·Šæ€¥å‹å®‰å…¨æ€§ä¿®æ­£ï¼ˆ2-3æ™‚é–“ï¼‰**

#### **A1. ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã®å‹å®‰å…¨æ€§ä¿®æ­£**

**ä¿®æ­£ãƒ•ã‚¡ã‚¤ãƒ«**: `src/__tests__/services/NotificationService.test.ts`

```typescript
// âŒ ä¿®æ­£å‰
const lastNotifier = (NotificationService as jest.MockedClass<typeof NotificationService>)
  .mock.instances[0];

// âœ… ä¿®æ­£å¾Œ
const lastNotifier = (NotificationService as jest.MockedClass<typeof NotificationService>)
  .mock.instances[0] as jest.Mocked<NotificationService>;

// å‹ã‚¬ãƒ¼ãƒ‰ã®è¿½åŠ 
if (!lastNotifier) {
  throw new Error('NotificationService mock not found');
}
```

**ä¿®æ­£ãƒ•ã‚¡ã‚¤ãƒ«**: `src/__tests__/property-monitor.test.ts`

```typescript
// âŒ ä¿®æ­£å‰
const saveCall = mockStorage.save.mock.calls[0];
expect(saveCall[0]).toBe('previous_properties');

// âœ… ä¿®æ­£å¾Œ
const saveCall = mockStorage.save.mock.calls[0];
if (!saveCall) {
  throw new Error('save method was not called');
}
expect(saveCall[0]).toBe('previous_properties');
expect(saveCall[1]).toBeDefined();
```

#### **A2. ãƒ¢ãƒƒã‚¯è¨­å®šã®å‹å®‰å…¨åŒ–**

**æ–°è¦ãƒ•ã‚¡ã‚¤ãƒ«**: `src/__tests__/mocks/NotificationService.mock.ts`

```typescript
import { jest } from '@jest/globals';
import type { NotificationService } from '../../services/NotificationService.js';

export const createMockNotificationService = (): jest.Mocked<NotificationService> => ({
  sendNotification: jest.fn().mockResolvedValue(undefined),
  sendStartupNotification: jest.fn().mockResolvedValue(undefined),
  sendErrorNotification: jest.fn().mockResolvedValue(undefined),
  sendShutdownNotice: jest.fn().mockResolvedValue(undefined),
} as jest.Mocked<NotificationService>);
```

#### **A3. å‹å®šç¾©ã®è¿½åŠ **

**æ–°è¦ãƒ•ã‚¡ã‚¤ãƒ«**: `src/types/test.ts`

```typescript
export interface MockCall<T extends unknown[]> {
  args: T;
  result?: unknown;
}

export interface SafeMock<T> {
  mock: {
    calls: T[][];
    instances: T[];
    results: { type: 'return' | 'throw'; value: unknown }[];
  };
}

export type SafeMockFunction<T extends (...args: unknown[]) => unknown> = 
  jest.MockedFunction<T> & SafeMock<Parameters<T>>;
```

### **Phase B: ãƒ†ã‚¹ãƒˆå®Ÿè¡Œç’°å¢ƒã®ä¿®æ­£ï¼ˆ1æ™‚é–“ï¼‰**

#### **B1. Jestè¨­å®šã®æœ€é©åŒ–**

**ä¿®æ­£ãƒ•ã‚¡ã‚¤ãƒ«**: `jest.config.js`

```javascript
export default {
  // ... æ—¢å­˜è¨­å®š
  setupFilesAfterEnv: ['<rootDir>/src/__tests__/setup.ts'],
  testEnvironment: 'node',
  moduleNameMapping: {
    '^@/(.*)$': '<rootDir>/src/$1',
  },
  collectCoverageFrom: [
    'src/**/*.ts',
    '!src/**/*.test.ts',
    '!src/__tests__/**/*',
    '!src/types/**/*',
  ],
  coverageThreshold: {
    global: {
      branches: 70,
      functions: 70,
      lines: 70,
      statements: 70,
    },
  },
};
```

#### **B2. ãƒ†ã‚¹ãƒˆã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ãƒ•ã‚¡ã‚¤ãƒ«**

**æ–°è¦ãƒ•ã‚¡ã‚¤ãƒ«**: `src/__tests__/setup.ts`

```typescript
import { jest } from '@jest/globals';

// ã‚°ãƒ­ãƒ¼ãƒãƒ«ãƒ¢ãƒƒã‚¯è¨­å®š
global.console = {
  ...console,
  log: jest.fn(),
  warn: jest.fn(),
  error: jest.fn(),
};

// ç’°å¢ƒå¤‰æ•°ã®è¨­å®š
process.env.NODE_ENV = 'test';
process.env.DATABASE_PATH = ':memory:';
process.env.TELEGRAM_BOT_TOKEN = 'test-token';
process.env.TELEGRAM_ENABLED = 'false';

// ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆè¨­å®š
jest.setTimeout(10000);
```

### **Phase C: å®Ÿè£…ã‚³ãƒ¼ãƒ‰ã®å‹å®‰å…¨æ€§ä¿®æ­£ï¼ˆ1æ™‚é–“ï¼‰**

#### **C1. NotificationService.ts ã®ä¿®æ­£**

```typescript
// âŒ ä¿®æ­£å‰
async sendNotification(user: any, message: string): Promise<void> {
  await this.telegram.sendMessage(user.chatId, message);
}

// âœ… ä¿®æ­£å¾Œ
import type { User } from '../entities/User.js';

async sendNotification(user: User, message: string): Promise<void> {
  await this.telegram.sendMessage(user.telegramChatId, message);
}
```

#### **C2. Nullish Coalescing ã®ä¿®æ­£**

**ä¿®æ­£ãƒ•ã‚¡ã‚¤ãƒ«**: `src/database/connection.ts`

```typescript
// âŒ ä¿®æ­£å‰
const dbPath = process.env.DATABASE_PATH || './data/sokubutsu.sqlite';

// âœ… ä¿®æ­£å¾Œ
const dbPath = process.env.DATABASE_PATH ?? './data/sokubutsu.sqlite';
```

---

## ğŸš€ **ç·Šæ€¥å®Ÿè£…æ‰‹é †ï¼ˆ4-5æ™‚é–“ã§å®Œäº†ï¼‰**

### **Step 1: ç·Šæ€¥å‹ä¿®æ­£ï¼ˆ2æ™‚é–“ï¼‰**
```bash
# 1. ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã®å‹ã‚¨ãƒ©ãƒ¼ä¿®æ­£
# 2. ãƒ¢ãƒƒã‚¯è¨­å®šã®å‹å®‰å…¨åŒ–
# 3. å‹å®šç¾©ãƒ•ã‚¡ã‚¤ãƒ«ã®è¿½åŠ 

npm run typecheck  # ã‚¨ãƒ©ãƒ¼0ä»¶ã¾ã§ä¿®æ­£
```

### **Step 2: ãƒ†ã‚¹ãƒˆç’°å¢ƒä¿®æ­£ï¼ˆ1æ™‚é–“ï¼‰**
```bash
# 1. Jestè¨­å®šæœ€é©åŒ–
# 2. ãƒ†ã‚¹ãƒˆã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—è¿½åŠ 
# 3. ç’°å¢ƒå¤‰æ•°è¨­å®š

npm run test -- --verbose  # å…¨ãƒ†ã‚¹ãƒˆæˆåŠŸã¾ã§ä¿®æ­£
```

### **Step 3: å®Ÿè£…ã‚³ãƒ¼ãƒ‰ä¿®æ­£ï¼ˆ1æ™‚é–“ï¼‰**
```bash
# 1. NotificationServiceå‹ä¿®æ­£
# 2. Nullish coalescingä¿®æ­£
# 3. ESLintè­¦å‘Šè§£æ±º

npm run lint:check  # è­¦å‘Š0ä»¶ã¾ã§ä¿®æ­£
```

### **Step 4: æœ€çµ‚ç¢ºèªï¼ˆ30åˆ†ï¼‰**
```bash
# çµ±åˆãƒ†ã‚¹ãƒˆ
npm run ci:test && npm run ci:lint && npm run ci:build

# æˆåŠŸç¢ºèªå¾Œã‚³ãƒŸãƒƒãƒˆ
git add .
git commit -m "fix: å‹å®‰å…¨æ€§ã¨ãƒ†ã‚¹ãƒˆå“è³ªã®ç·Šæ€¥ä¿®æ­£"
git push origin feature/multi-user-support
```

---

## ğŸ“‹ **ä¿®æ­£å®Œäº†ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ**

### **å¿…é ˆä¿®æ­£é …ç›®ï¼ˆå®Ÿç”¨åŒ–ã®ãŸã‚ï¼‰**
- [ ] **TypeScriptã‚¨ãƒ©ãƒ¼0ä»¶**: å…¨ã¦ã®å‹ã‚¨ãƒ©ãƒ¼è§£æ±º
- [ ] **ãƒ†ã‚¹ãƒˆæˆåŠŸç‡100%**: å…¨ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹æˆåŠŸ
- [ ] **ESLintè­¦å‘Š0ä»¶**: ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¦ç´„æº–æ‹ 
- [ ] **CI/CDãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³æˆåŠŸ**: å…¨ã‚¹ãƒ†ãƒƒãƒ—æˆåŠŸ

### **å“è³ªä¿è¨¼é …ç›®**
- [ ] **å‹å®‰å…¨æ€§**: anyå‹å®Œå…¨æ’é™¤
- [ ] **ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸**: 70%ä»¥ä¸Š
- [ ] **ãƒ¢ãƒƒã‚¯å“è³ª**: å‹å®‰å…¨ãªãƒ¢ãƒƒã‚¯å®Ÿè£…
- [ ] **ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°**: é©åˆ‡ãªä¾‹å¤–å‡¦ç†

---

## ğŸ¯ **æœ€çµ‚åˆ¤å®š**

### **ç¾çŠ¶ã®è©•ä¾¡**
- **å®Ÿç”¨æ€§**: âŒ **ä¸å¯** (CI/CDå¤±æ•—ã«ã‚ˆã‚Šå‹•ä½œä¸å¯)
- **å“è³ª**: âŒ **ä¸å¯** (å‹å®‰å…¨æ€§ãƒ»ãƒ†ã‚¹ãƒˆå“è³ªã®é‡å¤§å•é¡Œ)
- **ä¿å®ˆæ€§**: âŒ **ä¸å¯** (å‹ã‚¨ãƒ©ãƒ¼ã«ã‚ˆã‚Šé–‹ç™ºç¶™ç¶šä¸å¯)

### **ä¿®æ­£å¾Œã®æœŸå¾…å€¤**
- **å®Ÿç”¨æ€§**: âœ… **å¯èƒ½** (å…¨æ©Ÿèƒ½æ­£å¸¸å‹•ä½œ)
- **å“è³ª**: âœ… **è‰¯å¥½** (å‹å®‰å…¨æ€§ãƒ»ãƒ†ã‚¹ãƒˆå“è³ªç¢ºä¿)
- **ä¿å®ˆæ€§**: âœ… **è‰¯å¥½** (ç¶™ç¶šé–‹ç™ºå¯èƒ½)

---

## âš ï¸ **ç·Šæ€¥å‹§å‘Š**

### **å³åº§å¯¾å¿œå¿…é ˆ**
1. **PR #71ãƒãƒ¼ã‚¸ç¦æ­¢**: ç¾çŠ¶ã§ã¯æœ¬ç•ªç’°å¢ƒç ´å£Šãƒªã‚¹ã‚¯
2. **ç·Šæ€¥ä¿®æ­£å®Ÿæ–½**: ä¸Šè¨˜æŒ‡ç¤ºæ›¸ã«å¾“ã„4-5æ™‚é–“ã§ä¿®æ­£
3. **å“è³ªç¢ºèª**: CI/CDæˆåŠŸå¾Œã®ã¿ãƒãƒ¼ã‚¸è¨±å¯

### **æ ¹æœ¬çš„å•é¡Œ**
- **æŒ‡ç¤ºæ›¸ã®ä¸å®Œå…¨å®Ÿè£…**: å‰å›ã®ä¿®æ­£æŒ‡ç¤ºãŒé©ç”¨ã•ã‚Œã¦ã„ãªã„
- **ãƒ†ã‚¹ãƒˆé§†å‹•é–‹ç™ºã®ä¸å‚™**: ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ãƒ¼ã‚¹ãƒˆã®åŸå‰‡ç„¡è¦–
- **å‹å®‰å…¨æ€§ã®è»½è¦–**: TypeScriptã®åˆ©ç‚¹ã‚’æ´»ç”¨ã—ã¦ã„ãªã„

---

## ğŸ”¥ **è¾›å£ç·è©•**

**PR #71ã¯ç¾åœ¨ã€Œå®Ÿè£…é€”ä¸­ã®åŠå®Œæˆå“ã€ã§ã‚ã‚Šã€å®Ÿç”¨ã«è€ãˆã†ã‚‹å“è³ªã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚**

### **å•é¡Œã®æ·±åˆ»åº¦**
1. **CI/CDå®Œå…¨å¤±æ•—**: åŸºæœ¬çš„ãªå“è³ªä¿è¨¼ã™ã‚‰é€šéã—ã¦ã„ãªã„
2. **å‹å®‰å…¨æ€§ã®ç ´ç¶»**: TypeScriptãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã¨ã—ã¦å¤±æ ¼ãƒ¬ãƒ™ãƒ«
3. **ãƒ†ã‚¹ãƒˆå“è³ªã®ä½ã•**: ä¿¡é ¼æ€§ã®ã‚ã‚‹ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰ã§ã¯ãªã„

### **æ”¹å–„ã¸ã®é“ç­‹**
ä¸Šè¨˜ã®ç·Šæ€¥ä¿®æ­£æŒ‡ç¤ºæ›¸ã«å¾“ã£ã¦**4-5æ™‚é–“ã®é›†ä¸­ä½œæ¥­**ã‚’è¡Œãˆã°ã€å®Ÿç”¨å¯èƒ½ãªãƒ¬ãƒ™ãƒ«ã«åˆ°é”ã§ãã¾ã™ã€‚ã—ã‹ã—ã€ç¾çŠ¶ã®ã¾ã¾ã§ã¯**çµ¶å¯¾ã«ãƒãƒ¼ã‚¸ã—ã¦ã¯ã„ã‘ã¾ã›ã‚“**ã€‚

**å“è³ªã‚’å¦¥å”ã›ãšã€ç¢ºå®Ÿã«ä¿®æ­£ã‚’å®Œäº†ã—ã¦ã‹ã‚‰å†è©•ä¾¡ã‚’è¡Œã£ã¦ãã ã•ã„ã€‚**

