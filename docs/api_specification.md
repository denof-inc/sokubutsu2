# ã‚½ã‚¯ãƒ–ãƒ„ APIä»•æ§˜æ›¸

**ãƒãƒ¼ã‚¸ãƒ§ãƒ³**: 1.0  
**ä½œæˆæ—¥**: 2025å¹´7æœˆ25æ—¥  
**ä½œæˆè€…**: ãƒ†ãƒƒã‚¯ãƒªãƒ¼ãƒ‰ï¼ˆManus AIï¼‰  
**å¯¾è±¡ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ**: ã‚½ã‚¯ãƒ–ãƒ„ï¼ˆsokubutsu2ï¼‰

## æ¦‚è¦

ã‚½ã‚¯ãƒ–ãƒ„ã¯ç‰©ä»¶æ–°ç€é€šçŸ¥ã‚·ã‚¹ãƒ†ãƒ ã®APIã§ã™ã€‚REST APIã¨Telegram Bot APIã®ä¸¡æ–¹ã‚’æä¾›ã—ã€URLç›£è¦–æ©Ÿèƒ½ã¨é€šçŸ¥æ©Ÿèƒ½ã‚’å®Ÿç¾ã—ã¾ã™ã€‚

### æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯
- **ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯**: NestJS 10.x
- **è¨€èª**: TypeScript 5.x
- **ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹**: SQLiteï¼ˆbetter-sqlite3æ¨å¥¨ï¼‰
- **é€šçŸ¥**: Telegram Bot API
- **ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°**: Playwright

## èªè¨¼

### Telegram Botèªè¨¼
Telegram Bot APIã‚’ä½¿ç”¨ã—ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼èªè¨¼ã‚’å®Ÿè£…ã—ã¾ã™ã€‚

```typescript
// ç’°å¢ƒå¤‰æ•°
TELEGRAM_BOT_TOKEN=your_bot_token_here
```

## REST API ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ

### 1. ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯

#### GET /health
ã‚·ã‚¹ãƒ†ãƒ ã®ç¨¼åƒçŠ¶æ³ã‚’ç¢ºèªã—ã¾ã™ã€‚

**ãƒªã‚¯ã‚¨ã‚¹ãƒˆ**
```http
GET /health
```

**ãƒ¬ã‚¹ãƒãƒ³ã‚¹**
```json
{
  "status": "ok",
  "info": {
    "database": { "status": "up" },
    "telegram": { "status": "up" }
  },
  "details": {
    "database": { "status": "up" },
    "telegram": { "status": "up" }
  }
}
```

**ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚³ãƒ¼ãƒ‰**
- `200`: æ­£å¸¸
- `503`: ã‚µãƒ¼ãƒ“ã‚¹åˆ©ç”¨ä¸å¯

### 2. URLç®¡ç†

#### GET /urls
ç™»éŒ²æ¸ˆã¿URLä¸€è¦§ã‚’å–å¾—ã—ã¾ã™ã€‚

**ãƒªã‚¯ã‚¨ã‚¹ãƒˆ**
```http
GET /urls
```

**ãƒ¬ã‚¹ãƒãƒ³ã‚¹**
```json
{
  "data": [
    {
      "id": 1,
      "name": "æ¸‹è°·ã‚¨ãƒªã‚¢ç‰©ä»¶",
      "url": "https://example.com/properties",
      "selector": ".property-list",
      "contentHash": "abc123...",
      "isActive": true,
      "createdAt": "2025-07-25T10:00:00Z",
      "updatedAt": "2025-07-25T10:00:00Z"
    }
  ],
  "total": 1
}
```

#### POST /urls
æ–°ã—ã„ç›£è¦–URLã‚’ç™»éŒ²ã—ã¾ã™ã€‚

**ãƒªã‚¯ã‚¨ã‚¹ãƒˆ**
```http
POST /urls
Content-Type: application/json

{
  "name": "æ–°å®¿ã‚¨ãƒªã‚¢ç‰©ä»¶",
  "url": "https://example.com/shinjuku",
  "selector": ".property-item"
}
```

**ãƒ¬ã‚¹ãƒãƒ³ã‚¹**
```json
{
  "data": {
    "id": 2,
    "name": "æ–°å®¿ã‚¨ãƒªã‚¢ç‰©ä»¶",
    "url": "https://example.com/shinjuku",
    "selector": ".property-item",
    "contentHash": null,
    "isActive": true,
    "createdAt": "2025-07-25T11:00:00Z",
    "updatedAt": "2025-07-25T11:00:00Z"
  }
}
```

**ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚³ãƒ¼ãƒ‰**
- `201`: ä½œæˆæˆåŠŸ
- `400`: ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼
- `409`: URLé‡è¤‡ã‚¨ãƒ©ãƒ¼

#### PUT /urls/:id
æ—¢å­˜URLã®è¨­å®šã‚’æ›´æ–°ã—ã¾ã™ã€‚

**ãƒªã‚¯ã‚¨ã‚¹ãƒˆ**
```http
PUT /urls/1
Content-Type: application/json

{
  "name": "æ¸‹è°·ã‚¨ãƒªã‚¢ç‰©ä»¶ï¼ˆæ›´æ–°ï¼‰",
  "selector": ".new-property-list",
  "isActive": false
}
```

**ãƒ¬ã‚¹ãƒãƒ³ã‚¹**
```json
{
  "data": {
    "id": 1,
    "name": "æ¸‹è°·ã‚¨ãƒªã‚¢ç‰©ä»¶ï¼ˆæ›´æ–°ï¼‰",
    "url": "https://example.com/properties",
    "selector": ".new-property-list",
    "contentHash": "abc123...",
    "isActive": false,
    "createdAt": "2025-07-25T10:00:00Z",
    "updatedAt": "2025-07-25T12:00:00Z"
  }
}
```

#### DELETE /urls/:id
URLã‚’å‰Šé™¤ã—ã¾ã™ã€‚

**ãƒªã‚¯ã‚¨ã‚¹ãƒˆ**
```http
DELETE /urls/1
```

**ãƒ¬ã‚¹ãƒãƒ³ã‚¹**
```json
{
  "message": "URL deleted successfully"
}
```

**ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚³ãƒ¼ãƒ‰**
- `200`: å‰Šé™¤æˆåŠŸ
- `404`: URLæœªç™ºè¦‹

### 3. ç›£è¦–ãƒ­ã‚°

#### GET /monitoring-logs
ç›£è¦–å®Ÿè¡Œãƒ­ã‚°ã‚’å–å¾—ã—ã¾ã™ã€‚

**ãƒªã‚¯ã‚¨ã‚¹ãƒˆ**
```http
GET /monitoring-logs?urlId=1&limit=10&offset=0
```

**ãƒ¬ã‚¹ãƒãƒ³ã‚¹**
```json
{
  "data": [
    {
      "id": 1,
      "urlId": 1,
      "status": "success",
      "hasNewContent": false,
      "contentHash": "abc123...",
      "executedAt": "2025-07-25T13:00:00Z",
      "errorMessage": null
    }
  ],
  "total": 1
}
```

## Telegram Bot API

### ã‚³ãƒãƒ³ãƒ‰ä¸€è¦§

#### /start
ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²ã¨åˆ©ç”¨é–‹å§‹

**ä½¿ç”¨ä¾‹**
```
/start
```

**ãƒ¬ã‚¹ãƒãƒ³ã‚¹**
```
ã‚½ã‚¯ãƒ–ãƒ„ã¸ã‚ˆã†ã“ãï¼
ç‰©ä»¶ã®æ–°ç€é€šçŸ¥ã‚’é–‹å§‹ã—ã¾ã™ã€‚

åˆ©ç”¨å¯èƒ½ãªã‚³ãƒãƒ³ãƒ‰:
/add - URLç™»éŒ²
/list - URLä¸€è¦§
/pause - ç›£è¦–åœæ­¢
/resume - ç›£è¦–å†é–‹
/delete - URLå‰Šé™¤
/help - ãƒ˜ãƒ«ãƒ—
```

#### /add
æ–°è¦ç›£è¦–URLç™»éŒ²

**ä½¿ç”¨ä¾‹**
```
/add https://example.com/properties æ¸‹è°·ã‚¨ãƒªã‚¢ç‰©ä»¶
```

**ãƒ¬ã‚¹ãƒãƒ³ã‚¹**
```
âœ… URLç™»éŒ²å®Œäº†
åå‰: æ¸‹è°·ã‚¨ãƒªã‚¢ç‰©ä»¶
URL: https://example.com/properties
ID: 1

ç›£è¦–ã‚’é–‹å§‹ã—ã¾ã—ãŸã€‚
```

#### /list
ç™»éŒ²æ¸ˆã¿URLä¸€è¦§è¡¨ç¤º

**ä½¿ç”¨ä¾‹**
```
/list
```

**ãƒ¬ã‚¹ãƒãƒ³ã‚¹**
```
ğŸ“‹ ç™»éŒ²æ¸ˆã¿URLä¸€è¦§

1. æ¸‹è°·ã‚¨ãƒªã‚¢ç‰©ä»¶ âœ…
   https://example.com/properties
   
2. æ–°å®¿ã‚¨ãƒªã‚¢ç‰©ä»¶ â¸ï¸
   https://example.com/shinjuku

åˆè¨ˆ: 2ä»¶
```

#### /pause
URLç›£è¦–ã‚’ä¸€æ™‚åœæ­¢

**ä½¿ç”¨ä¾‹**
```
/pause 1
```

**ãƒ¬ã‚¹ãƒãƒ³ã‚¹**
```
â¸ï¸ ç›£è¦–ã‚’åœæ­¢ã—ã¾ã—ãŸ
ID: 1 - æ¸‹è°·ã‚¨ãƒªã‚¢ç‰©ä»¶
```

#### /resume
URLç›£è¦–ã‚’å†é–‹

**ä½¿ç”¨ä¾‹**
```
/resume 1
```

**ãƒ¬ã‚¹ãƒãƒ³ã‚¹**
```
â–¶ï¸ ç›£è¦–ã‚’å†é–‹ã—ã¾ã—ãŸ
ID: 1 - æ¸‹è°·ã‚¨ãƒªã‚¢ç‰©ä»¶
```

#### /delete
URLå‰Šé™¤

**ä½¿ç”¨ä¾‹**
```
/delete 1
```

**ãƒ¬ã‚¹ãƒãƒ³ã‚¹**
```
ğŸ—‘ï¸ URLã‚’å‰Šé™¤ã—ã¾ã—ãŸ
ID: 1 - æ¸‹è°·ã‚¨ãƒªã‚¢ç‰©ä»¶
```

### è‡ªå‹•é€šçŸ¥

#### æ–°ç€ç‰©ä»¶ç™ºè¦‹æ™‚
```
ğŸ†• æ–°ç€ç‰©ä»¶ã‚’ç™ºè¦‹ã—ã¾ã—ãŸï¼

ğŸ“ æ¸‹è°·ã‚¨ãƒªã‚¢ç‰©ä»¶
ğŸ”— https://example.com/properties
â° 2025-07-25 14:30

è©³ç´°ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚
```

#### ç›£è¦–ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹é€šçŸ¥ï¼ˆ1æ™‚é–“æ¯ï¼‰
```
ğŸ“Š ç›£è¦–ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å ±å‘Š

âœ… æ¸‹è°·ã‚¨ãƒªã‚¢ç‰©ä»¶: æ­£å¸¸ç›£è¦–ä¸­
âš ï¸ æ–°å®¿ã‚¨ãƒªã‚¢ç‰©ä»¶: ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿ
â¸ï¸ æ± è¢‹ã‚¨ãƒªã‚¢ç‰©ä»¶: åœæ­¢ä¸­

æœ€çµ‚æ›´æ–°: 2025-07-25 15:00
```

#### ã‚¨ãƒ©ãƒ¼é€šçŸ¥
```
âŒ ç›£è¦–ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ

ğŸ“ æ¸‹è°·ã‚¨ãƒªã‚¢ç‰©ä»¶
ğŸ”— https://example.com/properties
â— ã‚¨ãƒ©ãƒ¼: ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ

â° 2025-07-25 14:45
```

## ãƒ‡ãƒ¼ã‚¿å‹å®šç¾©

### URL Entity
```typescript
interface Url {
  id: number;
  name: string;
  url: string;
  selector: string;
  contentHash: string | null;
  isActive: boolean;
  createdAt: Date;
  updatedAt: Date;
}
```

### MonitoringLog Entity
```typescript
interface MonitoringLog {
  id: number;
  urlId: number;
  status: 'success' | 'error';
  hasNewContent: boolean;
  contentHash: string | null;
  executedAt: Date;
  errorMessage: string | null;
}
```

### User Entity
```typescript
interface User {
  id: number;
  telegramId: string;
  username: string | null;
  isActive: boolean;
  createdAt: Date;
  updatedAt: Date;
}
```

## ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°

### ã‚¨ãƒ©ãƒ¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹å½¢å¼
```json
{
  "error": {
    "code": "VALIDATION_ERROR",
    "message": "Invalid URL format",
    "details": {
      "field": "url",
      "value": "invalid-url"
    }
  },
  "timestamp": "2025-07-25T15:00:00Z",
  "path": "/urls"
}
```

### ã‚¨ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰ä¸€è¦§

| ã‚³ãƒ¼ãƒ‰ | èª¬æ˜ | HTTPã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ |
|--------|------|----------------|
| `VALIDATION_ERROR` | å…¥åŠ›å€¤æ¤œè¨¼ã‚¨ãƒ©ãƒ¼ | 400 |
| `URL_DUPLICATE` | URLé‡è¤‡ã‚¨ãƒ©ãƒ¼ | 409 |
| `URL_NOT_FOUND` | URLæœªç™ºè¦‹ | 404 |
| `SCRAPING_ERROR` | ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°ã‚¨ãƒ©ãƒ¼ | 500 |
| `TELEGRAM_ERROR` | Telegram API ã‚¨ãƒ©ãƒ¼ | 500 |
| `DATABASE_ERROR` | ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¨ãƒ©ãƒ¼ | 500 |

## ãƒ¬ãƒ¼ãƒˆåˆ¶é™

### REST API
- **åˆ¶é™**: 100ãƒªã‚¯ã‚¨ã‚¹ãƒˆ/åˆ†/IP
- **ãƒ˜ãƒƒãƒ€ãƒ¼**: `X-RateLimit-Remaining`, `X-RateLimit-Reset`

### Telegram Bot
- **åˆ¶é™**: Telegram APIåˆ¶é™ã«æº–æ‹ 
- **30ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸/ç§’/Bot**

## ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£

### CORSè¨­å®š
```typescript
app.enableCors({
  origin: process.env.ALLOWED_ORIGINS?.split(',') || ['http://localhost:3000'],
  credentials: true,
});
```

### ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ˜ãƒƒãƒ€ãƒ¼
- `helmet` ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã«ã‚ˆã‚‹åŸºæœ¬çš„ãªã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ˜ãƒƒãƒ€ãƒ¼
- `X-Frame-Options: DENY`
- `X-Content-Type-Options: nosniff`

### å…¥åŠ›å€¤æ¤œè¨¼
- `class-validator` ã«ã‚ˆã‚‹å³å¯†ãªå…¥åŠ›å€¤æ¤œè¨¼
- SQLã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³å¯¾ç­–
- XSSå¯¾ç­–

## ç›£è¦–ä»•æ§˜

### ç›£è¦–é–“éš”
- **ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ**: 5åˆ†é–“éš”
- **è¨­å®šå¯èƒ½ç¯„å›²**: 1åˆ†ã€œ60åˆ†

### Botæ¤œçŸ¥å›é¿
- **User-Agent**: æœ€æ–°ãƒ–ãƒ©ã‚¦ã‚¶ã‚’æ¨¡å€£
- **å¾…æ©Ÿæ™‚é–“**: ãƒ©ãƒ³ãƒ€ãƒ ï¼ˆ1-3ç§’ï¼‰
- **ãƒªã‚¯ã‚¨ã‚¹ãƒˆé–“éš”**: äººé–“çš„ãªãƒ‘ã‚¿ãƒ¼ãƒ³

### ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆè¨­å®š
- **ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿**: 30ç§’
- **è¦ç´ å¾…æ©Ÿ**: 10ç§’
- **å…¨ä½“å‡¦ç†**: 60ç§’

## å®Ÿè£…çŠ¶æ³

### å®Œäº†æ¸ˆã¿
- âœ… URL ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£å®šç¾©
- âœ… åŸºæœ¬çš„ãªãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«æ§‹æˆ
- âœ… TypeORMè¨­å®š

### å®Ÿè£…ä¸­
- ğŸ”„ REST API ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ
- ğŸ”„ Telegram Bot ã‚³ãƒãƒ³ãƒ‰
- ğŸ”„ ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°æ©Ÿèƒ½

### æœªå®Ÿè£…
- âŒ ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯æ©Ÿèƒ½
- âŒ ç›£è¦–ãƒ­ã‚°æ©Ÿèƒ½
- âŒ ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
- âŒ ãƒ¬ãƒ¼ãƒˆåˆ¶é™
- âŒ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¼·åŒ–

## ä»Šå¾Œã®æ‹¡å¼µäºˆå®š

### v1.1
- è¤‡æ•°ãƒ¦ãƒ¼ã‚¶ãƒ¼å¯¾å¿œ
- ãƒ¦ãƒ¼ã‚¶ãƒ¼åˆ¥URLåˆ¶é™
- é€šçŸ¥è¨­å®šã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º

### v1.2
- Webhooké€šçŸ¥å¯¾å¿œ
- ãƒ¡ãƒ¼ãƒ«é€šçŸ¥æ©Ÿèƒ½
- ç›£è¦–çµ±è¨ˆãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰

### v2.0
- è¤‡æ•°ã‚µã‚¤ãƒˆå¯¾å¿œ
- AI ã«ã‚ˆã‚‹ç‰©ä»¶åˆ†æ
- èª²é‡‘ã‚·ã‚¹ãƒ†ãƒ é€£æº

---

**æ³¨æ„**: ã“ã®ä»•æ§˜æ›¸ã¯ç¾åœ¨ã®å®Ÿè£…çŠ¶æ³ã«åŸºã¥ã„ã¦ä½œæˆã•ã‚Œã¦ãŠã‚Šã€é–‹ç™ºé€²æ—ã«å¿œã˜ã¦æ›´æ–°ã•ã‚Œã‚‹äºˆå®šã§ã™ã€‚

