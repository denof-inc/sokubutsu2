name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop, feature/*, fix/*, refactor/* ]
  pull_request:
    branches: [ main, develop ]

jobs:
  lint-and-test:
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        node-version: [20.x]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci
    
    - name: Run ESLint
      run: |
        echo "ğŸ” ESLintãƒã‚§ãƒƒã‚¯å®Ÿè¡Œä¸­..."
        npm run lint || true
        ERROR_COUNT=$(npm run lint 2>&1 | grep -E "(error|warning)" | wc -l || echo "0")
        echo "ESLintã‚¨ãƒ©ãƒ¼æ•°: $ERROR_COUNT"
        echo "eslint_errors=$ERROR_COUNT" >> $GITHUB_ENV
    
    - name: Run TypeScript check
      run: |
        echo "ğŸ”§ TypeScriptãƒã‚§ãƒƒã‚¯å®Ÿè¡Œä¸­..."
        npx tsc --noEmit || true
    
    - name: Run tests
      run: |
        echo "ğŸ§ª ãƒ†ã‚¹ãƒˆå®Ÿè¡Œä¸­..."
        npm run test -- --passWithNoTests || true
    
    - name: Run test coverage
      run: |
        echo "ğŸ“Š ã‚«ãƒãƒ¬ãƒƒã‚¸æ¸¬å®šä¸­..."
        npm run test:cov -- --passWithNoTests || true
    
    - name: Build application
      run: |
        echo "ğŸ”¨ ãƒ“ãƒ«ãƒ‰å®Ÿè¡Œä¸­..."
        npm run build
    
    - name: Quality Report
      if: always()
      run: |
        echo "ğŸ“Š å“è³ªãƒ¬ãƒãƒ¼ãƒˆ"
        echo "=================="
        echo "ESLintã‚¨ãƒ©ãƒ¼æ•°: ${{ env.eslint_errors }}"
        if [ "${{ env.eslint_errors }}" -le 50 ]; then
          echo "âœ… ESLintã‚¨ãƒ©ãƒ¼æ•°ãŒç›®æ¨™å€¤ï¼ˆ50å€‹ä»¥ä¸‹ï¼‰ã‚’é”æˆã—ã¦ã„ã¾ã™ï¼"
        else
          echo "âš ï¸ ESLintã‚¨ãƒ©ãƒ¼æ•°ãŒç›®æ¨™å€¤ã‚’è¶…ãˆã¦ã„ã¾ã™ï¼ˆç›®æ¨™: 50å€‹ä»¥ä¸‹ï¼‰"
        fi

  security-scan:
    runs-on: ubuntu-latest
    needs: lint-and-test
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci
    
    - name: Run security audit
      run: |
        echo "ğŸ”’ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç›£æŸ»å®Ÿè¡Œä¸­..."
        npm audit --audit-level moderate || true
    
    - name: Check for sensitive data
      run: |
        echo "ğŸ” æ©Ÿå¯†æƒ…å ±ãƒã‚§ãƒƒã‚¯ä¸­..."
        # .envãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚³ãƒŸãƒƒãƒˆã•ã‚Œã¦ã„ãªã„ã‹ç¢ºèª
        if [ -f ".env" ]; then
          echo "âŒ .envãƒ•ã‚¡ã‚¤ãƒ«ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸï¼"
          exit 1
        fi
        # APIã‚­ãƒ¼ã‚„ãƒˆãƒ¼ã‚¯ãƒ³ãŒéœ²å‡ºã—ã¦ã„ãªã„ã‹ç¢ºèª
        if grep -rE "(api_key|apikey|api-key|token|secret|password)" --include="*.ts" --include="*.js" --exclude-dir=node_modules .; then
          echo "âš ï¸ æ½œåœ¨çš„ãªæ©Ÿå¯†æƒ…å ±ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸã€‚ç¢ºèªã—ã¦ãã ã•ã„ã€‚"
        fi

  docker-check:
    runs-on: ubuntu-latest
    needs: lint-and-test
    if: github.event_name == 'push'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Check Dockerfile
      run: |
        echo "ğŸ³ Dockerfileãƒã‚§ãƒƒã‚¯ä¸­..."
        if [ -f "Dockerfile" ]; then
          echo "âœ… DockerfileãŒå­˜åœ¨ã—ã¾ã™"
          # Dockerfileã®æ§‹æ–‡ãƒã‚§ãƒƒã‚¯
          docker run --rm -i hadolint/hadolint < Dockerfile || true
        else
          echo "âš ï¸ DockerfileãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
        fi
    
    - name: Check docker-compose.yml
      run: |
        echo "ğŸ³ docker-compose.ymlãƒã‚§ãƒƒã‚¯ä¸­..."
        if [ -f "docker-compose.yml" ]; then
          echo "âœ… docker-compose.ymlãŒå­˜åœ¨ã—ã¾ã™"
          # docker-composeã®æ§‹æ–‡ãƒã‚§ãƒƒã‚¯
          docker compose config --quiet || true
        else
          echo "âš ï¸ docker-compose.ymlãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
        fi

  create-release:
    runs-on: ubuntu-latest
    needs: [lint-and-test, security-scan, docker-check]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Generate changelog
      id: changelog
      run: |
        echo "ğŸ“ å¤‰æ›´å±¥æ­´ã‚’ç”Ÿæˆä¸­..."
        LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
        if [ -z "$LAST_TAG" ]; then
          COMMITS=$(git log --oneline -10)
        else
          COMMITS=$(git log --oneline $LAST_TAG..HEAD)
        fi
        echo "commits<<EOF" >> $GITHUB_OUTPUT
        echo "$COMMITS" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT
    
    - name: Create Release
      if: startsWith(github.event.head_commit.message, 'release:')
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: v${{ github.run_number }}
        release_name: Release v${{ github.run_number }}
        body: |
          ## å¤‰æ›´å†…å®¹
          ${{ steps.changelog.outputs.commits }}
          
          ## å“è³ªãƒ¡ãƒˆãƒªã‚¯ã‚¹
          - ESLintã‚¨ãƒ©ãƒ¼æ•°: ${{ env.eslint_errors }}
          - ãƒ“ãƒ«ãƒ‰: æˆåŠŸ
        draft: false
        prerelease: false