name: CI/CD Pipeline

on:
  push:
    branches: [main, develop, feature/*, fix/*, refactor/*]
  pull_request:
    branches: [main, develop]

env:
  NODE_ENV: test
  DATABASE_URL: file:./test.db
  JEST_WORKERS: 1
  CI: true

jobs:
  lint-and-test:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        node-version: [20.x]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'

      - name: Debug Environment
        run: |
          echo "=== Debug Information ==="
          echo "Node.js version: $(node --version)"
          echo "npm version: $(npm --version)"
          echo "Working directory: $(pwd)"
          echo "Environment variables:"
          env | grep -E "(NODE_ENV|CI|DATABASE_URL|JEST)" || echo "No relevant env vars"
          echo "=== Package.json scripts ==="
          cat package.json | grep -A20 '"scripts"' || echo "No scripts found"
          echo "=== ESLint version ==="
          npx eslint --version || echo "ESLint not found"
          echo "=== TypeScript version ==="
          npx tsc --version || echo "TypeScript not found"
          echo "=== Jest version ==="
          npx jest --version || echo "Jest not found"

      - name: Install dependencies
        run: npm ci

      - name: Run ESLint
        run: |
          echo "ğŸ” ESLintãƒã‚§ãƒƒã‚¯å®Ÿè¡Œä¸­..."
          echo "å®Ÿè¡Œã‚³ãƒãƒ³ãƒ‰: npm run ci:lint"
          npm run ci:lint 2>&1 | tee eslint-output.log
          ESLINT_EXIT_CODE=${PIPESTATUS[0]}

          if [ $ESLINT_EXIT_CODE -ne 0 ]; then
            echo "âŒ ESLintã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ (exit code: $ESLINT_EXIT_CODE)"
            echo "=== ESLintå‡ºåŠ›è©³ç´° ==="
            cat eslint-output.log
            echo "=== ã‚¨ãƒ©ãƒ¼ã‚µãƒãƒªãƒ¼ ==="
            grep -E "error|Error" eslint-output.log || echo "ã‚¨ãƒ©ãƒ¼è©³ç´°ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
            exit 1
          fi
          echo "âœ… ESLintãƒã‚§ãƒƒã‚¯æˆåŠŸ"

      - name: Run TypeScript check
        run: |
          echo "ğŸ”§ TypeScriptãƒã‚§ãƒƒã‚¯å®Ÿè¡Œä¸­..."
          echo "å®Ÿè¡Œã‚³ãƒãƒ³ãƒ‰: npm run ci:typecheck"
          npm run ci:typecheck 2>&1 | tee typescript-output.log
          TS_EXIT_CODE=${PIPESTATUS[0]}

          if [ $TS_EXIT_CODE -ne 0 ]; then
            echo "âŒ TypeScriptã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ (exit code: $TS_EXIT_CODE)"
            echo "=== TypeScriptå‡ºåŠ›è©³ç´° ==="
            cat typescript-output.log
            exit 1
          fi
          echo "âœ… TypeScriptãƒã‚§ãƒƒã‚¯æˆåŠŸ"

      - name: Run tests
        run: |
          echo "ğŸ§ª ãƒ†ã‚¹ãƒˆå®Ÿè¡Œä¸­..."
          echo "å®Ÿè¡Œã‚³ãƒãƒ³ãƒ‰: npm run ci:test"
          npm run ci:test 2>&1 | tee test-output.log
          TEST_EXIT_CODE=${PIPESTATUS[0]}

          if [ $TEST_EXIT_CODE -ne 0 ]; then
            echo "âŒ ãƒ†ã‚¹ãƒˆãŒå¤±æ•—ã—ã¾ã—ãŸ (exit code: $TEST_EXIT_CODE)"
            echo "=== ãƒ†ã‚¹ãƒˆå‡ºåŠ›è©³ç´° ==="
            cat test-output.log
            echo "=== ã‚¨ãƒ©ãƒ¼ã‚µãƒãƒªãƒ¼ ==="
            grep -E "FAIL|Error|error" test-output.log || echo "ã‚¨ãƒ©ãƒ¼è©³ç´°ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
            exit 1
          fi
          echo "âœ… ãƒ†ã‚¹ãƒˆæˆåŠŸ"

      - name: Run test coverage
        run: |
          echo "ğŸ“Š ã‚«ãƒãƒ¬ãƒƒã‚¸æ¸¬å®šä¸­..."
          npm run ci:test -- --coverage
          # CI/CDã§ã¯ã‚«ãƒãƒ¬ãƒƒã‚¸ã‚¨ãƒ©ãƒ¼ã¯è­¦å‘Šã¨ã—ã¦æ‰±ã†

      - name: Build application
        run: |
          echo "ğŸ”¨ ãƒ“ãƒ«ãƒ‰å®Ÿè¡Œä¸­..."
          npm run ci:build

      - name: Quality Gate
        run: |
          echo "ğŸšª å“è³ªã‚²ãƒ¼ãƒˆãƒã‚§ãƒƒã‚¯"
          # ESLintã‚¨ãƒ©ãƒ¼æ•°ã‚’ãƒã‚§ãƒƒã‚¯
          ERROR_COUNT=$(npm run ci:lint 2>&1 | grep -E "^\s*[0-9]+:[0-9]+\s+error" | wc -l | tr -d ' ')
          WARNING_COUNT=$(npm run ci:lint 2>&1 | grep -E "^\s*[0-9]+:[0-9]+\s+warning" | wc -l | tr -d ' ')
          TOTAL_ISSUES=$((ERROR_COUNT + WARNING_COUNT))

          echo "ESLintã‚¨ãƒ©ãƒ¼: $ERROR_COUNTå€‹"
          echo "ESLintè­¦å‘Š: $WARNING_COUNTå€‹"
          echo "åˆè¨ˆå•é¡Œæ•°: $TOTAL_ISSUESå€‹"

          # ã‚¨ãƒ©ãƒ¼ãŒ1ã¤ã§ã‚‚ã‚ã‚Œã°å¤±æ•—
          if [ "$ERROR_COUNT" -gt 0 ]; then
            echo "âŒ ESLintã‚¨ãƒ©ãƒ¼ãŒå­˜åœ¨ã—ã¾ã™"
            exit 1
          fi

          # è­¦å‘ŠãŒå¤šã™ãã‚‹å ´åˆã‚‚å¤±æ•—ï¼ˆæ®µéšçš„ã«å³æ ¼åŒ–ï¼‰
          if [ "$WARNING_COUNT" -gt 320 ]; then
            echo "âŒ ESLintè­¦å‘ŠãŒå¤šã™ãã¾ã™ï¼ˆä¸Šé™: 320å€‹ï¼‰"
            exit 1
          fi

          echo "âœ… å“è³ªã‚²ãƒ¼ãƒˆé€šé"

  security-scan:
    runs-on: ubuntu-latest
    needs: lint-and-test

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run security audit
        run: |
          echo "ğŸ”’ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç›£æŸ»å®Ÿè¡Œä¸­..."
          npm audit --audit-level moderate
          # || true ã‚’å‰Šé™¤ - è„†å¼±æ€§ãŒã‚ã‚Œã°å¤±æ•—

      - name: Check for sensitive data
        run: |
          echo "ğŸ” æ©Ÿå¯†æƒ…å ±ãƒã‚§ãƒƒã‚¯ä¸­..."
          # .envãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚³ãƒŸãƒƒãƒˆã•ã‚Œã¦ã„ãªã„ã‹ç¢ºèª
          if [ -f ".env" ]; then
            echo "âŒ .envãƒ•ã‚¡ã‚¤ãƒ«ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸï¼"
            exit 1
          fi
          # APIã‚­ãƒ¼ã‚„ãƒˆãƒ¼ã‚¯ãƒ³ãŒéœ²å‡ºã—ã¦ã„ãªã„ã‹ç¢ºèª
          # å®Ÿéš›ã®ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰ã•ã‚ŒãŸå€¤ã®ã¿ã‚’æ¤œå‡ºï¼ˆå¤‰æ•°åã‚„ç’°å¢ƒå¤‰æ•°å‚ç…§ã¯é™¤å¤–ï¼‰
          if grep -rE "(api_key|apikey|api-key|token|secret|password)\s*[:=]\s*['\"][^'\"]+['\"]" --include="*.ts" --include="*.js" --exclude-dir=node_modules . | \
             grep -v "// " | \
             grep -v "* " | \
             grep -v "\.spec\." | \
             grep -v "test-" | \
             grep -v "dummy" | \
             grep -v "mock" | \
             grep -v "example" | \
             grep -v "placeholder" | \
             grep -v "YOUR_" | \
             grep -v "<.*>"; then
            echo "âŒ æ½œåœ¨çš„ãªæ©Ÿå¯†æƒ…å ±ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ"
            echo "ãƒ’ãƒ³ãƒˆ: ç’°å¢ƒå¤‰æ•°ã‚„ConfigServiceã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„"
            exit 1
          fi
          echo "âœ… æ©Ÿå¯†æƒ…å ±ãƒã‚§ãƒƒã‚¯å®Œäº†"

  docker-check:
    runs-on: ubuntu-latest
    needs: lint-and-test
    if: github.event_name == 'push'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check Dockerfile
        run: |
          echo "ğŸ³ Dockerfileãƒã‚§ãƒƒã‚¯ä¸­..."
          if [ -f "Dockerfile" ]; then
            echo "âœ… DockerfileãŒå­˜åœ¨ã—ã¾ã™"
            # Dockerfileã®æ§‹æ–‡ãƒã‚§ãƒƒã‚¯
            docker run --rm -i hadolint/hadolint < Dockerfile
            # || true ã‚’å‰Šé™¤ - å•é¡ŒãŒã‚ã‚Œã°å¤±æ•—
          else
            echo "âš ï¸ DockerfileãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
          fi

      - name: Check docker-compose.yml
        run: |
          echo "ğŸ³ docker-compose.ymlãƒã‚§ãƒƒã‚¯ä¸­..."
          if [ -f "docker-compose.yml" ]; then
            echo "âœ… docker-compose.ymlãŒå­˜åœ¨ã—ã¾ã™"
            # docker-composeã®æ§‹æ–‡ãƒã‚§ãƒƒã‚¯
            docker compose config --quiet
            # || true ã‚’å‰Šé™¤ - å•é¡ŒãŒã‚ã‚Œã°å¤±æ•—
          else
            echo "âš ï¸ docker-compose.ymlãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
          fi

  quality-metrics-report:
    runs-on: ubuntu-latest
    needs: lint-and-test
    if: always()

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Generate Quality Report
        run: |
          echo "ğŸ“Š å“è³ªãƒ¡ãƒˆãƒªã‚¯ã‚¹ãƒ¬ãƒãƒ¼ãƒˆ"
          echo "========================"

          # ESLintãƒ¡ãƒˆãƒªã‚¯ã‚¹
          LINT_OUTPUT=$(npm run lint 2>&1 || true)
          ERROR_COUNT=$(echo "$LINT_OUTPUT" | grep -c "error" || echo "0")
          WARNING_COUNT=$(echo "$LINT_OUTPUT" | grep -c "warning" || echo "0")

          echo "ESLintã‚¨ãƒ©ãƒ¼: $ERROR_COUNTå€‹"
          echo "ESLintè­¦å‘Š: $WARNING_COUNTå€‹"

          # TypeScriptãƒ¡ãƒˆãƒªã‚¯ã‚¹
          TS_OUTPUT=$(npx tsc --noEmit 2>&1 || true)
          TS_ERRORS=$(echo "$TS_OUTPUT" | grep -c "error TS" || echo "0")

          echo "TypeScriptã‚¨ãƒ©ãƒ¼: $TS_ERRORSå€‹"

          # å“è³ªåŸºæº–åˆ¤å®š
          echo ""
          echo "å“è³ªåŸºæº–åˆ¤å®š:"
          if [ "$ERROR_COUNT" -eq 0 ] && [ "$TS_ERRORS" -eq 0 ]; then
            echo "âœ… ã‚¨ãƒ©ãƒ¼ã‚¼ãƒ­é”æˆ"
          else
            echo "âŒ ã‚¨ãƒ©ãƒ¼ãŒå­˜åœ¨ã—ã¾ã™"
          fi

          if [ "$WARNING_COUNT" -le 100 ]; then
            echo "âœ… è­¦å‘Šæ•°ãŒè¨±å®¹ç¯„å›²å†…"
          else
            echo "âŒ è­¦å‘Šæ•°ãŒå¤šã™ãã¾ã™"
          fi

  create-release:
    runs-on: ubuntu-latest
    needs: [lint-and-test, security-scan, docker-check]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Generate changelog
        id: changelog
        run: |
          echo "ğŸ“ å¤‰æ›´å±¥æ­´ã‚’ç”Ÿæˆä¸­..."
          LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          if [ -z "$LAST_TAG" ]; then
            COMMITS=$(git log --oneline -10)
          else
            COMMITS=$(git log --oneline $LAST_TAG..HEAD)
          fi
          echo "commits<<EOF" >> $GITHUB_OUTPUT
          echo "$COMMITS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create Release
        if: startsWith(github.event.head_commit.message, 'release:')
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: v${{ github.run_number }}
          release_name: Release v${{ github.run_number }}
          body: |
            ## å¤‰æ›´å†…å®¹
            ${{ steps.changelog.outputs.commits }}

            ## å“è³ªåŸºæº–
            âœ… å…¨ã¦ã®å“è³ªãƒã‚§ãƒƒã‚¯ã«åˆæ ¼
            âœ… ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç›£æŸ»ã«åˆæ ¼
            âœ… ãƒ“ãƒ«ãƒ‰æˆåŠŸ
          draft: false
          prerelease: false
