name: Quality Regression Detection

on:
  pull_request:
    paths:
      - 'eslint.config.*'
      - '.github/workflows/**'
      - 'jest.config.*'
      - 'tsconfig.json'
      - 'package.json'
      - '.lintstagedrc.json'
      - '.husky/**'

jobs:
  quality-regression-check:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'
    
    - name: Detect Quality Rule Changes
      run: |
        echo "ðŸ” å“è³ªãƒ«ãƒ¼ãƒ«å¤‰æ›´æ¤œçŸ¥ä¸­..."
        
        # ESLintè¨­å®šã®'off'è¨­å®šã‚’æ¤œçŸ¥
        if grep -rE ":\s*['\"]off['\"]" eslint.config.* 2>/dev/null; then
          echo "âŒ ESLintãƒ«ãƒ¼ãƒ«ã®ç„¡åŠ¹åŒ–ã‚’æ¤œå‡ºã—ã¾ã—ãŸ"
          echo "åž‹å®‰å…¨æ€§ãƒ«ãƒ¼ãƒ«ã¯'warn'ã¾ãŸã¯'error'ã«è¨­å®šã—ã¦ãã ã•ã„"
          exit 1
        fi
        
        # CI/CDã®å¤±æ•—éš è”½ã‚’æ¤œçŸ¥
        if grep -r "|| true" .github/workflows/ 2>/dev/null; then
          echo "âŒ CI/CDãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã§ã®å¤±æ•—éš è”½ã‚’æ¤œå‡ºã—ã¾ã—ãŸ"
          echo "'|| true'ã‚’å‰Šé™¤ã—ã¦ãã ã•ã„"
          exit 1
        fi
        
        # --passWithNoTestsã®å¸¸ç”¨ã‚’æ¤œçŸ¥
        if grep -r -- "--passWithNoTests" .github/workflows/ package.json .lintstagedrc.json 2>/dev/null | grep -v "# " | grep -v "// "; then
          echo "âš ï¸ --passWithNoTestsã®ä½¿ç”¨ã‚’æ¤œå‡ºã—ã¾ã—ãŸ"
          echo "ãƒ†ã‚¹ãƒˆãŒå­˜åœ¨ã™ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¦ãã ã•ã„"
        fi
        
        # --no-verifyã®ä½¿ç”¨ã‚’æ¤œçŸ¥
        if grep -r -- "--no-verify" .husky/ 2>/dev/null; then
          echo "âŒ pre-commitãƒ•ãƒƒã‚¯ã®å›žé¿ã‚’æ¤œå‡ºã—ã¾ã—ãŸ"
          echo "--no-verifyã‚’å‰Šé™¤ã—ã¦ãã ã•ã„"
          exit 1
        fi
        
        echo "âœ… å“è³ªãƒ«ãƒ¼ãƒ«ãƒã‚§ãƒƒã‚¯å®Œäº†"
    
    - name: Check TypeScript Strict Mode
      run: |
        echo "ðŸ”§ TypeScriptåŽ³æ ¼ãƒ¢ãƒ¼ãƒ‰ãƒã‚§ãƒƒã‚¯ä¸­..."
        
        # tsconfig.jsonã®strictãƒ¢ãƒ¼ãƒ‰ã‚’ç¢ºèª
        if ! grep -q '"strict":\s*true' tsconfig.json; then
          echo "âŒ TypeScriptã®strictãƒ¢ãƒ¼ãƒ‰ãŒç„¡åŠ¹ã§ã™"
          echo "tsconfig.jsonã§\"strict\": trueã‚’è¨­å®šã—ã¦ãã ã•ã„"
          exit 1
        fi
        
        echo "âœ… TypeScriptè¨­å®šãƒã‚§ãƒƒã‚¯å®Œäº†"
    
    - name: Validate Quality Standards
      run: |
        echo "ðŸ“Š å“è³ªåŸºæº–æ¤œè¨¼ä¸­..."
        
        # package.jsonã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ç¢ºèª
        if ! grep -q '"lint"' package.json; then
          echo "âŒ lintã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒå®šç¾©ã•ã‚Œã¦ã„ã¾ã›ã‚“"
          exit 1
        fi
        
        if ! grep -q '"test"' package.json; then
          echo "âŒ testã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒå®šç¾©ã•ã‚Œã¦ã„ã¾ã›ã‚“"
          exit 1
        fi
        
        if ! grep -q '"build"' package.json; then
          echo "âŒ buildã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒå®šç¾©ã•ã‚Œã¦ã„ã¾ã›ã‚“"
          exit 1
        fi
        
        echo "âœ… å“è³ªåŸºæº–æ¤œè¨¼å®Œäº†"
    
    - name: Generate Quality Report
      if: always()
      run: |
        echo "ðŸ“‹ å“è³ªè¨­å®šå¤‰æ›´ã‚µãƒžãƒªãƒ¼"
        echo "===================="
        
        # å¤‰æ›´ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’è¡¨ç¤º
        echo "å¤‰æ›´ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«:"
        git diff --name-only origin/${{ github.base_ref }}...HEAD | grep -E "(eslint|jest|tsconfig|workflow)" || echo "ãªã—"
        
        echo ""
        echo "å“è³ªãƒã‚§ãƒƒã‚¯çµæžœ:"
        echo "- ESLintãƒ«ãƒ¼ãƒ«ç„¡åŠ¹åŒ–: $(grep -rE ":\s*['\"]off['\"]" eslint.config.* 2>/dev/null | wc -l || echo "0")å€‹"
        echo "- CI/CDå¤±æ•—éš è”½: $(grep -r "|| true" .github/workflows/ 2>/dev/null | wc -l || echo "0")å€‹"
        echo "- TypeScript strictãƒ¢ãƒ¼ãƒ‰: $(grep -q '"strict":\s*true' tsconfig.json && echo "æœ‰åŠ¹" || echo "ç„¡åŠ¹")"