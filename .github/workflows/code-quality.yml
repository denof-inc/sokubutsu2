name: Code Quality Check

on:
  pull_request:
    branches: [ main, develop ]
  schedule:
    - cron: '0 9 * * 1' # æ¯Žé€±æœˆæ›œæ—¥ã®9æ™‚ã«å®Ÿè¡Œ

jobs:
  code-quality:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci
    
    - name: Run ESLint with detailed report
      run: |
        echo "ðŸ“ ESLintè©³ç´°ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆä¸­..."
        npm run lint -- --format json > eslint-report.json 2>/dev/null || true
        
        # ã‚¨ãƒ©ãƒ¼çµ±è¨ˆã‚’é›†è¨ˆ
        ERROR_COUNT=$(npm run lint 2>&1 | grep -E "(error|warning)" | wc -l || echo "0")
        ERROR_ONLY=$(npm run lint 2>&1 | grep " error " | wc -l || echo "0")
        WARNING_ONLY=$(npm run lint 2>&1 | grep " warning " | wc -l || echo "0")
        
        echo "## ESLintçµæžœã‚µãƒžãƒªãƒ¼" >> $GITHUB_STEP_SUMMARY
        echo "- ç·ã‚¨ãƒ©ãƒ¼æ•°: $ERROR_COUNT" >> $GITHUB_STEP_SUMMARY
        echo "- errorãƒ¬ãƒ™ãƒ«: $ERROR_ONLY" >> $GITHUB_STEP_SUMMARY  
        echo "- warningãƒ¬ãƒ™ãƒ«: $WARNING_ONLY" >> $GITHUB_STEP_SUMMARY
        
        # ç›®æ¨™é”æˆçŠ¶æ³
        if [ "$ERROR_COUNT" -le 50 ]; then
          echo "âœ… **ç›®æ¨™é”æˆ**: ESLintã‚¨ãƒ©ãƒ¼ãŒ50å€‹ä»¥ä¸‹ã§ã™ï¼" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ **è¦æ”¹å–„**: ESLintã‚¨ãƒ©ãƒ¼ãŒç›®æ¨™ï¼ˆ50å€‹ä»¥ä¸‹ï¼‰ã‚’è¶…ãˆã¦ã„ã¾ã™" >> $GITHUB_STEP_SUMMARY
        fi
    
    - name: Check test coverage
      run: |
        echo "ðŸ“Š ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸ãƒã‚§ãƒƒã‚¯ä¸­..."
        npm run test:cov -- --passWithNoTests > coverage-report.txt 2>&1 || true
        
        # ã‚«ãƒãƒ¬ãƒƒã‚¸æƒ…å ±ã‚’æŠ½å‡º
        if [ -f "coverage/lcov-report/index.html" ]; then
          echo "## ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸" >> $GITHUB_STEP_SUMMARY
          echo "ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ¬ãƒãƒ¼ãƒˆãŒç”Ÿæˆã•ã‚Œã¾ã—ãŸ" >> $GITHUB_STEP_SUMMARY
        else
          echo "âš ï¸ ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ¬ãƒãƒ¼ãƒˆã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ" >> $GITHUB_STEP_SUMMARY
        fi
    
    - name: Check TypeScript strict mode
      run: |
        echo "ðŸ”§ TypeScriptè¨­å®šãƒã‚§ãƒƒã‚¯ä¸­..."
        if grep -q '"strict": true' tsconfig.json; then
          echo "âœ… TypeScript strict mode: æœ‰åŠ¹" >> $GITHUB_STEP_SUMMARY
        else
          echo "âš ï¸ TypeScript strict mode: ç„¡åŠ¹ï¼ˆæ®µéšŽçš„ç§»è¡Œä¸­ï¼‰" >> $GITHUB_STEP_SUMMARY
        fi
    
    - name: Check for TODO/FIXME comments
      run: |
        echo "ðŸ“ TODO/FIXMEã‚³ãƒ¡ãƒ³ãƒˆæ¤œç´¢ä¸­..."
        TODO_COUNT=$(grep -r "TODO\|FIXME" src/ --include="*.ts" | wc -l || echo "0")
        echo "## TODO/FIXMEã‚³ãƒ¡ãƒ³ãƒˆ" >> $GITHUB_STEP_SUMMARY
        echo "- æ¤œå‡ºæ•°: $TODO_COUNTå€‹" >> $GITHUB_STEP_SUMMARY
        
        if [ "$TODO_COUNT" -gt 0 ]; then
          echo "### è©³ç´°:" >> $GITHUB_STEP_SUMMARY
          grep -r "TODO\|FIXME" src/ --include="*.ts" | head -10 >> $GITHUB_STEP_SUMMARY || true
        fi
    
    - name: Dependency check
      run: |
        echo "ðŸ“¦ ä¾å­˜é–¢ä¿‚ãƒã‚§ãƒƒã‚¯ä¸­..."
        echo "## ä¾å­˜é–¢ä¿‚ã®çŠ¶æ…‹" >> $GITHUB_STEP_SUMMARY
        
        # å¤ã„ä¾å­˜é–¢ä¿‚ã‚’ãƒã‚§ãƒƒã‚¯
        npm outdated > outdated.txt 2>&1 || true
        if [ -s outdated.txt ]; then
          echo "### æ›´æ–°å¯èƒ½ãªãƒ‘ãƒƒã‚±ãƒ¼ã‚¸:" >> $GITHUB_STEP_SUMMARY
          cat outdated.txt | head -10 >> $GITHUB_STEP_SUMMARY
        else
          echo "âœ… ã™ã¹ã¦ã®ä¾å­˜é–¢ä¿‚ãŒæœ€æ–°ã§ã™" >> $GITHUB_STEP_SUMMARY
        fi
    
    - name: Code complexity analysis
      run: |
        echo "ðŸ§® ã‚³ãƒ¼ãƒ‰è¤‡é›‘åº¦åˆ†æžä¸­..."
        # ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºçµ±è¨ˆ
        echo "## ã‚³ãƒ¼ãƒ‰çµ±è¨ˆ" >> $GITHUB_STEP_SUMMARY
        echo "### ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚º TOP10:" >> $GITHUB_STEP_SUMMARY
        find src -name "*.ts" -type f -exec wc -l {} + | sort -rn | head -10 >> $GITHUB_STEP_SUMMARY
    
    - name: Generate improvement suggestions
      if: always()
      run: |
        echo "## æ”¹å–„ææ¡ˆ" >> $GITHUB_STEP_SUMMARY
        echo "1. ESLintã‚¨ãƒ©ãƒ¼ã®å‰Šæ¸›ã‚’ç¶™ç¶š" >> $GITHUB_STEP_SUMMARY
        echo "2. ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸ã®å‘ä¸Šï¼ˆç›®æ¨™: 70%ï¼‰" >> $GITHUB_STEP_SUMMARY
        echo "3. TypeScript strict modeã¸ã®æ®µéšŽçš„ç§»è¡Œ" >> $GITHUB_STEP_SUMMARY
        echo "4. TODO/FIXMEã‚³ãƒ¡ãƒ³ãƒˆã®è§£æ¶ˆ" >> $GITHUB_STEP_SUMMARY