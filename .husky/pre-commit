# staged filesのみをチェック（lint-staged使用）
echo "🔍 Running pre-commit checks on staged files..."
npm run precommit || {
  echo "❌ Pre-commit checks failed. Fix errors before committing."
  exit 1
}

# 型チェック（迅速）
echo "🔎 Typecheck (tsc --noEmit)"
npm run typecheck || {
  echo "❌ Typecheck failed. Fix errors before committing."
  exit 1
}

# 単体テスト（差分に関連するテストを優先実行。該当なしなら全件）
echo "🧪 Running unit tests..."
STAGED=$(git diff --name-only --cached | tr '\n' ' ')
if [ -n "$STAGED" ]; then
  npx jest --bail --findRelatedTests $STAGED || {
    echo "❌ Related tests failed. Fix failing tests before committing."
    exit 1
  }
else
  npm run test || {
    echo "❌ Tests failed. Fix failing tests before committing."
    exit 1
  }
fi

echo "✅ All checks passed!"
