#!/usr/bin/env sh

echo "🔍 Pre-commit checks running..."

# lint-stagedを実行（エラーで停止）
npx lint-staged || {
  echo "❌ Lint-staged failed! Fix errors before committing."
  exit 1
}

# TypeScript型チェック（開発中は警告のみ）
echo "🔧 Running TypeScript check..."
npx tsc --noEmit --incremental || {
  echo "⚠️  TypeScript warnings detected (development mode - continuing)"
  # 開発中は警告として扱い、コミットは継続
}

# 品質メトリクスチェック
echo "📊 Checking quality metrics..."
ERROR_COUNT=$(npm run lint 2>&1 | grep -E "^\s*[0-9]+:[0-9]+\s+error" | wc -l | tr -d ' ')
WARNING_COUNT=$(npm run lint 2>&1 | grep -c "warning" || echo "0")

echo "ESLintエラー: $ERROR_COUNT個"
echo "ESLint警告: $WARNING_COUNT個"

# エラーがある場合は停止
if [ "$ERROR_COUNT" -gt 0 ]; then
  echo "❌ ESLintエラーが存在します。修正してからコミットしてください。"
  exit 1
fi

# 警告数の上限チェック（開発中は緩和）
if [ "$WARNING_COUNT" -gt 500 ]; then
  echo "⚠️  ESLint警告が多すぎます（開発中の上限: 500個）"
  echo "リリース前に350個以下に削減してください"
  # 開発中は警告のみで継続
fi

echo "✅ Pre-commit checks completed!"