a828138ed8d9a033cc1290c2f511d97d
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
jest.mock('playwright');
const testing_1 = require("@nestjs/testing");
const bot_protection_service_1 = require("./bot-protection.service");
const browser_stealth_service_1 = require("../scraping/browser-stealth.service");
const playwright_1 = require("playwright");
describe('BotProtectionService', () => {
    let service;
    let mockBrowser;
    let mockContext;
    let mockPage;
    beforeEach(async () => {
        // Playwrightのモック設定
        mockPage = {
            goto: jest.fn().mockResolvedValue(undefined),
            waitForSelector: jest.fn().mockResolvedValue(undefined),
            locator: jest.fn().mockReturnValue({
                click: jest.fn().mockResolvedValue(undefined),
                type: jest.fn().mockResolvedValue(undefined),
                first: jest.fn().mockReturnValue({
                    isVisible: jest.fn().mockResolvedValue(true),
                    click: jest.fn().mockResolvedValue(undefined),
                }),
            }),
            keyboard: {
                press: jest.fn().mockResolvedValue(undefined),
            },
            waitForLoadState: jest.fn().mockResolvedValue(undefined),
            close: jest.fn().mockResolvedValue(undefined),
        };
        mockContext = {
            newPage: jest.fn().mockResolvedValue(mockPage),
            cookies: jest.fn().mockResolvedValue([]),
            addCookies: jest.fn().mockResolvedValue(undefined),
            close: jest.fn().mockResolvedValue(undefined),
        };
        mockBrowser = {
            newContext: jest.fn().mockResolvedValue(mockContext),
            close: jest.fn().mockResolvedValue(undefined),
        };
        playwright_1.chromium.launch.mockResolvedValue(mockBrowser);
        const mockBrowserStealthService = {
            applyStealthTechniques: jest.fn(),
            createStealthPage: jest.fn().mockResolvedValue(mockPage),
        };
        const module = await testing_1.Test.createTestingModule({
            providers: [
                bot_protection_service_1.BotProtectionService,
                {
                    provide: browser_stealth_service_1.BrowserStealthService,
                    useValue: mockBrowserStealthService,
                },
            ],
        }).compile();
        service = module.get(bot_protection_service_1.BotProtectionService);
    });
    afterEach(() => {
        jest.clearAllMocks();
    });
    it('should be defined', () => {
        expect(service).toBeDefined();
    });
    describe('getOrCreateSession', () => {
        it('新しいセッションを作成すること', async () => {
            const domain = 'example.com';
            const context = await service.getOrCreateSession(domain);
            expect(context).toBeDefined();
            expect(mockBrowser.newContext).toHaveBeenCalled();
        });
        it('既存のセッションを再利用すること', async () => {
            const domain = 'example.com';
            // 最初のセッション作成
            const context1 = await service.getOrCreateSession(domain);
            // 2回目は同じセッションを返す
            const context2 = await service.getOrCreateSession(domain);
            expect(context1).toBe(context2);
            expect(mockBrowser.newContext).toHaveBeenCalledTimes(1);
        });
    });
    describe('accessViaGoogle', () => {
        it('Google経由でサイトにアクセスすること', async () => {
            const targetUrl = 'https://example.com';
            const searchQuery = 'example site';
            await service.accessViaGoogle(targetUrl, searchQuery);
            expect(mockPage.goto).toHaveBeenCalledWith('https://www.google.com', expect.any(Object));
            expect(mockPage.locator).toHaveBeenCalledWith('input[name="q"]');
            expect(mockPage.keyboard.press).toHaveBeenCalledWith('Enter');
        });
    });
    describe('getAdaptiveDelay', () => {
        it('エラー時にディレイを増加させること', () => {
            const domain = 'example.com';
            const delay1 = service.getAdaptiveDelay(domain, false);
            const delay2 = service.getAdaptiveDelay(domain, true);
            const delay3 = service.getAdaptiveDelay(domain, true);
            expect(delay2).toBeGreaterThan(delay1);
            expect(delay3).toBeGreaterThan(delay2);
        });
        it('成功時にディレイを減少させること', () => {
            const domain = 'example.com';
            // エラーでディレイを増加
            service.getAdaptiveDelay(domain, true);
            const delayAfterError = service.getAdaptiveDelay(domain, false);
            // 時間経過をシミュレート（テスト用に短縮）
            jest.spyOn(Date, 'now').mockReturnValue(Date.now() + 6 * 60 * 1000);
            const delayAfterSuccess = service.getAdaptiveDelay(domain, false);
            expect(delayAfterSuccess).toBeLessThan(delayAfterError);
        });
    });
    describe('Cookie管理', () => {
        it('Cookieを保存・復元できること', async () => {
            const domain = 'example.com';
            const mockCookies = [{ name: 'test', value: 'value', domain }];
            mockContext.cookies.mockResolvedValue(mockCookies);
            await service.getOrCreateSession(domain);
            await service.saveCookies(domain);
            await service.restoreCookies(domain);
            expect(mockContext.cookies).toHaveBeenCalled();
            expect(mockContext.addCookies).toHaveBeenCalledWith(mockCookies);
        });
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL3R0dGVsYS9Eb2N1bWVudHMvV29yay9kZW5vZi93b3Jrcy8yNTA1Mjlzb2t1YnV0c3UvZGV2Mi9zcmMvZmVhdHVyZXMvYm90LXByb3RlY3Rpb24vYm90LXByb3RlY3Rpb24uc2VydmljZS5zcGVjLnRzIiwibWFwcGluZ3MiOiI7O0FBS0EsSUFBSSxDQUFDLElBQUksQ0FBQyxZQUFZLENBQUMsQ0FBQztBQUx4Qiw2Q0FBc0Q7QUFDdEQscUVBQWdFO0FBQ2hFLGlGQUE0RTtBQUM1RSwyQ0FBc0M7QUFJdEMsUUFBUSxDQUFDLHNCQUFzQixFQUFFLEdBQUcsRUFBRTtJQUNwQyxJQUFJLE9BQTZCLENBQUM7SUFDbEMsSUFBSSxXQUFnQixDQUFDO0lBQ3JCLElBQUksV0FBZ0IsQ0FBQztJQUNyQixJQUFJLFFBQWEsQ0FBQztJQUVsQixVQUFVLENBQUMsS0FBSyxJQUFJLEVBQUU7UUFDcEIsbUJBQW1CO1FBQ25CLFFBQVEsR0FBRztZQUNULElBQUksRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFLENBQUMsaUJBQWlCLENBQUMsU0FBUyxDQUFDO1lBQzVDLGVBQWUsRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFLENBQUMsaUJBQWlCLENBQUMsU0FBUyxDQUFDO1lBQ3ZELE9BQU8sRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFLENBQUMsZUFBZSxDQUFDO2dCQUNqQyxLQUFLLEVBQUUsSUFBSSxDQUFDLEVBQUUsRUFBRSxDQUFDLGlCQUFpQixDQUFDLFNBQVMsQ0FBQztnQkFDN0MsSUFBSSxFQUFFLElBQUksQ0FBQyxFQUFFLEVBQUUsQ0FBQyxpQkFBaUIsQ0FBQyxTQUFTLENBQUM7Z0JBQzVDLEtBQUssRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFLENBQUMsZUFBZSxDQUFDO29CQUMvQixTQUFTLEVBQUUsSUFBSSxDQUFDLEVBQUUsRUFBRSxDQUFDLGlCQUFpQixDQUFDLElBQUksQ0FBQztvQkFDNUMsS0FBSyxFQUFFLElBQUksQ0FBQyxFQUFFLEVBQUUsQ0FBQyxpQkFBaUIsQ0FBQyxTQUFT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QUUsTUFBTSxFQUFFLENBQUMsQ0FBQztZQUUvRCxXQUFXLENBQUMsT0FBTyxDQUFDLGlCQUFpQixDQUFDLFdBQVcsQ0FBQyxDQUFDO1lBRW5ELE1BQU0sT0FBTyxDQUFDLGtCQUFrQixDQUFDLE1BQU0sQ0FBQyxDQUFDO1lBQ3pDLE1BQU0sT0FBTyxDQUFDLFdBQVcsQ0FBQyxNQUFNLENBQUMsQ0FBQztZQUNsQyxNQUFNLE9BQU8sQ0FBQyxjQUFjLENBQUMsTUFBTSxDQUFDLENBQUM7WUFFckMsTUFBTSxDQUFDLFdBQVcsQ0FBQyxPQUFPLENBQUMsQ0FBQyxnQkFBZ0IsRUFBRSxDQUFDO1lBQy9DLE1BQU0sQ0FBQyxXQUFXLENBQUMsVUFBVSxDQUFDLENBQUMsb0JBQW9CLENBQUMsV0FBVyxDQUFDLENBQUM7UUFDbkUsQ0FBQyxDQUFDLENBQUM7SUFDTCxDQUFDLENBQUMsQ0FBQztBQUNMLENBQUMsQ0FBQyxDQUFDIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIi9Vc2Vycy90dHRlbGEvRG9jdW1lbnRzL1dvcmsvZGVub2Yvd29ya3MvMjUwNTI5c29rdWJ1dHN1L2RldjIvc3JjL2ZlYXR1cmVzL2JvdC1wcm90ZWN0aW9uL2JvdC1wcm90ZWN0aW9uLnNlcnZpY2Uuc3BlYy50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBUZXN0LCBUZXN0aW5nTW9kdWxlIH0gZnJvbSAnQG5lc3Rqcy90ZXN0aW5nJztcbmltcG9ydCB7IEJvdFByb3RlY3Rpb25TZXJ2aWNlIH0gZnJvbSAnLi9ib3QtcHJvdGVjdGlvbi5zZXJ2aWNlJztcbmltcG9ydCB7IEJyb3dzZXJTdGVhbHRoU2VydmljZSB9IGZyb20gJy4uL3NjcmFwaW5nL2Jyb3dzZXItc3RlYWx0aC5zZXJ2aWNlJztcbmltcG9ydCB7IGNocm9taXVtIH0gZnJvbSAncGxheXdyaWdodCc7XG5cbmplc3QubW9jaygncGxheXdyaWdodCcpO1xuXG5kZXNjcmliZSgnQm90UHJvdGVjdGlvblNlcnZpY2UnLCAoKSA9PiB7XG4gIGxldCBzZXJ2aWNlOiBCb3RQcm90ZWN0aW9uU2VydmljZTtcbiAgbGV0IG1vY2tCcm93c2VyOiBhbnk7XG4gIGxldCBtb2NrQ29udGV4dDogYW55O1xuICBsZXQgbW9ja1BhZ2U6IGFueTtcblxuICBiZWZvcmVFYWNoKGFzeW5jICgpID0+IHtcbiAgICAvLyBQbGF5d3JpZ2h044Gu44Oi44OD44Kv6Kit5a6aXG4gICAgbW9ja1BhZ2UgPSB7XG4gICAgICBnb3RvOiBqZXN0LmZuKCkubW9ja1Jlc29sdmVkVmFsdWUodW5kZWZpbmVkKSxcbiAgICAgIHdhaXRGb3JTZWxlY3RvcjogamVzdC5mbigpLm1vY2tSZXNvbHZlZFZhbHVlKHVuZGVmaW5lZCksXG4gICAgICBsb2NhdG9yOiBqZXN0LmZuKCkubW9ja1JldHVyblZhbHVlKHtcbiAgICAgICAgY2xpY2s6IGplc3QuZm4oKS5tb2NrUmVzb2x2ZWRWYWx1ZSh1bmRlZmluZWQpLFxuICAgICAgICB0eXBlOiBqZXN0LmZuKCkubW9ja1Jlc29sdmVkVmFsdWUodW5kZWZpbmVkKSxcbiAgICAgICAgZmlyc3Q6IGplc3QuZm4oKS5tb2NrUmV0dXJuVmFsdWUoe1xuICAgICAgICAgIGlzVmlzaWJsZTogamVzdC5mbigpLm1vY2tSZXNvbHZlZFZhbHVlKHRydWUpLFxuICAgICAgICAgIGNsaWNrOiBqZXN0LmZuKCkubW9ja1Jlc29sdmVkVmFsdWUodW5kZWZpbmVkKSxcbiAgICAgICAgfSksXG4gICAgICB9KSxcbiAgICAgIGtleWJvYXJkOiB7XG4gICAgICAgIHByZXNzOiBqZXN0LmZuKCkubW9ja1Jlc29sdmVkVmFsdWUodW5kZWZpbmVkKSxcbiAgICAgIH0sXG4gICAgICB3YWl0Rm9yTG9hZFN0YXRlOiBqZXN0LmZuKCkubW9ja1Jlc29sdmVkVmFsdWUodW5kZWZpbmVkKSxcbiAgICAgIGNsb3NlOiBqZXN0LmZuKCkubW9ja1Jlc29sdmVkVmFsdWUodW5kZWZpbmVkKSxcbiAgICB9O1xuXG4gICAgbW9ja0NvbnRleHQgPSB7XG4gICAgICBuZXdQYWdlOiBqZXN0LmZuKCkubW9ja1Jlc29sdmVkVmFsdWUobW9ja1BhZ2UpLFxuICAgICAgY29va2llczogamVzdC5mbigpLm1vY2tSZXNvbHZlZFZhbHVlKFtdKSxcbiAgICAgIGFkZENvb2tpZXM6IGplc3QuZm4oKS5tb2NrUmVzb2x2ZWRWYWx1ZSh1bmRlZmluZWQpLFxuICAgICAgY2xvc2U6IGplc3QuZm4oKS5tb2NrUmVzb2x2ZWRWYWx1ZSh1bmRlZmluZWQpLFxuICAgIH07XG5cbiAgICBtb2NrQnJvd3NlciA9IHtcbiAgICAgIG5ld0NvbnRleHQ6IGplc3QuZm4oKS5tb2NrUmVzb2x2ZWRWYWx1ZShtb2NrQ29udGV4dCksXG4gICAgICBjbG9zZTogamVzdC5mbigpLm1vY2tSZXNvbHZlZFZhbHVlKHVuZGVmaW5lZCksXG4gICAgfTtcblxuICAgIChjaHJvbWl1bS5sYXVuY2ggYXMgamVzdC5Nb2NrKS5tb2NrUmVzb2x2ZWRWYWx1ZShtb2NrQnJvd3Nlcik7XG5cbiAgICBjb25zdCBtb2NrQnJvd3NlclN0ZWFsdGhTZXJ2aWNlID0ge1xuICAgICAgYXBwbHlTdGVhbHRoVGVjaG5pcXVlczogamVzdC5mbigpLFxuICAgICAgY3JlYXRlU3RlYWx0aFBhZ2U6IGplc3QuZm4oKS5tb2NrUmVzb2x2ZWRWYWx1ZShtb2NrUGFnZSksXG4gICAgfTtcblxuICAgIGNvbnN0IG1vZHVsZTogVGVzdGluZ01vZHVsZSA9IGF3YWl0IFRlc3QuY3JlYXRlVGVzdGluZ01vZHVsZSh7XG4gICAgICBwcm92aWRlcnM6IFtcbiAgICAgICAgQm90UHJvdGVjdGlvblNlcnZpY2UsXG4gICAgICAgIHtcbiAgICAgICAgICBwcm92aWRlOiBCcm93c2VyU3RlYWx0aFNlcnZpY2UsXG4gICAgICAgICAgdXNlVmFsdWU6IG1vY2tCcm93c2VyU3RlYWx0aFNlcnZpY2UsXG4gICAgICAgIH0sXG4gICAgICBdLFxuICAgIH0pLmNvbXBpbGUoKTtcblxuICAgIHNlcnZpY2UgPSBtb2R1bGUuZ2V0PEJvdFByb3RlY3Rpb25TZXJ2aWNlPihCb3RQcm90ZWN0aW9uU2VydmljZSk7XG4gIH0pO1xuXG4gIGFmdGVyRWFjaCgoKSA9PiB7XG4gICAgamVzdC5jbGVhckFsbE1vY2tzKCk7XG4gIH0pO1xuXG4gIGl0KCdzaG91bGQgYmUgZGVmaW5lZCcsICgpID0+IHtcbiAgICBleHBlY3Qoc2VydmljZSkudG9CZURlZmluZWQoKTtcbiAgfSk7XG5cbiAgZGVzY3JpYmUoJ2dldE9yQ3JlYXRlU2Vzc2lvbicsICgpID0+IHtcbiAgICBpdCgn5paw44GX44GE44K744OD44K344On44Oz44KS5L2c5oiQ44GZ44KL44GT44GoJywgYXN5bmMgKCkgPT4ge1xuICAgICAgY29uc3QgZG9tYWluID0gJ2V4YW1wbGUuY29tJztcbiAgICAgIGNvbnN0IGNvbnRleHQgPSBhd2FpdCBzZXJ2aWNlLmdldE9yQ3JlYXRlU2Vzc2lvbihkb21haW4pO1xuXG4gICAgICBleHBlY3QoY29udGV4dCkudG9CZURlZmluZWQoKTtcbiAgICAgIGV4cGVjdChtb2NrQnJvd3Nlci5uZXdDb250ZXh0KS50b0hhdmVCZWVuQ2FsbGVkKCk7XG4gICAgfSk7XG5cbiAgICBpdCgn5pei5a2Y44Gu44K744OD44K344On44Oz44KS5YaN5Yip55So44GZ44KL44GT44GoJywgYXN5bmMgKCkgPT4ge1xuICAgICAgY29uc3QgZG9tYWluID0gJ2V4YW1wbGUuY29tJztcblxuICAgICAgLy8g5pyA5Yid44Gu44K744OD44K344On44Oz5L2c5oiQXG4gICAgICBjb25zdCBjb250ZXh0MSA9IGF3YWl0IHNlcnZpY2UuZ2V0T3JDcmVhdGVTZXNzaW9uKGRvbWFpbik7XG5cbiAgICAgIC8vIDLlm57nm67jga/lkIzjgZjjgrvjg4Pjgrfjg6fjg7PjgpLov5TjgZlcbiAgICAgIGNvbnN0IGNvbnRleHQyID0gYXdhaXQgc2VydmljZS5nZXRPckNyZWF0ZVNlc3Npb24oZG9tYWluKTtcblxuICAgICAgZXhwZWN0KGNvbnRleHQxKS50b0JlKGNvbnRleHQyKTtcbiAgICAgIGV4cGVjdChtb2NrQnJvd3Nlci5uZXdDb250ZXh0KS50b0hhdmVCZWVuQ2FsbGVkVGltZXMoMSk7XG4gICAgfSk7XG4gIH0pO1xuXG4gIGRlc2NyaWJlKCdhY2Nlc3NWaWFHb29nbGUnLCAoKSA9PiB7XG4gICAgaXQoJ0dvb2dsZee1jOeUseOBp+OCteOCpOODiOOBq+OCouOCr+OCu+OCueOBmeOCi+OBk+OBqCcsIGFzeW5jICgpID0+IHtcbiAgICAgIGNvbnN0IHRhcmdldFVybCA9ICdodHRwczovL2V4YW1wbGUuY29tJztcbiAgICAgIGNvbnN0IHNlYXJjaFF1ZXJ5ID0gJ2V4YW1wbGUgc2l0ZSc7XG5cbiAgICAgIGF3YWl0IHNlcnZpY2UuYWNjZXNzVmlhR29vZ2xlKHRhcmdldFVybCwgc2VhcmNoUXVlcnkpO1xuXG4gICAgICBleHBlY3QobW9ja1BhZ2UuZ290bykudG9IYXZlQmVlbkNhbGxlZFdpdGgoXG4gICAgICAgICdodHRwczovL3d3dy5nb29nbGUuY29tJyxcbiAgICAgICAgZXhwZWN0LmFueShPYmplY3QpLFxuICAgICAgKTtcbiAgICAgIGV4cGVjdChtb2NrUGFnZS5sb2NhdG9yKS50b0hhdmVCZWVuQ2FsbGVkV2l0aCgnaW5wdXRbbmFtZT1cInFcIl0nKTtcbiAgICAgIGV4cGVjdChtb2NrUGFnZS5rZXlib2FyZC5wcmVzcykudG9IYXZlQmVlbkNhbGxlZFdpdGgoJ0VudGVyJyk7XG4gICAgfSk7XG4gIH0pO1xuXG4gIGRlc2NyaWJlKCdnZXRBZGFwdGl2ZURlbGF5JywgKCkgPT4ge1xuICAgIGl0KCfjgqjjg6njg7zmmYLjgavjg4fjgqPjg6zjgqTjgpLlopfliqDjgZXjgZvjgovjgZPjgagnLCAoKSA9PiB7XG4gICAgICBjb25zdCBkb21haW4gPSAnZXhhbXBsZS5jb20nO1xuXG4gICAgICBjb25zdCBkZWxheTEgPSBzZXJ2aWNlLmdldEFkYXB0aXZlRGVsYXkoZG9tYWluLCBmYWxzZSk7XG4gICAgICBjb25zdCBkZWxheTIgPSBzZXJ2aWNlLmdldEFkYXB0aXZlRGVsYXkoZG9tYWluLCB0cnVlKTtcbiAgICAgIGNvbnN0IGRlbGF5MyA9IHNlcnZpY2UuZ2V0QWRhcHRpdmVEZWxheShkb21haW4sIHRydWUpO1xuXG4gICAgICBleHBlY3QoZGVsYXkyKS50b0JlR3JlYXRlclRoYW4oZGVsYXkxKTtcbiAgICAgIGV4cGVjdChkZWxheTMpLnRvQmVHcmVhdGVyVGhhbihkZWxheTIpO1xuICAgIH0pO1xuXG4gICAgaXQoJ+aIkOWKn+aZguOBq+ODh+OCo+ODrOOCpOOCkua4m+WwkeOBleOBm+OCi+OBk+OBqCcsICgpID0+IHtcbiAgICAgIGNvbnN0IGRvbWFpbiA9ICdleGFtcGxlLmNvbSc7XG5cbiAgICAgIC8vIOOCqOODqeODvOOBp+ODh+OCo+ODrOOCpOOCkuWil+WKoFxuICAgICAgc2VydmljZS5nZXRBZGFwdGl2ZURlbGF5KGRvbWFpbiwgdHJ1ZSk7XG4gICAgICBjb25zdCBkZWxheUFmdGVyRXJyb3IgPSBzZXJ2aWNlLmdldEFkYXB0aXZlRGVsYXkoZG9tYWluLCBmYWxzZSk7XG5cbiAgICAgIC8vIOaZgumWk+e1jOmBjuOCkuOCt+ODn+ODpeODrOODvOODiO+8iOODhuOCueODiOeUqOOBq+efree4ru+8iVxuICAgICAgamVzdC5zcHlPbihEYXRlLCAnbm93JykubW9ja1JldHVyblZhbHVlKERhdGUubm93KCkgKyA2ICogNjAgKiAxMDAwKTtcblxuICAgICAgY29uc3QgZGVsYXlBZnRlclN1Y2Nlc3MgPSBzZXJ2aWNlLmdldEFkYXB0aXZlRGVsYXkoZG9tYWluLCBmYWxzZSk7XG5cbiAgICAgIGV4cGVjdChkZWxheUFmdGVyU3VjY2VzcykudG9CZUxlc3NUaGFuKGRlbGF5QWZ0ZXJFcnJvcik7XG4gICAgfSk7XG4gIH0pO1xuXG4gIGRlc2NyaWJlKCdDb29raWXnrqHnkIYnLCAoKSA9PiB7XG4gICAgaXQoJ0Nvb2tpZeOCkuS/neWtmOODu+W+qeWFg+OBp+OBjeOCi+OBk+OBqCcsIGFzeW5jICgpID0+IHtcbiAgICAgIGNvbnN0IGRvbWFpbiA9ICdleGFtcGxlLmNvbSc7XG4gICAgICBjb25zdCBtb2NrQ29va2llcyA9IFt7IG5hbWU6ICd0ZXN0JywgdmFsdWU6ICd2YWx1ZScsIGRvbWFpbiB9XTtcblxuICAgICAgbW9ja0NvbnRleHQuY29va2llcy5tb2NrUmVzb2x2ZWRWYWx1ZShtb2NrQ29va2llcyk7XG5cbiAgICAgIGF3YWl0IHNlcnZpY2UuZ2V0T3JDcmVhdGVTZXNzaW9uKGRvbWFpbik7XG4gICAgICBhd2FpdCBzZXJ2aWNlLnNhdmVDb29raWVzKGRvbWFpbik7XG4gICAgICBhd2FpdCBzZXJ2aWNlLnJlc3RvcmVDb29raWVzKGRvbWFpbik7XG5cbiAgICAgIGV4cGVjdChtb2NrQ29udGV4dC5jb29raWVzKS50b0hhdmVCZWVuQ2FsbGVkKCk7XG4gICAgICBleHBlY3QobW9ja0NvbnRleHQuYWRkQ29va2llcykudG9IYXZlQmVlbkNhbGxlZFdpdGgobW9ja0Nvb2tpZXMpO1xuICAgIH0pO1xuICB9KTtcbn0pO1xuIl0sInZlcnNpb24iOjN9