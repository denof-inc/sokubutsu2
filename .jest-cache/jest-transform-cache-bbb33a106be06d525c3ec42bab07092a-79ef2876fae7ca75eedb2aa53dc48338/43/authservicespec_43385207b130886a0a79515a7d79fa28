ddcdaa856c4d96ba996fa5d539f26c58
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const testing_1 = require("@nestjs/testing");
const auth_service_1 = require("./auth.service");
const users_service_1 = require("../../domain/users/users.service");
const auth_exceptions_1 = require("../../common/exceptions/auth.exceptions");
describe('AuthService', () => {
    let service;
    let usersService;
    const mockTelegramUser = {
        id: 123456789,
        is_bot: false,
        first_name: 'Test',
        last_name: 'User',
        username: 'testuser',
        language_code: 'ja',
    };
    const mockUser = {
        id: 1,
        telegramId: '123456789',
        firstName: 'Test',
        lastName: 'User',
        username: 'testuser',
        isActive: true,
        languageCode: 'ja',
        settings: {
            notifications: { enabled: true, silent: false },
            language: 'ja',
        },
        lastActiveAt: new Date(),
        createdAt: new Date(),
        updatedAt: new Date(),
        fullName: 'Test User',
        displayName: 'testuser',
    };
    beforeEach(async () => {
        const mockUsersService = {
            findByTelegramId: jest.fn(),
            create: jest.fn(),
            update: jest.fn(),
            exists: jest.fn(),
        };
        const module = await testing_1.Test.createTestingModule({
            providers: [
                auth_service_1.AuthService,
                { provide: users_service_1.UsersService, useValue: mockUsersService },
            ],
        }).compile();
        service = module.get(auth_service_1.AuthService);
        usersService = module.get(users_service_1.UsersService);
    });
    it('should be defined', () => {
        expect(service).toBeDefined();
    });
    describe('authenticateTelegramUser', () => {
        it('should create new user when user does not exist', async () => {
            usersService.findByTelegramId.mockResolvedValue(null);
            usersService.create.mockResolvedValue(mockUser);
            const result = await service.authenticateTelegramUser(mockTelegramUser);
            expect(result).toEqual(mockUser);
            expect(usersService.findByTelegramId).toHaveBeenCalledWith('123456789');
            expect(usersService.create).toHaveBeenCalled();
        });
        it('should update existing user', async () => {
            usersService.findByTelegramId.mockResolvedValue(mockUser);
            usersService.update.mockResolvedValue(mockUser);
            const result = await service.authenticateTelegramUser(mockTelegramUser);
            expect(result).toEqual(mockUser);
            expect(usersService.update).toHaveBeenCalled();
        });
        it('should throw error for invalid telegram user data', async () => {
            const invalidUser = { ...mockTelegramUser, first_name: '' };
            await expect(service.authenticateTelegramUser(invalidUser)).rejects.toThrow(auth_exceptions_1.InvalidTelegramDataException);
        });
        it('should reactivate inactive user', async () => {
            const inactiveUser = { ...mockUser, isActive: false };
            usersService.findByTelegramId.mockResolvedValue(inactiveUser);
            const activeUser = { ...mockUser, isActive: true };
            usersService.update.mockResolvedValue(activeUser);
            await service.authenticateTelegramUser(mockTelegramUser);
            expect(usersService.update).toHaveBeenCalledWith('123456789', expect.objectContaining({ isActive: true }));
        });
    });
    describe('handleStartCommand', () => {
        it('should handle start command for new user', async () => {
            usersService.exists.mockResolvedValue(false);
            usersService.findByTelegramId.mockResolvedValue(null);
            usersService.create.mockResolvedValue(mockUser);
            const result = await service.handleStartCommand(mockTelegramUser);
            expect(result.isNewUser).toBe(true);
            expect(result.user).toEqual(mockUser);
            expect(result.welcomeMessage).toContain('はじめまして');
        });
        it('should handle start command for existing user', async () => {
            usersService.exists.mockResolvedValue(true);
            usersService.findByTelegramId.mockResolvedValue(mockUser);
            usersService.update.mockResolvedValue(mockUser);
            const result = await service.handleStartCommand(mockTelegramUser);
            expect(result.isNewUser).toBe(false);
            expect(result.user).toEqual(mockUser);
            expect(result.welcomeMessage).toContain('おかえりなさい');
        });
    });
    describe('validateUser', () => {
        it('should return true for active user', async () => {
            usersService.findByTelegramId.mockResolvedValue(mockUser);
            const result = await service.validateUser('123456789');
            expect(result).toBe(true);
        });
        it('should return false for inactive user', async () => {
            const inactiveUser = { ...mockUser, isActive: false };
            usersService.findByTelegramId.mockResolvedValue(inactiveUser);
            const result = await service.validateUser('123456789');
            expect(result).toBe(false);
        });
        it('should return false for non-existent user', async () => {
            usersService.findByTelegramId.mockResolvedValue(null);
            const result = await service.validateUser('123456789');
            expect(result).toBe(false);
        });
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL3R0dGVsYS9Eb2N1bWVudHMvV29yay9kZW5vZi93b3Jrcy8yNTA1Mjlzb2t1YnV0c3UvZGV2Mi9zcmMvY29yZS9hdXRoL2F1dGguc2VydmljZS5zcGVjLnRzIiwibWFwcGluZ3MiOiI7O0FBQUEsNkNBQXNEO0FBQ3RELGlEQUE2QztBQUM3QyxvRUFBZ0U7QUFHaEUsNkVBQXVGO0FBRXZGLFFBQVEsQ0FBQyxhQUFhLEVBQUUsR0FBRyxFQUFFO0lBQzNCLElBQUksT0FBb0IsQ0FBQztJQUN6QixJQUFJLFlBQXVDLENBQUM7SUFFNUMsTUFBTSxnQkFBZ0IsR0FBaUI7UUFDckMsRUFBRSxFQUFFLFNBQVM7UUFDYixNQUFNLEVBQUUsS0FBSztRQUNiLFVBQVUsRUFBRSxNQUFNO1FBQ2xCLFNBQVMsRUFBRSxNQUFNO1FBQ2pCLFFBQVEsRUFBRSxVQUFVO1FBQ3BCLGFBQWEsRUFBRSxJQUFJO0tBQ3BCLENBQUM7SUFFRixNQUFNLFFBQVEsR0FBUztRQUNyQixFQUFFLEVBQUUsQ0FBQztRQUNMLFVBQVUsRUFBRSxXQUFXO1FBQ3ZCLFNBQVMsRUFBRSxNQUFNO1FBQ2pCLFFBQVEsRUFBRSxNQUFNO1FBQ2hCLFFBQVEsRUFBRSxVQUFVO1FBQ3BCLFFBQVEsRUFBRSxJQUFJO1FBQ2QsWUFBWSxFQUFFLElBQUk7UUFDbEIsUUFBUSxFQUFFO1lBQ1IsYUFBYSxFQUFFLEVBQUUsT0FBTyxFQUFFLElBQUksRUFBRSxNQUFNLEVBQUUsS0FBSyxFQUFFO1lBQy9DLFFBQVEsRUFBRSxJQUFJO1NBQ2Y7UUFDRCxZQUFZLEVBQUUsSUFBSSxJQUFJLEVBQUU7UUFDeEIsU0FBUyxFQUFFLElBQUksSUFBSSxFQUFFO1FBQ3JCLFNBQVMsRUFBRSxJQUFJLElBQUksRUFBRTtRQUNyQixRQUFRLEVBQUUsV0FBVztRQUNyQixXQUFXLEVBQUUsVUFBVTtLQUN4QixDQUFDO0lBRUYsVUFBVSxDQUFDLEtBQUssSUFBSSxFQUFFO1FBQ3BCLE1BQU0sZ0JBQWdCLEdBQUc7WUFDdkIsZ0JBQWdCLEVBQUUsSUFBSSxD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QUFNLENBQUMsTUFBTSxDQUFDLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDO1FBQzdCLENBQUMsQ0FBQyxDQUFDO1FBRUgsRUFBRSxDQUFDLDJDQUEyQyxFQUFFLEtBQUssSUFBSSxFQUFFO1lBQ3pELFlBQVksQ0FBQyxnQkFBZ0IsQ0FBQyxpQkFBaUIsQ0FBQyxJQUFJLENBQUMsQ0FBQztZQUV0RCxNQUFNLE1BQU0sR0FBRyxNQUFNLE9BQU8sQ0FBQyxZQUFZLENBQUMsV0FBVyxDQUFDLENBQUM7WUFFdkQsTUFBTSxDQUFDLE1BQU0sQ0FBQyxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUM3QixDQUFDLENBQUMsQ0FBQztJQUNMLENBQUMsQ0FBQyxDQUFDO0FBQ0wsQ0FBQyxDQUFDLENBQUMiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiL1VzZXJzL3R0dGVsYS9Eb2N1bWVudHMvV29yay9kZW5vZi93b3Jrcy8yNTA1Mjlzb2t1YnV0c3UvZGV2Mi9zcmMvY29yZS9hdXRoL2F1dGguc2VydmljZS5zcGVjLnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IFRlc3QsIFRlc3RpbmdNb2R1bGUgfSBmcm9tICdAbmVzdGpzL3Rlc3RpbmcnO1xuaW1wb3J0IHsgQXV0aFNlcnZpY2UgfSBmcm9tICcuL2F1dGguc2VydmljZSc7XG5pbXBvcnQgeyBVc2Vyc1NlcnZpY2UgfSBmcm9tICcuLi8uLi9kb21haW4vdXNlcnMvdXNlcnMuc2VydmljZSc7XG5pbXBvcnQgeyBUZWxlZ3JhbVVzZXIgfSBmcm9tICcuLi8uLi9jb21tb24vaW50ZXJmYWNlcy90ZWxlZ3JhbS11c2VyLmludGVyZmFjZSc7XG5pbXBvcnQgeyBVc2VyIH0gZnJvbSAnLi4vLi4vZG9tYWluL3VzZXJzL2VudGl0aWVzL3VzZXIuZW50aXR5JztcbmltcG9ydCB7IEludmFsaWRUZWxlZ3JhbURhdGFFeGNlcHRpb24gfSBmcm9tICcuLi8uLi9jb21tb24vZXhjZXB0aW9ucy9hdXRoLmV4Y2VwdGlvbnMnO1xuXG5kZXNjcmliZSgnQXV0aFNlcnZpY2UnLCAoKSA9PiB7XG4gIGxldCBzZXJ2aWNlOiBBdXRoU2VydmljZTtcbiAgbGV0IHVzZXJzU2VydmljZTogamVzdC5Nb2NrZWQ8VXNlcnNTZXJ2aWNlPjtcblxuICBjb25zdCBtb2NrVGVsZWdyYW1Vc2VyOiBUZWxlZ3JhbVVzZXIgPSB7XG4gICAgaWQ6IDEyMzQ1Njc4OSxcbiAgICBpc19ib3Q6IGZhbHNlLFxuICAgIGZpcnN0X25hbWU6ICdUZXN0JyxcbiAgICBsYXN0X25hbWU6ICdVc2VyJyxcbiAgICB1c2VybmFtZTogJ3Rlc3R1c2VyJyxcbiAgICBsYW5ndWFnZV9jb2RlOiAnamEnLFxuICB9O1xuXG4gIGNvbnN0IG1vY2tVc2VyOiBVc2VyID0ge1xuICAgIGlkOiAxLFxuICAgIHRlbGVncmFtSWQ6ICcxMjM0NTY3ODknLFxuICAgIGZpcnN0TmFtZTogJ1Rlc3QnLFxuICAgIGxhc3ROYW1lOiAnVXNlcicsXG4gICAgdXNlcm5hbWU6ICd0ZXN0dXNlcicsXG4gICAgaXNBY3RpdmU6IHRydWUsXG4gICAgbGFuZ3VhZ2VDb2RlOiAnamEnLFxuICAgIHNldHRpbmdzOiB7XG4gICAgICBub3RpZmljYXRpb25zOiB7IGVuYWJsZWQ6IHRydWUsIHNpbGVudDogZmFsc2UgfSxcbiAgICAgIGxhbmd1YWdlOiAnamEnLFxuICAgIH0sXG4gICAgbGFzdEFjdGl2ZUF0OiBuZXcgRGF0ZSgpLFxuICAgIGNyZWF0ZWRBdDogbmV3IERhdGUoKSxcbiAgICB1cGRhdGVkQXQ6IG5ldyBEYXRlKCksXG4gICAgZnVsbE5hbWU6ICdUZXN0IFVzZXInLFxuICAgIGRpc3BsYXlOYW1lOiAndGVzdHVzZXInLFxuICB9O1xuXG4gIGJlZm9yZUVhY2goYXN5bmMgKCkgPT4ge1xuICAgIGNvbnN0IG1vY2tVc2Vyc1NlcnZpY2UgPSB7XG4gICAgICBmaW5kQnlUZWxlZ3JhbUlkOiBqZXN0LmZuKCksXG4gICAgICBjcmVhdGU6IGplc3QuZm4oKSxcbiAgICAgIHVwZGF0ZTogamVzdC5mbigpLFxuICAgICAgZXhpc3RzOiBqZXN0LmZuKCksXG4gICAgfTtcblxuICAgIGNvbnN0IG1vZHVsZTogVGVzdGluZ01vZHVsZSA9IGF3YWl0IFRlc3QuY3JlYXRlVGVzdGluZ01vZHVsZSh7XG4gICAgICBwcm92aWRlcnM6IFtcbiAgICAgICAgQXV0aFNlcnZpY2UsXG4gICAgICAgIHsgcHJvdmlkZTogVXNlcnNTZXJ2aWNlLCB1c2VWYWx1ZTogbW9ja1VzZXJzU2VydmljZSB9LFxuICAgICAgXSxcbiAgICB9KS5jb21waWxlKCk7XG5cbiAgICBzZXJ2aWNlID0gbW9kdWxlLmdldDxBdXRoU2VydmljZT4oQXV0aFNlcnZpY2UpO1xuICAgIHVzZXJzU2VydmljZSA9IG1vZHVsZS5nZXQoVXNlcnNTZXJ2aWNlKTtcbiAgfSk7XG5cbiAgaXQoJ3Nob3VsZCBiZSBkZWZpbmVkJywgKCkgPT4ge1xuICAgIGV4cGVjdChzZXJ2aWNlKS50b0JlRGVmaW5lZCgpO1xuICB9KTtcblxuICBkZXNjcmliZSgnYXV0aGVudGljYXRlVGVsZWdyYW1Vc2VyJywgKCkgPT4ge1xuICAgIGl0KCdzaG91bGQgY3JlYXRlIG5ldyB1c2VyIHdoZW4gdXNlciBkb2VzIG5vdCBleGlzdCcsIGFzeW5jICgpID0+IHtcbiAgICAgIHVzZXJzU2VydmljZS5maW5kQnlUZWxlZ3JhbUlkLm1vY2tSZXNvbHZlZFZhbHVlKG51bGwpO1xuICAgICAgdXNlcnNTZXJ2aWNlLmNyZWF0ZS5tb2NrUmVzb2x2ZWRWYWx1ZShtb2NrVXNlcik7XG5cbiAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IHNlcnZpY2UuYXV0aGVudGljYXRlVGVsZWdyYW1Vc2VyKG1vY2tUZWxlZ3JhbVVzZXIpO1xuXG4gICAgICBleHBlY3QocmVzdWx0KS50b0VxdWFsKG1vY2tVc2VyKTtcbiAgICAgIGV4cGVjdCh1c2Vyc1NlcnZpY2UuZmluZEJ5VGVsZWdyYW1JZCkudG9IYXZlQmVlbkNhbGxlZFdpdGgoJzEyMzQ1Njc4OScpO1xuICAgICAgZXhwZWN0KHVzZXJzU2VydmljZS5jcmVhdGUpLnRvSGF2ZUJlZW5DYWxsZWQoKTtcbiAgICB9KTtcblxuICAgIGl0KCdzaG91bGQgdXBkYXRlIGV4aXN0aW5nIHVzZXInLCBhc3luYyAoKSA9PiB7XG4gICAgICB1c2Vyc1NlcnZpY2UuZmluZEJ5VGVsZWdyYW1JZC5tb2NrUmVzb2x2ZWRWYWx1ZShtb2NrVXNlcik7XG4gICAgICB1c2Vyc1NlcnZpY2UudXBkYXRlLm1vY2tSZXNvbHZlZFZhbHVlKG1vY2tVc2VyKTtcblxuICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgc2VydmljZS5hdXRoZW50aWNhdGVUZWxlZ3JhbVVzZXIobW9ja1RlbGVncmFtVXNlcik7XG5cbiAgICAgIGV4cGVjdChyZXN1bHQpLnRvRXF1YWwobW9ja1VzZXIpO1xuICAgICAgZXhwZWN0KHVzZXJzU2VydmljZS51cGRhdGUpLnRvSGF2ZUJlZW5DYWxsZWQoKTtcbiAgICB9KTtcblxuICAgIGl0KCdzaG91bGQgdGhyb3cgZXJyb3IgZm9yIGludmFsaWQgdGVsZWdyYW0gdXNlciBkYXRhJywgYXN5bmMgKCkgPT4ge1xuICAgICAgY29uc3QgaW52YWxpZFVzZXIgPSB7IC4uLm1vY2tUZWxlZ3JhbVVzZXIsIGZpcnN0X25hbWU6ICcnIH07XG5cbiAgICAgIGF3YWl0IGV4cGVjdChcbiAgICAgICAgc2VydmljZS5hdXRoZW50aWNhdGVUZWxlZ3JhbVVzZXIoaW52YWxpZFVzZXIpLFxuICAgICAgKS5yZWplY3RzLnRvVGhyb3coSW52YWxpZFRlbGVncmFtRGF0YUV4Y2VwdGlvbik7XG4gICAgfSk7XG5cbiAgICBpdCgnc2hvdWxkIHJlYWN0aXZhdGUgaW5hY3RpdmUgdXNlcicsIGFzeW5jICgpID0+IHtcbiAgICAgIGNvbnN0IGluYWN0aXZlVXNlciA9IHsgLi4ubW9ja1VzZXIsIGlzQWN0aXZlOiBmYWxzZSB9IGFzIFVzZXI7XG4gICAgICB1c2Vyc1NlcnZpY2UuZmluZEJ5VGVsZWdyYW1JZC5tb2NrUmVzb2x2ZWRWYWx1ZShpbmFjdGl2ZVVzZXIpO1xuICAgICAgY29uc3QgYWN0aXZlVXNlciA9IHsgLi4ubW9ja1VzZXIsIGlzQWN0aXZlOiB0cnVlIH0gYXMgVXNlcjtcbiAgICAgIHVzZXJzU2VydmljZS51cGRhdGUubW9ja1Jlc29sdmVkVmFsdWUoYWN0aXZlVXNlcik7XG5cbiAgICAgIGF3YWl0IHNlcnZpY2UuYXV0aGVudGljYXRlVGVsZWdyYW1Vc2VyKG1vY2tUZWxlZ3JhbVVzZXIpO1xuXG4gICAgICBleHBlY3QodXNlcnNTZXJ2aWNlLnVwZGF0ZSkudG9IYXZlQmVlbkNhbGxlZFdpdGgoXG4gICAgICAgICcxMjM0NTY3ODknLFxuICAgICAgICBleHBlY3Qub2JqZWN0Q29udGFpbmluZyh7IGlzQWN0aXZlOiB0cnVlIH0pLFxuICAgICAgKTtcbiAgICB9KTtcbiAgfSk7XG5cbiAgZGVzY3JpYmUoJ2hhbmRsZVN0YXJ0Q29tbWFuZCcsICgpID0+IHtcbiAgICBpdCgnc2hvdWxkIGhhbmRsZSBzdGFydCBjb21tYW5kIGZvciBuZXcgdXNlcicsIGFzeW5jICgpID0+IHtcbiAgICAgIHVzZXJzU2VydmljZS5leGlzdHMubW9ja1Jlc29sdmVkVmFsdWUoZmFsc2UpO1xuICAgICAgdXNlcnNTZXJ2aWNlLmZpbmRCeVRlbGVncmFtSWQubW9ja1Jlc29sdmVkVmFsdWUobnVsbCk7XG4gICAgICB1c2Vyc1NlcnZpY2UuY3JlYXRlLm1vY2tSZXNvbHZlZFZhbHVlKG1vY2tVc2VyKTtcblxuICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgc2VydmljZS5oYW5kbGVTdGFydENvbW1hbmQobW9ja1RlbGVncmFtVXNlcik7XG5cbiAgICAgIGV4cGVjdChyZXN1bHQuaXNOZXdVc2VyKS50b0JlKHRydWUpO1xuICAgICAgZXhwZWN0KHJlc3VsdC51c2VyKS50b0VxdWFsKG1vY2tVc2VyKTtcbiAgICAgIGV4cGVjdChyZXN1bHQud2VsY29tZU1lc3NhZ2UpLnRvQ29udGFpbign44Gv44GY44KB44G+44GX44GmJyk7XG4gICAgfSk7XG5cbiAgICBpdCgnc2hvdWxkIGhhbmRsZSBzdGFydCBjb21tYW5kIGZvciBleGlzdGluZyB1c2VyJywgYXN5bmMgKCkgPT4ge1xuICAgICAgdXNlcnNTZXJ2aWNlLmV4aXN0cy5tb2NrUmVzb2x2ZWRWYWx1ZSh0cnVlKTtcbiAgICAgIHVzZXJzU2VydmljZS5maW5kQnlUZWxlZ3JhbUlkLm1vY2tSZXNvbHZlZFZhbHVlKG1vY2tVc2VyKTtcbiAgICAgIHVzZXJzU2VydmljZS51cGRhdGUubW9ja1Jlc29sdmVkVmFsdWUobW9ja1VzZXIpO1xuXG4gICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBzZXJ2aWNlLmhhbmRsZVN0YXJ0Q29tbWFuZChtb2NrVGVsZWdyYW1Vc2VyKTtcblxuICAgICAgZXhwZWN0KHJlc3VsdC5pc05ld1VzZXIpLnRvQmUoZmFsc2UpO1xuICAgICAgZXhwZWN0KHJlc3VsdC51c2VyKS50b0VxdWFsKG1vY2tVc2VyKTtcbiAgICAgIGV4cGVjdChyZXN1bHQud2VsY29tZU1lc3NhZ2UpLnRvQ29udGFpbign44GK44GL44GI44KK44Gq44GV44GEJyk7XG4gICAgfSk7XG4gIH0pO1xuXG4gIGRlc2NyaWJlKCd2YWxpZGF0ZVVzZXInLCAoKSA9PiB7XG4gICAgaXQoJ3Nob3VsZCByZXR1cm4gdHJ1ZSBmb3IgYWN0aXZlIHVzZXInLCBhc3luYyAoKSA9PiB7XG4gICAgICB1c2Vyc1NlcnZpY2UuZmluZEJ5VGVsZWdyYW1JZC5tb2NrUmVzb2x2ZWRWYWx1ZShtb2NrVXNlcik7XG5cbiAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IHNlcnZpY2UudmFsaWRhdGVVc2VyKCcxMjM0NTY3ODknKTtcblxuICAgICAgZXhwZWN0KHJlc3VsdCkudG9CZSh0cnVlKTtcbiAgICB9KTtcblxuICAgIGl0KCdzaG91bGQgcmV0dXJuIGZhbHNlIGZvciBpbmFjdGl2ZSB1c2VyJywgYXN5bmMgKCkgPT4ge1xuICAgICAgY29uc3QgaW5hY3RpdmVVc2VyID0geyAuLi5tb2NrVXNlciwgaXNBY3RpdmU6IGZhbHNlIH0gYXMgVXNlcjtcbiAgICAgIHVzZXJzU2VydmljZS5maW5kQnlUZWxlZ3JhbUlkLm1vY2tSZXNvbHZlZFZhbHVlKGluYWN0aXZlVXNlcik7XG5cbiAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IHNlcnZpY2UudmFsaWRhdGVVc2VyKCcxMjM0NTY3ODknKTtcblxuICAgICAgZXhwZWN0KHJlc3VsdCkudG9CZShmYWxzZSk7XG4gICAgfSk7XG5cbiAgICBpdCgnc2hvdWxkIHJldHVybiBmYWxzZSBmb3Igbm9uLWV4aXN0ZW50IHVzZXInLCBhc3luYyAoKSA9PiB7XG4gICAgICB1c2Vyc1NlcnZpY2UuZmluZEJ5VGVsZWdyYW1JZC5tb2NrUmVzb2x2ZWRWYWx1ZShudWxsKTtcblxuICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgc2VydmljZS52YWxpZGF0ZVVzZXIoJzEyMzQ1Njc4OScpO1xuXG4gICAgICBleHBlY3QocmVzdWx0KS50b0JlKGZhbHNlKTtcbiAgICB9KTtcbiAgfSk7XG59KTtcbiJdLCJ2ZXJzaW9uIjozfQ==