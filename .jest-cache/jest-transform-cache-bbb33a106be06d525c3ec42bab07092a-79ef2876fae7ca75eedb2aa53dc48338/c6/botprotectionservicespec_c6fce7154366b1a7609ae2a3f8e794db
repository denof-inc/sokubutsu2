91478cfca87437c99d380cbfa0fe30cc
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
jest.mock('playwright');
const testing_1 = require("@nestjs/testing");
const bot_protection_service_1 = require("./bot-protection.service");
const browser_stealth_service_1 = require("../scraping/browser-stealth.service");
const playwright_1 = require("playwright");
describe('BotProtectionService', () => {
    let service;
    let mockBrowser;
    let mockContext;
    let mockPage;
    beforeEach(async () => {
        // Playwrightのモック設定
        mockPage = {
            goto: jest.fn().mockResolvedValue(undefined),
            waitForSelector: jest.fn().mockResolvedValue(undefined),
            locator: jest.fn().mockReturnValue({
                click: jest.fn().mockResolvedValue(undefined),
                type: jest.fn().mockResolvedValue(undefined),
                first: jest.fn().mockReturnValue({
                    isVisible: jest.fn().mockResolvedValue(true),
                    click: jest.fn().mockResolvedValue(undefined),
                }),
            }),
            keyboard: {
                press: jest.fn().mockResolvedValue(undefined),
            },
            waitForLoadState: jest.fn().mockResolvedValue(undefined),
            close: jest.fn().mockResolvedValue(undefined),
        };
        mockContext = {
            newPage: jest.fn().mockResolvedValue(mockPage),
            cookies: jest.fn().mockResolvedValue([]),
            addCookies: jest.fn().mockResolvedValue(undefined),
            close: jest.fn().mockResolvedValue(undefined),
        };
        mockBrowser = {
            newContext: jest.fn().mockResolvedValue(mockContext),
            close: jest.fn().mockResolvedValue(undefined),
        };
        playwright_1.chromium.launch.mockResolvedValue(mockBrowser);
        const mockBrowserStealthService = {
            applyStealthTechniques: jest.fn(),
            createStealthPage: jest.fn().mockResolvedValue(mockPage),
        };
        const module = await testing_1.Test.createTestingModule({
            providers: [
                bot_protection_service_1.BotProtectionService,
                {
                    provide: browser_stealth_service_1.BrowserStealthService,
                    useValue: mockBrowserStealthService,
                },
            ],
        }).compile();
        service = module.get(bot_protection_service_1.BotProtectionService);
    });
    afterEach(() => {
        jest.clearAllMocks();
    });
    it('should be defined', () => {
        expect(service).toBeDefined();
    });
    describe('getOrCreateSession', () => {
        it('新しいセッションを作成すること', async () => {
            const domain = 'example.com';
            const context = await service.getOrCreateSession(domain);
            expect(context).toBeDefined();
            expect(mockBrowser.newContext).toHaveBeenCalled();
        });
        it('既存のセッションを再利用すること', async () => {
            const domain = 'example.com';
            // 最初のセッション作成
            const context1 = await service.getOrCreateSession(domain);
            // 2回目は同じセッションを返す
            const context2 = await service.getOrCreateSession(domain);
            expect(context1).toBe(context2);
            expect(mockBrowser.newContext).toHaveBeenCalledTimes(1);
        });
    });
    describe('accessViaGoogle', () => {
        it.skip('Google経由でサイトにアクセスすること', async () => {
            const targetUrl = 'https://example.com';
            const searchQuery = 'example site';
            await service.accessViaGoogle(targetUrl, searchQuery);
            expect(mockPage.goto).toHaveBeenCalledWith('https://www.google.com', expect.any(Object));
            expect(mockPage.locator).toHaveBeenCalledWith('input[name="q"]');
            expect(mockPage.keyboard.press).toHaveBeenCalledWith('Enter');
        });
    });
    describe('getAdaptiveDelay', () => {
        it('エラー時にディレイを増加させること', () => {
            const domain = 'example.com';
            const delay1 = service.getAdaptiveDelay(domain, false);
            const delay2 = service.getAdaptiveDelay(domain, true);
            const delay3 = service.getAdaptiveDelay(domain, true);
            expect(delay2).toBeGreaterThan(delay1);
            expect(delay3).toBeGreaterThan(delay2);
        });
        it('成功時にディレイを減少させること', () => {
            const domain = 'example.com';
            // エラーでディレイを増加
            service.getAdaptiveDelay(domain, true);
            const delayAfterError = service.getAdaptiveDelay(domain, false);
            // 時間経過をシミュレート（テスト用に短縮）
            jest.spyOn(Date, 'now').mockReturnValue(Date.now() + 6 * 60 * 1000);
            const delayAfterSuccess = service.getAdaptiveDelay(domain, false);
            expect(delayAfterSuccess).toBeLessThan(delayAfterError);
        });
    });
    describe('Cookie管理', () => {
        it('Cookieを保存・復元できること', async () => {
            const domain = 'example.com';
            const mockCookies = [{ name: 'test', value: 'value', domain }];
            mockContext.cookies.mockResolvedValue(mockCookies);
            await service.getOrCreateSession(domain);
            await service.saveCookies(domain);
            await service.restoreCookies(domain);
            expect(mockContext.cookies).toHaveBeenCalled();
            expect(mockContext.addCookies).toHaveBeenCalledWith(mockCookies);
        });
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL3R0dGVsYS9Eb2N1bWVudHMvV29yay9kZW5vZi93b3Jrcy8yNTA1Mjlzb2t1YnV0c3UvZGV2Mi9zcmMvZmVhdHVyZXMvYm90LXByb3RlY3Rpb24vYm90LXByb3RlY3Rpb24uc2VydmljZS5zcGVjLnRzIiwibWFwcGluZ3MiOiI7O0FBS0EsSUFBSSxDQUFDLElBQUksQ0FBQyxZQUFZLENBQUMsQ0FBQztBQUx4Qiw2Q0FBc0Q7QUFDdEQscUVBQWdFO0FBQ2hFLGlGQUE0RTtBQUM1RSwyQ0FBc0M7QUFJdEMsUUFBUSxDQUFDLHNCQUFzQixFQUFFLEdBQUcsRUFBRTtJQUNwQyxJQUFJLE9BQTZCLENBQUM7SUFDbEMsSUFBSSxXQUFnQixDQUFDO0lBQ3JCLElBQUksV0FBZ0IsQ0FBQztJQUNyQixJQUFJLFFBQWEsQ0FBQztJQUVsQixVQUFVLENBQUMsS0FBSyxJQUFJLEVBQUU7UUFDcEIsbUJBQW1CO1FBQ25CLFFBQVEsR0FBRztZQUNULElBQUksRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFLENBQUMsaUJBQWlCLENBQUMsU0FBUyxDQUFDO1lBQzVDLGVBQWUsRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFLENBQUMsaUJBQWlCLENBQUMsU0FBUyxDQUFDO1lBQ3ZELE9BQU8sRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFLENBQUMsZUFBZSxDQUFDO2dCQUNqQyxLQUFLLEVBQUUsSUFBSSxDQUFDLEVBQUUsRUFBRSxDQUFDLGlCQUFpQixDQUFDLFNBQVMsQ0FBQztnQkFDN0MsSUFBSSxFQUFFLElBQUksQ0FBQyxFQUFFLEVBQUUsQ0FBQyxpQkFBaUIsQ0FBQyxTQUFTLENBQUM7Z0JBQzVDLEtBQUssRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFLENBQUMsZUFBZSxDQUFDO29CQUMvQixTQUFTLEVBQUUsSUFBSSxDQUFDLEVBQUUsRUFBRSxDQUFDLGlCQUFpQixDQUFDLElBQUksQ0FBQztvQkFDNUMsS0FBSyxFQUFFLElBQUksQ0FBQyxFQUFFLEVBQUUsQ0FBQyxpQkFBaUIsQ0FBQyxTQUFT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QUUsT0FBTyxFQUFFLE1BQU0sRUFBRSxDQUFDLENBQUM7WUFFL0QsV0FBVyxDQUFDLE9BQU8sQ0FBQyxpQkFBaUIsQ0FBQyxXQUFXLENBQUMsQ0FBQztZQUVuRCxNQUFNLE9BQU8sQ0FBQyxrQkFBa0IsQ0FBQyxNQUFNLENBQUMsQ0FBQztZQUN6QyxNQUFNLE9BQU8sQ0FBQyxXQUFXLENBQUMsTUFBTSxDQUFDLENBQUM7WUFDbEMsTUFBTSxPQUFPLENBQUMsY0FBYyxDQUFDLE1BQU0sQ0FBQyxDQUFDO1lBRXJDLE1BQU0sQ0FBQyxXQUFXLENBQUMsT0FBTyxDQUFDLENBQUMsZ0JBQWdCLEVBQUUsQ0FBQztZQUMvQyxNQUFNLENBQUMsV0FBVyxDQUFDLFVBQVUsQ0FBQyxDQUFDLG9CQUFvQixDQUFDLFdBQVcsQ0FBQyxDQUFDO1FBQ25FLENBQUMsQ0FBQyxDQUFDO0lBQ0wsQ0FBQyxDQUFDLENBQUM7QUFDTCxDQUFDLENBQUMsQ0FBQyIsIm5hbWVzIjpbXSwic291cmNlcyI6WyIvVXNlcnMvdHR0ZWxhL0RvY3VtZW50cy9Xb3JrL2Rlbm9mL3dvcmtzLzI1MDUyOXNva3VidXRzdS9kZXYyL3NyYy9mZWF0dXJlcy9ib3QtcHJvdGVjdGlvbi9ib3QtcHJvdGVjdGlvbi5zZXJ2aWNlLnNwZWMudHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgVGVzdCwgVGVzdGluZ01vZHVsZSB9IGZyb20gJ0BuZXN0anMvdGVzdGluZyc7XG5pbXBvcnQgeyBCb3RQcm90ZWN0aW9uU2VydmljZSB9IGZyb20gJy4vYm90LXByb3RlY3Rpb24uc2VydmljZSc7XG5pbXBvcnQgeyBCcm93c2VyU3RlYWx0aFNlcnZpY2UgfSBmcm9tICcuLi9zY3JhcGluZy9icm93c2VyLXN0ZWFsdGguc2VydmljZSc7XG5pbXBvcnQgeyBjaHJvbWl1bSB9IGZyb20gJ3BsYXl3cmlnaHQnO1xuXG5qZXN0Lm1vY2soJ3BsYXl3cmlnaHQnKTtcblxuZGVzY3JpYmUoJ0JvdFByb3RlY3Rpb25TZXJ2aWNlJywgKCkgPT4ge1xuICBsZXQgc2VydmljZTogQm90UHJvdGVjdGlvblNlcnZpY2U7XG4gIGxldCBtb2NrQnJvd3NlcjogYW55O1xuICBsZXQgbW9ja0NvbnRleHQ6IGFueTtcbiAgbGV0IG1vY2tQYWdlOiBhbnk7XG5cbiAgYmVmb3JlRWFjaChhc3luYyAoKSA9PiB7XG4gICAgLy8gUGxheXdyaWdodOOBruODouODg+OCr+ioreWumlxuICAgIG1vY2tQYWdlID0ge1xuICAgICAgZ290bzogamVzdC5mbigpLm1vY2tSZXNvbHZlZFZhbHVlKHVuZGVmaW5lZCksXG4gICAgICB3YWl0Rm9yU2VsZWN0b3I6IGplc3QuZm4oKS5tb2NrUmVzb2x2ZWRWYWx1ZSh1bmRlZmluZWQpLFxuICAgICAgbG9jYXRvcjogamVzdC5mbigpLm1vY2tSZXR1cm5WYWx1ZSh7XG4gICAgICAgIGNsaWNrOiBqZXN0LmZuKCkubW9ja1Jlc29sdmVkVmFsdWUodW5kZWZpbmVkKSxcbiAgICAgICAgdHlwZTogamVzdC5mbigpLm1vY2tSZXNvbHZlZFZhbHVlKHVuZGVmaW5lZCksXG4gICAgICAgIGZpcnN0OiBqZXN0LmZuKCkubW9ja1JldHVyblZhbHVlKHtcbiAgICAgICAgICBpc1Zpc2libGU6IGplc3QuZm4oKS5tb2NrUmVzb2x2ZWRWYWx1ZSh0cnVlKSxcbiAgICAgICAgICBjbGljazogamVzdC5mbigpLm1vY2tSZXNvbHZlZFZhbHVlKHVuZGVmaW5lZCksXG4gICAgICAgIH0pLFxuICAgICAgfSksXG4gICAgICBrZXlib2FyZDoge1xuICAgICAgICBwcmVzczogamVzdC5mbigpLm1vY2tSZXNvbHZlZFZhbHVlKHVuZGVmaW5lZCksXG4gICAgICB9LFxuICAgICAgd2FpdEZvckxvYWRTdGF0ZTogamVzdC5mbigpLm1vY2tSZXNvbHZlZFZhbHVlKHVuZGVmaW5lZCksXG4gICAgICBjbG9zZTogamVzdC5mbigpLm1vY2tSZXNvbHZlZFZhbHVlKHVuZGVmaW5lZCksXG4gICAgfTtcblxuICAgIG1vY2tDb250ZXh0ID0ge1xuICAgICAgbmV3UGFnZTogamVzdC5mbigpLm1vY2tSZXNvbHZlZFZhbHVlKG1vY2tQYWdlKSxcbiAgICAgIGNvb2tpZXM6IGplc3QuZm4oKS5tb2NrUmVzb2x2ZWRWYWx1ZShbXSksXG4gICAgICBhZGRDb29raWVzOiBqZXN0LmZuKCkubW9ja1Jlc29sdmVkVmFsdWUodW5kZWZpbmVkKSxcbiAgICAgIGNsb3NlOiBqZXN0LmZuKCkubW9ja1Jlc29sdmVkVmFsdWUodW5kZWZpbmVkKSxcbiAgICB9O1xuXG4gICAgbW9ja0Jyb3dzZXIgPSB7XG4gICAgICBuZXdDb250ZXh0OiBqZXN0LmZuKCkubW9ja1Jlc29sdmVkVmFsdWUobW9ja0NvbnRleHQpLFxuICAgICAgY2xvc2U6IGplc3QuZm4oKS5tb2NrUmVzb2x2ZWRWYWx1ZSh1bmRlZmluZWQpLFxuICAgIH07XG5cbiAgICAoY2hyb21pdW0ubGF1bmNoIGFzIGplc3QuTW9jaykubW9ja1Jlc29sdmVkVmFsdWUobW9ja0Jyb3dzZXIpO1xuXG4gICAgY29uc3QgbW9ja0Jyb3dzZXJTdGVhbHRoU2VydmljZSA9IHtcbiAgICAgIGFwcGx5U3RlYWx0aFRlY2huaXF1ZXM6IGplc3QuZm4oKSxcbiAgICAgIGNyZWF0ZVN0ZWFsdGhQYWdlOiBqZXN0LmZuKCkubW9ja1Jlc29sdmVkVmFsdWUobW9ja1BhZ2UpLFxuICAgIH07XG5cbiAgICBjb25zdCBtb2R1bGU6IFRlc3RpbmdNb2R1bGUgPSBhd2FpdCBUZXN0LmNyZWF0ZVRlc3RpbmdNb2R1bGUoe1xuICAgICAgcHJvdmlkZXJzOiBbXG4gICAgICAgIEJvdFByb3RlY3Rpb25TZXJ2aWNlLFxuICAgICAgICB7XG4gICAgICAgICAgcHJvdmlkZTogQnJvd3NlclN0ZWFsdGhTZXJ2aWNlLFxuICAgICAgICAgIHVzZVZhbHVlOiBtb2NrQnJvd3NlclN0ZWFsdGhTZXJ2aWNlLFxuICAgICAgICB9LFxuICAgICAgXSxcbiAgICB9KS5jb21waWxlKCk7XG5cbiAgICBzZXJ2aWNlID0gbW9kdWxlLmdldDxCb3RQcm90ZWN0aW9uU2VydmljZT4oQm90UHJvdGVjdGlvblNlcnZpY2UpO1xuICB9KTtcblxuICBhZnRlckVhY2goKCkgPT4ge1xuICAgIGplc3QuY2xlYXJBbGxNb2NrcygpO1xuICB9KTtcblxuICBpdCgnc2hvdWxkIGJlIGRlZmluZWQnLCAoKSA9PiB7XG4gICAgZXhwZWN0KHNlcnZpY2UpLnRvQmVEZWZpbmVkKCk7XG4gIH0pO1xuXG4gIGRlc2NyaWJlKCdnZXRPckNyZWF0ZVNlc3Npb24nLCAoKSA9PiB7XG4gICAgaXQoJ+aWsOOBl+OBhOOCu+ODg+OCt+ODp+ODs+OCkuS9nOaIkOOBmeOCi+OBk+OBqCcsIGFzeW5jICgpID0+IHtcbiAgICAgIGNvbnN0IGRvbWFpbiA9ICdleGFtcGxlLmNvbSc7XG4gICAgICBjb25zdCBjb250ZXh0ID0gYXdhaXQgc2VydmljZS5nZXRPckNyZWF0ZVNlc3Npb24oZG9tYWluKTtcblxuICAgICAgZXhwZWN0KGNvbnRleHQpLnRvQmVEZWZpbmVkKCk7XG4gICAgICBleHBlY3QobW9ja0Jyb3dzZXIubmV3Q29udGV4dCkudG9IYXZlQmVlbkNhbGxlZCgpO1xuICAgIH0pO1xuXG4gICAgaXQoJ+aXouWtmOOBruOCu+ODg+OCt+ODp+ODs+OCkuWGjeWIqeeUqOOBmeOCi+OBk+OBqCcsIGFzeW5jICgpID0+IHtcbiAgICAgIGNvbnN0IGRvbWFpbiA9ICdleGFtcGxlLmNvbSc7XG5cbiAgICAgIC8vIOacgOWIneOBruOCu+ODg+OCt+ODp+ODs+S9nOaIkFxuICAgICAgY29uc3QgY29udGV4dDEgPSBhd2FpdCBzZXJ2aWNlLmdldE9yQ3JlYXRlU2Vzc2lvbihkb21haW4pO1xuXG4gICAgICAvLyAy5Zue55uu44Gv5ZCM44GY44K744OD44K344On44Oz44KS6L+U44GZXG4gICAgICBjb25zdCBjb250ZXh0MiA9IGF3YWl0IHNlcnZpY2UuZ2V0T3JDcmVhdGVTZXNzaW9uKGRvbWFpbik7XG5cbiAgICAgIGV4cGVjdChjb250ZXh0MSkudG9CZShjb250ZXh0Mik7XG4gICAgICBleHBlY3QobW9ja0Jyb3dzZXIubmV3Q29udGV4dCkudG9IYXZlQmVlbkNhbGxlZFRpbWVzKDEpO1xuICAgIH0pO1xuICB9KTtcblxuICBkZXNjcmliZSgnYWNjZXNzVmlhR29vZ2xlJywgKCkgPT4ge1xuICAgIGl0LnNraXAoJ0dvb2dsZee1jOeUseOBp+OCteOCpOODiOOBq+OCouOCr+OCu+OCueOBmeOCi+OBk+OBqCcsIGFzeW5jICgpID0+IHtcbiAgICAgIGNvbnN0IHRhcmdldFVybCA9ICdodHRwczovL2V4YW1wbGUuY29tJztcbiAgICAgIGNvbnN0IHNlYXJjaFF1ZXJ5ID0gJ2V4YW1wbGUgc2l0ZSc7XG5cbiAgICAgIGF3YWl0IHNlcnZpY2UuYWNjZXNzVmlhR29vZ2xlKHRhcmdldFVybCwgc2VhcmNoUXVlcnkpO1xuXG4gICAgICBleHBlY3QobW9ja1BhZ2UuZ290bykudG9IYXZlQmVlbkNhbGxlZFdpdGgoXG4gICAgICAgICdodHRwczovL3d3dy5nb29nbGUuY29tJyxcbiAgICAgICAgZXhwZWN0LmFueShPYmplY3QpLFxuICAgICAgKTtcbiAgICAgIGV4cGVjdChtb2NrUGFnZS5sb2NhdG9yKS50b0hhdmVCZWVuQ2FsbGVkV2l0aCgnaW5wdXRbbmFtZT1cInFcIl0nKTtcbiAgICAgIGV4cGVjdChtb2NrUGFnZS5rZXlib2FyZC5wcmVzcykudG9IYXZlQmVlbkNhbGxlZFdpdGgoJ0VudGVyJyk7XG4gICAgfSk7XG4gIH0pO1xuXG4gIGRlc2NyaWJlKCdnZXRBZGFwdGl2ZURlbGF5JywgKCkgPT4ge1xuICAgIGl0KCfjgqjjg6njg7zmmYLjgavjg4fjgqPjg6zjgqTjgpLlopfliqDjgZXjgZvjgovjgZPjgagnLCAoKSA9PiB7XG4gICAgICBjb25zdCBkb21haW4gPSAnZXhhbXBsZS5jb20nO1xuXG4gICAgICBjb25zdCBkZWxheTEgPSBzZXJ2aWNlLmdldEFkYXB0aXZlRGVsYXkoZG9tYWluLCBmYWxzZSk7XG4gICAgICBjb25zdCBkZWxheTIgPSBzZXJ2aWNlLmdldEFkYXB0aXZlRGVsYXkoZG9tYWluLCB0cnVlKTtcbiAgICAgIGNvbnN0IGRlbGF5MyA9IHNlcnZpY2UuZ2V0QWRhcHRpdmVEZWxheShkb21haW4sIHRydWUpO1xuXG4gICAgICBleHBlY3QoZGVsYXkyKS50b0JlR3JlYXRlclRoYW4oZGVsYXkxKTtcbiAgICAgIGV4cGVjdChkZWxheTMpLnRvQmVHcmVhdGVyVGhhbihkZWxheTIpO1xuICAgIH0pO1xuXG4gICAgaXQoJ+aIkOWKn+aZguOBq+ODh+OCo+ODrOOCpOOCkua4m+WwkeOBleOBm+OCi+OBk+OBqCcsICgpID0+IHtcbiAgICAgIGNvbnN0IGRvbWFpbiA9ICdleGFtcGxlLmNvbSc7XG5cbiAgICAgIC8vIOOCqOODqeODvOOBp+ODh+OCo+ODrOOCpOOCkuWil+WKoFxuICAgICAgc2VydmljZS5nZXRBZGFwdGl2ZURlbGF5KGRvbWFpbiwgdHJ1ZSk7XG4gICAgICBjb25zdCBkZWxheUFmdGVyRXJyb3IgPSBzZXJ2aWNlLmdldEFkYXB0aXZlRGVsYXkoZG9tYWluLCBmYWxzZSk7XG5cbiAgICAgIC8vIOaZgumWk+e1jOmBjuOCkuOCt+ODn+ODpeODrOODvOODiO+8iOODhuOCueODiOeUqOOBq+efree4ru+8iVxuICAgICAgamVzdC5zcHlPbihEYXRlLCAnbm93JykubW9ja1JldHVyblZhbHVlKERhdGUubm93KCkgKyA2ICogNjAgKiAxMDAwKTtcblxuICAgICAgY29uc3QgZGVsYXlBZnRlclN1Y2Nlc3MgPSBzZXJ2aWNlLmdldEFkYXB0aXZlRGVsYXkoZG9tYWluLCBmYWxzZSk7XG5cbiAgICAgIGV4cGVjdChkZWxheUFmdGVyU3VjY2VzcykudG9CZUxlc3NUaGFuKGRlbGF5QWZ0ZXJFcnJvcik7XG4gICAgfSk7XG4gIH0pO1xuXG4gIGRlc2NyaWJlKCdDb29raWXnrqHnkIYnLCAoKSA9PiB7XG4gICAgaXQoJ0Nvb2tpZeOCkuS/neWtmOODu+W+qeWFg+OBp+OBjeOCi+OBk+OBqCcsIGFzeW5jICgpID0+IHtcbiAgICAgIGNvbnN0IGRvbWFpbiA9ICdleGFtcGxlLmNvbSc7XG4gICAgICBjb25zdCBtb2NrQ29va2llcyA9IFt7IG5hbWU6ICd0ZXN0JywgdmFsdWU6ICd2YWx1ZScsIGRvbWFpbiB9XTtcblxuICAgICAgbW9ja0NvbnRleHQuY29va2llcy5tb2NrUmVzb2x2ZWRWYWx1ZShtb2NrQ29va2llcyk7XG5cbiAgICAgIGF3YWl0IHNlcnZpY2UuZ2V0T3JDcmVhdGVTZXNzaW9uKGRvbWFpbik7XG4gICAgICBhd2FpdCBzZXJ2aWNlLnNhdmVDb29raWVzKGRvbWFpbik7XG4gICAgICBhd2FpdCBzZXJ2aWNlLnJlc3RvcmVDb29raWVzKGRvbWFpbik7XG5cbiAgICAgIGV4cGVjdChtb2NrQ29udGV4dC5jb29raWVzKS50b0hhdmVCZWVuQ2FsbGVkKCk7XG4gICAgICBleHBlY3QobW9ja0NvbnRleHQuYWRkQ29va2llcykudG9IYXZlQmVlbkNhbGxlZFdpdGgobW9ja0Nvb2tpZXMpO1xuICAgIH0pO1xuICB9KTtcbn0pO1xuIl0sInZlcnNpb24iOjN9