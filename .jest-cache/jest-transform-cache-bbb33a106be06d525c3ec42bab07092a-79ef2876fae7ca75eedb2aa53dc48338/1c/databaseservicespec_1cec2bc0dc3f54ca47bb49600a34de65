e4770f4f1c1022cc48e38d928f270918
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
// import type { Database as BetterSqlite3Database } from 'better-sqlite3';
jest.mock('better-sqlite3');
jest.mock('fs');
const testing_1 = require("@nestjs/testing");
const database_service_1 = require("./database.service");
describe('DatabaseService', () => {
    let service;
    let mockDb;
    beforeEach(async () => {
        mockDb = {
            pragma: jest.fn(),
            exec: jest.fn(),
            prepare: jest.fn(),
            close: jest.fn(),
            transaction: jest.fn(),
        };
        jest.doMock('better-sqlite3', () => jest.fn(() => mockDb));
        jest.doMock('fs', () => ({
            readFileSync: jest.fn().mockReturnValue('CREATE TABLE test;'),
        }));
        const module = await testing_1.Test.createTestingModule({
            providers: [database_service_1.DatabaseService],
        }).compile();
        service = module.get(database_service_1.DatabaseService);
        service.onModuleInit();
    });
    afterEach(() => {
        jest.clearAllMocks();
    });
    it('should be defined', () => {
        expect(service).toBeDefined();
    });
    describe('onModuleInit', () => {
        it('データベース接続を確立し、スキーマを初期化すること', () => {
            // Mocks are already set up in beforeEach
            const Database = jest.requireMock('better-sqlite3');
            const fs = jest.requireMock('fs');
            expect(Database).toHaveBeenCalledWith(expect.stringContaining('sokubutsu.sqlite'));
            expect(mockDb.pragma).toHaveBeenCalledWith('journal_mode = WAL');
            expect(fs.readFileSync).toHaveBeenCalledWith(expect.stringContaining('schema.sql'), 'utf8');
            expect(mockDb.exec).toHaveBeenCalledWith('CREATE TABLE test;');
        });
    });
    describe('onModuleDestroy', () => {
        it('データベース接続を閉じること', () => {
            service.onModuleDestroy();
            expect(mockDb.close).toHaveBeenCalled();
        });
    });
    describe('query', () => {
        it('複数の結果を返すこと', () => {
            const mockStmt = {
                all: jest.fn().mockReturnValue([{ id: 1 }, { id: 2 }]),
            };
            mockDb.prepare.mockReturnValue(mockStmt);
            const result = service.query('SELECT * FROM test WHERE active = ?', [
                true,
            ]);
            expect(mockDb.prepare).toHaveBeenCalledWith('SELECT * FROM test WHERE active = ?');
            expect(mockStmt.all).toHaveBeenCalledWith(true);
            expect(result).toEqual([{ id: 1 }, { id: 2 }]);
        });
    });
    describe('findOne', () => {
        it('単一の結果を返すこと', () => {
            const mockStmt = {
                get: jest.fn().mockReturnValue({ id: 1, name: 'test' }),
            };
            mockDb.prepare.mockReturnValue(mockStmt);
            const result = service.findOne('SELECT * FROM test WHERE id = ?', [1]);
            expect(mockDb.prepare).toHaveBeenCalledWith('SELECT * FROM test WHERE id = ?');
            expect(mockStmt.get).toHaveBeenCalledWith(1);
            expect(result).toEqual({ id: 1, name: 'test' });
        });
        it('結果がない場合はundefinedを返すこと', () => {
            const mockStmt = {
                get: jest.fn().mockReturnValue(undefined),
            };
            mockDb.prepare.mockReturnValue(mockStmt);
            const result = service.findOne('SELECT * FROM test WHERE id = ?', [999]);
            expect(result).toBeUndefined();
        });
    });
    describe('execute', () => {
        it('INSERT/UPDATE/DELETE操作を実行すること', () => {
            const mockRunResult = { changes: 1, lastInsertRowid: 123 };
            const mockStmt = {
                run: jest.fn().mockReturnValue(mockRunResult),
            };
            mockDb.prepare.mockReturnValue(mockStmt);
            const result = service.execute('INSERT INTO test (name) VALUES (?)', [
                'test',
            ]);
            expect(mockDb.prepare).toHaveBeenCalledWith('INSERT INTO test (name) VALUES (?)');
            expect(mockStmt.run).toHaveBeenCalledWith('test');
            expect(result).toEqual(mockRunResult);
        });
    });
    describe('transaction', () => {
        it('トランザクション内で関数を実行すること', () => {
            const mockFn = jest.fn().mockReturnValue('result');
            const mockTransaction = jest.fn().mockReturnValue('result');
            mockDb.transaction.mockReturnValue(mockTransaction);
            const result = service.transaction(mockFn);
            expect(mockDb.transaction).toHaveBeenCalledWith(mockFn);
            expect(mockTransaction).toHaveBeenCalled();
            expect(result).toBe('result');
        });
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL3R0dGVsYS9Eb2N1bWVudHMvV29yay9kZW5vZi93b3Jrcy8yNTA1Mjlzb2t1YnV0c3UvZGV2Mi9zcmMvY29yZS9kYXRhYmFzZS9kYXRhYmFzZS5zZXJ2aWNlLnNwZWMudHMiLCJtYXBwaW5ncyI6Ijs7QUFFQSwyRUFBMkU7QUFFM0UsSUFBSSxDQUFDLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDO0FBQzVCLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7QUFMaEIsNkNBQXNEO0FBQ3RELHlEQUFxRDtBQWNyRCxRQUFRLENBQUMsaUJBQWlCLEVBQUUsR0FBRyxFQUFFO0lBQy9CLElBQUksT0FBd0IsQ0FBQztJQUM3QixJQUFJLE1BQW9CLENBQUM7SUFFekIsVUFBVSxDQUFDLEtBQUssSUFBSSxFQUFFO1FBQ3BCLE1BQU0sR0FBRztZQUNQLE1BQU0sRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFO1lBQ2pCLElBQUksRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFO1lBQ2YsT0FBTyxFQUFFLElBQUksQ0FBQyxFQUFFLEVBQUU7WUFDbEIsS0FBSyxFQUFFLElBQUksQ0FBQyxFQUFFLEVBQUU7WUFDaEIsV0FBVyxFQUFFLElBQUksQ0FBQyxFQUFFLEVBQUU7U0FDdkIsQ0FBQztRQUVGLElBQUksQ0FBQyxNQUFNLENBQUMsZ0JBQWdCLEVBQUUsR0FBRyxFQUFFLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxHQUFHLEVBQUUsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDO1FBRTNELElBQUksQ0FBQyxNQUFNLENBQUMsSUFBSSxFQUFFLEdBQUcsRUFBRSxDQUFDLENBQUM7WUFDdkIsWUFBWSxFQUFFLElBQUksQ0FBQyxFQUFFLEVBQUUsQ0FBQyxlQUFlLENBQUMsb0JBQW9CLENBQUM7U0FDOUQsQ0FBQyxDQUFDLENBQUM7UUFFSixNQUFNLE1BQU0sR0FBa0IsTUFBTSxjQUFJLENBQUMsbUJBQW1CLENBQUM7WUFDM0QsU0FBUyxFQUFFLENBQUMsa0NBQWUsQ0FBQztTQUM3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M0MsTUFBTSxDQUFDLE1BQU0sQ0FBQyxXQUFXLENBQUMsQ0FBQyxvQkFBb0IsQ0FBQyxNQUFNLENBQUMsQ0FBQztZQUN4RCxNQUFNLENBQUMsZUFBZSxDQUFDLENBQUMsZ0JBQWdCLEVBQUUsQ0FBQztZQUMzQyxNQUFNLENBQUMsTUFBTSxDQUFDLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDO1FBQ2hDLENBQUMsQ0FBQyxDQUFDO0lBQ0wsQ0FBQyxDQUFDLENBQUM7QUFDTCxDQUFDLENBQUMsQ0FBQyIsIm5hbWVzIjpbXSwic291cmNlcyI6WyIvVXNlcnMvdHR0ZWxhL0RvY3VtZW50cy9Xb3JrL2Rlbm9mL3dvcmtzLzI1MDUyOXNva3VidXRzdS9kZXYyL3NyYy9jb3JlL2RhdGFiYXNlL2RhdGFiYXNlLnNlcnZpY2Uuc3BlYy50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBUZXN0LCBUZXN0aW5nTW9kdWxlIH0gZnJvbSAnQG5lc3Rqcy90ZXN0aW5nJztcbmltcG9ydCB7IERhdGFiYXNlU2VydmljZSB9IGZyb20gJy4vZGF0YWJhc2Uuc2VydmljZSc7XG4vLyBpbXBvcnQgdHlwZSB7IERhdGFiYXNlIGFzIEJldHRlclNxbGl0ZTNEYXRhYmFzZSB9IGZyb20gJ2JldHRlci1zcWxpdGUzJztcblxuamVzdC5tb2NrKCdiZXR0ZXItc3FsaXRlMycpO1xuamVzdC5tb2NrKCdmcycpO1xuXG50eXBlIE1vY2tEYXRhYmFzZSA9IHtcbiAgcHJhZ21hOiBqZXN0Lk1vY2s7XG4gIGV4ZWM6IGplc3QuTW9jaztcbiAgcHJlcGFyZTogamVzdC5Nb2NrO1xuICBjbG9zZTogamVzdC5Nb2NrO1xuICB0cmFuc2FjdGlvbjogamVzdC5Nb2NrO1xufTtcblxuZGVzY3JpYmUoJ0RhdGFiYXNlU2VydmljZScsICgpID0+IHtcbiAgbGV0IHNlcnZpY2U6IERhdGFiYXNlU2VydmljZTtcbiAgbGV0IG1vY2tEYjogTW9ja0RhdGFiYXNlO1xuXG4gIGJlZm9yZUVhY2goYXN5bmMgKCkgPT4ge1xuICAgIG1vY2tEYiA9IHtcbiAgICAgIHByYWdtYTogamVzdC5mbigpLFxuICAgICAgZXhlYzogamVzdC5mbigpLFxuICAgICAgcHJlcGFyZTogamVzdC5mbigpLFxuICAgICAgY2xvc2U6IGplc3QuZm4oKSxcbiAgICAgIHRyYW5zYWN0aW9uOiBqZXN0LmZuKCksXG4gICAgfTtcblxuICAgIGplc3QuZG9Nb2NrKCdiZXR0ZXItc3FsaXRlMycsICgpID0+IGplc3QuZm4oKCkgPT4gbW9ja0RiKSk7XG5cbiAgICBqZXN0LmRvTW9jaygnZnMnLCAoKSA9PiAoe1xuICAgICAgcmVhZEZpbGVTeW5jOiBqZXN0LmZuKCkubW9ja1JldHVyblZhbHVlKCdDUkVBVEUgVEFCTEUgdGVzdDsnKSxcbiAgICB9KSk7XG5cbiAgICBjb25zdCBtb2R1bGU6IFRlc3RpbmdNb2R1bGUgPSBhd2FpdCBUZXN0LmNyZWF0ZVRlc3RpbmdNb2R1bGUoe1xuICAgICAgcHJvdmlkZXJzOiBbRGF0YWJhc2VTZXJ2aWNlXSxcbiAgICB9KS5jb21waWxlKCk7XG5cbiAgICBzZXJ2aWNlID0gbW9kdWxlLmdldDxEYXRhYmFzZVNlcnZpY2U+KERhdGFiYXNlU2VydmljZSk7XG4gICAgc2VydmljZS5vbk1vZHVsZUluaXQoKTtcbiAgfSk7XG5cbiAgYWZ0ZXJFYWNoKCgpID0+IHtcbiAgICBqZXN0LmNsZWFyQWxsTW9ja3MoKTtcbiAgfSk7XG5cbiAgaXQoJ3Nob3VsZCBiZSBkZWZpbmVkJywgKCkgPT4ge1xuICAgIGV4cGVjdChzZXJ2aWNlKS50b0JlRGVmaW5lZCgpO1xuICB9KTtcblxuICBkZXNjcmliZSgnb25Nb2R1bGVJbml0JywgKCkgPT4ge1xuICAgIGl0KCfjg4fjg7zjgr/jg5njg7zjgrnmjqXntprjgpLnorrnq4vjgZfjgIHjgrnjgq3jg7zjg57jgpLliJ3mnJ/ljJbjgZnjgovjgZPjgagnLCAoKSA9PiB7XG4gICAgICAvLyBNb2NrcyBhcmUgYWxyZWFkeSBzZXQgdXAgaW4gYmVmb3JlRWFjaFxuXG4gICAgICBjb25zdCBEYXRhYmFzZSA9IGplc3QucmVxdWlyZU1vY2soJ2JldHRlci1zcWxpdGUzJyk7XG4gICAgICBjb25zdCBmcyA9IGplc3QucmVxdWlyZU1vY2soJ2ZzJyk7XG4gICAgICBleHBlY3QoRGF0YWJhc2UpLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKFxuICAgICAgICBleHBlY3Quc3RyaW5nQ29udGFpbmluZygnc29rdWJ1dHN1LnNxbGl0ZScpLFxuICAgICAgKTtcbiAgICAgIGV4cGVjdChtb2NrRGIucHJhZ21hKS50b0hhdmVCZWVuQ2FsbGVkV2l0aCgnam91cm5hbF9tb2RlID0gV0FMJyk7XG4gICAgICBleHBlY3QoZnMucmVhZEZpbGVTeW5jKS50b0hhdmVCZWVuQ2FsbGVkV2l0aChcbiAgICAgICAgZXhwZWN0LnN0cmluZ0NvbnRhaW5pbmcoJ3NjaGVtYS5zcWwnKSxcbiAgICAgICAgJ3V0ZjgnLFxuICAgICAgKTtcbiAgICAgIGV4cGVjdChtb2NrRGIuZXhlYykudG9IYXZlQmVlbkNhbGxlZFdpdGgoJ0NSRUFURSBUQUJMRSB0ZXN0OycpO1xuICAgIH0pO1xuICB9KTtcblxuICBkZXNjcmliZSgnb25Nb2R1bGVEZXN0cm95JywgKCkgPT4ge1xuICAgIGl0KCfjg4fjg7zjgr/jg5njg7zjgrnmjqXntprjgpLplonjgZjjgovjgZPjgagnLCAoKSA9PiB7XG4gICAgICBzZXJ2aWNlLm9uTW9kdWxlRGVzdHJveSgpO1xuICAgICAgZXhwZWN0KG1vY2tEYi5jbG9zZSkudG9IYXZlQmVlbkNhbGxlZCgpO1xuICAgIH0pO1xuICB9KTtcblxuICBkZXNjcmliZSgncXVlcnknLCAoKSA9PiB7XG4gICAgaXQoJ+ikh+aVsOOBrue1kOaenOOCkui/lOOBmeOBk+OBqCcsICgpID0+IHtcbiAgICAgIGNvbnN0IG1vY2tTdG10ID0ge1xuICAgICAgICBhbGw6IGplc3QuZm4oKS5tb2NrUmV0dXJuVmFsdWUoW3sgaWQ6IDEgfSwgeyBpZDogMiB9XSksXG4gICAgICB9O1xuICAgICAgbW9ja0RiLnByZXBhcmUubW9ja1JldHVyblZhbHVlKG1vY2tTdG10KTtcblxuICAgICAgY29uc3QgcmVzdWx0ID0gc2VydmljZS5xdWVyeSgnU0VMRUNUICogRlJPTSB0ZXN0IFdIRVJFIGFjdGl2ZSA9ID8nLCBbXG4gICAgICAgIHRydWUsXG4gICAgICBdKTtcblxuICAgICAgZXhwZWN0KG1vY2tEYi5wcmVwYXJlKS50b0hhdmVCZWVuQ2FsbGVkV2l0aChcbiAgICAgICAgJ1NFTEVDVCAqIEZST00gdGVzdCBXSEVSRSBhY3RpdmUgPSA/JyxcbiAgICAgICk7XG4gICAgICBleHBlY3QobW9ja1N0bXQuYWxsKS50b0hhdmVCZWVuQ2FsbGVkV2l0aCh0cnVlKTtcbiAgICAgIGV4cGVjdChyZXN1bHQpLnRvRXF1YWwoW3sgaWQ6IDEgfSwgeyBpZDogMiB9XSk7XG4gICAgfSk7XG4gIH0pO1xuXG4gIGRlc2NyaWJlKCdmaW5kT25lJywgKCkgPT4ge1xuICAgIGl0KCfljZjkuIDjga7ntZDmnpzjgpLov5TjgZnjgZPjgagnLCAoKSA9PiB7XG4gICAgICBjb25zdCBtb2NrU3RtdCA9IHtcbiAgICAgICAgZ2V0OiBqZXN0LmZuKCkubW9ja1JldHVyblZhbHVlKHsgaWQ6IDEsIG5hbWU6ICd0ZXN0JyB9KSxcbiAgICAgIH07XG4gICAgICBtb2NrRGIucHJlcGFyZS5tb2NrUmV0dXJuVmFsdWUobW9ja1N0bXQpO1xuXG4gICAgICBjb25zdCByZXN1bHQgPSBzZXJ2aWNlLmZpbmRPbmUoJ1NFTEVDVCAqIEZST00gdGVzdCBXSEVSRSBpZCA9ID8nLCBbMV0pO1xuXG4gICAgICBleHBlY3QobW9ja0RiLnByZXBhcmUpLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKFxuICAgICAgICAnU0VMRUNUICogRlJPTSB0ZXN0IFdIRVJFIGlkID0gPycsXG4gICAgICApO1xuICAgICAgZXhwZWN0KG1vY2tTdG10LmdldCkudG9IYXZlQmVlbkNhbGxlZFdpdGgoMSk7XG4gICAgICBleHBlY3QocmVzdWx0KS50b0VxdWFsKHsgaWQ6IDEsIG5hbWU6ICd0ZXN0JyB9KTtcbiAgICB9KTtcblxuICAgIGl0KCfntZDmnpzjgYzjgarjgYTloLTlkIjjga91bmRlZmluZWTjgpLov5TjgZnjgZPjgagnLCAoKSA9PiB7XG4gICAgICBjb25zdCBtb2NrU3RtdCA9IHtcbiAgICAgICAgZ2V0OiBqZXN0LmZuKCkubW9ja1JldHVyblZhbHVlKHVuZGVmaW5lZCksXG4gICAgICB9O1xuICAgICAgbW9ja0RiLnByZXBhcmUubW9ja1JldHVyblZhbHVlKG1vY2tTdG10KTtcblxuICAgICAgY29uc3QgcmVzdWx0ID0gc2VydmljZS5maW5kT25lKCdTRUxFQ1QgKiBGUk9NIHRlc3QgV0hFUkUgaWQgPSA/JywgWzk5OV0pO1xuXG4gICAgICBleHBlY3QocmVzdWx0KS50b0JlVW5kZWZpbmVkKCk7XG4gICAgfSk7XG4gIH0pO1xuXG4gIGRlc2NyaWJlKCdleGVjdXRlJywgKCkgPT4ge1xuICAgIGl0KCdJTlNFUlQvVVBEQVRFL0RFTEVUReaTjeS9nOOCkuWun+ihjOOBmeOCi+OBk+OBqCcsICgpID0+IHtcbiAgICAgIGNvbnN0IG1vY2tSdW5SZXN1bHQgPSB7IGNoYW5nZXM6IDEsIGxhc3RJbnNlcnRSb3dpZDogMTIzIH07XG4gICAgICBjb25zdCBtb2NrU3RtdCA9IHtcbiAgICAgICAgcnVuOiBqZXN0LmZuKCkubW9ja1JldHVyblZhbHVlKG1vY2tSdW5SZXN1bHQpLFxuICAgICAgfTtcbiAgICAgIG1vY2tEYi5wcmVwYXJlLm1vY2tSZXR1cm5WYWx1ZShtb2NrU3RtdCk7XG5cbiAgICAgIGNvbnN0IHJlc3VsdCA9IHNlcnZpY2UuZXhlY3V0ZSgnSU5TRVJUIElOVE8gdGVzdCAobmFtZSkgVkFMVUVTICg/KScsIFtcbiAgICAgICAgJ3Rlc3QnLFxuICAgICAgXSk7XG5cbiAgICAgIGV4cGVjdChtb2NrRGIucHJlcGFyZSkudG9IYXZlQmVlbkNhbGxlZFdpdGgoXG4gICAgICAgICdJTlNFUlQgSU5UTyB0ZXN0IChuYW1lKSBWQUxVRVMgKD8pJyxcbiAgICAgICk7XG4gICAgICBleHBlY3QobW9ja1N0bXQucnVuKS50b0hhdmVCZWVuQ2FsbGVkV2l0aCgndGVzdCcpO1xuICAgICAgZXhwZWN0KHJlc3VsdCkudG9FcXVhbChtb2NrUnVuUmVzdWx0KTtcbiAgICB9KTtcbiAgfSk7XG5cbiAgZGVzY3JpYmUoJ3RyYW5zYWN0aW9uJywgKCkgPT4ge1xuICAgIGl0KCfjg4jjg6njg7Pjgrbjgq/jgrfjg6fjg7PlhoXjgafplqLmlbDjgpLlrp/ooYzjgZnjgovjgZPjgagnLCAoKSA9PiB7XG4gICAgICBjb25zdCBtb2NrRm4gPSBqZXN0LmZuKCkubW9ja1JldHVyblZhbHVlKCdyZXN1bHQnKTtcbiAgICAgIGNvbnN0IG1vY2tUcmFuc2FjdGlvbiA9IGplc3QuZm4oKS5tb2NrUmV0dXJuVmFsdWUoJ3Jlc3VsdCcpO1xuICAgICAgbW9ja0RiLnRyYW5zYWN0aW9uLm1vY2tSZXR1cm5WYWx1ZShtb2NrVHJhbnNhY3Rpb24pO1xuXG4gICAgICBjb25zdCByZXN1bHQgPSBzZXJ2aWNlLnRyYW5zYWN0aW9uKG1vY2tGbik7XG5cbiAgICAgIGV4cGVjdChtb2NrRGIudHJhbnNhY3Rpb24pLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKG1vY2tGbik7XG4gICAgICBleHBlY3QobW9ja1RyYW5zYWN0aW9uKS50b0hhdmVCZWVuQ2FsbGVkKCk7XG4gICAgICBleHBlY3QocmVzdWx0KS50b0JlKCdyZXN1bHQnKTtcbiAgICB9KTtcbiAgfSk7XG59KTtcbiJdLCJ2ZXJzaW9uIjozfQ==