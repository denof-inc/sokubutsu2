a4875a8460b066ce952fc282b0db42ea
"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    var desc = Object.getOwnPropertyDescriptor(m, k);
    if (!desc || ("get" in desc ? !m.__esModule : desc.writable || desc.configurable)) {
      desc = { enumerable: true, get: function() { return m[k]; } };
    }
    Object.defineProperty(o, k2, desc);
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || (function () {
    var ownKeys = function(o) {
        ownKeys = Object.getOwnPropertyNames || function (o) {
            var ar = [];
            for (var k in o) if (Object.prototype.hasOwnProperty.call(o, k)) ar[ar.length] = k;
            return ar;
        };
        return ownKeys(o);
    };
    return function (mod) {
        if (mod && mod.__esModule) return mod;
        var result = {};
        if (mod != null) for (var k = ownKeys(mod), i = 0; i < k.length; i++) if (k[i] !== "default") __createBinding(result, mod, k[i]);
        __setModuleDefault(result, mod);
        return result;
    };
})();
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
jest.mock('axios');
jest.mock('cheerio');
jest.mock('jsdom');
jest.mock('playwright');
const testing_1 = require("@nestjs/testing");
const scraping_service_1 = require("./scraping.service");
const axios_1 = __importDefault(require("axios"));
const cheerio = __importStar(require("cheerio"));
const jsdom_1 = require("jsdom");
const playwright_1 = require("playwright");
describe('ScrapingService', () => {
    let service;
    const mockUrl = 'https://example.com';
    const mockSelector = '#test-selector';
    const mockContent = '<div>Test Content</div>';
    const _mockHash = 'mocked-hash';
    beforeEach(async () => {
        const module = await testing_1.Test.createTestingModule({
            providers: [scraping_service_1.ScrapingService],
        }).compile();
        service = module.get(scraping_service_1.ScrapingService);
        // クリーンアップ
        jest.clearAllMocks();
    });
    it('should be defined', () => {
        expect(service).toBeDefined();
    });
    describe('scrapeAndGetHash', () => {
        it('HTTP + Cheerioで成功する場合', async () => {
            // Axiosのモック
            axios_1.default.get.mockResolvedValue({
                data: '<html><body><div id="test-selector">Test Content</div></body></html>',
            });
            // Cheerioのモック
            const mockElement = {
                html: jest.fn().mockReturnValue(mockContent),
                length: 1,
            };
            const mockCheerio = {
                load: jest.fn().mockReturnValue(jest.fn().mockReturnValue(mockElement)),
            };
            cheerio.load = mockCheerio.load;
            const result = await service.scrapeAndGetHash(mockUrl, mockSelector);
            expect(result).toBeDefined();
            expect(axios_1.default.get).toHaveBeenCalledWith(mockUrl, expect.objectContaining({
                headers: expect.objectContaining({
                    'User-Agent': expect.any(String),
                }),
            }));
        });
        it('HTTP失敗時はJSDOMにフォールバック', async () => {
            // Axiosを失敗させる
            axios_1.default.get.mockRejectedValue(new Error('Network error'));
            // JSDOMのモック
            const mockElement = { innerHTML: mockContent };
            const mockDocument = {
                querySelector: jest.fn().mockReturnValue(mockElement),
            };
            const mockWindow = { document: mockDocument, close: jest.fn() };
            jsdom_1.JSDOM.fromURL.mockResolvedValue({ window: mockWindow });
            const result = await service.scrapeAndGetHash(mockUrl, mockSelector);
            expect(result).toBeDefined();
            expect(jsdom_1.JSDOM.fromURL).toHaveBeenCalled();
        });
        it('すべての手法が失敗した場合はnullを返す', async () => {
            // すべて失敗させる
            axios_1.default.get.mockRejectedValue(new Error('HTTP failed'));
            jsdom_1.JSDOM.fromURL.mockRejectedValue(new Error('JSDOM failed'));
            const mockBrowser = {
                newPage: jest.fn().mockRejectedValue(new Error('Playwright failed')),
                close: jest.fn(),
            };
            playwright_1.chromium.launch.mockResolvedValue(mockBrowser);
            const result = await service.scrapeAndGetHash(mockUrl, mockSelector);
            expect(result).toBeNull();
        });
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL3R0dGVsYS9Eb2N1bWVudHMvV29yay9kZW5vZi93b3Jrcy8yNTA1Mjlzb2t1YnV0c3UvZGV2Mi9zcmMvZmVhdHVyZXMvc2NyYXBpbmcvc2NyYXBpbmcuc2VydmljZS5zcGVjLnRzIiwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBT0EsSUFBSSxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsQ0FBQztBQUNuQixJQUFJLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUFDO0FBQ3JCLElBQUksQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLENBQUM7QUFDbkIsSUFBSSxDQUFDLElBQUksQ0FBQyxZQUFZLENBQUMsQ0FBQztBQVZ4Qiw2Q0FBc0Q7QUFDdEQseURBQXFEO0FBQ3JELGtEQUEwQjtBQUMxQixpREFBbUM7QUFDbkMsaUNBQThCO0FBQzlCLDJDQUFzQztBQU90QyxRQUFRLENBQUMsaUJBQWlCLEVBQUUsR0FBRyxFQUFFO0lBQy9CLElBQUksT0FBd0IsQ0FBQztJQUM3QixNQUFNLE9BQU8sR0FBRyxxQkFBcUIsQ0FBQztJQUN0QyxNQUFNLFlBQVksR0FBRyxnQkFBZ0IsQ0FBQztJQUN0QyxNQUFNLFdBQVcsR0FBRyx5QkFBeUIsQ0FBQztJQUM5QyxNQUFNLFNBQVMsR0FBRyxhQUFhLENBQUM7SUFFaEMsVUFBVSxDQUFDLEtBQUssSUFBSSxFQUFFO1FBQ3BCLE1BQU0sTUFBTSxHQUFrQixNQUFNLGNBQUksQ0FBQyxtQkFBbUIsQ0FBQztZQUMzRCxTQUFTLEVBQUUsQ0FBQyxrQ0FBZSxDQUFDO1NBQzdCLENBQUMsQ0FBQyxPQUFPLEVBQUUsQ0FBQztRQUViLE9BQU8sR0FBRyxNQUFNLENBQUMsR0FBRyxDQUFrQixrQ0FBZSxDQUFDLENBQUM7UUFFdkQsVUFBVTtRQUNWLElBQUksQ0FBQyxhQUFhLEVBQUUsQ0FBQztJQUN2QixDQUFDLENBQUMsQ0FBQztJQUVILEVBQUUsQ0FBQyxtQkFBbUIsRUFBRSxHQUFHLEVBQUU7UUFDM0Is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QUMsbUJBQW1CLENBQUMsQ0FBQztnQkFDcEUsS0FBSyxFQUFFLElBQUksQ0FBQyxFQUFFLEVBQUU7YUFDakIsQ0FBQztZQUNELHFCQUFRLENBQUMsTUFBb0IsQ0FBQyxpQkFBaUIsQ0FBQyxXQUFXLENBQUMsQ0FBQztZQUU5RCxNQUFNLE1BQU0sR0FBRyxNQUFNLE9BQU8sQ0FBQyxnQkFBZ0IsQ0FBQyxPQUFPLEVBQUUsWUFBWSxDQUFDLENBQUM7WUFFckUsTUFBTSxDQUFDLE1BQU0sQ0FBQyxDQUFDLFFBQVEsRUFBRSxDQUFDO1FBQzVCLENBQUMsQ0FBQyxDQUFDO0lBQ0wsQ0FBQyxDQUFDLENBQUM7QUFDTCxDQUFDLENBQUMsQ0FBQyIsIm5hbWVzIjpbXSwic291cmNlcyI6WyIvVXNlcnMvdHR0ZWxhL0RvY3VtZW50cy9Xb3JrL2Rlbm9mL3dvcmtzLzI1MDUyOXNva3VidXRzdS9kZXYyL3NyYy9mZWF0dXJlcy9zY3JhcGluZy9zY3JhcGluZy5zZXJ2aWNlLnNwZWMudHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgVGVzdCwgVGVzdGluZ01vZHVsZSB9IGZyb20gJ0BuZXN0anMvdGVzdGluZyc7XG5pbXBvcnQgeyBTY3JhcGluZ1NlcnZpY2UgfSBmcm9tICcuL3NjcmFwaW5nLnNlcnZpY2UnO1xuaW1wb3J0IGF4aW9zIGZyb20gJ2F4aW9zJztcbmltcG9ydCAqIGFzIGNoZWVyaW8gZnJvbSAnY2hlZXJpbyc7XG5pbXBvcnQgeyBKU0RPTSB9IGZyb20gJ2pzZG9tJztcbmltcG9ydCB7IGNocm9taXVtIH0gZnJvbSAncGxheXdyaWdodCc7XG5cbmplc3QubW9jaygnYXhpb3MnKTtcbmplc3QubW9jaygnY2hlZXJpbycpO1xuamVzdC5tb2NrKCdqc2RvbScpO1xuamVzdC5tb2NrKCdwbGF5d3JpZ2h0Jyk7XG5cbmRlc2NyaWJlKCdTY3JhcGluZ1NlcnZpY2UnLCAoKSA9PiB7XG4gIGxldCBzZXJ2aWNlOiBTY3JhcGluZ1NlcnZpY2U7XG4gIGNvbnN0IG1vY2tVcmwgPSAnaHR0cHM6Ly9leGFtcGxlLmNvbSc7XG4gIGNvbnN0IG1vY2tTZWxlY3RvciA9ICcjdGVzdC1zZWxlY3Rvcic7XG4gIGNvbnN0IG1vY2tDb250ZW50ID0gJzxkaXY+VGVzdCBDb250ZW50PC9kaXY+JztcbiAgY29uc3QgX21vY2tIYXNoID0gJ21vY2tlZC1oYXNoJztcblxuICBiZWZvcmVFYWNoKGFzeW5jICgpID0+IHtcbiAgICBjb25zdCBtb2R1bGU6IFRlc3RpbmdNb2R1bGUgPSBhd2FpdCBUZXN0LmNyZWF0ZVRlc3RpbmdNb2R1bGUoe1xuICAgICAgcHJvdmlkZXJzOiBbU2NyYXBpbmdTZXJ2aWNlXSxcbiAgICB9KS5jb21waWxlKCk7XG5cbiAgICBzZXJ2aWNlID0gbW9kdWxlLmdldDxTY3JhcGluZ1NlcnZpY2U+KFNjcmFwaW5nU2VydmljZSk7XG5cbiAgICAvLyDjgq/jg6rjg7zjg7PjgqLjg4Pjg5dcbiAgICBqZXN0LmNsZWFyQWxsTW9ja3MoKTtcbiAgfSk7XG5cbiAgaXQoJ3Nob3VsZCBiZSBkZWZpbmVkJywgKCkgPT4ge1xuICAgIGV4cGVjdChzZXJ2aWNlKS50b0JlRGVmaW5lZCgpO1xuICB9KTtcblxuICBkZXNjcmliZSgnc2NyYXBlQW5kR2V0SGFzaCcsICgpID0+IHtcbiAgICBpdCgnSFRUUCArIENoZWVyaW/jgafmiJDlip/jgZnjgovloLTlkIgnLCBhc3luYyAoKSA9PiB7XG4gICAgICAvLyBBeGlvc+OBruODouODg+OCr1xuICAgICAgKGF4aW9zLmdldCBhcyBqZXN0Lk1vY2spLm1vY2tSZXNvbHZlZFZhbHVlKHtcbiAgICAgICAgZGF0YTogJzxodG1sPjxib2R5PjxkaXYgaWQ9XCJ0ZXN0LXNlbGVjdG9yXCI+VGVzdCBDb250ZW50PC9kaXY+PC9ib2R5PjwvaHRtbD4nLFxuICAgICAgfSk7XG5cbiAgICAgIC8vIENoZWVyaW/jga7jg6Ljg4Pjgq9cbiAgICAgIGNvbnN0IG1vY2tFbGVtZW50ID0ge1xuICAgICAgICBodG1sOiBqZXN0LmZuKCkubW9ja1JldHVyblZhbHVlKG1vY2tDb250ZW50KSxcbiAgICAgICAgbGVuZ3RoOiAxLFxuICAgICAgfTtcbiAgICAgIGNvbnN0IG1vY2tDaGVlcmlvID0ge1xuICAgICAgICBsb2FkOiBqZXN0LmZuKCkubW9ja1JldHVyblZhbHVlKGplc3QuZm4oKS5tb2NrUmV0dXJuVmFsdWUobW9ja0VsZW1lbnQpKSxcbiAgICAgIH07XG4gICAgICAoY2hlZXJpbyBhcyBhbnkpLmxvYWQgPSBtb2NrQ2hlZXJpby5sb2FkO1xuXG4gICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBzZXJ2aWNlLnNjcmFwZUFuZEdldEhhc2gobW9ja1VybCwgbW9ja1NlbGVjdG9yKTtcblxuICAgICAgZXhwZWN0KHJlc3VsdCkudG9CZURlZmluZWQoKTtcbiAgICAgIGV4cGVjdChheGlvcy5nZXQpLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKFxuICAgICAgICBtb2NrVXJsLFxuICAgICAgICBleHBlY3Qub2JqZWN0Q29udGFpbmluZyh7XG4gICAgICAgICAgaGVhZGVyczogZXhwZWN0Lm9iamVjdENvbnRhaW5pbmcoe1xuICAgICAgICAgICAgJ1VzZXItQWdlbnQnOiBleHBlY3QuYW55KFN0cmluZyksXG4gICAgICAgICAgfSksXG4gICAgICAgIH0pLFxuICAgICAgKTtcbiAgICB9KTtcblxuICAgIGl0KCdIVFRQ5aSx5pWX5pmC44GvSlNET03jgavjg5Xjgqnjg7zjg6vjg5Djg4Pjgq8nLCBhc3luYyAoKSA9PiB7XG4gICAgICAvLyBBeGlvc+OCkuWkseaVl+OBleOBm+OCi1xuICAgICAgKGF4aW9zLmdldCBhcyBqZXN0Lk1vY2spLm1vY2tSZWplY3RlZFZhbHVlKG5ldyBFcnJvcignTmV0d29yayBlcnJvcicpKTtcblxuICAgICAgLy8gSlNET03jga7jg6Ljg4Pjgq9cbiAgICAgIGNvbnN0IG1vY2tFbGVtZW50ID0geyBpbm5lckhUTUw6IG1vY2tDb250ZW50IH07XG4gICAgICBjb25zdCBtb2NrRG9jdW1lbnQgPSB7XG4gICAgICAgIHF1ZXJ5U2VsZWN0b3I6IGplc3QuZm4oKS5tb2NrUmV0dXJuVmFsdWUobW9ja0VsZW1lbnQpLFxuICAgICAgfTtcbiAgICAgIGNvbnN0IG1vY2tXaW5kb3cgPSB7IGRvY3VtZW50OiBtb2NrRG9jdW1lbnQsIGNsb3NlOiBqZXN0LmZuKCkgfTtcbiAgICAgIChKU0RPTS5mcm9tVVJMIGFzIGplc3QuTW9jaykubW9ja1Jlc29sdmVkVmFsdWUoeyB3aW5kb3c6IG1vY2tXaW5kb3cgfSk7XG5cbiAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IHNlcnZpY2Uuc2NyYXBlQW5kR2V0SGFzaChtb2NrVXJsLCBtb2NrU2VsZWN0b3IpO1xuXG4gICAgICBleHBlY3QocmVzdWx0KS50b0JlRGVmaW5lZCgpO1xuICAgICAgZXhwZWN0KEpTRE9NLmZyb21VUkwpLnRvSGF2ZUJlZW5DYWxsZWQoKTtcbiAgICB9KTtcblxuICAgIGl0KCfjgZnjgbnjgabjga7miYvms5XjgYzlpLHmlZfjgZfjgZ/loLTlkIjjga9udWxs44KS6L+U44GZJywgYXN5bmMgKCkgPT4ge1xuICAgICAgLy8g44GZ44G544Gm5aSx5pWX44GV44Gb44KLXG4gICAgICAoYXhpb3MuZ2V0IGFzIGplc3QuTW9jaykubW9ja1JlamVjdGVkVmFsdWUobmV3IEVycm9yKCdIVFRQIGZhaWxlZCcpKTtcbiAgICAgIChKU0RPTS5mcm9tVVJMIGFzIGplc3QuTW9jaykubW9ja1JlamVjdGVkVmFsdWUobmV3IEVycm9yKCdKU0RPTSBmYWlsZWQnKSk7XG5cbiAgICAgIGNvbnN0IG1vY2tCcm93c2VyID0ge1xuICAgICAgICBuZXdQYWdlOiBqZXN0LmZuKCkubW9ja1JlamVjdGVkVmFsdWUobmV3IEVycm9yKCdQbGF5d3JpZ2h0IGZhaWxlZCcpKSxcbiAgICAgICAgY2xvc2U6IGplc3QuZm4oKSxcbiAgICAgIH07XG4gICAgICAoY2hyb21pdW0ubGF1bmNoIGFzIGplc3QuTW9jaykubW9ja1Jlc29sdmVkVmFsdWUobW9ja0Jyb3dzZXIpO1xuXG4gICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBzZXJ2aWNlLnNjcmFwZUFuZEdldEhhc2gobW9ja1VybCwgbW9ja1NlbGVjdG9yKTtcblxuICAgICAgZXhwZWN0KHJlc3VsdCkudG9CZU51bGwoKTtcbiAgICB9KTtcbiAgfSk7XG59KTtcbiJdLCJ2ZXJzaW9uIjozfQ==