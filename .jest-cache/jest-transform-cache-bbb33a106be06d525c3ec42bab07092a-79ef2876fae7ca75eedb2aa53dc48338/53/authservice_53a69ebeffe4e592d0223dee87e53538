90081102190c8df258493fe92d40fb3f
"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
var AuthService_1;
Object.defineProperty(exports, "__esModule", { value: true });
exports.AuthService = void 0;
const common_1 = require("@nestjs/common");
const users_service_1 = require("../../domain/users/users.service");
const exceptions_1 = require("../../common/exceptions");
let AuthService = AuthService_1 = class AuthService {
    usersService;
    logger = new common_1.Logger(AuthService_1.name);
    constructor(usersService) {
        this.usersService = usersService;
    }
    /**
     * Telegram„É¶„Éº„Ç∂„Éº„ÅÆË™çË®º„ÉªÁôªÈå≤Âá¶ÁêÜ
     */
    async authenticateTelegramUser(telegramUser) {
        try {
            // ÂÖ•ÂäõÊ§úË®º
            this.validateTelegramUser(telegramUser);
            const telegramId = telegramUser.id.toString();
            // Êó¢Â≠ò„É¶„Éº„Ç∂„Éº„ÉÅ„Çß„ÉÉ„ÇØ
            let user = await this.usersService.findByTelegramId(telegramId);
            if (user) {
                // Êó¢Â≠ò„É¶„Éº„Ç∂„Éº„ÅÆÂ†¥Âêà„ÄÅÊúÄÁµÇ„Ç¢„ÇØ„ÉÜ„Ç£„ÉñÊôÇÂàª„Å®ÊÉÖÂ†±„ÇíÊõ¥Êñ∞
                this.logger.debug(`Existing user found: ${telegramId}`);
                const updateData = {
                    lastActiveAt: new Date(),
                    username: telegramUser.username,
                    firstName: telegramUser.first_name,
                    lastName: telegramUser.last_name,
                    languageCode: telegramUser.language_code,
                };
                // „Ç¢„ÇØ„ÉÜ„Ç£„Éñ„Åß„Å™„ÅÑ„É¶„Éº„Ç∂„Éº„ÅØÂÜçÊúâÂäπÂåñ
                if (!user.isActive) {
                    updateData.isActive = true;
                    this.logger.log(`Reactivating user: ${telegramId}`);
                }
                user = await this.usersService.update(telegramId, updateData);
            }
            else {
                // Êñ∞Ë¶è„É¶„Éº„Ç∂„Éº‰ΩúÊàê
                this.logger.log(`Creating new user: ${telegramId}`);
                const defaultSettings = {
                    notifications: {
                        enabled: true,
                        silent: false,
                    },
                    language: telegramUser.language_code || 'ja',
                };
                const createUserDto = {
                    telegramId,
                    username: telegramUser.username,
                    firstName: telegramUser.first_name,
                    lastName: telegramUser.last_name,
                    languageCode: telegramUser.language_code,
                    isActive: true,
                    settings: defaultSettings,
                };
                user = await this.usersService.create(createUserDto);
            }
            return user;
        }
        catch (error) {
            this.logger.error(`Authentication failed for Telegram user ${String(telegramUser.id)}: ${error instanceof Error ? error.message : String(error)}`, error instanceof Error ? error.stack : undefined);
            if (error instanceof exceptions_1.InvalidTelegramDataException ||
                error instanceof exceptions_1.UserRegistrationException) {
                throw error;
            }
            throw new exceptions_1.TelegramAuthException('Authentication failed');
        }
    }
    /**
     * /start„Ç≥„Éû„É≥„ÉâÂá¶ÁêÜ
     */
    async handleStartCommand(telegramUser) {
        try {
            const telegramId = telegramUser.id.toString();
            const existingUser = await this.usersService.exists(telegramId);
            // „É¶„Éº„Ç∂„ÉºË™çË®º„ÉªÁôªÈå≤
            const user = await this.authenticateTelegramUser(telegramUser);
            // „Ç¶„Çß„É´„Ç´„É†„É°„ÉÉ„Çª„Éº„Ç∏ÁîüÊàê
            const welcomeMessage = this.generateWelcomeMessage(user, !existingUser);
            return {
                user,
                isNewUser: !existingUser,
                welcomeMessage,
            };
        }
        catch (error) {
            this.logger.error(`Start command failed for user ${String(telegramUser.id)}: ${error instanceof Error ? error.message : String(error)}`, error instanceof Error ? error.stack : undefined);
            throw error;
        }
    }
    /**
     * „Ç¶„Çß„É´„Ç´„É†„É°„ÉÉ„Çª„Éº„Ç∏ÁîüÊàê
     */
    generateWelcomeMessage(user, isNewUser) {
        const greeting = isNewUser ? '„ÅØ„Åò„ÇÅ„Åæ„Åó„Å¶' : '„Åä„Åã„Åà„Çä„Å™„Åï„ÅÑ';
        const message = `
${greeting}„ÄÅ${user.fullName}„Åï„ÇìÔºÅüè†

${isNewUser ? '„ÇΩ„ÇØ„Éñ„ÉÑ„Å∏„Çà„ÅÜ„Åì„ÅùÔºÅ' : '„Åæ„Åü„Åä‰ºö„ÅÑ„Åß„Åç„Å¶Â¨â„Åó„ÅÑ„Åß„ÅôÔºÅ'}

üìã ‰ΩøÁî®ÂèØËÉΩ„Å™„Ç≥„Éû„É≥„Éâ:
/add <URL> - Áõ£Ë¶ñURL„ÇíËøΩÂä†
/list - ÁôªÈå≤URL‰∏ÄË¶ß„ÇíË°®Á§∫
/remove <Áï™Âè∑> - URL„ÇíÂâäÈô§
/pause <Áï™Âè∑> - Áõ£Ë¶ñ„Çí‰∏ÄÊôÇÂÅúÊ≠¢
/resume <Áï™Âè∑> - Áõ£Ë¶ñ„ÇíÂÜçÈñã
/status - Áõ£Ë¶ñÁä∂Ê≥Å„ÇíÁ¢∫Ë™ç
/help - „Éò„É´„Éó„ÇíË°®Á§∫

„Åæ„Åö„ÅØ /add „Ç≥„Éû„É≥„Éâ„ÅßÁõ£Ë¶ñ„Åó„Åü„ÅÑÁâ©‰ª∂URL„ÇíÁôªÈå≤„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºÅ
    `.trim();
        return message;
    }
    /**
     * Telegram„É¶„Éº„Ç∂„Éº„Éá„Éº„Çø„ÅÆÊ§úË®º
     */
    validateTelegramUser(telegramUser) {
        if (!telegramUser.id) {
            throw new exceptions_1.InvalidTelegramDataException('Telegram user ID is required');
        }
        if (!telegramUser.first_name ||
            telegramUser.first_name.trim().length === 0) {
            throw new exceptions_1.InvalidTelegramDataException('Telegram user first name is required');
        }
        // ÂêçÂâç„ÅÆÈï∑„ÅïÂà∂Èôê
        if (telegramUser.first_name.length > 255) {
            throw new exceptions_1.InvalidTelegramDataException('First name is too long');
        }
        if (telegramUser.last_name && telegramUser.last_name.length > 255) {
            throw new exceptions_1.InvalidTelegramDataException('Last name is too long');
        }
        if (telegramUser.username && telegramUser.username.length > 255) {
            throw new exceptions_1.InvalidTelegramDataException('Username is too long');
        }
    }
    /**
     * „É¶„Éº„Ç∂„Éº„Åå„Ç¢„ÇØ„ÉÜ„Ç£„Éñ„Åã„ÉÅ„Çß„ÉÉ„ÇØ
     */
    async validateUser(telegramId) {
        try {
            const user = await this.usersService.findByTelegramId(telegramId);
            return user?.isActive ?? false;
        }
        catch (error) {
            this.logger.error(`User validation failed for ${telegramId}: ${error instanceof Error ? error.message : String(error)}`);
            return false;
        }
    }
    /**
     * „É¶„Éº„Ç∂„ÉºÊÉÖÂ†±„ÇíÂèñÂæóÔºàË™çË®ºÊ∏à„ÅøÂâçÊèêÔºâ
     */
    async getUser(telegramId) {
        try {
            return await this.usersService.findByTelegramId(telegramId);
        }
        catch (error) {
            this.logger.error(`Failed to get user ${telegramId}: ${error instanceof Error ? error.message : String(error)}`);
            return null;
        }
    }
};
exports.AuthService = AuthService;
exports.AuthService = AuthService = AuthService_1 = __decorate([
    (0, common_1.Injectable)(),
    __metadata("design:paramtypes", [users_service_1.UsersService])
], AuthService);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL3R0dGVsYS9Eb2N1bWVudHMvV29yay9kZW5vZi93b3Jrcy8yNTA1Mjlzb2t1YnV0c3UvZGV2Mi9zcmMvY29yZS9hdXRoL2F1dGguc2VydmljZS50cyIsIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7O0FBQUEsMkNBQW9EO0FBQ3BELG9FQUFnRTtBQUloRSx3REFJaUM7QUFHMUIsSUFBTSxXQUFXLG1CQUFqQixNQUFNLFdBQVc7SUFHTztJQUZaLE1BQU0sR0FBRyxJQUFJLGVBQU0sQ0FBQyxhQUFXLENBQUMsSUFBSSxDQUFDLENBQUM7SUFFdkQsWUFBNkIsWUFBMEI7UUFBMUIsaUJBQVksR0FBWixZQUFZLENBQWM7SUFBRyxDQUFDO0lBRTNEOztPQUVHO0lBQ0gsS0FBSyxDQUFDLHdCQUF3QixDQUFDLFlBQTBCO1FBQ3ZELElBQUksQ0FBQztZQUNILE9BQU87WUFDUCxJQUFJLENBQUMsb0JBQW9CLENBQUMsWUFBWSxDQUFDLENBQUM7WUFFeEMsTUFBTSxVQUFVLEdBQUcsWUFBWSxDQUFDLEVBQUUsQ0FBQyxRQUFRLEVBQUUsQ0FBQztZQUU5QyxhQUFhO1lBQ2IsSUFBSSxJQUFJLEdBQUcsTUFBTSxJQUFJLENBQUMsWUFBWSxDQUFDLGdCQUFnQixDQUFDLFVBQVUsQ0FBQyxDQUFDO1lBRWhFLElBQUksSUFBSSxFQUFFLENBQUM7Z0JBQ1QsNEJBQTRCO2dCQUM1QixJQUFJLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyx3QkFBd0IsVUFBVSxFQUFFLENBQUMsQ0FBQztnQkFFeEQsTUFBTSxVQUFVLEdBQW1CO29CQUNqQyxZQUFZLEVBQUUsSUFBSSxJQUFJLEVBQUU7b0JBQ3hCLFFBQVEsRUFBRSxZQUFZLENBQUMsUUFBUTtvQkFDL0IsU0FBUyxFQUFFLFlBQVksQ0FBQyxVQUFVO29CQUNsQyxRQUFRLEVBQUUsWUFBWSxDQUFDLFNBQVM7b0JBQ2hDLFlBQVksRUFBRSxZQUFZLENBQUMsYUFBYTtpQkFDekMsQ0FBQztnQkFFRixvQkFBb0I7Z0JBQ3BCLElBQUksQ0FBQyxJQUFJLENB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SUFBSSxDQUFDO1FBQ2QsQ0FBQztJQUNILENBQUM7Q0FDRixDQUFBO0FBck1ZLGtDQUFXO3NCQUFYLFdBQVc7SUFEdkIsSUFBQSxtQkFBVSxHQUFFO3FDQUlnQyw0QkFBWTtHQUg1QyxXQUFXLENBcU12QiIsIm5hbWVzIjpbXSwic291cmNlcyI6WyIvVXNlcnMvdHR0ZWxhL0RvY3VtZW50cy9Xb3JrL2Rlbm9mL3dvcmtzLzI1MDUyOXNva3VidXRzdS9kZXYyL3NyYy9jb3JlL2F1dGgvYXV0aC5zZXJ2aWNlLnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdGFibGUsIExvZ2dlciB9IGZyb20gJ0BuZXN0anMvY29tbW9uJztcbmltcG9ydCB7IFVzZXJzU2VydmljZSB9IGZyb20gJy4uLy4uL2RvbWFpbi91c2Vycy91c2Vycy5zZXJ2aWNlJztcbmltcG9ydCB7IFVzZXIsIFVzZXJTZXR0aW5ncyB9IGZyb20gJy4uLy4uL2RvbWFpbi91c2Vycy9lbnRpdGllcy91c2VyLmVudGl0eSc7XG5pbXBvcnQgeyBUZWxlZ3JhbVVzZXIsIFVzZXJVcGRhdGVEYXRhIH0gZnJvbSAnLi4vLi4vY29tbW9uL2ludGVyZmFjZXMnO1xuaW1wb3J0IHsgQ3JlYXRlVXNlckR0byB9IGZyb20gJy4uLy4uL2RvbWFpbi91c2Vycy9kdG8vY3JlYXRlLXVzZXIuZHRvJztcbmltcG9ydCB7XG4gIFRlbGVncmFtQXV0aEV4Y2VwdGlvbixcbiAgVXNlclJlZ2lzdHJhdGlvbkV4Y2VwdGlvbixcbiAgSW52YWxpZFRlbGVncmFtRGF0YUV4Y2VwdGlvbixcbn0gZnJvbSAnLi4vLi4vY29tbW9uL2V4Y2VwdGlvbnMnO1xuXG5ASW5qZWN0YWJsZSgpXG5leHBvcnQgY2xhc3MgQXV0aFNlcnZpY2Uge1xuICBwcml2YXRlIHJlYWRvbmx5IGxvZ2dlciA9IG5ldyBMb2dnZXIoQXV0aFNlcnZpY2UubmFtZSk7XG5cbiAgY29uc3RydWN0b3IocHJpdmF0ZSByZWFkb25seSB1c2Vyc1NlcnZpY2U6IFVzZXJzU2VydmljZSkge31cblxuICAvKipcbiAgICogVGVsZWdyYW3jg6bjg7zjgrbjg7zjga7oqo3oqLzjg7vnmbvpjLLlh6bnkIZcbiAgICovXG4gIGFzeW5jIGF1dGhlbnRpY2F0ZVRlbGVncmFtVXNlcih0ZWxlZ3JhbVVzZXI6IFRlbGVncmFtVXNlcik6IFByb21pc2U8VXNlcj4ge1xuICAgIHRyeSB7XG4gICAgICAvLyDlhaXlipvmpJzoqLxcbiAgICAgIHRoaXMudmFsaWRhdGVUZWxlZ3JhbVVzZXIodGVsZWdyYW1Vc2VyKTtcblxuICAgICAgY29uc3QgdGVsZWdyYW1JZCA9IHRlbGVncmFtVXNlci5pZC50b1N0cmluZygpO1xuXG4gICAgICAvLyDml6LlrZjjg6bjg7zjgrbjg7zjg4Hjgqfjg4Pjgq9cbiAgICAgIGxldCB1c2VyID0gYXdhaXQgdGhpcy51c2Vyc1NlcnZpY2UuZmluZEJ5VGVsZWdyYW1JZCh0ZWxlZ3JhbUlkKTtcblxuICAgICAgaWYgKHVzZXIpIHtcbiAgICAgICAgLy8g5pei5a2Y44Om44O844K244O844Gu5aC05ZCI44CB5pyA57WC44Ki44Kv44OG44Kj44OW5pmC5Yi744Go5oOF5aCx44KS5pu05pawXG4gICAgICAgIHRoaXMubG9nZ2VyLmRlYnVnKGBFeGlzdGluZyB1c2VyIGZvdW5kOiAke3RlbGVncmFtSWR9YCk7XG5cbiAgICAgICAgY29uc3QgdXBkYXRlRGF0YTogVXNlclVwZGF0ZURhdGEgPSB7XG4gICAgICAgICAgbGFzdEFjdGl2ZUF0OiBuZXcgRGF0ZSgpLFxuICAgICAgICAgIHVzZXJuYW1lOiB0ZWxlZ3JhbVVzZXIudXNlcm5hbWUsXG4gICAgICAgICAgZmlyc3ROYW1lOiB0ZWxlZ3JhbVVzZXIuZmlyc3RfbmFtZSxcbiAgICAgICAgICBsYXN0TmFtZTogdGVsZWdyYW1Vc2VyLmxhc3RfbmFtZSxcbiAgICAgICAgICBsYW5ndWFnZUNvZGU6IHRlbGVncmFtVXNlci5sYW5ndWFnZV9jb2RlLFxuICAgICAgICB9O1xuXG4gICAgICAgIC8vIOOCouOCr+ODhuOCo+ODluOBp+OBquOBhOODpuODvOOCtuODvOOBr+WGjeacieWKueWMllxuICAgICAgICBpZiAoIXVzZXIuaXNBY3RpdmUpIHtcbiAgICAgICAgICB1cGRhdGVEYXRhLmlzQWN0aXZlID0gdHJ1ZTtcbiAgICAgICAgICB0aGlzLmxvZ2dlci5sb2coYFJlYWN0aXZhdGluZyB1c2VyOiAke3RlbGVncmFtSWR9YCk7XG4gICAgICAgIH1cblxuICAgICAgICB1c2VyID0gYXdhaXQgdGhpcy51c2Vyc1NlcnZpY2UudXBkYXRlKHRlbGVncmFtSWQsIHVwZGF0ZURhdGEpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgLy8g5paw6KaP44Om44O844K244O85L2c5oiQXG4gICAgICAgIHRoaXMubG9nZ2VyLmxvZyhgQ3JlYXRpbmcgbmV3IHVzZXI6ICR7dGVsZWdyYW1JZH1gKTtcblxuICAgICAgICBjb25zdCBkZWZhdWx0U2V0dGluZ3M6IFVzZXJTZXR0aW5ncyA9IHtcbiAgICAgICAgICBub3RpZmljYXRpb25zOiB7XG4gICAgICAgICAgICBlbmFibGVkOiB0cnVlLFxuICAgICAgICAgICAgc2lsZW50OiBmYWxzZSxcbiAgICAgICAgICB9LFxuICAgICAgICAgIGxhbmd1YWdlOiB0ZWxlZ3JhbVVzZXIubGFuZ3VhZ2VfY29kZSB8fCAnamEnLFxuICAgICAgICB9O1xuXG4gICAgICAgIGNvbnN0IGNyZWF0ZVVzZXJEdG86IENyZWF0ZVVzZXJEdG8gPSB7XG4gICAgICAgICAgdGVsZWdyYW1JZCxcbiAgICAgICAgICB1c2VybmFtZTogdGVsZWdyYW1Vc2VyLnVzZXJuYW1lLFxuICAgICAgICAgIGZpcnN0TmFtZTogdGVsZWdyYW1Vc2VyLmZpcnN0X25hbWUsXG4gICAgICAgICAgbGFzdE5hbWU6IHRlbGVncmFtVXNlci5sYXN0X25hbWUsXG4gICAgICAgICAgbGFuZ3VhZ2VDb2RlOiB0ZWxlZ3JhbVVzZXIubGFuZ3VhZ2VfY29kZSxcbiAgICAgICAgICBpc0FjdGl2ZTogdHJ1ZSxcbiAgICAgICAgICBzZXR0aW5nczogZGVmYXVsdFNldHRpbmdzLFxuICAgICAgICB9O1xuXG4gICAgICAgIHVzZXIgPSBhd2FpdCB0aGlzLnVzZXJzU2VydmljZS5jcmVhdGUoY3JlYXRlVXNlckR0byk7XG4gICAgICB9XG5cbiAgICAgIHJldHVybiB1c2VyO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICB0aGlzLmxvZ2dlci5lcnJvcihcbiAgICAgICAgYEF1dGhlbnRpY2F0aW9uIGZhaWxlZCBmb3IgVGVsZWdyYW0gdXNlciAke1N0cmluZyh0ZWxlZ3JhbVVzZXIuaWQpfTogJHtlcnJvciBpbnN0YW5jZW9mIEVycm9yID8gZXJyb3IubWVzc2FnZSA6IFN0cmluZyhlcnJvcil9YCxcbiAgICAgICAgZXJyb3IgaW5zdGFuY2VvZiBFcnJvciA/IGVycm9yLnN0YWNrIDogdW5kZWZpbmVkLFxuICAgICAgKTtcblxuICAgICAgaWYgKFxuICAgICAgICBlcnJvciBpbnN0YW5jZW9mIEludmFsaWRUZWxlZ3JhbURhdGFFeGNlcHRpb24gfHxcbiAgICAgICAgZXJyb3IgaW5zdGFuY2VvZiBVc2VyUmVnaXN0cmF0aW9uRXhjZXB0aW9uXG4gICAgICApIHtcbiAgICAgICAgdGhyb3cgZXJyb3I7XG4gICAgICB9XG5cbiAgICAgIHRocm93IG5ldyBUZWxlZ3JhbUF1dGhFeGNlcHRpb24oJ0F1dGhlbnRpY2F0aW9uIGZhaWxlZCcpO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiAvc3RhcnTjgrPjg57jg7Pjg4nlh6bnkIZcbiAgICovXG4gIGFzeW5jIGhhbmRsZVN0YXJ0Q29tbWFuZCh0ZWxlZ3JhbVVzZXI6IFRlbGVncmFtVXNlcik6IFByb21pc2U8e1xuICAgIHVzZXI6IFVzZXI7XG4gICAgaXNOZXdVc2VyOiBib29sZWFuO1xuICAgIHdlbGNvbWVNZXNzYWdlOiBzdHJpbmc7XG4gIH0+IHtcbiAgICB0cnkge1xuICAgICAgY29uc3QgdGVsZWdyYW1JZCA9IHRlbGVncmFtVXNlci5pZC50b1N0cmluZygpO1xuICAgICAgY29uc3QgZXhpc3RpbmdVc2VyID0gYXdhaXQgdGhpcy51c2Vyc1NlcnZpY2UuZXhpc3RzKHRlbGVncmFtSWQpO1xuXG4gICAgICAvLyDjg6bjg7zjgrbjg7zoqo3oqLzjg7vnmbvpjLJcbiAgICAgIGNvbnN0IHVzZXIgPSBhd2FpdCB0aGlzLmF1dGhlbnRpY2F0ZVRlbGVncmFtVXNlcih0ZWxlZ3JhbVVzZXIpO1xuXG4gICAgICAvLyDjgqbjgqfjg6vjgqvjg6Djg6Hjg4Pjgrvjg7zjgrjnlJ/miJBcbiAgICAgIGNvbnN0IHdlbGNvbWVNZXNzYWdlID0gdGhpcy5nZW5lcmF0ZVdlbGNvbWVNZXNzYWdlKHVzZXIsICFleGlzdGluZ1VzZXIpO1xuXG4gICAgICByZXR1cm4ge1xuICAgICAgICB1c2VyLFxuICAgICAgICBpc05ld1VzZXI6ICFleGlzdGluZ1VzZXIsXG4gICAgICAgIHdlbGNvbWVNZXNzYWdlLFxuICAgICAgfTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgdGhpcy5sb2dnZXIuZXJyb3IoXG4gICAgICAgIGBTdGFydCBjb21tYW5kIGZhaWxlZCBmb3IgdXNlciAke1N0cmluZyh0ZWxlZ3JhbVVzZXIuaWQpfTogJHtlcnJvciBpbnN0YW5jZW9mIEVycm9yID8gZXJyb3IubWVzc2FnZSA6IFN0cmluZyhlcnJvcil9YCxcbiAgICAgICAgZXJyb3IgaW5zdGFuY2VvZiBFcnJvciA/IGVycm9yLnN0YWNrIDogdW5kZWZpbmVkLFxuICAgICAgKTtcbiAgICAgIHRocm93IGVycm9yO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiDjgqbjgqfjg6vjgqvjg6Djg6Hjg4Pjgrvjg7zjgrjnlJ/miJBcbiAgICovXG4gIHByaXZhdGUgZ2VuZXJhdGVXZWxjb21lTWVzc2FnZSh1c2VyOiBVc2VyLCBpc05ld1VzZXI6IGJvb2xlYW4pOiBzdHJpbmcge1xuICAgIGNvbnN0IGdyZWV0aW5nID0gaXNOZXdVc2VyID8gJ+OBr+OBmOOCgeOBvuOBl+OBpicgOiAn44GK44GL44GI44KK44Gq44GV44GEJztcblxuICAgIGNvbnN0IG1lc3NhZ2UgPSBgXG4ke2dyZWV0aW5nfeOAgSR7dXNlci5mdWxsTmFtZX3jgZXjgpPvvIHwn4+gXG5cbiR7aXNOZXdVc2VyID8gJ+OCveOCr+ODluODhOOBuOOCiOOBhuOBk+OBne+8gScgOiAn44G+44Gf44GK5Lya44GE44Gn44GN44Gm5ayJ44GX44GE44Gn44GZ77yBJ31cblxu8J+TiyDkvb/nlKjlj6/og73jgarjgrPjg57jg7Pjg4k6XG4vYWRkIDxVUkw+IC0g55uj6KaWVVJM44KS6L+95YqgXG4vbGlzdCAtIOeZu+mMslVSTOS4gOimp+OCkuihqOekulxuL3JlbW92ZSA855Wq5Y+3PiAtIFVSTOOCkuWJiumZpFxuL3BhdXNlIDznlarlj7c+IC0g55uj6KaW44KS5LiA5pmC5YGc5q2iXG4vcmVzdW1lIDznlarlj7c+IC0g55uj6KaW44KS5YaN6ZaLXG4vc3RhdHVzIC0g55uj6KaW54q25rOB44KS56K66KqNXG4vaGVscCAtIOODmOODq+ODl+OCkuihqOekulxuXG7jgb7jgZrjga8gL2FkZCDjgrPjg57jg7Pjg4njgafnm6PoppbjgZfjgZ/jgYTnianku7ZVUkzjgpLnmbvpjLLjgZfjgabjgY/jgaDjgZXjgYTvvIFcbiAgICBgLnRyaW0oKTtcblxuICAgIHJldHVybiBtZXNzYWdlO1xuICB9XG5cbiAgLyoqXG4gICAqIFRlbGVncmFt44Om44O844K244O844OH44O844K/44Gu5qSc6Ki8XG4gICAqL1xuICBwcml2YXRlIHZhbGlkYXRlVGVsZWdyYW1Vc2VyKHRlbGVncmFtVXNlcjogVGVsZWdyYW1Vc2VyKTogdm9pZCB7XG4gICAgaWYgKCF0ZWxlZ3JhbVVzZXIuaWQpIHtcbiAgICAgIHRocm93IG5ldyBJbnZhbGlkVGVsZWdyYW1EYXRhRXhjZXB0aW9uKCdUZWxlZ3JhbSB1c2VyIElEIGlzIHJlcXVpcmVkJyk7XG4gICAgfVxuXG4gICAgaWYgKFxuICAgICAgIXRlbGVncmFtVXNlci5maXJzdF9uYW1lIHx8XG4gICAgICB0ZWxlZ3JhbVVzZXIuZmlyc3RfbmFtZS50cmltKCkubGVuZ3RoID09PSAwXG4gICAgKSB7XG4gICAgICB0aHJvdyBuZXcgSW52YWxpZFRlbGVncmFtRGF0YUV4Y2VwdGlvbihcbiAgICAgICAgJ1RlbGVncmFtIHVzZXIgZmlyc3QgbmFtZSBpcyByZXF1aXJlZCcsXG4gICAgICApO1xuICAgIH1cblxuICAgIC8vIOWQjeWJjeOBrumVt+OBleWItumZkFxuICAgIGlmICh0ZWxlZ3JhbVVzZXIuZmlyc3RfbmFtZS5sZW5ndGggPiAyNTUpIHtcbiAgICAgIHRocm93IG5ldyBJbnZhbGlkVGVsZWdyYW1EYXRhRXhjZXB0aW9uKCdGaXJzdCBuYW1lIGlzIHRvbyBsb25nJyk7XG4gICAgfVxuXG4gICAgaWYgKHRlbGVncmFtVXNlci5sYXN0X25hbWUgJiYgdGVsZWdyYW1Vc2VyLmxhc3RfbmFtZS5sZW5ndGggPiAyNTUpIHtcbiAgICAgIHRocm93IG5ldyBJbnZhbGlkVGVsZWdyYW1EYXRhRXhjZXB0aW9uKCdMYXN0IG5hbWUgaXMgdG9vIGxvbmcnKTtcbiAgICB9XG5cbiAgICBpZiAodGVsZWdyYW1Vc2VyLnVzZXJuYW1lICYmIHRlbGVncmFtVXNlci51c2VybmFtZS5sZW5ndGggPiAyNTUpIHtcbiAgICAgIHRocm93IG5ldyBJbnZhbGlkVGVsZWdyYW1EYXRhRXhjZXB0aW9uKCdVc2VybmFtZSBpcyB0b28gbG9uZycpO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiDjg6bjg7zjgrbjg7zjgYzjgqLjgq/jg4bjgqPjg5bjgYvjg4Hjgqfjg4Pjgq9cbiAgICovXG4gIGFzeW5jIHZhbGlkYXRlVXNlcih0ZWxlZ3JhbUlkOiBzdHJpbmcpOiBQcm9taXNlPGJvb2xlYW4+IHtcbiAgICB0cnkge1xuICAgICAgY29uc3QgdXNlciA9IGF3YWl0IHRoaXMudXNlcnNTZXJ2aWNlLmZpbmRCeVRlbGVncmFtSWQodGVsZWdyYW1JZCk7XG4gICAgICByZXR1cm4gdXNlcj8uaXNBY3RpdmUgPz8gZmFsc2U7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIHRoaXMubG9nZ2VyLmVycm9yKFxuICAgICAgICBgVXNlciB2YWxpZGF0aW9uIGZhaWxlZCBmb3IgJHt0ZWxlZ3JhbUlkfTogJHtlcnJvciBpbnN0YW5jZW9mIEVycm9yID8gZXJyb3IubWVzc2FnZSA6IFN0cmluZyhlcnJvcil9YCxcbiAgICAgICk7XG4gICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIOODpuODvOOCtuODvOaDheWgseOCkuWPluW+l++8iOiqjeiovOa4iOOBv+WJjeaPkO+8iVxuICAgKi9cbiAgYXN5bmMgZ2V0VXNlcih0ZWxlZ3JhbUlkOiBzdHJpbmcpOiBQcm9taXNlPFVzZXIgfCBudWxsPiB7XG4gICAgdHJ5IHtcbiAgICAgIHJldHVybiBhd2FpdCB0aGlzLnVzZXJzU2VydmljZS5maW5kQnlUZWxlZ3JhbUlkKHRlbGVncmFtSWQpO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICB0aGlzLmxvZ2dlci5lcnJvcihcbiAgICAgICAgYEZhaWxlZCB0byBnZXQgdXNlciAke3RlbGVncmFtSWR9OiAke2Vycm9yIGluc3RhbmNlb2YgRXJyb3IgPyBlcnJvci5tZXNzYWdlIDogU3RyaW5nKGVycm9yKX1gLFxuICAgICAgKTtcbiAgICAgIHJldHVybiBudWxsO1xuICAgIH1cbiAgfVxufVxuIl0sInZlcnNpb24iOjN9