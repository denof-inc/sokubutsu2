ec32299e03396835d76430e3cf1e589f
"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
var TelegramService_1;
Object.defineProperty(exports, "__esModule", { value: true });
exports.TelegramService = void 0;
const common_1 = require("@nestjs/common");
const config_1 = require("@nestjs/config");
const axios_1 = __importDefault(require("axios"));
let TelegramService = TelegramService_1 = class TelegramService {
    configService;
    logger = new common_1.Logger(TelegramService_1.name);
    botToken;
    apiUrl;
    constructor(configService) {
        this.configService = configService;
        this.botToken = this.configService.get('TELEGRAM_BOT_TOKEN', '');
        this.apiUrl = `https://api.telegram.org/bot${this.botToken}`;
    }
    /**
     * Telegramメッセージ送信
     */
    async sendMessage(chatId, text, options) {
        try {
            const response = await axios_1.default.post(`${this.apiUrl}/sendMessage`, {
                chat_id: chatId,
                text,
                ...options,
            });
            if (!response.data.ok) {
                throw new Error(`Telegram API error: ${String(response.data.description)}`);
            }
            this.logger.debug(`Message sent to ${String(chatId)}`);
        }
        catch (error) {
            this.logger.error(`Failed to send message to ${String(chatId)}:`, error);
            throw error;
        }
    }
    /**
     * 写真付きメッセージ送信（物件情報通知用）
     */
    async sendPhoto(chatId, photo, caption, options) {
        try {
            const response = await axios_1.default.post(`${this.apiUrl}/sendPhoto`, {
                chat_id: chatId,
                photo,
                caption,
                ...options,
            });
            if (!response.data.ok) {
                throw new Error(`Telegram API error: ${String(response.data.description)}`);
            }
            this.logger.debug(`Photo sent to ${String(chatId)}`);
        }
        catch (error) {
            this.logger.error(`Failed to send photo to ${String(chatId)}:`, error);
            throw error;
        }
    }
    /**
     * インラインキーボード付きメッセージ送信
     */
    async sendMessageWithKeyboard(chatId, text, keyboard) {
        await this.sendMessage(chatId, text, {
            reply_markup: {
                inline_keyboard: keyboard,
            },
        });
    }
    /**
     * Webhook設定
     */
    async setWebhook(webhookUrl) {
        try {
            const response = await axios_1.default.post(`${this.apiUrl}/setWebhook`, {
                url: webhookUrl,
            });
            if (!response.data.ok) {
                throw new Error(`Failed to set webhook: ${String(response.data.description)}`);
            }
            this.logger.log(`Webhook set to ${webhookUrl}`);
        }
        catch (error) {
            this.logger.error('Failed to set webhook:', error);
            throw error;
        }
    }
    /**
     * Webhook削除
     */
    async deleteWebhook() {
        try {
            const response = await axios_1.default.post(`${this.apiUrl}/deleteWebhook`);
            if (!response.data.ok) {
                throw new Error(`Failed to delete webhook: ${String(response.data.description)}`);
            }
            this.logger.log('Webhook deleted');
        }
        catch (error) {
            this.logger.error('Failed to delete webhook:', error);
            throw error;
        }
    }
    /**
     * Bot情報取得
     */
    async getMe() {
        try {
            const response = await axios_1.default.get(`${this.apiUrl}/getMe`);
            if (!response.data.ok) {
                throw new Error(`Failed to get bot info: ${String(response.data.description)}`);
            }
            return response.data.result;
        }
        catch (error) {
            this.logger.error('Failed to get bot info:', error);
            throw error;
        }
    }
};
exports.TelegramService = TelegramService;
exports.TelegramService = TelegramService = TelegramService_1 = __decorate([
    (0, common_1.Injectable)(),
    __metadata("design:paramtypes", [config_1.ConfigService])
], TelegramService);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL3R0dGVsYS9Eb2N1bWVudHMvV29yay9kZW5vZi93b3Jrcy8yNTA1Mjlzb2t1YnV0c3UvZGV2Mi9zcmMvZG9tYWluL3RlbGVncmFtL3RlbGVncmFtLnNlcnZpY2UudHMiLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7OztBQUFBLDJDQUFvRDtBQUNwRCwyQ0FBK0M7QUFDL0Msa0RBQTBCO0FBR25CLElBQU0sZUFBZSx1QkFBckIsTUFBTSxlQUFlO0lBS0c7SUFKWixNQUFNLEdBQUcsSUFBSSxlQUFNLENBQUMsaUJBQWUsQ0FBQyxJQUFJLENBQUMsQ0FBQztJQUMxQyxRQUFRLENBQVM7SUFDakIsTUFBTSxDQUFTO0lBRWhDLFlBQTZCLGFBQTRCO1FBQTVCLGtCQUFhLEdBQWIsYUFBYSxDQUFlO1FBQ3ZELElBQUksQ0FBQyxRQUFRLEdBQUcsSUFBSSxDQUFDLGFBQWEsQ0FBQyxHQUFHLENBQVMsb0JBQW9CLEVBQUUsRUFBRSxDQUFDLENBQUM7UUFDekUsSUFBSSxDQUFDLE1BQU0sR0FBRywrQkFBK0IsSUFBSSxDQUFDLFFBQVEsRUFBRSxDQUFDO0lBQy9ELENBQUM7SUFFRDs7T0FFRztJQUNILEtBQUssQ0FBQyxXQUFXLENBQ2YsTUFBYyxFQUNkLElBQVksRUFDWixPQUtDO1FBRUQsSUFBSSxDQUFDO1lBQ0gsTUFBTSxRQUFRLEdBQUcsTUFBTSxlQUFLLENBQUMsSUFBSSxDQUFDLEdBQUcsSUFBSSxDQUFDLE1BQU0sY0FBYyxFQUFFO2dCQUM5RCxPQUFPLEVBQUUsTUFBTTtnQkFDZixJQUFJO2dCQUNKLEdBQUcsT0FBTzthQUNYLENBQUMsQ0FBQztZQUVILElBQUksQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLEVBQUUsRUFBRSxDQUFDO2dCQUN0QixNQUFNLElBQUksS0FBSyxDQUNiLHVCQUF1QixNQUFNLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxXQUFXLENBQUMsRUFBRSxDQUMzRCxDQUFDO1lBQ0osQ0FBQztZQUVELElBQUksQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFD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LENBQ2pFLENBQUM7WUFDSixDQUFDO1lBRUQsSUFBSSxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsaUJBQWlCLENBQUMsQ0FBQztRQUNyQyxDQUFDO1FBQUMsT0FBTyxLQUFLLEVBQUUsQ0FBQztZQUNmLElBQUksQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLDJCQUEyQixFQUFFLEtBQUssQ0FBQyxDQUFDO1lBQ3RELE1BQU0sS0FBSyxDQUFDO1FBQ2QsQ0FBQztJQUNILENBQUM7SUFFRDs7T0FFRztJQUNILEtBQUssQ0FBQyxLQUFLO1FBQ1QsSUFBSSxDQUFDO1lBQ0gsTUFBTSxRQUFRLEdBQUcsTUFBTSxlQUFLLENBQUMsR0FBRyxDQUFDLEdBQUcsSUFBSSxDQUFDLE1BQU0sUUFBUSxDQUFDLENBQUM7WUFFekQsSUFBSSxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsRUFBRSxFQUFFLENBQUM7Z0JBQ3RCLE1BQU0sSUFBSSxLQUFLLENBQ2IsMkJBQTJCLE1BQU0sQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxFQUFFLENBQy9ELENBQUM7WUFDSixDQUFDO1lBRUQsT0FBTyxRQUFRLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQztRQUM5QixDQUFDO1FBQUMsT0FBTyxLQUFLLEVBQUUsQ0FBQztZQUNmLElBQUksQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLHlCQUF5QixFQUFFLEtBQUssQ0FBQyxDQUFDO1lBQ3BELE1BQU0sS0FBSyxDQUFDO1FBQ2QsQ0FBQztJQUNILENBQUM7Q0FDRixDQUFBO0FBeEpZLDBDQUFlOzBCQUFmLGVBQWU7SUFEM0IsSUFBQSxtQkFBVSxHQUFFO3FDQU1pQyxzQkFBYTtHQUw5QyxlQUFlLENBd0ozQiIsIm5hbWVzIjpbXSwic291cmNlcyI6WyIvVXNlcnMvdHR0ZWxhL0RvY3VtZW50cy9Xb3JrL2Rlbm9mL3dvcmtzLzI1MDUyOXNva3VidXRzdS9kZXYyL3NyYy9kb21haW4vdGVsZWdyYW0vdGVsZWdyYW0uc2VydmljZS50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3RhYmxlLCBMb2dnZXIgfSBmcm9tICdAbmVzdGpzL2NvbW1vbic7XG5pbXBvcnQgeyBDb25maWdTZXJ2aWNlIH0gZnJvbSAnQG5lc3Rqcy9jb25maWcnO1xuaW1wb3J0IGF4aW9zIGZyb20gJ2F4aW9zJztcblxuQEluamVjdGFibGUoKVxuZXhwb3J0IGNsYXNzIFRlbGVncmFtU2VydmljZSB7XG4gIHByaXZhdGUgcmVhZG9ubHkgbG9nZ2VyID0gbmV3IExvZ2dlcihUZWxlZ3JhbVNlcnZpY2UubmFtZSk7XG4gIHByaXZhdGUgcmVhZG9ubHkgYm90VG9rZW46IHN0cmluZztcbiAgcHJpdmF0ZSByZWFkb25seSBhcGlVcmw6IHN0cmluZztcblxuICBjb25zdHJ1Y3Rvcihwcml2YXRlIHJlYWRvbmx5IGNvbmZpZ1NlcnZpY2U6IENvbmZpZ1NlcnZpY2UpIHtcbiAgICB0aGlzLmJvdFRva2VuID0gdGhpcy5jb25maWdTZXJ2aWNlLmdldDxzdHJpbmc+KCdURUxFR1JBTV9CT1RfVE9LRU4nLCAnJyk7XG4gICAgdGhpcy5hcGlVcmwgPSBgaHR0cHM6Ly9hcGkudGVsZWdyYW0ub3JnL2JvdCR7dGhpcy5ib3RUb2tlbn1gO1xuICB9XG5cbiAgLyoqXG4gICAqIFRlbGVncmFt44Oh44OD44K744O844K46YCB5L+hXG4gICAqL1xuICBhc3luYyBzZW5kTWVzc2FnZShcbiAgICBjaGF0SWQ6IG51bWJlcixcbiAgICB0ZXh0OiBzdHJpbmcsXG4gICAgb3B0aW9ucz86IHtcbiAgICAgIHBhcnNlX21vZGU/OiAnTWFya2Rvd24nIHwgJ0hUTUwnO1xuICAgICAgZGlzYWJsZV93ZWJfcGFnZV9wcmV2aWV3PzogYm9vbGVhbjtcbiAgICAgIGRpc2FibGVfbm90aWZpY2F0aW9uPzogYm9vbGVhbjtcbiAgICAgIHJlcGx5X21hcmt1cD86IGFueTtcbiAgICB9LFxuICApOiBQcm9taXNlPHZvaWQ+IHtcbiAgICB0cnkge1xuICAgICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCBheGlvcy5wb3N0KGAke3RoaXMuYXBpVXJsfS9zZW5kTWVzc2FnZWAsIHtcbiAgICAgICAgY2hhdF9pZDogY2hhdElkLFxuICAgICAgICB0ZXh0LFxuICAgICAgICAuLi5vcHRpb25zLFxuICAgICAgfSk7XG5cbiAgICAgIGlmICghcmVzcG9uc2UuZGF0YS5vaykge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgICAgYFRlbGVncmFtIEFQSSBlcnJvcjogJHtTdHJpbmcocmVzcG9uc2UuZGF0YS5kZXNjcmlwdGlvbil9YCxcbiAgICAgICAgKTtcbiAgICAgIH1cblxuICAgICAgdGhpcy5sb2dnZXIuZGVidWcoYE1lc3NhZ2Ugc2VudCB0byAke1N0cmluZyhjaGF0SWQpfWApO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICB0aGlzLmxvZ2dlci5lcnJvcihgRmFpbGVkIHRvIHNlbmQgbWVzc2FnZSB0byAke1N0cmluZyhjaGF0SWQpfTpgLCBlcnJvcik7XG4gICAgICB0aHJvdyBlcnJvcjtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICog5YaZ55yf5LuY44GN44Oh44OD44K744O844K46YCB5L+h77yI54mp5Lu25oOF5aCx6YCa55+l55So77yJXG4gICAqL1xuICBhc3luYyBzZW5kUGhvdG8oXG4gICAgY2hhdElkOiBudW1iZXIsXG4gICAgcGhvdG86IHN0cmluZyxcbiAgICBjYXB0aW9uPzogc3RyaW5nLFxuICAgIG9wdGlvbnM/OiB7XG4gICAgICBwYXJzZV9tb2RlPzogJ01hcmtkb3duJyB8ICdIVE1MJztcbiAgICAgIGRpc2FibGVfbm90aWZpY2F0aW9uPzogYm9vbGVhbjtcbiAgICB9LFxuICApOiBQcm9taXNlPHZvaWQ+IHtcbiAgICB0cnkge1xuICAgICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCBheGlvcy5wb3N0KGAke3RoaXMuYXBpVXJsfS9zZW5kUGhvdG9gLCB7XG4gICAgICAgIGNoYXRfaWQ6IGNoYXRJZCxcbiAgICAgICAgcGhvdG8sXG4gICAgICAgIGNhcHRpb24sXG4gICAgICAgIC4uLm9wdGlvbnMsXG4gICAgICB9KTtcblxuICAgICAgaWYgKCFyZXNwb25zZS5kYXRhLm9rKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgICBgVGVsZWdyYW0gQVBJIGVycm9yOiAke1N0cmluZyhyZXNwb25zZS5kYXRhLmRlc2NyaXB0aW9uKX1gLFxuICAgICAgICApO1xuICAgICAgfVxuXG4gICAgICB0aGlzLmxvZ2dlci5kZWJ1ZyhgUGhvdG8gc2VudCB0byAke1N0cmluZyhjaGF0SWQpfWApO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICB0aGlzLmxvZ2dlci5lcnJvcihgRmFpbGVkIHRvIHNlbmQgcGhvdG8gdG8gJHtTdHJpbmcoY2hhdElkKX06YCwgZXJyb3IpO1xuICAgICAgdGhyb3cgZXJyb3I7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIOOCpOODs+ODqeOCpOODs+OCreODvOODnOODvOODieS7mOOBjeODoeODg+OCu+ODvOOCuOmAgeS/oVxuICAgKi9cbiAgYXN5bmMgc2VuZE1lc3NhZ2VXaXRoS2V5Ym9hcmQoXG4gICAgY2hhdElkOiBudW1iZXIsXG4gICAgdGV4dDogc3RyaW5nLFxuICAgIGtleWJvYXJkOiBhbnlbXVtdLFxuICApOiBQcm9taXNlPHZvaWQ+IHtcbiAgICBhd2FpdCB0aGlzLnNlbmRNZXNzYWdlKGNoYXRJZCwgdGV4dCwge1xuICAgICAgcmVwbHlfbWFya3VwOiB7XG4gICAgICAgIGlubGluZV9rZXlib2FyZDoga2V5Ym9hcmQsXG4gICAgICB9LFxuICAgIH0pO1xuICB9XG5cbiAgLyoqXG4gICAqIFdlYmhvb2voqK3lrppcbiAgICovXG4gIGFzeW5jIHNldFdlYmhvb2sod2ViaG9va1VybDogc3RyaW5nKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgYXhpb3MucG9zdChgJHt0aGlzLmFwaVVybH0vc2V0V2ViaG9va2AsIHtcbiAgICAgICAgdXJsOiB3ZWJob29rVXJsLFxuICAgICAgfSk7XG5cbiAgICAgIGlmICghcmVzcG9uc2UuZGF0YS5vaykge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgICAgYEZhaWxlZCB0byBzZXQgd2ViaG9vazogJHtTdHJpbmcocmVzcG9uc2UuZGF0YS5kZXNjcmlwdGlvbil9YCxcbiAgICAgICAgKTtcbiAgICAgIH1cblxuICAgICAgdGhpcy5sb2dnZXIubG9nKGBXZWJob29rIHNldCB0byAke3dlYmhvb2tVcmx9YCk7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIHRoaXMubG9nZ2VyLmVycm9yKCdGYWlsZWQgdG8gc2V0IHdlYmhvb2s6JywgZXJyb3IpO1xuICAgICAgdGhyb3cgZXJyb3I7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIFdlYmhvb2vliYrpmaRcbiAgICovXG4gIGFzeW5jIGRlbGV0ZVdlYmhvb2soKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgYXhpb3MucG9zdChgJHt0aGlzLmFwaVVybH0vZGVsZXRlV2ViaG9va2ApO1xuXG4gICAgICBpZiAoIXJlc3BvbnNlLmRhdGEub2spIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICAgIGBGYWlsZWQgdG8gZGVsZXRlIHdlYmhvb2s6ICR7U3RyaW5nKHJlc3BvbnNlLmRhdGEuZGVzY3JpcHRpb24pfWAsXG4gICAgICAgICk7XG4gICAgICB9XG5cbiAgICAgIHRoaXMubG9nZ2VyLmxvZygnV2ViaG9vayBkZWxldGVkJyk7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIHRoaXMubG9nZ2VyLmVycm9yKCdGYWlsZWQgdG8gZGVsZXRlIHdlYmhvb2s6JywgZXJyb3IpO1xuICAgICAgdGhyb3cgZXJyb3I7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIEJvdOaDheWgseWPluW+l1xuICAgKi9cbiAgYXN5bmMgZ2V0TWUoKTogUHJvbWlzZTxhbnk+IHtcbiAgICB0cnkge1xuICAgICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCBheGlvcy5nZXQoYCR7dGhpcy5hcGlVcmx9L2dldE1lYCk7XG5cbiAgICAgIGlmICghcmVzcG9uc2UuZGF0YS5vaykge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgICAgYEZhaWxlZCB0byBnZXQgYm90IGluZm86ICR7U3RyaW5nKHJlc3BvbnNlLmRhdGEuZGVzY3JpcHRpb24pfWAsXG4gICAgICAgICk7XG4gICAgICB9XG5cbiAgICAgIHJldHVybiByZXNwb25zZS5kYXRhLnJlc3VsdDtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgdGhpcy5sb2dnZXIuZXJyb3IoJ0ZhaWxlZCB0byBnZXQgYm90IGluZm86JywgZXJyb3IpO1xuICAgICAgdGhyb3cgZXJyb3I7XG4gICAgfVxuICB9XG59XG4iXSwidmVyc2lvbiI6M30=