457229b12c71543ece971be59ecd8e2a
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const testing_1 = require("@nestjs/testing");
const url_service_1 = require("./url.service");
const database_service_1 = require("../../core/database/database.service");
const mockDatabaseService = {
    query: jest.fn(),
    findOne: jest.fn(),
    execute: jest.fn(),
    transaction: jest.fn(),
};
describe('UrlService', () => {
    let service;
    let databaseService;
    beforeEach(async () => {
        const module = await testing_1.Test.createTestingModule({
            providers: [
                url_service_1.UrlService,
                {
                    provide: database_service_1.DatabaseService,
                    useValue: mockDatabaseService,
                },
            ],
        }).compile();
        service = module.get(url_service_1.UrlService);
        databaseService = module.get(database_service_1.DatabaseService);
    });
    afterEach(() => {
        jest.clearAllMocks();
    });
    it('should be defined', () => {
        expect(service).toBeDefined();
    });
    describe('onModuleInit', () => {
        it('初期データがない場合、テストデータを登録すること', async () => {
            databaseService.findOne.mockReturnValue(undefined);
            databaseService.execute.mockReturnValue({
                changes: 1,
                lastInsertRowid: 1,
            });
            service.onModuleInit();
            expect(databaseService.findOne).toHaveBeenCalledWith('SELECT * FROM urls WHERE url = ?', [expect.stringContaining('athome.co.jp')]);
            expect(databaseService.execute).toHaveBeenCalledWith('INSERT INTO urls (name, url, selector, is_active) VALUES (?, ?, ?, ?)', [
                '広島県のテスト物件',
                expect.stringContaining('athome.co.jp'),
                '#item-list',
                1,
            ]);
        });
        it('初期データが既に存在する場合、新たに登録しないこと', async () => {
            databaseService.findOne.mockReturnValue({ id: 1 });
            service.onModuleInit();
            expect(databaseService.findOne).toHaveBeenCalled();
            expect(databaseService.execute).not.toHaveBeenCalled();
        });
    });
    describe('findAllActive', () => {
        it('アクティブなURLの配列を返すこと', async () => {
            const activeUrls = [
                {
                    id: 1,
                    name: 'URL1',
                    url: 'http://example1.com',
                    selector: '#test',
                    contentHash: null,
                    isActive: true,
                    createdAt: new Date(),
                    updatedAt: new Date(),
                },
                {
                    id: 2,
                    name: 'URL2',
                    url: 'http://example2.com',
                    selector: '#test',
                    contentHash: null,
                    isActive: true,
                    createdAt: new Date(),
                    updatedAt: new Date(),
                },
            ];
            databaseService.query.mockResolvedValue(activeUrls);
            const result = await service.findAllActive();
            expect(result).toEqual(activeUrls);
            expect(databaseService.query).toHaveBeenCalledWith('SELECT * FROM urls WHERE is_active = ?', [1]);
        });
        it('アクティブなURLが存在しない場合、空の配列を返すこと', async () => {
            databaseService.query.mockResolvedValue([]);
            const result = await service.findAllActive();
            expect(result).toEqual([]);
            expect(databaseService.query).toHaveBeenCalledWith('SELECT * FROM urls WHERE is_active = ?', [1]);
        });
    });
    describe('updateHash', () => {
        it('指定したIDのURLのハッシュを更新すること', async () => {
            const updateResult = { changes: 1, lastInsertRowid: 0 };
            databaseService.execute.mockReturnValue(updateResult);
            await service.updateHash(1, 'newhash123');
            expect(databaseService.execute).toHaveBeenCalledWith('UPDATE urls SET content_hash = ? WHERE id = ?', ['newhash123', 1]);
        });
        it('存在しないIDの場合でも更新を実行すること（現在の実装）', async () => {
            const updateResult = { changes: 0, lastInsertRowid: 0 };
            databaseService.execute.mockReturnValue(updateResult);
            await service.updateHash(999, 'newhash123');
            expect(databaseService.execute).toHaveBeenCalledWith('UPDATE urls SET content_hash = ? WHERE id = ?', ['newhash123', 999]);
        });
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL3R0dGVsYS9Eb2N1bWVudHMvV29yay9kZW5vZi93b3Jrcy8yNTA1Mjlzb2t1YnV0c3UvZGV2Mi9zcmMvZG9tYWluL3VybC91cmwuc2VydmljZS5zcGVjLnRzIiwibWFwcGluZ3MiOiI7O0FBQUEsNkNBQXNEO0FBQ3RELCtDQUEyQztBQUMzQywyRUFBdUU7QUFHdkUsTUFBTSxtQkFBbUIsR0FBRztJQUMxQixLQUFLLEVBQUUsSUFBSSxDQUFDLEVBQUUsRUFBRTtJQUNoQixPQUFPLEVBQUUsSUFBSSxDQUFDLEVBQUUsRUFBRTtJQUNsQixPQUFPLEVBQUUsSUFBSSxDQUFDLEVBQUUsRUFBRTtJQUNsQixXQUFXLEVBQUUsSUFBSSxDQUFDLEVBQUUsRUFBRTtDQUN2QixDQUFDO0FBRUYsUUFBUSxDQUFDLFlBQVksRUFBRSxHQUFHLEVBQUU7SUFDMUIsSUFBSSxPQUFtQixDQUFDO0lBQ3hCLElBQUksZUFBMkMsQ0FBQztJQUVoRCxVQUFVLENBQUMsS0FBSyxJQUFJLEVBQUU7UUFDcEIsTUFBTSxNQUFNLEdBQWtCLE1BQU0sY0FBSSxDQUFDLG1CQUFtQixDQUFDO1lBQzNELFNBQVMsRUFBRTtnQkFDVCx3QkFBVTtnQkFDVjtvQkFDRSxPQUFPLEVBQUUsa0NBQWU7b0JBQ3hCLFFBQVEsRUFBRSxtQkFBbUI7aUJBQzlCO2FBQ0Y7U0FDRixDQUFDLENBQUMsT0FBTyxFQUFFLENBQUM7UUFFYixPQUFPLEdBQUcsTUFBTSxDQUFDLEdBQUcsQ0FBYSx3QkFBVSxDQUFDLENBQUM7UUFDN0MsZUFBZSxHQUFHLE1BQU0sQ0FBQyxHQUFHLENBQUMsa0NBQWUsQ0FBQyxDQUFDO0lBQ2hELENBQUMsQ0FBQyxDQUFDO0lBRUgsU0FBUyxDQUFDLEdBQUcsRUFBRTtRQUNiLElBQUksQ0FBQyxhQUFhLEVBQUUsQ0FBQztJQUN2QixDQUFDLENBQUMsQ0FBQztJQUVILEVBQUUsQ0FBQyxtQkFBbUIsRUFBRSxHQUFHLEVBQUU7UUFDM0IsTUFBTSxDQUFDLE9BQU8sQ0FBQyxDQUFDLFdBQVcsRUFBRSxDQUFDO0lBQ2hDLENBQUMsQ0FBQyxDQUFDO0lBRUgsUUFBUSxDQUFDLGNBQWMsRUFBRSxHQUFHLEVBQUU7UUFDNUIsRUFBRSxDQUFDLDBCQUEwQixFQUFFLEtBQUssSUFBSSxFQUFFO1lBQ3hDLGVBQWUsQ0FBQyxPQUFPLENBQUMsZUFBZSxDQUFDLFNBQVMsQ0FBQyxDQUFDO1lBQ25ELGVBQWUsQ0FBQyxPQUFPLENBQUMsZUFBZSxDQUFDO2dCQUN0QyxPQUFPLEVBQUUsQ0FBQztnQkFDVixlQUFlLEVBQUUsQ0FBQzthQUNuQixDQUFDLENBQUM7WUFFSCxPQUFPLENBQUMsWUFBWSxFQUFFLENBQUM7WUFFdkIsTUFBTSxDQUFDLGVBQWUsQ0FBQyxPQUFPLENBQUMsQ0FBQyxvQkFBb0IsQ0FDbEQsa0NBQWtDLEVBQ2xDLENBQUMsTUFBTSxDQUFDLGdCQUFnQixDQUFDLGNBQWMsQ0FBQyxDQUFDLENBQzFDLENBQUM7WUFDRixNQUFNLENBQUMsZUFBZSxDQUFDLE9BQU8sQ0FBQyxDQUFDLG9CQUFvQixDQUNsRCx1RUFBdUUsRUFDdkU7Z0JBQ0UsV0FBVztnQkFDWCxNQUFNLENBQUMsZ0JBQWdCLENBQUMsY0FBYyxDQUFDO2dCQUN2QyxZQUFZO2dCQUNaLENBQUM7YUFDRixDQUNGLENBQUM7UUFDSixDQUFDLENBQUMsQ0FBQztRQUVILEVBQUUsQ0FBQywyQkFBMkIsRUFBRSxLQUFLLElBQUksRUFBRTtZQUN6QyxlQUFlLENBQUMsT0FBTyxDQUFDLGVBQWUsQ0FBQyxFQUFFLEVBQUUsRUFBRSxDQUFDLEVBQUUsQ0FBQyxDQUFDO1lBRW5ELE9BQU8sQ0FBQyxZQUFZLEVBQUUsQ0FBQztZQUV2QixNQUFNLENBQUMsZUFBZSxDQUFDLE9BQU8sQ0FBQyxDQUFDLGdCQUFnQixFQUFFLENBQUM7WUFDbkQsTUFBTSxDQUFDLGVBQWUsQ0FBQyxPQUFPLENBQUMsQ0FBQyxHQUFHLENBQUMsZ0JBQWdCLEVBQUUsQ0FBQztRQUN6RCxDQUFDLENBQUMsQ0FBQztJQUNMLENBQUMsQ0FBQyxDQUFDO0lBRUgsUUFBUSxDQUFDLGVBQWUsRUFBRSxHQUFHLEVBQUU7UUFDN0IsRUFBRSxDQUFDLG1CQUFtQixFQUFFLEtBQUssSUFBSSxFQUFFO1lBQ2pDLE1BQU0sVUFBVSxHQUFVO2dCQUN4QjtvQkFDRSxFQUFFLEVBQUUsQ0FBQztvQkFDTCxJQUFJLEVBQUUsTUFBTTtvQkFDWixHQUFHLEVBQUUscUJBQXFCO29CQUMxQixRQUFRLEVBQUUsT0FBTztvQkFDakIsV0FBVyxFQUFFLElBQUk7b0JBQ2pCLFFBQVEsRUFBRSxJQUFJO29CQUNkLFNBQVMsRUFBRSxJQUFJLElBQUksRUFBRTtvQkFDckIsU0FBUyxFQUFFLElBQUksSUFBSSxFQUFFO2lCQUN0QjtnQkFDRDtvQkFDRSxFQUFFLEVBQUUsQ0FBQztvQkFDTCxJQUFJLEVBQUUsTUFBTTtvQkFDWixHQUFHLEVBQUUscUJBQXFCO29CQUMxQixRQUFRLEVBQUUsT0FBTztvQkFDakIsV0FBVyxFQUFFLElBQUk7b0JBQ2pCLFFBQVEsRUFBRSxJQUFJO29CQUNkLFNBQVMsRUFBRSxJQUFJLElBQUksRUFBRTtvQkFDckIsU0FBUyxFQUFFLElBQUksSUFBSSxFQUFFO2lCQUN0QjthQUNGLENBQUM7WUFDRixlQUFlLENBQUMsS0FBSyxDQUFDLGlCQUFpQixDQUFDLFVBQVUsQ0FBQyxDQUFDO1lBRXBELE1BQU0sTUFBTSxHQUFHLE1BQU0sT0FBTyxDQUFDLGFBQWEsRUFBRSxDQUFDO1lBRTdDLE1BQU0sQ0FBQyxNQUFNLENBQUMsQ0FBQyxPQUFPLENBQUMsVUFBVSxDQUFDLENBQUM7WUFDbkMsTUFBTSxDQUFDLGVBQWUsQ0FBQyxLQUFLLENBQUMsQ0FBQyxvQkFBb0IsQ0FDaEQsd0NBQXdDLEVBQ3hDLENBQUMsQ0FBQyxDQUFDLENBQ0osQ0FBQztRQUNKLENBQUMsQ0FBQyxDQUFDO1FBRUgsRUFBRSxDQUFDLDZCQUE2QixFQUFFLEtBQUssSUFBSSxFQUFFO1lBQzNDLGVBQWUsQ0FBQyxLQUFLLENBQUMsaUJBQWlCLENBQUMsRUFBRSxDQUFDLENBQUM7WUFFNUMsTUFBTSxNQUFNLEdBQUcsTUFBTSxPQUFPLENBQUMsYUFBYSxFQUFFLENBQUM7WUFFN0MsTUFBTSxDQUFDLE1BQU0sQ0FBQyxDQUFDLE9BQU8sQ0FBQyxFQUFFLENBQUMsQ0FBQztZQUMzQixNQUFNLENBQUMsZUFBZSxDQUFDLEtBQUssQ0FBQyxDQUFDLG9CQUFvQixDQUNoRCx3Q0FBd0MsRUFDeEMsQ0FBQyxDQUFDLENBQUMsQ0FDSixDQUFDO1FBQ0osQ0FBQyxDQUFDLENBQUM7SUFDTCxDQUFDLENBQUMsQ0FBQztJQUVILFFBQVEsQ0FBQyxZQUFZLEVBQUUsR0FBRyxFQUFFO1FBQzFCLEVBQUUsQ0FBQyx3QkFBd0IsRUFBRSxLQUFLLElBQUksRUFBRTtZQUN0QyxNQUFNLFlBQVksR0FBRyxFQUFFLE9BQU8sRUFBRSxDQUFDLEVBQUUsZUFBZSxFQUFFLENBQUMsRUFBRSxDQUFDO1lBQ3hELGVBQWUsQ0FBQyxPQUFPLENBQUMsZUFBZSxDQUFDLFlBQVksQ0FBQyxDQUFDO1lBRXRELE1BQU0sT0FBTyxDQUFDLFVBQVUsQ0FBQyxDQUFDLEVBQUUsWUFBWSxDQUFDLENBQUM7WUFDMUMsTUFBTSxDQUFDLGVBQWUsQ0FBQyxPQUFPLENBQUMsQ0FBQyxvQkFBb0IsQ0FDbEQsK0NBQStDLEVBQy9DLENBQUMsWUFBWSxFQUFFLENBQUMsQ0FBQyxDQUNsQixDQUFDO1FBQ0osQ0FBQyxDQUFDLENBQUM7UUFFSCxFQUFFLENBQUMsOEJBQThCLEVBQUUsS0FBSyxJQUFJLEVBQUU7WUFDNUMsTUFBTSxZQUFZLEdBQUcsRUFBRSxPQUFPLEVBQUUsQ0FBQyxFQUFFLGVBQWUsRUFBRSxDQUFDLEVBQUUsQ0FBQztZQUN4RCxlQUFlLENBQUMsT0FBTyxDQUFDLGVBQWUsQ0FBQyxZQUFZLENBQUMsQ0FBQztZQUV0RCxNQUFNLE9BQU8sQ0FBQyxVQUFVLENBQUMsR0FBRyxFQUFFLFlBQVksQ0FBQyxDQUFDO1lBQzVDLE1BQU0sQ0FBQyxlQUFlLENBQUMsT0FBTyxDQUFDLENBQUMsb0JBQW9CLENBQ2xELCtDQUErQyxFQUMvQyxDQUFDLFlBQVksRUFBRSxHQUFHLENBQUMsQ0FDcEIsQ0FBQztRQUNKLENBQUMsQ0FBQyxDQUFDO0lBQ0wsQ0FBQyxDQUFDLENBQUM7QUFDTCxDQUFDLENBQUMsQ0FBQyIsIm5hbWVzIjpbXSwic291cmNlcyI6WyIvVXNlcnMvdHR0ZWxhL0RvY3VtZW50cy9Xb3JrL2Rlbm9mL3dvcmtzLzI1MDUyOXNva3VidXRzdS9kZXYyL3NyYy9kb21haW4vdXJsL3VybC5zZXJ2aWNlLnNwZWMudHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgVGVzdCwgVGVzdGluZ01vZHVsZSB9IGZyb20gJ0BuZXN0anMvdGVzdGluZyc7XG5pbXBvcnQgeyBVcmxTZXJ2aWNlIH0gZnJvbSAnLi91cmwuc2VydmljZSc7XG5pbXBvcnQgeyBEYXRhYmFzZVNlcnZpY2UgfSBmcm9tICcuLi8uLi9jb3JlL2RhdGFiYXNlL2RhdGFiYXNlLnNlcnZpY2UnO1xuaW1wb3J0IHsgVXJsIH0gZnJvbSAnLi91cmwuaW50ZXJmYWNlJztcblxuY29uc3QgbW9ja0RhdGFiYXNlU2VydmljZSA9IHtcbiAgcXVlcnk6IGplc3QuZm4oKSxcbiAgZmluZE9uZTogamVzdC5mbigpLFxuICBleGVjdXRlOiBqZXN0LmZuKCksXG4gIHRyYW5zYWN0aW9uOiBqZXN0LmZuKCksXG59O1xuXG5kZXNjcmliZSgnVXJsU2VydmljZScsICgpID0+IHtcbiAgbGV0IHNlcnZpY2U6IFVybFNlcnZpY2U7XG4gIGxldCBkYXRhYmFzZVNlcnZpY2U6IHR5cGVvZiBtb2NrRGF0YWJhc2VTZXJ2aWNlO1xuXG4gIGJlZm9yZUVhY2goYXN5bmMgKCkgPT4ge1xuICAgIGNvbnN0IG1vZHVsZTogVGVzdGluZ01vZHVsZSA9IGF3YWl0IFRlc3QuY3JlYXRlVGVzdGluZ01vZHVsZSh7XG4gICAgICBwcm92aWRlcnM6IFtcbiAgICAgICAgVXJsU2VydmljZSxcbiAgICAgICAge1xuICAgICAgICAgIHByb3ZpZGU6IERhdGFiYXNlU2VydmljZSxcbiAgICAgICAgICB1c2VWYWx1ZTogbW9ja0RhdGFiYXNlU2VydmljZSxcbiAgICAgICAgfSxcbiAgICAgIF0sXG4gICAgfSkuY29tcGlsZSgpO1xuXG4gICAgc2VydmljZSA9IG1vZHVsZS5nZXQ8VXJsU2VydmljZT4oVXJsU2VydmljZSk7XG4gICAgZGF0YWJhc2VTZXJ2aWNlID0gbW9kdWxlLmdldChEYXRhYmFzZVNlcnZpY2UpO1xuICB9KTtcblxuICBhZnRlckVhY2goKCkgPT4ge1xuICAgIGplc3QuY2xlYXJBbGxNb2NrcygpO1xuICB9KTtcblxuICBpdCgnc2hvdWxkIGJlIGRlZmluZWQnLCAoKSA9PiB7XG4gICAgZXhwZWN0KHNlcnZpY2UpLnRvQmVEZWZpbmVkKCk7XG4gIH0pO1xuXG4gIGRlc2NyaWJlKCdvbk1vZHVsZUluaXQnLCAoKSA9PiB7XG4gICAgaXQoJ+WIneacn+ODh+ODvOOCv+OBjOOBquOBhOWgtOWQiOOAgeODhuOCueODiOODh+ODvOOCv+OCkueZu+mMsuOBmeOCi+OBk+OBqCcsIGFzeW5jICgpID0+IHtcbiAgICAgIGRhdGFiYXNlU2VydmljZS5maW5kT25lLm1vY2tSZXR1cm5WYWx1ZSh1bmRlZmluZWQpO1xuICAgICAgZGF0YWJhc2VTZXJ2aWNlLmV4ZWN1dGUubW9ja1JldHVyblZhbHVlKHtcbiAgICAgICAgY2hhbmdlczogMSxcbiAgICAgICAgbGFzdEluc2VydFJvd2lkOiAxLFxuICAgICAgfSk7XG5cbiAgICAgIHNlcnZpY2Uub25Nb2R1bGVJbml0KCk7XG5cbiAgICAgIGV4cGVjdChkYXRhYmFzZVNlcnZpY2UuZmluZE9uZSkudG9IYXZlQmVlbkNhbGxlZFdpdGgoXG4gICAgICAgICdTRUxFQ1QgKiBGUk9NIHVybHMgV0hFUkUgdXJsID0gPycsXG4gICAgICAgIFtleHBlY3Quc3RyaW5nQ29udGFpbmluZygnYXRob21lLmNvLmpwJyldLFxuICAgICAgKTtcbiAgICAgIGV4cGVjdChkYXRhYmFzZVNlcnZpY2UuZXhlY3V0ZSkudG9IYXZlQmVlbkNhbGxlZFdpdGgoXG4gICAgICAgICdJTlNFUlQgSU5UTyB1cmxzIChuYW1lLCB1cmwsIHNlbGVjdG9yLCBpc19hY3RpdmUpIFZBTFVFUyAoPywgPywgPywgPyknLFxuICAgICAgICBbXG4gICAgICAgICAgJ+W6g+WztuecjOOBruODhuOCueODiOeJqeS7ticsXG4gICAgICAgICAgZXhwZWN0LnN0cmluZ0NvbnRhaW5pbmcoJ2F0aG9tZS5jby5qcCcpLFxuICAgICAgICAgICcjaXRlbS1saXN0JyxcbiAgICAgICAgICAxLFxuICAgICAgICBdLFxuICAgICAgKTtcbiAgICB9KTtcblxuICAgIGl0KCfliJ3mnJ/jg4fjg7zjgr/jgYzml6LjgavlrZjlnKjjgZnjgovloLTlkIjjgIHmlrDjgZ/jgavnmbvpjLLjgZfjgarjgYTjgZPjgagnLCBhc3luYyAoKSA9PiB7XG4gICAgICBkYXRhYmFzZVNlcnZpY2UuZmluZE9uZS5tb2NrUmV0dXJuVmFsdWUoeyBpZDogMSB9KTtcblxuICAgICAgc2VydmljZS5vbk1vZHVsZUluaXQoKTtcblxuICAgICAgZXhwZWN0KGRhdGFiYXNlU2VydmljZS5maW5kT25lKS50b0hhdmVCZWVuQ2FsbGVkKCk7XG4gICAgICBleHBlY3QoZGF0YWJhc2VTZXJ2aWNlLmV4ZWN1dGUpLm5vdC50b0hhdmVCZWVuQ2FsbGVkKCk7XG4gICAgfSk7XG4gIH0pO1xuXG4gIGRlc2NyaWJlKCdmaW5kQWxsQWN0aXZlJywgKCkgPT4ge1xuICAgIGl0KCfjgqLjgq/jg4bjgqPjg5bjgapVUkzjga7phY3liJfjgpLov5TjgZnjgZPjgagnLCBhc3luYyAoKSA9PiB7XG4gICAgICBjb25zdCBhY3RpdmVVcmxzOiBVcmxbXSA9IFtcbiAgICAgICAge1xuICAgICAgICAgIGlkOiAxLFxuICAgICAgICAgIG5hbWU6ICdVUkwxJyxcbiAgICAgICAgICB1cmw6ICdodHRwOi8vZXhhbXBsZTEuY29tJyxcbiAgICAgICAgICBzZWxlY3RvcjogJyN0ZXN0JyxcbiAgICAgICAgICBjb250ZW50SGFzaDogbnVsbCxcbiAgICAgICAgICBpc0FjdGl2ZTogdHJ1ZSxcbiAgICAgICAgICBjcmVhdGVkQXQ6IG5ldyBEYXRlKCksXG4gICAgICAgICAgdXBkYXRlZEF0OiBuZXcgRGF0ZSgpLFxuICAgICAgICB9LFxuICAgICAgICB7XG4gICAgICAgICAgaWQ6IDIsXG4gICAgICAgICAgbmFtZTogJ1VSTDInLFxuICAgICAgICAgIHVybDogJ2h0dHA6Ly9leGFtcGxlMi5jb20nLFxuICAgICAgICAgIHNlbGVjdG9yOiAnI3Rlc3QnLFxuICAgICAgICAgIGNvbnRlbnRIYXNoOiBudWxsLFxuICAgICAgICAgIGlzQWN0aXZlOiB0cnVlLFxuICAgICAgICAgIGNyZWF0ZWRBdDogbmV3IERhdGUoKSxcbiAgICAgICAgICB1cGRhdGVkQXQ6IG5ldyBEYXRlKCksXG4gICAgICAgIH0sXG4gICAgICBdO1xuICAgICAgZGF0YWJhc2VTZXJ2aWNlLnF1ZXJ5Lm1vY2tSZXNvbHZlZFZhbHVlKGFjdGl2ZVVybHMpO1xuXG4gICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBzZXJ2aWNlLmZpbmRBbGxBY3RpdmUoKTtcblxuICAgICAgZXhwZWN0KHJlc3VsdCkudG9FcXVhbChhY3RpdmVVcmxzKTtcbiAgICAgIGV4cGVjdChkYXRhYmFzZVNlcnZpY2UucXVlcnkpLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKFxuICAgICAgICAnU0VMRUNUICogRlJPTSB1cmxzIFdIRVJFIGlzX2FjdGl2ZSA9ID8nLFxuICAgICAgICBbMV0sXG4gICAgICApO1xuICAgIH0pO1xuXG4gICAgaXQoJ+OCouOCr+ODhuOCo+ODluOBqlVSTOOBjOWtmOWcqOOBl+OBquOBhOWgtOWQiOOAgeepuuOBrumFjeWIl+OCkui/lOOBmeOBk+OBqCcsIGFzeW5jICgpID0+IHtcbiAgICAgIGRhdGFiYXNlU2VydmljZS5xdWVyeS5tb2NrUmVzb2x2ZWRWYWx1ZShbXSk7XG5cbiAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IHNlcnZpY2UuZmluZEFsbEFjdGl2ZSgpO1xuXG4gICAgICBleHBlY3QocmVzdWx0KS50b0VxdWFsKFtdKTtcbiAgICAgIGV4cGVjdChkYXRhYmFzZVNlcnZpY2UucXVlcnkpLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKFxuICAgICAgICAnU0VMRUNUICogRlJPTSB1cmxzIFdIRVJFIGlzX2FjdGl2ZSA9ID8nLFxuICAgICAgICBbMV0sXG4gICAgICApO1xuICAgIH0pO1xuICB9KTtcblxuICBkZXNjcmliZSgndXBkYXRlSGFzaCcsICgpID0+IHtcbiAgICBpdCgn5oyH5a6a44GX44GfSUTjga5VUkzjga7jg4/jg4Pjgrfjg6XjgpLmm7TmlrDjgZnjgovjgZPjgagnLCBhc3luYyAoKSA9PiB7XG4gICAgICBjb25zdCB1cGRhdGVSZXN1bHQgPSB7IGNoYW5nZXM6IDEsIGxhc3RJbnNlcnRSb3dpZDogMCB9O1xuICAgICAgZGF0YWJhc2VTZXJ2aWNlLmV4ZWN1dGUubW9ja1JldHVyblZhbHVlKHVwZGF0ZVJlc3VsdCk7XG5cbiAgICAgIGF3YWl0IHNlcnZpY2UudXBkYXRlSGFzaCgxLCAnbmV3aGFzaDEyMycpO1xuICAgICAgZXhwZWN0KGRhdGFiYXNlU2VydmljZS5leGVjdXRlKS50b0hhdmVCZWVuQ2FsbGVkV2l0aChcbiAgICAgICAgJ1VQREFURSB1cmxzIFNFVCBjb250ZW50X2hhc2ggPSA/IFdIRVJFIGlkID0gPycsXG4gICAgICAgIFsnbmV3aGFzaDEyMycsIDFdLFxuICAgICAgKTtcbiAgICB9KTtcblxuICAgIGl0KCflrZjlnKjjgZfjgarjgYRJROOBruWgtOWQiOOBp+OCguabtOaWsOOCkuWun+ihjOOBmeOCi+OBk+OBqO+8iOePvuWcqOOBruWun+ijhe+8iScsIGFzeW5jICgpID0+IHtcbiAgICAgIGNvbnN0IHVwZGF0ZVJlc3VsdCA9IHsgY2hhbmdlczogMCwgbGFzdEluc2VydFJvd2lkOiAwIH07XG4gICAgICBkYXRhYmFzZVNlcnZpY2UuZXhlY3V0ZS5tb2NrUmV0dXJuVmFsdWUodXBkYXRlUmVzdWx0KTtcblxuICAgICAgYXdhaXQgc2VydmljZS51cGRhdGVIYXNoKDk5OSwgJ25ld2hhc2gxMjMnKTtcbiAgICAgIGV4cGVjdChkYXRhYmFzZVNlcnZpY2UuZXhlY3V0ZSkudG9IYXZlQmVlbkNhbGxlZFdpdGgoXG4gICAgICAgICdVUERBVEUgdXJscyBTRVQgY29udGVudF9oYXNoID0gPyBXSEVSRSBpZCA9ID8nLFxuICAgICAgICBbJ25ld2hhc2gxMjMnLCA5OTldLFxuICAgICAgKTtcbiAgICB9KTtcbiAgfSk7XG59KTtcbiJdLCJ2ZXJzaW9uIjozfQ==