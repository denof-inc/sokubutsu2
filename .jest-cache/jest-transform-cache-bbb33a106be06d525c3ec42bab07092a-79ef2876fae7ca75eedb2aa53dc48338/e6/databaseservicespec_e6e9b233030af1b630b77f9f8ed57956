059e176c3e8e0f1151694d76a8b5a460
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
// better-sqlite3のモック
jest.mock('better-sqlite3', () => {
    return jest.fn().mockImplementation(() => mockDb);
});
// fsのモック
jest.mock('fs', () => ({
    readFileSync: jest.fn().mockReturnValue('CREATE TABLE test;'),
}));
const testing_1 = require("@nestjs/testing");
const database_service_1 = require("./database.service");
const mockDb = {
    pragma: jest.fn(),
    exec: jest.fn(),
    prepare: jest.fn(),
    close: jest.fn(),
    transaction: jest.fn(),
};
describe('DatabaseService', () => {
    let service;
    beforeEach(async () => {
        // モックをリセット
        jest.clearAllMocks();
        const module = await testing_1.Test.createTestingModule({
            providers: [database_service_1.DatabaseService],
        }).compile();
        service = module.get(database_service_1.DatabaseService);
    });
    afterEach(() => {
        jest.clearAllMocks();
    });
    it('should be defined', () => {
        expect(service).toBeDefined();
    });
    describe('onModuleInit', () => {
        it('データベース接続を確立し、スキーマを初期化すること', () => {
            // onModuleInitを呼び出す
            service.onModuleInit();
            const Database = require('better-sqlite3');
            const fs = require('fs');
            expect(Database).toHaveBeenCalledWith(expect.stringContaining('sokubutsu.sqlite'));
            expect(mockDb.pragma).toHaveBeenCalledWith('journal_mode = WAL');
            expect(fs.readFileSync).toHaveBeenCalledWith(expect.stringContaining('schema.sql'), 'utf8');
            expect(mockDb.exec).toHaveBeenCalledWith('CREATE TABLE test;');
        });
    });
    describe('onModuleDestroy', () => {
        it('データベース接続を閉じること', () => {
            // まずonModuleInitを呼び出してdbを初期化
            service.onModuleInit();
            // その後でonModuleDestroyを呼び出す
            service.onModuleDestroy();
            expect(mockDb.close).toHaveBeenCalled();
        });
    });
    describe('query', () => {
        it('複数の結果を返すこと', () => {
            // 先にonModuleInitを呼び出してdbを初期化
            service.onModuleInit();
            const mockStmt = {
                all: jest.fn().mockReturnValue([{ id: 1 }, { id: 2 }]),
            };
            mockDb.prepare.mockReturnValue(mockStmt);
            const result = service.query('SELECT * FROM test WHERE active = ?', [
                true,
            ]);
            expect(mockDb.prepare).toHaveBeenCalledWith('SELECT * FROM test WHERE active = ?');
            expect(mockStmt.all).toHaveBeenCalledWith(true);
            expect(result).toEqual([{ id: 1 }, { id: 2 }]);
        });
    });
    describe('findOne', () => {
        beforeEach(() => {
            // 各テストの前にonModuleInitを呼び出してdbを初期化
            service.onModuleInit();
        });
        it('単一の結果を返すこと', () => {
            const mockStmt = {
                get: jest.fn().mockReturnValue({ id: 1, name: 'test' }),
            };
            mockDb.prepare.mockReturnValue(mockStmt);
            const result = service.findOne('SELECT * FROM test WHERE id = ?', [1]);
            expect(mockDb.prepare).toHaveBeenCalledWith('SELECT * FROM test WHERE id = ?');
            expect(mockStmt.get).toHaveBeenCalledWith(1);
            expect(result).toEqual({ id: 1, name: 'test' });
        });
        it('結果がない場合はundefinedを返すこと', () => {
            const mockStmt = {
                get: jest.fn().mockReturnValue(undefined),
            };
            mockDb.prepare.mockReturnValue(mockStmt);
            const result = service.findOne('SELECT * FROM test WHERE id = ?', [999]);
            expect(result).toBeUndefined();
        });
    });
    describe('execute', () => {
        it('INSERT/UPDATE/DELETE操作を実行すること', () => {
            // 先にonModuleInitを呼び出してdbを初期化
            service.onModuleInit();
            const mockRunResult = { changes: 1, lastInsertRowid: 123 };
            const mockStmt = {
                run: jest.fn().mockReturnValue(mockRunResult),
            };
            mockDb.prepare.mockReturnValue(mockStmt);
            const result = service.execute('INSERT INTO test (name) VALUES (?)', [
                'test',
            ]);
            expect(mockDb.prepare).toHaveBeenCalledWith('INSERT INTO test (name) VALUES (?)');
            expect(mockStmt.run).toHaveBeenCalledWith('test');
            expect(result).toEqual(mockRunResult);
        });
    });
    describe('transaction', () => {
        it('トランザクション内で関数を実行すること', () => {
            // 先にonModuleInitを呼び出してdbを初期化
            service.onModuleInit();
            const mockFn = jest.fn().mockReturnValue('result');
            const mockTransaction = jest.fn().mockReturnValue('result');
            mockDb.transaction.mockReturnValue(mockTransaction);
            const result = service.transaction(mockFn);
            expect(mockDb.transaction).toHaveBeenCalledWith(mockFn);
            expect(mockTransaction).toHaveBeenCalled();
            expect(result).toBe('result');
        });
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL3R0dGVsYS9Eb2N1bWVudHMvV29yay9kZW5vZi93b3Jrcy8yNTA1Mjlzb2t1YnV0c3UvZGV2Mi9zcmMvY29yZS9kYXRhYmFzZS9kYXRhYmFzZS5zZXJ2aWNlLnNwZWMudHMiLCJtYXBwaW5ncyI6Ijs7QUFvQkEscUJBQXFCO0FBQ3JCLElBQUksQ0FBQyxJQUFJLENBQUMsZ0JBQWdCLEVBQUUsR0FBRyxFQUFFO0lBQy9CLE9BQU8sSUFBSSxDQUFDLEVBQUUsRUFBRSxDQUFDLGtCQUFrQixDQUFDLEdBQUcsRUFBRSxDQUFDLE1BQU0sQ0FBQyxDQUFDO0FBQ3BELENBQUMsQ0FBQyxDQUFDO0FBRUgsU0FBUztBQUNULElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxFQUFFLEdBQUcsRUFBRSxDQUFDLENBQUM7SUFDckIsWUFBWSxFQUFFLElBQUksQ0FBQyxFQUFFLEVBQUUsQ0FBQyxlQUFlLENBQUMsb0JBQW9CLENBQUM7Q0FDOUQsQ0FBQyxDQUFDLENBQUM7QUE1QkosNkNBQXNEO0FBQ3RELHlEQUFxRDtBQVdyRCxNQUFNLE1BQU0sR0FBaUI7SUFDM0IsTUFBTSxFQUFFLElBQUksQ0FBQyxFQUFFLEVBQUU7SUFDakIsSUFBSSxFQUFFLElBQUksQ0FBQyxFQUFFLEVBQUU7SUFDZixPQUFPLEVBQUUsSUFBSSxDQUFDLEVBQUUsRUFBRTtJQUNsQixLQUFLLEVBQUUsSUFBSSxDQUFDLEVBQUUsRUFBRTtJQUNoQixXQUFXLEVBQUUsSUFBSSxDQUFDLEVBQUUsRUFBRTtDQUN2QixDQUFDO0FBWUYsUUFBUSxDQUFDLGlCQUFpQixFQUFFLEdBQUcsRUFBRTtJQUMvQixJQUFJLE9BQXdCLENBQUM7SUFFN0IsVUFBVSxDQUFDLEtBQUssSUFBSSxFQUFFO1FBQ3BCLFdBQVc7UUFDWCxJQUFJLENBQUMsYUFBYSxFQUFFLENBQUM7UUFFckIsTUFBTSxNQUFNLEdBQWtCLE1BQU0sY0FBSSxDQUFDLG1CQUFtQixDQUFDO1lBQzNELFNBQVMsRUFBRSxDQUFDLGtDQUFlLENBQUM7U0FDN0IsQ0FBQyxD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RXZCLE1BQU0sTUFBTSxHQUFHLElBQUksQ0FBQyxFQUFFLEVBQUUsQ0FBQyxlQUFlLENBQUMsUUFBUSxDQUFDLENBQUM7WUFDbkQsTUFBTSxlQUFlLEdBQUcsSUFBSSxDQUFDLEVBQUUsRUFBRSxDQUFDLGVBQWUsQ0FBQyxRQUFRLENBQUMsQ0FBQztZQUM1RCxNQUFNLENBQUMsV0FBVyxDQUFDLGVBQWUsQ0FBQyxlQUFlLENBQUMsQ0FBQztZQUVwRCxNQUFNLE1BQU0sR0FBRyxPQUFPLENBQUMsV0FBVyxDQUFDLE1BQU0sQ0FBQyxDQUFDO1lBRTNDLE1BQU0sQ0FBQyxNQUFNLENBQUMsV0FBVyxDQUFDLENBQUMsb0JBQW9CLENBQUMsTUFBTSxDQUFDLENBQUM7WUFDeEQsTUFBTSxDQUFDLGVBQWUsQ0FBQyxDQUFDLGdCQUFnQixFQUFFLENBQUM7WUFDM0MsTUFBTSxDQUFDLE1BQU0sQ0FBQyxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsQ0FBQztRQUNoQyxDQUFDLENBQUMsQ0FBQztJQUNMLENBQUMsQ0FBQyxDQUFDO0FBQ0wsQ0FBQyxDQUFDLENBQUMiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiL1VzZXJzL3R0dGVsYS9Eb2N1bWVudHMvV29yay9kZW5vZi93b3Jrcy8yNTA1Mjlzb2t1YnV0c3UvZGV2Mi9zcmMvY29yZS9kYXRhYmFzZS9kYXRhYmFzZS5zZXJ2aWNlLnNwZWMudHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgVGVzdCwgVGVzdGluZ01vZHVsZSB9IGZyb20gJ0BuZXN0anMvdGVzdGluZyc7XG5pbXBvcnQgeyBEYXRhYmFzZVNlcnZpY2UgfSBmcm9tICcuL2RhdGFiYXNlLnNlcnZpY2UnO1xuLy8gaW1wb3J0IHR5cGUgeyBEYXRhYmFzZSBhcyBCZXR0ZXJTcWxpdGUzRGF0YWJhc2UgfSBmcm9tICdiZXR0ZXItc3FsaXRlMyc7XG5cbnR5cGUgTW9ja0RhdGFiYXNlID0ge1xuICBwcmFnbWE6IGplc3QuTW9jaztcbiAgZXhlYzogamVzdC5Nb2NrO1xuICBwcmVwYXJlOiBqZXN0Lk1vY2s7XG4gIGNsb3NlOiBqZXN0Lk1vY2s7XG4gIHRyYW5zYWN0aW9uOiBqZXN0Lk1vY2s7XG59O1xuXG5jb25zdCBtb2NrRGI6IE1vY2tEYXRhYmFzZSA9IHtcbiAgcHJhZ21hOiBqZXN0LmZuKCksXG4gIGV4ZWM6IGplc3QuZm4oKSxcbiAgcHJlcGFyZTogamVzdC5mbigpLFxuICBjbG9zZTogamVzdC5mbigpLFxuICB0cmFuc2FjdGlvbjogamVzdC5mbigpLFxufTtcblxuLy8gYmV0dGVyLXNxbGl0ZTPjga7jg6Ljg4Pjgq9cbmplc3QubW9jaygnYmV0dGVyLXNxbGl0ZTMnLCAoKSA9PiB7XG4gIHJldHVybiBqZXN0LmZuKCkubW9ja0ltcGxlbWVudGF0aW9uKCgpID0+IG1vY2tEYik7XG59KTtcblxuLy8gZnPjga7jg6Ljg4Pjgq9cbmplc3QubW9jaygnZnMnLCAoKSA9PiAoe1xuICByZWFkRmlsZVN5bmM6IGplc3QuZm4oKS5tb2NrUmV0dXJuVmFsdWUoJ0NSRUFURSBUQUJMRSB0ZXN0OycpLFxufSkpO1xuXG5kZXNjcmliZSgnRGF0YWJhc2VTZXJ2aWNlJywgKCkgPT4ge1xuICBsZXQgc2VydmljZTogRGF0YWJhc2VTZXJ2aWNlO1xuXG4gIGJlZm9yZUVhY2goYXN5bmMgKCkgPT4ge1xuICAgIC8vIOODouODg+OCr+OCkuODquOCu+ODg+ODiFxuICAgIGplc3QuY2xlYXJBbGxNb2NrcygpO1xuXG4gICAgY29uc3QgbW9kdWxlOiBUZXN0aW5nTW9kdWxlID0gYXdhaXQgVGVzdC5jcmVhdGVUZXN0aW5nTW9kdWxlKHtcbiAgICAgIHByb3ZpZGVyczogW0RhdGFiYXNlU2VydmljZV0sXG4gICAgfSkuY29tcGlsZSgpO1xuXG4gICAgc2VydmljZSA9IG1vZHVsZS5nZXQ8RGF0YWJhc2VTZXJ2aWNlPihEYXRhYmFzZVNlcnZpY2UpO1xuICB9KTtcblxuICBhZnRlckVhY2goKCkgPT4ge1xuICAgIGplc3QuY2xlYXJBbGxNb2NrcygpO1xuICB9KTtcblxuICBpdCgnc2hvdWxkIGJlIGRlZmluZWQnLCAoKSA9PiB7XG4gICAgZXhwZWN0KHNlcnZpY2UpLnRvQmVEZWZpbmVkKCk7XG4gIH0pO1xuXG4gIGRlc2NyaWJlKCdvbk1vZHVsZUluaXQnLCAoKSA9PiB7XG4gICAgaXQoJ+ODh+ODvOOCv+ODmeODvOOCueaOpee2muOCkueiuueri+OBl+OAgeOCueOCreODvOODnuOCkuWIneacn+WMluOBmeOCi+OBk+OBqCcsICgpID0+IHtcbiAgICAgIC8vIG9uTW9kdWxlSW5pdOOCkuWRvOOBs+WHuuOBmVxuICAgICAgc2VydmljZS5vbk1vZHVsZUluaXQoKTtcblxuICAgICAgY29uc3QgRGF0YWJhc2UgPSByZXF1aXJlKCdiZXR0ZXItc3FsaXRlMycpO1xuICAgICAgY29uc3QgZnMgPSByZXF1aXJlKCdmcycpO1xuICAgICAgXG4gICAgICBleHBlY3QoRGF0YWJhc2UpLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKFxuICAgICAgICBleHBlY3Quc3RyaW5nQ29udGFpbmluZygnc29rdWJ1dHN1LnNxbGl0ZScpLFxuICAgICAgKTtcbiAgICAgIGV4cGVjdChtb2NrRGIucHJhZ21hKS50b0hhdmVCZWVuQ2FsbGVkV2l0aCgnam91cm5hbF9tb2RlID0gV0FMJyk7XG4gICAgICBleHBlY3QoZnMucmVhZEZpbGVTeW5jKS50b0hhdmVCZWVuQ2FsbGVkV2l0aChcbiAgICAgICAgZXhwZWN0LnN0cmluZ0NvbnRhaW5pbmcoJ3NjaGVtYS5zcWwnKSxcbiAgICAgICAgJ3V0ZjgnLFxuICAgICAgKTtcbiAgICAgIGV4cGVjdChtb2NrRGIuZXhlYykudG9IYXZlQmVlbkNhbGxlZFdpdGgoJ0NSRUFURSBUQUJMRSB0ZXN0OycpO1xuICAgIH0pO1xuICB9KTtcblxuICBkZXNjcmliZSgnb25Nb2R1bGVEZXN0cm95JywgKCkgPT4ge1xuICAgIGl0KCfjg4fjg7zjgr/jg5njg7zjgrnmjqXntprjgpLplonjgZjjgovjgZPjgagnLCAoKSA9PiB7XG4gICAgICAvLyDjgb7jgZpvbk1vZHVsZUluaXTjgpLlkbzjgbPlh7rjgZfjgaZkYuOCkuWIneacn+WMllxuICAgICAgc2VydmljZS5vbk1vZHVsZUluaXQoKTtcbiAgICAgIFxuICAgICAgLy8g44Gd44Gu5b6M44Gnb25Nb2R1bGVEZXN0cm9544KS5ZG844Gz5Ye644GZXG4gICAgICBzZXJ2aWNlLm9uTW9kdWxlRGVzdHJveSgpO1xuICAgICAgZXhwZWN0KG1vY2tEYi5jbG9zZSkudG9IYXZlQmVlbkNhbGxlZCgpO1xuICAgIH0pO1xuICB9KTtcblxuICBkZXNjcmliZSgncXVlcnknLCAoKSA9PiB7XG4gICAgaXQoJ+ikh+aVsOOBrue1kOaenOOCkui/lOOBmeOBk+OBqCcsICgpID0+IHtcbiAgICAgIC8vIOWFiOOBq29uTW9kdWxlSW5pdOOCkuWRvOOBs+WHuuOBl+OBpmRi44KS5Yid5pyf5YyWXG4gICAgICBzZXJ2aWNlLm9uTW9kdWxlSW5pdCgpO1xuICAgICAgXG4gICAgICBjb25zdCBtb2NrU3RtdCA9IHtcbiAgICAgICAgYWxsOiBqZXN0LmZuKCkubW9ja1JldHVyblZhbHVlKFt7IGlkOiAxIH0sIHsgaWQ6IDIgfV0pLFxuICAgICAgfTtcbiAgICAgIG1vY2tEYi5wcmVwYXJlLm1vY2tSZXR1cm5WYWx1ZShtb2NrU3RtdCk7XG5cbiAgICAgIGNvbnN0IHJlc3VsdCA9IHNlcnZpY2UucXVlcnkoJ1NFTEVDVCAqIEZST00gdGVzdCBXSEVSRSBhY3RpdmUgPSA/JywgW1xuICAgICAgICB0cnVlLFxuICAgICAgXSk7XG5cbiAgICAgIGV4cGVjdChtb2NrRGIucHJlcGFyZSkudG9IYXZlQmVlbkNhbGxlZFdpdGgoXG4gICAgICAgICdTRUxFQ1QgKiBGUk9NIHRlc3QgV0hFUkUgYWN0aXZlID0gPycsXG4gICAgICApO1xuICAgICAgZXhwZWN0KG1vY2tTdG10LmFsbCkudG9IYXZlQmVlbkNhbGxlZFdpdGgodHJ1ZSk7XG4gICAgICBleHBlY3QocmVzdWx0KS50b0VxdWFsKFt7IGlkOiAxIH0sIHsgaWQ6IDIgfV0pO1xuICAgIH0pO1xuICB9KTtcblxuICBkZXNjcmliZSgnZmluZE9uZScsICgpID0+IHtcbiAgICBiZWZvcmVFYWNoKCgpID0+IHtcbiAgICAgIC8vIOWQhOODhuOCueODiOOBruWJjeOBq29uTW9kdWxlSW5pdOOCkuWRvOOBs+WHuuOBl+OBpmRi44KS5Yid5pyf5YyWXG4gICAgICBzZXJ2aWNlLm9uTW9kdWxlSW5pdCgpO1xuICAgIH0pO1xuICAgIFxuICAgIGl0KCfljZjkuIDjga7ntZDmnpzjgpLov5TjgZnjgZPjgagnLCAoKSA9PiB7XG4gICAgICBjb25zdCBtb2NrU3RtdCA9IHtcbiAgICAgICAgZ2V0OiBqZXN0LmZuKCkubW9ja1JldHVyblZhbHVlKHsgaWQ6IDEsIG5hbWU6ICd0ZXN0JyB9KSxcbiAgICAgIH07XG4gICAgICBtb2NrRGIucHJlcGFyZS5tb2NrUmV0dXJuVmFsdWUobW9ja1N0bXQpO1xuXG4gICAgICBjb25zdCByZXN1bHQgPSBzZXJ2aWNlLmZpbmRPbmUoJ1NFTEVDVCAqIEZST00gdGVzdCBXSEVSRSBpZCA9ID8nLCBbMV0pO1xuXG4gICAgICBleHBlY3QobW9ja0RiLnByZXBhcmUpLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKFxuICAgICAgICAnU0VMRUNUICogRlJPTSB0ZXN0IFdIRVJFIGlkID0gPycsXG4gICAgICApO1xuICAgICAgZXhwZWN0KG1vY2tTdG10LmdldCkudG9IYXZlQmVlbkNhbGxlZFdpdGgoMSk7XG4gICAgICBleHBlY3QocmVzdWx0KS50b0VxdWFsKHsgaWQ6IDEsIG5hbWU6ICd0ZXN0JyB9KTtcbiAgICB9KTtcblxuICAgIGl0KCfntZDmnpzjgYzjgarjgYTloLTlkIjjga91bmRlZmluZWTjgpLov5TjgZnjgZPjgagnLCAoKSA9PiB7XG4gICAgICBjb25zdCBtb2NrU3RtdCA9IHtcbiAgICAgICAgZ2V0OiBqZXN0LmZuKCkubW9ja1JldHVyblZhbHVlKHVuZGVmaW5lZCksXG4gICAgICB9O1xuICAgICAgbW9ja0RiLnByZXBhcmUubW9ja1JldHVyblZhbHVlKG1vY2tTdG10KTtcblxuICAgICAgY29uc3QgcmVzdWx0ID0gc2VydmljZS5maW5kT25lKCdTRUxFQ1QgKiBGUk9NIHRlc3QgV0hFUkUgaWQgPSA/JywgWzk5OV0pO1xuXG4gICAgICBleHBlY3QocmVzdWx0KS50b0JlVW5kZWZpbmVkKCk7XG4gICAgfSk7XG4gIH0pO1xuXG4gIGRlc2NyaWJlKCdleGVjdXRlJywgKCkgPT4ge1xuICAgIGl0KCdJTlNFUlQvVVBEQVRFL0RFTEVUReaTjeS9nOOCkuWun+ihjOOBmeOCi+OBk+OBqCcsICgpID0+IHtcbiAgICAgIC8vIOWFiOOBq29uTW9kdWxlSW5pdOOCkuWRvOOBs+WHuuOBl+OBpmRi44KS5Yid5pyf5YyWXG4gICAgICBzZXJ2aWNlLm9uTW9kdWxlSW5pdCgpO1xuICAgICAgXG4gICAgICBjb25zdCBtb2NrUnVuUmVzdWx0ID0geyBjaGFuZ2VzOiAxLCBsYXN0SW5zZXJ0Um93aWQ6IDEyMyB9O1xuICAgICAgY29uc3QgbW9ja1N0bXQgPSB7XG4gICAgICAgIHJ1bjogamVzdC5mbigpLm1vY2tSZXR1cm5WYWx1ZShtb2NrUnVuUmVzdWx0KSxcbiAgICAgIH07XG4gICAgICBtb2NrRGIucHJlcGFyZS5tb2NrUmV0dXJuVmFsdWUobW9ja1N0bXQpO1xuXG4gICAgICBjb25zdCByZXN1bHQgPSBzZXJ2aWNlLmV4ZWN1dGUoJ0lOU0VSVCBJTlRPIHRlc3QgKG5hbWUpIFZBTFVFUyAoPyknLCBbXG4gICAgICAgICd0ZXN0JyxcbiAgICAgIF0pO1xuXG4gICAgICBleHBlY3QobW9ja0RiLnByZXBhcmUpLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKFxuICAgICAgICAnSU5TRVJUIElOVE8gdGVzdCAobmFtZSkgVkFMVUVTICg/KScsXG4gICAgICApO1xuICAgICAgZXhwZWN0KG1vY2tTdG10LnJ1bikudG9IYXZlQmVlbkNhbGxlZFdpdGgoJ3Rlc3QnKTtcbiAgICAgIGV4cGVjdChyZXN1bHQpLnRvRXF1YWwobW9ja1J1blJlc3VsdCk7XG4gICAgfSk7XG4gIH0pO1xuXG4gIGRlc2NyaWJlKCd0cmFuc2FjdGlvbicsICgpID0+IHtcbiAgICBpdCgn44OI44Op44Oz44K244Kv44K344On44Oz5YaF44Gn6Zai5pWw44KS5a6f6KGM44GZ44KL44GT44GoJywgKCkgPT4ge1xuICAgICAgLy8g5YWI44Grb25Nb2R1bGVJbml044KS5ZG844Gz5Ye644GX44GmZGLjgpLliJ3mnJ/ljJZcbiAgICAgIHNlcnZpY2Uub25Nb2R1bGVJbml0KCk7XG4gICAgICBcbiAgICAgIGNvbnN0IG1vY2tGbiA9IGplc3QuZm4oKS5tb2NrUmV0dXJuVmFsdWUoJ3Jlc3VsdCcpO1xuICAgICAgY29uc3QgbW9ja1RyYW5zYWN0aW9uID0gamVzdC5mbigpLm1vY2tSZXR1cm5WYWx1ZSgncmVzdWx0Jyk7XG4gICAgICBtb2NrRGIudHJhbnNhY3Rpb24ubW9ja1JldHVyblZhbHVlKG1vY2tUcmFuc2FjdGlvbik7XG5cbiAgICAgIGNvbnN0IHJlc3VsdCA9IHNlcnZpY2UudHJhbnNhY3Rpb24obW9ja0ZuKTtcblxuICAgICAgZXhwZWN0KG1vY2tEYi50cmFuc2FjdGlvbikudG9IYXZlQmVlbkNhbGxlZFdpdGgobW9ja0ZuKTtcbiAgICAgIGV4cGVjdChtb2NrVHJhbnNhY3Rpb24pLnRvSGF2ZUJlZW5DYWxsZWQoKTtcbiAgICAgIGV4cGVjdChyZXN1bHQpLnRvQmUoJ3Jlc3VsdCcpO1xuICAgIH0pO1xuICB9KTtcbn0pO1xuIl0sInZlcnNpb24iOjN9