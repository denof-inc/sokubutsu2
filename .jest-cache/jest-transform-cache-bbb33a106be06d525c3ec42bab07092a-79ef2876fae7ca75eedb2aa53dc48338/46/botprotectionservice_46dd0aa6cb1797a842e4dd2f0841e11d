ac39ac89d5ced0325258e766b2946026
"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
var BotProtectionService_1;
Object.defineProperty(exports, "__esModule", { value: true });
exports.BotProtectionService = void 0;
const common_1 = require("@nestjs/common");
const playwright_1 = require("playwright");
const bot_protection_config_1 = require("../../core/config/bot-protection.config");
const browser_stealth_service_1 = require("../scraping/browser-stealth.service");
let BotProtectionService = BotProtectionService_1 = class BotProtectionService {
    browserStealthService;
    logger = new common_1.Logger(BotProtectionService_1.name);
    browser = null;
    sessions = new Map();
    rateLimits = new Map();
    SESSION_TIMEOUT_MS = 30 * 60 * 1000; // 30分
    MAX_ERROR_COUNT = 5;
    BASE_DELAY_MS = 1000;
    MAX_DELAY_MS = 60000; // 最大1分
    constructor(browserStealthService) {
        this.browserStealthService = browserStealthService;
    }
    async onModuleInit() {
        await this.initializeBrowser();
    }
    async onModuleDestroy() {
        await this.cleanup();
    }
    async initializeBrowser() {
        if (!this.browser) {
            this.browser = await playwright_1.chromium.launch({
                headless: true,
                args: bot_protection_config_1.botProtectionConfig.playwrightOptions.args,
            });
            this.logger.log('Browser initialized');
        }
    }
    async cleanup() {
        // すべてのセッションをクリーンアップ
        for (const [_domain, session] of this.sessions.entries()) {
            await session.context.close();
        }
        this.sessions.clear();
        // ブラウザをクローズ
        if (this.browser) {
            await this.browser.close();
            this.browser = null;
        }
    }
    /**
     * ドメイン用のセッションを取得または作成
     */
    async getOrCreateSession(domain) {
        // 既存のセッションをチェック
        const existingSession = this.sessions.get(domain);
        if (existingSession) {
            const sessionAge = Date.now() - existingSession.lastAccessTime.getTime();
            // セッションタイムアウトチェック
            if (sessionAge < this.SESSION_TIMEOUT_MS) {
                existingSession.lastAccessTime = new Date();
                return existingSession.context;
            }
            else {
                this.logger.warn(`Session timeout for ${domain}, creating new session`);
                await existingSession.context.close();
                this.sessions.delete(domain);
            }
        }
        // 新しいセッションを作成
        return await this.createNewSession(domain);
    }
    async createNewSession(domain) {
        if (!this.browser) {
            await this.initializeBrowser();
        }
        if (!this.browser) {
            throw new Error('Browser not initialized');
        }
        const context = await this.browser.newContext({
            userAgent: this.getRandomUserAgent(),
            viewport: { width: 1920, height: 1080 },
            locale: 'ja-JP',
            timezoneId: 'Asia/Tokyo',
        });
        const sessionData = {
            context,
            cookies: [],
            lastAccessTime: new Date(),
            errorCount: 0,
            domain,
        };
        this.sessions.set(domain, sessionData);
        this.logger.log(`New session created for ${domain}`);
        return context;
    }
    /**
     * Google経由でサイトにアクセス
     */
    async accessViaGoogle(targetUrl, searchQuery) {
        const domain = new URL(targetUrl).hostname;
        const context = await this.getOrCreateSession(domain);
        const page = await context.newPage();
        try {
            // Step 1: Bot検知テストサイトへのアクセス
            await page.goto('https://bot.sannysoft.com', {
                waitUntil: 'networkidle',
                timeout: 30000,
            });
            // Step 2: 3秒間の待機（重要：この待機時間は必須）
            await new Promise((resolve) => setTimeout(resolve, 3000));
            // Step 3: Googleへのアクセス
            await page.goto('https://www.google.com', {
                waitUntil: 'networkidle',
                timeout: 30000,
            });
            // Step 4: 検索実行
            // Googleの検索ボックスを複数のセレクタで試行
            let searchBox;
            try {
                searchBox = await page.waitForSelector('input[name="q"]', {
                    timeout: 5000,
                });
            }
            catch {
                // 別のセレクタを試行
                searchBox = await page.waitForSelector('textarea[name="q"]', {
                    timeout: 5000,
                });
            }
            await searchBox.type(searchQuery, { delay: 100 });
            await searchBox.press('Enter');
            // Step 5: 検索結果の待機
            await page.waitForSelector('#search', { timeout: 15000 });
            // Step 6: 目的サイトのリンクを探してクリック
            const targetDomain = new URL(targetUrl).hostname;
            const links = await page.$$eval('a[href]', (elements, domain) => {
                return elements
                    .filter((el) => el.href.includes(domain))
                    .map((el) => ({
                    href: el.href,
                    text: el.textContent,
                }));
            }, targetDomain);
            if (links.length === 0) {
                throw new Error(`No links found for domain: ${targetDomain}`);
            }
            // Step 7: 最初のリンクをクリック
            await page.click(`a[href*="${targetDomain}"]`);
            await page.waitForLoadState('networkidle');
            this.logger.log(`Successfully accessed ${targetUrl} via Google`);
            return true;
        }
        catch (error) {
            this.logger.error(`Google経由アクセス失敗: ${error instanceof Error ? error.message : String(error)}`);
            return false;
        }
        finally {
            await page.close();
        }
    }
    /**
     * Bot検知テスト（3段階）
     */
    testBotDetection(_url) {
        const results = {
            httpAccessible: false,
            jsdomAccessible: false,
            playwrightAccessible: false,
        };
        // この部分はScrapingServiceと連携して実装
        // 各手法でアクセスを試み、成功/失敗を記録
        return results;
    }
    /**
     * レート制限の取得と更新
     */
    getAdaptiveDelay(domain, isError = false) {
        const rateLimit = this.rateLimits.get(domain) || {
            domain,
            errorCount: 0,
            lastErrorTime: new Date(0),
            currentDelay: this.BASE_DELAY_MS,
        };
        if (isError) {
            // エラーカウントを増加
            rateLimit.errorCount++;
            rateLimit.lastErrorTime = new Date();
            // 指数関数的にディレイを増加
            rateLimit.currentDelay = Math.min(this.BASE_DELAY_MS * Math.pow(2, rateLimit.errorCount), this.MAX_DELAY_MS);
            this.logger.warn(`Rate limit increased for ${domain}: ${String(rateLimit.currentDelay)}ms`);
        }
        else {
            // 成功時は徐々にディレイを減少
            const timeSinceLastError = Date.now() - rateLimit.lastErrorTime.getTime();
            if (timeSinceLastError > 5 * 60 * 1000) {
                // 5分以上エラーなし
                rateLimit.errorCount = Math.max(0, rateLimit.errorCount - 1);
                rateLimit.currentDelay = Math.max(this.BASE_DELAY_MS, rateLimit.currentDelay * 0.8);
            }
        }
        this.rateLimits.set(domain, rateLimit);
        // ランダム性を追加
        const jitter = rateLimit.currentDelay * 0.2;
        return rateLimit.currentDelay + (Math.random() - 0.5) * jitter;
    }
    /**
     * Cookieの保存と復元
     */
    async saveCookies(domain) {
        const session = this.sessions.get(domain);
        if (session) {
            session.cookies = await session.context.cookies();
            this.logger.debug(`Saved ${String(session.cookies.length)} cookies for ${domain}`);
        }
    }
    async restoreCookies(domain) {
        const session = this.sessions.get(domain);
        if (session && session.cookies.length > 0) {
            await session.context.addCookies(session.cookies);
            this.logger.debug(`Restored ${String(session.cookies.length)} cookies for ${domain}`);
        }
    }
    getRandomUserAgent() {
        const userAgents = bot_protection_config_1.botProtectionConfig.userAgents;
        return userAgents[Math.floor(Math.random() * userAgents.length)];
    }
    async humanDelay() {
        const delay = 500 + Math.random() * 2000; // 0.5〜2.5秒
        await new Promise((resolve) => setTimeout(resolve, delay));
    }
    getRandomTypingDelay() {
        return 50 + Math.random() * 150; // 50〜200ms/文字
    }
    /**
     * 高度なBot対策を実行
     */
    async performAdvancedBotProtection(page, targetUrl) {
        try {
            // Step 1: ブラウザステルス機能の適用
            await this.browserStealthService.applyStealthMeasures(page);
            // Step 2: 段階的なサイトアクセス
            const success = await this.graduatedAccess(page, targetUrl);
            if (!success) {
                // Step 3: Google経由アクセスの実行
                return await this.accessViaGoogle(targetUrl, this.generateSearchQuery(targetUrl));
            }
            return true;
        }
        catch (error) {
            this.logger.error(`高度なBot対策実行失敗: ${error instanceof Error ? error.message : String(error)}`);
            return false;
        }
    }
    async graduatedAccess(page, targetUrl) {
        const domain = new URL(targetUrl).hostname;
        try {
            // Step 1: ドメインのトップページにアクセス
            const topPageUrl = `https://${domain}`;
            await page.goto(topPageUrl, { waitUntil: 'networkidle', timeout: 30000 });
            await this.browserStealthService.simulateHumanInteraction(page);
            // Step 2: サイト内の別ページにアクセス
            const internalLinks = await page.$$eval('a[href]', (links, currentDomain) => {
                return links
                    .filter((link) => {
                    const href = link.href;
                    return (href.includes(currentDomain) && href !== window.location.href);
                })
                    .slice(0, 3)
                    .map((link) => link.href);
            }, domain);
            // 内部リンクが見つかった場合、ランダムに1つ選んでアクセス
            if (internalLinks.length > 0) {
                const randomLink = internalLinks[Math.floor(Math.random() * internalLinks.length)];
                await page.goto(randomLink, {
                    waitUntil: 'networkidle',
                    timeout: 30000,
                });
                await this.browserStealthService.simulateHumanInteraction(page);
            }
            // Step 3: 目的のページにアクセス
            await page.goto(targetUrl, { waitUntil: 'networkidle', timeout: 30000 });
            return true;
        }
        catch (error) {
            this.logger.warn(`段階的アクセス失敗: ${error instanceof Error ? error.message : String(error)}`);
            return false;
        }
    }
    generateSearchQuery(targetUrl) {
        const domain = new URL(targetUrl).hostname;
        const siteQueries = {
            'athome.co.jp': 'アットホーム 賃貸 物件検索',
            'suumo.jp': 'SUUMO スーモ 不動産',
            'homes.co.jp': 'ホームズ 賃貸 マンション',
            'chintai.mynavi.jp': 'マイナビ賃貸 物件情報',
        };
        return siteQueries[domain] || `${domain} 不動産 物件`;
    }
};
exports.BotProtectionService = BotProtectionService;
exports.BotProtectionService = BotProtectionService = BotProtectionService_1 = __decorate([
    (0, common_1.Injectable)(),
    __metadata("design:paramtypes", [browser_stealth_service_1.BrowserStealthService])
], BotProtectionService);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL3R0dGVsYS9Eb2N1bWVudHMvV29yay9kZW5vZi93b3Jrcy8yNTA1Mjlzb2t1YnV0c3UvZGV2Mi9zcmMvZmVhdHVyZXMvYm90LXByb3RlY3Rpb24vYm90LXByb3RlY3Rpb24uc2VydmljZS50cyIsIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7O0FBQUEsMkNBS3dCO0FBQ3hCLDJDQUE2RTtBQUM3RSxtRkFBOEU7QUFDOUUsaUZBQTRFO0FBa0JyRSxJQUFNLG9CQUFvQiw0QkFBMUIsTUFBTSxvQkFBb0I7SUFXRjtJQVZaLE1BQU0sR0FBRyxJQUFJLGVBQU0sQ0FBQyxzQkFBb0IsQ0FBQyxJQUFJLENBQUMsQ0FBQztJQUN4RCxPQUFPLEdBQW1CLElBQUksQ0FBQztJQUMvQixRQUFRLEdBQTZCLElBQUksR0FBRyxFQUFFLENBQUM7SUFDL0MsVUFBVSxHQUErQixJQUFJLEdBQUcsRUFBRSxDQUFDO0lBRTFDLGtCQUFrQixHQUFHLEVBQUUsR0FBRyxFQUFFLEdBQUcsSUFBSSxDQUFDLENBQUMsTUFBTTtJQUMzQyxlQUFlLEdBQUcsQ0FBQyxDQUFDO0lBQ3BCLGFBQWEsR0FBRyxJQUFJLENBQUM7SUFDckIsWUFBWSxHQUFHLEtBQUssQ0FBQyxDQUFDLE9BQU87SUFFOUMsWUFBNkIscUJBQTRDO1FBQTVDLDBCQUFxQixHQUFyQixxQkFBcUIsQ0FBdUI7SUFBRyxDQUFDO0lBRTdFLEtBQUssQ0FBQyxZQUFZO1FBQ2hCLE1BQU0sSUFBSSxDQUFDLGlCQUFpQixFQUFFLENBQUM7SUFDakMsQ0FBQztJQUVELEtBQUssQ0FBQyxlQUFlO1FBQ25CLE1BQU0sSUFBSSxDQUFDLE9BQU8sRUFBRSxDQUFDO0lBQ3ZCLENBQUM7SUFFTyxLQUFLLENBQUMsaUJBQWlCO1FBQzdCLElBQUksQ0FBQyxJQUFJLENBQUMsT0FBTyxFQUFFLENBQUM7WUFDbEIsSUFBSSxDQUFDLE9BQU8sR0FBRyxNQUFNLHFCQUFRLENBQUMsTUFBTSxDQUFDO2dCQUNuQyxRQUFRLEVBQUUsSUFBSTtnQkFDZCxJQUFJLEVBQUUs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QkFDSCxNQUFNLElBQUksQ0FBQyxxQkFBcUIsQ0FBQyx3QkFBd0IsQ0FBQyxJQUFJLENBQUMsQ0FBQztZQUNsRSxDQUFDO1lBRUQsc0JBQXNCO1lBQ3RCLE1BQU0sSUFBSSxDQUFDLElBQUksQ0FBQyxTQUFTLEVBQUUsRUFBRSxTQUFTLEVBQUUsYUFBYSxFQUFFLE9BQU8sRUFBRSxLQUFLLEVBQUUsQ0FBQyxDQUFDO1lBRXpFLE9BQU8sSUFBSSxDQUFDO1FBQ2QsQ0FBQztRQUFDLE9BQU8sS0FBSyxFQUFFLENBQUM7WUFDZixJQUFJLENBQUMsTUFBTSxDQUFDLElBQUksQ0FDZCxjQUFjLEtBQUssWUFBWSxLQUFLLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsRUFBRSxDQUN2RSxDQUFDO1lBQ0YsT0FBTyxLQUFLLENBQUM7UUFDZixDQUFDO0lBQ0gsQ0FBQztJQUVPLG1CQUFtQixDQUFDLFNBQWlCO1FBQzNDLE1BQU0sTUFBTSxHQUFHLElBQUksR0FBRyxDQUFDLFNBQVMsQ0FBQyxDQUFDLFFBQVEsQ0FBQztRQUUzQyxNQUFNLFdBQVcsR0FBOEI7WUFDN0MsY0FBYyxFQUFFLGdCQUFnQjtZQUNoQyxVQUFVLEVBQUUsZUFBZTtZQUMzQixhQUFhLEVBQUUsZUFBZTtZQUM5QixtQkFBbUIsRUFBRSxhQUFhO1NBQ25DLENBQUM7UUFFRixPQUFPLFdBQVcsQ0FBQyxNQUFNLENBQUMsSUFBSSxHQUFHLE1BQU0sU0FBUyxDQUFDO0lBQ25ELENBQUM7Q0FDRixDQUFBO0FBM1hZLG9EQUFvQjsrQkFBcEIsb0JBQW9CO0lBRGhDLElBQUEsbUJBQVUsR0FBRTtxQ0FZeUMsK0NBQXFCO0dBWDlELG9CQUFvQixDQTJYaEMiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiL1VzZXJzL3R0dGVsYS9Eb2N1bWVudHMvV29yay9kZW5vZi93b3Jrcy8yNTA1Mjlzb2t1YnV0c3UvZGV2Mi9zcmMvZmVhdHVyZXMvYm90LXByb3RlY3Rpb24vYm90LXByb3RlY3Rpb24uc2VydmljZS50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xuICBJbmplY3RhYmxlLFxuICBMb2dnZXIsXG4gIE9uTW9kdWxlSW5pdCxcbiAgT25Nb2R1bGVEZXN0cm95LFxufSBmcm9tICdAbmVzdGpzL2NvbW1vbic7XG5pbXBvcnQgeyBCcm93c2VyLCBCcm93c2VyQ29udGV4dCwgY2hyb21pdW0sIENvb2tpZSwgUGFnZSB9IGZyb20gJ3BsYXl3cmlnaHQnO1xuaW1wb3J0IHsgYm90UHJvdGVjdGlvbkNvbmZpZyB9IGZyb20gJy4uLy4uL2NvcmUvY29uZmlnL2JvdC1wcm90ZWN0aW9uLmNvbmZpZyc7XG5pbXBvcnQgeyBCcm93c2VyU3RlYWx0aFNlcnZpY2UgfSBmcm9tICcuLi9zY3JhcGluZy9icm93c2VyLXN0ZWFsdGguc2VydmljZSc7XG5cbmludGVyZmFjZSBTZXNzaW9uRGF0YSB7XG4gIGNvbnRleHQ6IEJyb3dzZXJDb250ZXh0O1xuICBjb29raWVzOiBDb29raWVbXTtcbiAgbGFzdEFjY2Vzc1RpbWU6IERhdGU7XG4gIGVycm9yQ291bnQ6IG51bWJlcjtcbiAgZG9tYWluOiBzdHJpbmc7XG59XG5cbmludGVyZmFjZSBSYXRlTGltaXREYXRhIHtcbiAgZG9tYWluOiBzdHJpbmc7XG4gIGVycm9yQ291bnQ6IG51bWJlcjtcbiAgbGFzdEVycm9yVGltZTogRGF0ZTtcbiAgY3VycmVudERlbGF5OiBudW1iZXI7XG59XG5cbkBJbmplY3RhYmxlKClcbmV4cG9ydCBjbGFzcyBCb3RQcm90ZWN0aW9uU2VydmljZSBpbXBsZW1lbnRzIE9uTW9kdWxlSW5pdCwgT25Nb2R1bGVEZXN0cm95IHtcbiAgcHJpdmF0ZSByZWFkb25seSBsb2dnZXIgPSBuZXcgTG9nZ2VyKEJvdFByb3RlY3Rpb25TZXJ2aWNlLm5hbWUpO1xuICBwcml2YXRlIGJyb3dzZXI6IEJyb3dzZXIgfCBudWxsID0gbnVsbDtcbiAgcHJpdmF0ZSBzZXNzaW9uczogTWFwPHN0cmluZywgU2Vzc2lvbkRhdGE+ID0gbmV3IE1hcCgpO1xuICBwcml2YXRlIHJhdGVMaW1pdHM6IE1hcDxzdHJpbmcsIFJhdGVMaW1pdERhdGE+ID0gbmV3IE1hcCgpO1xuXG4gIHByaXZhdGUgcmVhZG9ubHkgU0VTU0lPTl9USU1FT1VUX01TID0gMzAgKiA2MCAqIDEwMDA7IC8vIDMw5YiGXG4gIHByaXZhdGUgcmVhZG9ubHkgTUFYX0VSUk9SX0NPVU5UID0gNTtcbiAgcHJpdmF0ZSByZWFkb25seSBCQVNFX0RFTEFZX01TID0gMTAwMDtcbiAgcHJpdmF0ZSByZWFkb25seSBNQVhfREVMQVlfTVMgPSA2MDAwMDsgLy8g5pyA5aSnMeWIhlxuXG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgcmVhZG9ubHkgYnJvd3NlclN0ZWFsdGhTZXJ2aWNlOiBCcm93c2VyU3RlYWx0aFNlcnZpY2UpIHt9XG5cbiAgYXN5bmMgb25Nb2R1bGVJbml0KCkge1xuICAgIGF3YWl0IHRoaXMuaW5pdGlhbGl6ZUJyb3dzZXIoKTtcbiAgfVxuXG4gIGFzeW5jIG9uTW9kdWxlRGVzdHJveSgpIHtcbiAgICBhd2FpdCB0aGlzLmNsZWFudXAoKTtcbiAgfVxuXG4gIHByaXZhdGUgYXN5bmMgaW5pdGlhbGl6ZUJyb3dzZXIoKSB7XG4gICAgaWYgKCF0aGlzLmJyb3dzZXIpIHtcbiAgICAgIHRoaXMuYnJvd3NlciA9IGF3YWl0IGNocm9taXVtLmxhdW5jaCh7XG4gICAgICAgIGhlYWRsZXNzOiB0cnVlLFxuICAgICAgICBhcmdzOiBib3RQcm90ZWN0aW9uQ29uZmlnLnBsYXl3cmlnaHRPcHRpb25zLmFyZ3MsXG4gICAgICB9KTtcbiAgICAgIHRoaXMubG9nZ2VyLmxvZygnQnJvd3NlciBpbml0aWFsaXplZCcpO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgYXN5bmMgY2xlYW51cCgpIHtcbiAgICAvLyDjgZnjgbnjgabjga7jgrvjg4Pjgrfjg6fjg7PjgpLjgq/jg6rjg7zjg7PjgqLjg4Pjg5dcbiAgICBmb3IgKGNvbnN0IFtfZG9tYWluLCBzZXNzaW9uXSBvZiB0aGlzLnNlc3Npb25zLmVudHJpZXMoKSkge1xuICAgICAgYXdhaXQgc2Vzc2lvbi5jb250ZXh0LmNsb3NlKCk7XG4gICAgfVxuICAgIHRoaXMuc2Vzc2lvbnMuY2xlYXIoKTtcblxuICAgIC8vIOODluODqeOCpuOCtuOCkuOCr+ODreODvOOCulxuICAgIGlmICh0aGlzLmJyb3dzZXIpIHtcbiAgICAgIGF3YWl0IHRoaXMuYnJvd3Nlci5jbG9zZSgpO1xuICAgICAgdGhpcy5icm93c2VyID0gbnVsbDtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICog44OJ44Oh44Kk44Oz55So44Gu44K744OD44K344On44Oz44KS5Y+W5b6X44G+44Gf44Gv5L2c5oiQXG4gICAqL1xuICBhc3luYyBnZXRPckNyZWF0ZVNlc3Npb24oZG9tYWluOiBzdHJpbmcpOiBQcm9taXNlPEJyb3dzZXJDb250ZXh0PiB7XG4gICAgLy8g5pei5a2Y44Gu44K744OD44K344On44Oz44KS44OB44Kn44OD44KvXG4gICAgY29uc3QgZXhpc3RpbmdTZXNzaW9uID0gdGhpcy5zZXNzaW9ucy5nZXQoZG9tYWluKTtcblxuICAgIGlmIChleGlzdGluZ1Nlc3Npb24pIHtcbiAgICAgIGNvbnN0IHNlc3Npb25BZ2UgPSBEYXRlLm5vdygpIC0gZXhpc3RpbmdTZXNzaW9uLmxhc3RBY2Nlc3NUaW1lLmdldFRpbWUoKTtcblxuICAgICAgLy8g44K744OD44K344On44Oz44K/44Kk44Og44Ki44Km44OI44OB44Kn44OD44KvXG4gICAgICBpZiAoc2Vzc2lvbkFnZSA8IHRoaXMuU0VTU0lPTl9USU1FT1VUX01TKSB7XG4gICAgICAgIGV4aXN0aW5nU2Vzc2lvbi5sYXN0QWNjZXNzVGltZSA9IG5ldyBEYXRlKCk7XG4gICAgICAgIHJldHVybiBleGlzdGluZ1Nlc3Npb24uY29udGV4dDtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHRoaXMubG9nZ2VyLndhcm4oYFNlc3Npb24gdGltZW91dCBmb3IgJHtkb21haW59LCBjcmVhdGluZyBuZXcgc2Vzc2lvbmApO1xuICAgICAgICBhd2FpdCBleGlzdGluZ1Nlc3Npb24uY29udGV4dC5jbG9zZSgpO1xuICAgICAgICB0aGlzLnNlc3Npb25zLmRlbGV0ZShkb21haW4pO1xuICAgICAgfVxuICAgIH1cblxuICAgIC8vIOaWsOOBl+OBhOOCu+ODg+OCt+ODp+ODs+OCkuS9nOaIkFxuICAgIHJldHVybiBhd2FpdCB0aGlzLmNyZWF0ZU5ld1Nlc3Npb24oZG9tYWluKTtcbiAgfVxuXG4gIHByaXZhdGUgYXN5bmMgY3JlYXRlTmV3U2Vzc2lvbihkb21haW46IHN0cmluZyk6IFByb21pc2U8QnJvd3NlckNvbnRleHQ+IHtcbiAgICBpZiAoIXRoaXMuYnJvd3Nlcikge1xuICAgICAgYXdhaXQgdGhpcy5pbml0aWFsaXplQnJvd3NlcigpO1xuICAgIH1cblxuICAgIGlmICghdGhpcy5icm93c2VyKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ0Jyb3dzZXIgbm90IGluaXRpYWxpemVkJyk7XG4gICAgfVxuICAgIGNvbnN0IGNvbnRleHQgPSBhd2FpdCB0aGlzLmJyb3dzZXIubmV3Q29udGV4dCh7XG4gICAgICB1c2VyQWdlbnQ6IHRoaXMuZ2V0UmFuZG9tVXNlckFnZW50KCksXG4gICAgICB2aWV3cG9ydDogeyB3aWR0aDogMTkyMCwgaGVpZ2h0OiAxMDgwIH0sXG4gICAgICBsb2NhbGU6ICdqYS1KUCcsXG4gICAgICB0aW1lem9uZUlkOiAnQXNpYS9Ub2t5bycsXG4gICAgfSk7XG5cbiAgICBjb25zdCBzZXNzaW9uRGF0YTogU2Vzc2lvbkRhdGEgPSB7XG4gICAgICBjb250ZXh0LFxuICAgICAgY29va2llczogW10sXG4gICAgICBsYXN0QWNjZXNzVGltZTogbmV3IERhdGUoKSxcbiAgICAgIGVycm9yQ291bnQ6IDAsXG4gICAgICBkb21haW4sXG4gICAgfTtcblxuICAgIHRoaXMuc2Vzc2lvbnMuc2V0KGRvbWFpbiwgc2Vzc2lvbkRhdGEpO1xuICAgIHRoaXMubG9nZ2VyLmxvZyhgTmV3IHNlc3Npb24gY3JlYXRlZCBmb3IgJHtkb21haW59YCk7XG5cbiAgICByZXR1cm4gY29udGV4dDtcbiAgfVxuXG4gIC8qKlxuICAgKiBHb29nbGXntYznlLHjgafjgrXjgqTjg4jjgavjgqLjgq/jgrvjgrlcbiAgICovXG4gIGFzeW5jIGFjY2Vzc1ZpYUdvb2dsZShcbiAgICB0YXJnZXRVcmw6IHN0cmluZyxcbiAgICBzZWFyY2hRdWVyeTogc3RyaW5nLFxuICApOiBQcm9taXNlPGJvb2xlYW4+IHtcbiAgICBjb25zdCBkb21haW4gPSBuZXcgVVJMKHRhcmdldFVybCkuaG9zdG5hbWU7XG4gICAgY29uc3QgY29udGV4dCA9IGF3YWl0IHRoaXMuZ2V0T3JDcmVhdGVTZXNzaW9uKGRvbWFpbik7XG4gICAgY29uc3QgcGFnZSA9IGF3YWl0IGNvbnRleHQubmV3UGFnZSgpO1xuXG4gICAgdHJ5IHtcbiAgICAgIC8vIFN0ZXAgMTogQm905qSc55+l44OG44K544OI44K144Kk44OI44G444Gu44Ki44Kv44K744K5XG4gICAgICBhd2FpdCBwYWdlLmdvdG8oJ2h0dHBzOi8vYm90LnNhbm55c29mdC5jb20nLCB7XG4gICAgICAgIHdhaXRVbnRpbDogJ25ldHdvcmtpZGxlJyxcbiAgICAgICAgdGltZW91dDogMzAwMDAsXG4gICAgICB9KTtcblxuICAgICAgLy8gU3RlcCAyOiAz56eS6ZaT44Gu5b6F5qmf77yI6YeN6KaB77ya44GT44Gu5b6F5qmf5pmC6ZaT44Gv5b+F6aCI77yJXG4gICAgICBhd2FpdCBuZXcgUHJvbWlzZSgocmVzb2x2ZSkgPT4gc2V0VGltZW91dChyZXNvbHZlLCAzMDAwKSk7XG5cbiAgICAgIC8vIFN0ZXAgMzogR29vZ2xl44G444Gu44Ki44Kv44K744K5XG4gICAgICBhd2FpdCBwYWdlLmdvdG8oJ2h0dHBzOi8vd3d3Lmdvb2dsZS5jb20nLCB7XG4gICAgICAgIHdhaXRVbnRpbDogJ25ldHdvcmtpZGxlJyxcbiAgICAgICAgdGltZW91dDogMzAwMDAsXG4gICAgICB9KTtcblxuICAgICAgLy8gU3RlcCA0OiDmpJzntKLlrp/ooYxcbiAgICAgIC8vIEdvb2dsZeOBruaknOe0ouODnOODg+OCr+OCueOCkuikh+aVsOOBruOCu+ODrOOCr+OCv+OBp+ippuihjFxuICAgICAgbGV0IHNlYXJjaEJveDtcbiAgICAgIHRyeSB7XG4gICAgICAgIHNlYXJjaEJveCA9IGF3YWl0IHBhZ2Uud2FpdEZvclNlbGVjdG9yKCdpbnB1dFtuYW1lPVwicVwiXScsIHtcbiAgICAgICAgICB0aW1lb3V0OiA1MDAwLFxuICAgICAgICB9KTtcbiAgICAgIH0gY2F0Y2gge1xuICAgICAgICAvLyDliKXjga7jgrvjg6zjgq/jgr/jgpLoqabooYxcbiAgICAgICAgc2VhcmNoQm94ID0gYXdhaXQgcGFnZS53YWl0Rm9yU2VsZWN0b3IoJ3RleHRhcmVhW25hbWU9XCJxXCJdJywge1xuICAgICAgICAgIHRpbWVvdXQ6IDUwMDAsXG4gICAgICAgIH0pO1xuICAgICAgfVxuXG4gICAgICBhd2FpdCBzZWFyY2hCb3gudHlwZShzZWFyY2hRdWVyeSwgeyBkZWxheTogMTAwIH0pO1xuICAgICAgYXdhaXQgc2VhcmNoQm94LnByZXNzKCdFbnRlcicpO1xuXG4gICAgICAvLyBTdGVwIDU6IOaknOe0oue1kOaenOOBruW+heapn1xuICAgICAgYXdhaXQgcGFnZS53YWl0Rm9yU2VsZWN0b3IoJyNzZWFyY2gnLCB7IHRpbWVvdXQ6IDE1MDAwIH0pO1xuXG4gICAgICAvLyBTdGVwIDY6IOebrueahOOCteOCpOODiOOBruODquODs+OCr+OCkuaOouOBl+OBpuOCr+ODquODg+OCr1xuICAgICAgY29uc3QgdGFyZ2V0RG9tYWluID0gbmV3IFVSTCh0YXJnZXRVcmwpLmhvc3RuYW1lO1xuICAgICAgY29uc3QgbGlua3MgPSBhd2FpdCBwYWdlLiQkZXZhbChcbiAgICAgICAgJ2FbaHJlZl0nLFxuICAgICAgICAoZWxlbWVudHMsIGRvbWFpbikgPT4ge1xuICAgICAgICAgIHJldHVybiBlbGVtZW50c1xuICAgICAgICAgICAgLmZpbHRlcigoZWwpID0+IChlbCBhcyBIVE1MQW5jaG9yRWxlbWVudCkuaHJlZi5pbmNsdWRlcyhkb21haW4pKVxuICAgICAgICAgICAgLm1hcCgoZWwpID0+ICh7XG4gICAgICAgICAgICAgIGhyZWY6IChlbCBhcyBIVE1MQW5jaG9yRWxlbWVudCkuaHJlZixcbiAgICAgICAgICAgICAgdGV4dDogZWwudGV4dENvbnRlbnQsXG4gICAgICAgICAgICB9KSk7XG4gICAgICAgIH0sXG4gICAgICAgIHRhcmdldERvbWFpbixcbiAgICAgICk7XG5cbiAgICAgIGlmIChsaW5rcy5sZW5ndGggPT09IDApIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBObyBsaW5rcyBmb3VuZCBmb3IgZG9tYWluOiAke3RhcmdldERvbWFpbn1gKTtcbiAgICAgIH1cblxuICAgICAgLy8gU3RlcCA3OiDmnIDliJ3jga7jg6rjg7Pjgq/jgpLjgq/jg6rjg4Pjgq9cbiAgICAgIGF3YWl0IHBhZ2UuY2xpY2soYGFbaHJlZio9XCIke3RhcmdldERvbWFpbn1cIl1gKTtcbiAgICAgIGF3YWl0IHBhZ2Uud2FpdEZvckxvYWRTdGF0ZSgnbmV0d29ya2lkbGUnKTtcblxuICAgICAgdGhpcy5sb2dnZXIubG9nKGBTdWNjZXNzZnVsbHkgYWNjZXNzZWQgJHt0YXJnZXRVcmx9IHZpYSBHb29nbGVgKTtcbiAgICAgIHJldHVybiB0cnVlO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICB0aGlzLmxvZ2dlci5lcnJvcihcbiAgICAgICAgYEdvb2dsZee1jOeUseOCouOCr+OCu+OCueWkseaVlzogJHtlcnJvciBpbnN0YW5jZW9mIEVycm9yID8gZXJyb3IubWVzc2FnZSA6IFN0cmluZyhlcnJvcil9YCxcbiAgICAgICk7XG4gICAgICByZXR1cm4gZmFsc2U7XG4gICAgfSBmaW5hbGx5IHtcbiAgICAgIGF3YWl0IHBhZ2UuY2xvc2UoKTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogQm905qSc55+l44OG44K544OI77yIM+autemaju+8iVxuICAgKi9cbiAgdGVzdEJvdERldGVjdGlvbihfdXJsOiBzdHJpbmcpOiB7XG4gICAgaHR0cEFjY2Vzc2libGU6IGJvb2xlYW47XG4gICAganNkb21BY2Nlc3NpYmxlOiBib29sZWFuO1xuICAgIHBsYXl3cmlnaHRBY2Nlc3NpYmxlOiBib29sZWFuO1xuICB9IHtcbiAgICBjb25zdCByZXN1bHRzID0ge1xuICAgICAgaHR0cEFjY2Vzc2libGU6IGZhbHNlLFxuICAgICAganNkb21BY2Nlc3NpYmxlOiBmYWxzZSxcbiAgICAgIHBsYXl3cmlnaHRBY2Nlc3NpYmxlOiBmYWxzZSxcbiAgICB9O1xuXG4gICAgLy8g44GT44Gu6YOo5YiG44GvU2NyYXBpbmdTZXJ2aWNl44Go6YCj5pC644GX44Gm5a6f6KOFXG4gICAgLy8g5ZCE5omL5rOV44Gn44Ki44Kv44K744K544KS6Kmm44G/44CB5oiQ5YqfL+WkseaVl+OCkuiomOmMslxuXG4gICAgcmV0dXJuIHJlc3VsdHM7XG4gIH1cblxuICAvKipcbiAgICog44Os44O844OI5Yi26ZmQ44Gu5Y+W5b6X44Go5pu05pawXG4gICAqL1xuICBnZXRBZGFwdGl2ZURlbGF5KGRvbWFpbjogc3RyaW5nLCBpc0Vycm9yOiBib29sZWFuID0gZmFsc2UpOiBudW1iZXIge1xuICAgIGNvbnN0IHJhdGVMaW1pdCA9IHRoaXMucmF0ZUxpbWl0cy5nZXQoZG9tYWluKSB8fCB7XG4gICAgICBkb21haW4sXG4gICAgICBlcnJvckNvdW50OiAwLFxuICAgICAgbGFzdEVycm9yVGltZTogbmV3IERhdGUoMCksXG4gICAgICBjdXJyZW50RGVsYXk6IHRoaXMuQkFTRV9ERUxBWV9NUyxcbiAgICB9O1xuXG4gICAgaWYgKGlzRXJyb3IpIHtcbiAgICAgIC8vIOOCqOODqeODvOOCq+OCpuODs+ODiOOCkuWil+WKoFxuICAgICAgcmF0ZUxpbWl0LmVycm9yQ291bnQrKztcbiAgICAgIHJhdGVMaW1pdC5sYXN0RXJyb3JUaW1lID0gbmV3IERhdGUoKTtcblxuICAgICAgLy8g5oyH5pWw6Zai5pWw55qE44Gr44OH44Kj44Os44Kk44KS5aKX5YqgXG4gICAgICByYXRlTGltaXQuY3VycmVudERlbGF5ID0gTWF0aC5taW4oXG4gICAgICAgIHRoaXMuQkFTRV9ERUxBWV9NUyAqIE1hdGgucG93KDIsIHJhdGVMaW1pdC5lcnJvckNvdW50KSxcbiAgICAgICAgdGhpcy5NQVhfREVMQVlfTVMsXG4gICAgICApO1xuXG4gICAgICB0aGlzLmxvZ2dlci53YXJuKFxuICAgICAgICBgUmF0ZSBsaW1pdCBpbmNyZWFzZWQgZm9yICR7ZG9tYWlufTogJHtTdHJpbmcocmF0ZUxpbWl0LmN1cnJlbnREZWxheSl9bXNgLFxuICAgICAgKTtcbiAgICB9IGVsc2Uge1xuICAgICAgLy8g5oiQ5Yqf5pmC44Gv5b6Q44CF44Gr44OH44Kj44Os44Kk44KS5rib5bCRXG4gICAgICBjb25zdCB0aW1lU2luY2VMYXN0RXJyb3IgPSBEYXRlLm5vdygpIC0gcmF0ZUxpbWl0Lmxhc3RFcnJvclRpbWUuZ2V0VGltZSgpO1xuXG4gICAgICBpZiAodGltZVNpbmNlTGFzdEVycm9yID4gNSAqIDYwICogMTAwMCkge1xuICAgICAgICAvLyA15YiG5Lul5LiK44Ko44Op44O844Gq44GXXG4gICAgICAgIHJhdGVMaW1pdC5lcnJvckNvdW50ID0gTWF0aC5tYXgoMCwgcmF0ZUxpbWl0LmVycm9yQ291bnQgLSAxKTtcbiAgICAgICAgcmF0ZUxpbWl0LmN1cnJlbnREZWxheSA9IE1hdGgubWF4KFxuICAgICAgICAgIHRoaXMuQkFTRV9ERUxBWV9NUyxcbiAgICAgICAgICByYXRlTGltaXQuY3VycmVudERlbGF5ICogMC44LFxuICAgICAgICApO1xuICAgICAgfVxuICAgIH1cblxuICAgIHRoaXMucmF0ZUxpbWl0cy5zZXQoZG9tYWluLCByYXRlTGltaXQpO1xuXG4gICAgLy8g44Op44Oz44OA44Og5oCn44KS6L+95YqgXG4gICAgY29uc3Qgaml0dGVyID0gcmF0ZUxpbWl0LmN1cnJlbnREZWxheSAqIDAuMjtcbiAgICByZXR1cm4gcmF0ZUxpbWl0LmN1cnJlbnREZWxheSArIChNYXRoLnJhbmRvbSgpIC0gMC41KSAqIGppdHRlcjtcbiAgfVxuXG4gIC8qKlxuICAgKiBDb29raWXjga7kv53lrZjjgajlvqnlhYNcbiAgICovXG4gIGFzeW5jIHNhdmVDb29raWVzKGRvbWFpbjogc3RyaW5nKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgY29uc3Qgc2Vzc2lvbiA9IHRoaXMuc2Vzc2lvbnMuZ2V0KGRvbWFpbik7XG4gICAgaWYgKHNlc3Npb24pIHtcbiAgICAgIHNlc3Npb24uY29va2llcyA9IGF3YWl0IHNlc3Npb24uY29udGV4dC5jb29raWVzKCk7XG4gICAgICB0aGlzLmxvZ2dlci5kZWJ1ZyhcbiAgICAgICAgYFNhdmVkICR7U3RyaW5nKHNlc3Npb24uY29va2llcy5sZW5ndGgpfSBjb29raWVzIGZvciAke2RvbWFpbn1gLFxuICAgICAgKTtcbiAgICB9XG4gIH1cblxuICBhc3luYyByZXN0b3JlQ29va2llcyhkb21haW46IHN0cmluZyk6IFByb21pc2U8dm9pZD4ge1xuICAgIGNvbnN0IHNlc3Npb24gPSB0aGlzLnNlc3Npb25zLmdldChkb21haW4pO1xuICAgIGlmIChzZXNzaW9uICYmIHNlc3Npb24uY29va2llcy5sZW5ndGggPiAwKSB7XG4gICAgICBhd2FpdCBzZXNzaW9uLmNvbnRleHQuYWRkQ29va2llcyhzZXNzaW9uLmNvb2tpZXMpO1xuICAgICAgdGhpcy5sb2dnZXIuZGVidWcoXG4gICAgICAgIGBSZXN0b3JlZCAke1N0cmluZyhzZXNzaW9uLmNvb2tpZXMubGVuZ3RoKX0gY29va2llcyBmb3IgJHtkb21haW59YCxcbiAgICAgICk7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBnZXRSYW5kb21Vc2VyQWdlbnQoKTogc3RyaW5nIHtcbiAgICBjb25zdCB1c2VyQWdlbnRzID0gYm90UHJvdGVjdGlvbkNvbmZpZy51c2VyQWdlbnRzO1xuICAgIHJldHVybiB1c2VyQWdlbnRzW01hdGguZmxvb3IoTWF0aC5yYW5kb20oKSAqIHVzZXJBZ2VudHMubGVuZ3RoKV07XG4gIH1cblxuICBwcml2YXRlIGFzeW5jIGh1bWFuRGVsYXkoKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgY29uc3QgZGVsYXkgPSA1MDAgKyBNYXRoLnJhbmRvbSgpICogMjAwMDsgLy8gMC4144CcMi4156eSXG4gICAgYXdhaXQgbmV3IFByb21pc2UoKHJlc29sdmUpID0+IHNldFRpbWVvdXQocmVzb2x2ZSwgZGVsYXkpKTtcbiAgfVxuXG4gIHByaXZhdGUgZ2V0UmFuZG9tVHlwaW5nRGVsYXkoKTogbnVtYmVyIHtcbiAgICByZXR1cm4gNTAgKyBNYXRoLnJhbmRvbSgpICogMTUwOyAvLyA1MOOAnDIwMG1zL+aWh+Wtl1xuICB9XG5cbiAgLyoqXG4gICAqIOmrmOW6puOBqkJvdOWvvuetluOCkuWun+ihjFxuICAgKi9cbiAgYXN5bmMgcGVyZm9ybUFkdmFuY2VkQm90UHJvdGVjdGlvbihcbiAgICBwYWdlOiBQYWdlLFxuICAgIHRhcmdldFVybDogc3RyaW5nLFxuICApOiBQcm9taXNlPGJvb2xlYW4+IHtcbiAgICB0cnkge1xuICAgICAgLy8gU3RlcCAxOiDjg5bjg6njgqbjgrbjgrnjg4bjg6vjgrnmqZ/og73jga7pgannlKhcbiAgICAgIGF3YWl0IHRoaXMuYnJvd3NlclN0ZWFsdGhTZXJ2aWNlLmFwcGx5U3RlYWx0aE1lYXN1cmVzKHBhZ2UpO1xuXG4gICAgICAvLyBTdGVwIDI6IOautemajueahOOBquOCteOCpOODiOOCouOCr+OCu+OCuVxuICAgICAgY29uc3Qgc3VjY2VzcyA9IGF3YWl0IHRoaXMuZ3JhZHVhdGVkQWNjZXNzKHBhZ2UsIHRhcmdldFVybCk7XG5cbiAgICAgIGlmICghc3VjY2Vzcykge1xuICAgICAgICAvLyBTdGVwIDM6IEdvb2dsZee1jOeUseOCouOCr+OCu+OCueOBruWun+ihjFxuICAgICAgICByZXR1cm4gYXdhaXQgdGhpcy5hY2Nlc3NWaWFHb29nbGUoXG4gICAgICAgICAgdGFyZ2V0VXJsLFxuICAgICAgICAgIHRoaXMuZ2VuZXJhdGVTZWFyY2hRdWVyeSh0YXJnZXRVcmwpLFxuICAgICAgICApO1xuICAgICAgfVxuXG4gICAgICByZXR1cm4gdHJ1ZTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgdGhpcy5sb2dnZXIuZXJyb3IoXG4gICAgICAgIGDpq5jluqbjgapCb3Tlr77nrZblrp/ooYzlpLHmlZc6ICR7ZXJyb3IgaW5zdGFuY2VvZiBFcnJvciA/IGVycm9yLm1lc3NhZ2UgOiBTdHJpbmcoZXJyb3IpfWAsXG4gICAgICApO1xuICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgYXN5bmMgZ3JhZHVhdGVkQWNjZXNzKFxuICAgIHBhZ2U6IFBhZ2UsXG4gICAgdGFyZ2V0VXJsOiBzdHJpbmcsXG4gICk6IFByb21pc2U8Ym9vbGVhbj4ge1xuICAgIGNvbnN0IGRvbWFpbiA9IG5ldyBVUkwodGFyZ2V0VXJsKS5ob3N0bmFtZTtcblxuICAgIHRyeSB7XG4gICAgICAvLyBTdGVwIDE6IOODieODoeOCpOODs+OBruODiOODg+ODl+ODmuODvOOCuOOBq+OCouOCr+OCu+OCuVxuICAgICAgY29uc3QgdG9wUGFnZVVybCA9IGBodHRwczovLyR7ZG9tYWlufWA7XG4gICAgICBhd2FpdCBwYWdlLmdvdG8odG9wUGFnZVVybCwgeyB3YWl0VW50aWw6ICduZXR3b3JraWRsZScsIHRpbWVvdXQ6IDMwMDAwIH0pO1xuICAgICAgYXdhaXQgdGhpcy5icm93c2VyU3RlYWx0aFNlcnZpY2Uuc2ltdWxhdGVIdW1hbkludGVyYWN0aW9uKHBhZ2UpO1xuXG4gICAgICAvLyBTdGVwIDI6IOOCteOCpOODiOWGheOBruWIpeODmuODvOOCuOOBq+OCouOCr+OCu+OCuVxuICAgICAgY29uc3QgaW50ZXJuYWxMaW5rcyA9IGF3YWl0IHBhZ2UuJCRldmFsKFxuICAgICAgICAnYVtocmVmXScsXG4gICAgICAgIChsaW5rcywgY3VycmVudERvbWFpbikgPT4ge1xuICAgICAgICAgIHJldHVybiBsaW5rc1xuICAgICAgICAgICAgLmZpbHRlcigobGluaykgPT4ge1xuICAgICAgICAgICAgICBjb25zdCBocmVmID0gKGxpbmsgYXMgSFRNTEFuY2hvckVsZW1lbnQpLmhyZWY7XG4gICAgICAgICAgICAgIHJldHVybiAoXG4gICAgICAgICAgICAgICAgaHJlZi5pbmNsdWRlcyhjdXJyZW50RG9tYWluKSAmJiBocmVmICE9PSB3aW5kb3cubG9jYXRpb24uaHJlZlxuICAgICAgICAgICAgICApO1xuICAgICAgICAgICAgfSlcbiAgICAgICAgICAgIC5zbGljZSgwLCAzKVxuICAgICAgICAgICAgLm1hcCgobGluaykgPT4gKGxpbmsgYXMgSFRNTEFuY2hvckVsZW1lbnQpLmhyZWYpO1xuICAgICAgICB9LFxuICAgICAgICBkb21haW4sXG4gICAgICApO1xuXG4gICAgICAvLyDlhoXpg6jjg6rjg7Pjgq/jgYzopovjgaTjgYvjgaPjgZ/loLTlkIjjgIHjg6njg7Pjg4Djg6Djgasx44Gk6YG444KT44Gn44Ki44Kv44K744K5XG4gICAgICBpZiAoaW50ZXJuYWxMaW5rcy5sZW5ndGggPiAwKSB7XG4gICAgICAgIGNvbnN0IHJhbmRvbUxpbmsgPVxuICAgICAgICAgIGludGVybmFsTGlua3NbTWF0aC5mbG9vcihNYXRoLnJhbmRvbSgpICogaW50ZXJuYWxMaW5rcy5sZW5ndGgpXTtcbiAgICAgICAgYXdhaXQgcGFnZS5nb3RvKHJhbmRvbUxpbmssIHtcbiAgICAgICAgICB3YWl0VW50aWw6ICduZXR3b3JraWRsZScsXG4gICAgICAgICAgdGltZW91dDogMzAwMDAsXG4gICAgICAgIH0pO1xuICAgICAgICBhd2FpdCB0aGlzLmJyb3dzZXJTdGVhbHRoU2VydmljZS5zaW11bGF0ZUh1bWFuSW50ZXJhY3Rpb24ocGFnZSk7XG4gICAgICB9XG5cbiAgICAgIC8vIFN0ZXAgMzog55uu55qE44Gu44Oa44O844K444Gr44Ki44Kv44K744K5XG4gICAgICBhd2FpdCBwYWdlLmdvdG8odGFyZ2V0VXJsLCB7IHdhaXRVbnRpbDogJ25ldHdvcmtpZGxlJywgdGltZW91dDogMzAwMDAgfSk7XG5cbiAgICAgIHJldHVybiB0cnVlO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICB0aGlzLmxvZ2dlci53YXJuKFxuICAgICAgICBg5q616ZqO55qE44Ki44Kv44K744K55aSx5pWXOiAke2Vycm9yIGluc3RhbmNlb2YgRXJyb3IgPyBlcnJvci5tZXNzYWdlIDogU3RyaW5nKGVycm9yKX1gLFxuICAgICAgKTtcbiAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIGdlbmVyYXRlU2VhcmNoUXVlcnkodGFyZ2V0VXJsOiBzdHJpbmcpOiBzdHJpbmcge1xuICAgIGNvbnN0IGRvbWFpbiA9IG5ldyBVUkwodGFyZ2V0VXJsKS5ob3N0bmFtZTtcblxuICAgIGNvbnN0IHNpdGVRdWVyaWVzOiB7IFtrZXk6IHN0cmluZ106IHN0cmluZyB9ID0ge1xuICAgICAgJ2F0aG9tZS5jby5qcCc6ICfjgqLjg4Pjg4jjg5vjg7zjg6Ag6LOD6LK4IOeJqeS7tuaknOe0oicsXG4gICAgICAnc3V1bW8uanAnOiAnU1VVTU8g44K544O844OiIOS4jeWLleeUoycsXG4gICAgICAnaG9tZXMuY28uanAnOiAn44Ob44O844Og44K6IOizg+iyuCDjg57jg7Pjgrfjg6fjg7MnLFxuICAgICAgJ2NoaW50YWkubXluYXZpLmpwJzogJ+ODnuOCpOODiuODk+izg+iyuCDnianku7bmg4XloLEnLFxuICAgIH07XG5cbiAgICByZXR1cm4gc2l0ZVF1ZXJpZXNbZG9tYWluXSB8fCBgJHtkb21haW59IOS4jeWLleeUoyDnianku7ZgO1xuICB9XG59XG4iXSwidmVyc2lvbiI6M30=