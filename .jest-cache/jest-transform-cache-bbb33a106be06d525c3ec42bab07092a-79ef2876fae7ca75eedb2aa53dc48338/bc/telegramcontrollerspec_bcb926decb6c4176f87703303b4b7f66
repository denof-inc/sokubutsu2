d8842fd5c0ebd698f123b25becf971ec
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const testing_1 = require("@nestjs/testing");
const telegram_controller_1 = require("./telegram.controller");
const auth_service_1 = require("../../core/auth/auth.service");
const telegram_service_1 = require("./telegram.service");
const telegram_webhook_guard_1 = require("../../common/guards/telegram-webhook.guard");
const telegram_auth_guard_1 = require("../../common/guards/telegram-auth.guard");
const rate_limit_guard_1 = require("../../common/guards/rate-limit.guard");
describe('TelegramController', () => {
    let controller;
    let authService;
    let telegramService;
    const mockUser = {
        id: 1,
        telegramId: '123456789',
        firstName: 'Test',
        lastName: 'User',
        username: 'testuser',
        isActive: true,
        languageCode: 'ja',
        settings: {
            notifications: { enabled: true, silent: false },
            language: 'ja',
        },
        lastActiveAt: new Date(),
        createdAt: new Date(),
        updatedAt: new Date(),
        fullName: 'Test User',
        displayName: 'testuser',
    };
    const mockTelegramUser = {
        id: 123456789,
        is_bot: false,
        first_name: 'Test',
        last_name: 'User',
        username: 'testuser',
        language_code: 'ja',
    };
    const mockUpdate = {
        update_id: 1,
        message: {
            message_id: 1,
            date: Date.now(),
            chat: {
                id: 123456789,
                type: 'private',
            },
            from: mockTelegramUser,
            text: '/start',
        },
    };
    beforeEach(async () => {
        const mockAuthService = {
            handleStartCommand: jest.fn(),
        };
        const mockTelegramService = {
            sendMessage: jest.fn(),
        };
        const module = await testing_1.Test.createTestingModule({
            controllers: [telegram_controller_1.TelegramController],
            providers: [
                { provide: auth_service_1.AuthService, useValue: mockAuthService },
                { provide: telegram_service_1.TelegramService, useValue: mockTelegramService },
            ],
        })
            .overrideGuard(telegram_webhook_guard_1.TelegramWebhookGuard)
            .useValue({ canActivate: () => true })
            .overrideGuard(telegram_auth_guard_1.TelegramAuthGuard)
            .useValue({ canActivate: () => true })
            .overrideGuard(rate_limit_guard_1.RateLimitGuard)
            .useValue({ canActivate: () => true })
            .compile();
        controller = module.get(telegram_controller_1.TelegramController);
        authService = module.get(auth_service_1.AuthService);
        telegramService = module.get(telegram_service_1.TelegramService);
    });
    it('should be defined', () => {
        expect(controller).toBeDefined();
    });
    describe('handleUpdate', () => {
        it('should handle /start command', async () => {
            authService.handleStartCommand.mockResolvedValue({
                user: mockUser,
                isNewUser: true,
                welcomeMessage: 'はじめまして！',
            });
            const result = await controller.handleUpdate(mockUpdate, mockUser, mockTelegramUser, true);
            expect(result).toEqual({ ok: true });
            expect(authService.handleStartCommand).toHaveBeenCalledWith(mockTelegramUser);
            expect(telegramService.sendMessage).toHaveBeenCalledWith(123456789, 'はじめまして！');
        });
        it('should handle /add command without URL', async () => {
            const update = {
                ...mockUpdate,
                message: {
                    ...(mockUpdate.message || {}),
                    text: '/add',
                },
            };
            await controller.handleUpdate(update, mockUser, mockTelegramUser, false);
            expect(telegramService.sendMessage).toHaveBeenCalledWith(123456789, expect.stringContaining('使用方法: /add <URL>'));
        });
        it('should handle /add command with invalid URL', async () => {
            const update = {
                ...mockUpdate,
                message: {
                    ...(mockUpdate.message || {}),
                    text: '/add invalid-url',
                },
            };
            await controller.handleUpdate(update, mockUser, mockTelegramUser, false);
            expect(telegramService.sendMessage).toHaveBeenCalledWith(123456789, '有効なURLを入力してください。');
        });
        it('should handle /add command with valid URL', async () => {
            const update = {
                ...mockUpdate,
                message: {
                    ...(mockUpdate.message || {}),
                    text: '/add https://example.com',
                },
            };
            await controller.handleUpdate(update, mockUser, mockTelegramUser, false);
            expect(telegramService.sendMessage).toHaveBeenCalledWith(123456789, expect.stringContaining('監視リストに追加しました'));
        });
        it('should handle /list command', async () => {
            const update = {
                ...mockUpdate,
                message: {
                    ...(mockUpdate.message || {}),
                    text: '/list',
                },
            };
            await controller.handleUpdate(update, mockUser, mockTelegramUser, false);
            expect(telegramService.sendMessage).toHaveBeenCalledWith(123456789, expect.stringContaining('監視中のURL一覧'));
        });
        it('should handle /help command', async () => {
            const update = {
                ...mockUpdate,
                message: {
                    ...(mockUpdate.message || {}),
                    text: '/help',
                },
            };
            await controller.handleUpdate(update, mockUser, mockTelegramUser, false);
            expect(telegramService.sendMessage).toHaveBeenCalledWith(123456789, expect.stringContaining('コマンド一覧'));
        });
        it('should handle unknown command', async () => {
            const update = {
                ...mockUpdate,
                message: {
                    ...(mockUpdate.message || {}),
                    text: '/unknown',
                },
            };
            await controller.handleUpdate(update, mockUser, mockTelegramUser, false);
            expect(telegramService.sendMessage).toHaveBeenCalledWith(123456789, '不明なコマンドです。/help でコマンド一覧を確認してください。');
        });
        it('should ignore non-text updates', async () => {
            const update = {
                ...mockUpdate,
                message: {
                    ...(mockUpdate.message || {}),
                    text: undefined,
                },
            };
            const result = await controller.handleUpdate(update, mockUser, mockTelegramUser, false);
            expect(result).toEqual({ ok: true });
            expect(telegramService.sendMessage).not.toHaveBeenCalled();
        });
        it('should handle errors gracefully', async () => {
            authService.handleStartCommand.mockRejectedValue(new Error('Test error'));
            await controller.handleUpdate(mockUpdate, mockUser, mockTelegramUser, true);
            expect(telegramService.sendMessage).toHaveBeenCalledWith(123456789, 'エラーが発生しました。しばらく待ってから再度お試しください。');
        });
        it('should handle /status command', async () => {
            const update = {
                ...mockUpdate,
                message: {
                    ...(mockUpdate.message || {}),
                    text: '/status',
                },
            };
            await controller.handleUpdate(update, mockUser, mockTelegramUser, false);
            expect(telegramService.sendMessage).toHaveBeenCalledWith(123456789, expect.stringContaining('監視状況'));
        });
        it('should handle /remove command without index', async () => {
            const update = {
                ...mockUpdate,
                message: {
                    ...(mockUpdate.message || {}),
                    text: '/remove',
                },
            };
            await controller.handleUpdate(update, mockUser, mockTelegramUser, false);
            expect(telegramService.sendMessage).toHaveBeenCalledWith(123456789, expect.stringContaining('使用方法: /remove <番号>'));
        });
        it('should handle /pause command with valid index', async () => {
            const update = {
                ...mockUpdate,
                message: {
                    ...(mockUpdate.message || {}),
                    text: '/pause 1',
                },
            };
            await controller.handleUpdate(update, mockUser, mockTelegramUser, false);
            expect(telegramService.sendMessage).toHaveBeenCalledWith(123456789, expect.stringContaining('監視を一時停止しました'));
        });
        it('should handle /resume command with invalid index', async () => {
            const update = {
                ...mockUpdate,
                message: {
                    ...(mockUpdate.message || {}),
                    text: '/resume abc',
                },
            };
            await controller.handleUpdate(update, mockUser, mockTelegramUser, false);
            expect(telegramService.sendMessage).toHaveBeenCalledWith(123456789, '番号を正しく入力してください。');
        });
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL3R0dGVsYS9Eb2N1bWVudHMvV29yay9kZW5vZi93b3Jrcy8yNTA1Mjlzb2t1YnV0c3UvZGV2Mi9zcmMvZG9tYWluL3RlbGVncmFtL3RlbGVncmFtLmNvbnRyb2xsZXIuc3BlYy50cyIsIm1hcHBpbmdzIjoiOztBQUFBLDZDQUFzRDtBQUN0RCwrREFBMkQ7QUFDM0QsK0RBQTJEO0FBQzNELHlEQUFxRDtBQU1yRCx1RkFBa0Y7QUFDbEYsaUZBQTRFO0FBQzVFLDJFQUFzRTtBQUV0RSxRQUFRLENBQUMsb0JBQW9CLEVBQUUsR0FBRyxFQUFFO0lBQ2xDLElBQUksVUFBOEIsQ0FBQztJQUNuQyxJQUFJLFdBQXFDLENBQUM7SUFDMUMsSUFBSSxlQUE2QyxDQUFDO0lBRWxELE1BQU0sUUFBUSxHQUFTO1FBQ3JCLEVBQUUsRUFBRSxDQUFDO1FBQ0wsVUFBVSxFQUFFLFdBQVc7UUFDdkIsU0FBUyxFQUFFLE1BQU07UUFDakIsUUFBUSxFQUFFLE1BQU07UUFDaEIsUUFBUSxFQUFFLFVBQVU7UUFDcEIsUUFBUSxFQUFFLElBQUk7UUFDZCxZQUFZLEVBQUUsSUFBSTtRQUNsQixRQUFRLEVBQUU7WUFDUixhQUFhLEVBQUUsRUFBRSxPQUFPLEVBQUUsSUFBSSxFQUFFLE1BQU0sRUFBRSxLQUFLLEVBQUU7WUFDL0MsUUFBUSxFQUFFLElBQUk7U0FDZjtRQUNELFlBQVksRUFBRSxJQUFJLElBQUksRUFBRTtRQUN4QixTQUFTLEVBQUUsSUFBSSxJQUFJLEVBQUU7UUFDckIsU0FBUyxFQUFFLElBQUksSUFBSSxFQUFFO1FBQ3JCLFFBQVEsRUFBRSxXQUFXO1FBQ3JCLFdBQVcsRUFBRSxVQUFVO0tBQ3hCLENBQUM7SUFFRixNQUFNLGdCQUFnQixHQUFpQjtRQUNyQyxFQUFFLEVBQUUsU0FBUztRQUNiLE1BQU0sRUFBRSxLQUFLO1FBQ2IsVUFBVSxFQUFFLE1BQU07UUFDbEIsU0FBUyxFQUFFLE1BQU07UUFDakIsUUFBUSxFQUFFLFVBQVU7UUFDcEIsYUFBYSxFQUFFLElBQUk7S0FDcEIsQ0FBQztJ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YW1lcyI6W10sInNvdXJjZXMiOlsiL1VzZXJzL3R0dGVsYS9Eb2N1bWVudHMvV29yay9kZW5vZi93b3Jrcy8yNTA1Mjlzb2t1YnV0c3UvZGV2Mi9zcmMvZG9tYWluL3RlbGVncmFtL3RlbGVncmFtLmNvbnRyb2xsZXIuc3BlYy50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBUZXN0LCBUZXN0aW5nTW9kdWxlIH0gZnJvbSAnQG5lc3Rqcy90ZXN0aW5nJztcbmltcG9ydCB7IFRlbGVncmFtQ29udHJvbGxlciB9IGZyb20gJy4vdGVsZWdyYW0uY29udHJvbGxlcic7XG5pbXBvcnQgeyBBdXRoU2VydmljZSB9IGZyb20gJy4uLy4uL2NvcmUvYXV0aC9hdXRoLnNlcnZpY2UnO1xuaW1wb3J0IHsgVGVsZWdyYW1TZXJ2aWNlIH0gZnJvbSAnLi90ZWxlZ3JhbS5zZXJ2aWNlJztcbmltcG9ydCB7IFVzZXIgfSBmcm9tICcuLi91c2Vycy9lbnRpdGllcy91c2VyLmVudGl0eSc7XG5pbXBvcnQge1xuICBUZWxlZ3JhbVVwZGF0ZSxcbiAgVGVsZWdyYW1Vc2VyLFxufSBmcm9tICcuLi8uLi9jb21tb24vaW50ZXJmYWNlcy90ZWxlZ3JhbS11c2VyLmludGVyZmFjZSc7XG5pbXBvcnQgeyBUZWxlZ3JhbVdlYmhvb2tHdWFyZCB9IGZyb20gJy4uLy4uL2NvbW1vbi9ndWFyZHMvdGVsZWdyYW0td2ViaG9vay5ndWFyZCc7XG5pbXBvcnQgeyBUZWxlZ3JhbUF1dGhHdWFyZCB9IGZyb20gJy4uLy4uL2NvbW1vbi9ndWFyZHMvdGVsZWdyYW0tYXV0aC5ndWFyZCc7XG5pbXBvcnQgeyBSYXRlTGltaXRHdWFyZCB9IGZyb20gJy4uLy4uL2NvbW1vbi9ndWFyZHMvcmF0ZS1saW1pdC5ndWFyZCc7XG5cbmRlc2NyaWJlKCdUZWxlZ3JhbUNvbnRyb2xsZXInLCAoKSA9PiB7XG4gIGxldCBjb250cm9sbGVyOiBUZWxlZ3JhbUNvbnRyb2xsZXI7XG4gIGxldCBhdXRoU2VydmljZTogamVzdC5Nb2NrZWQ8QXV0aFNlcnZpY2U+O1xuICBsZXQgdGVsZWdyYW1TZXJ2aWNlOiBqZXN0Lk1vY2tlZDxUZWxlZ3JhbVNlcnZpY2U+O1xuXG4gIGNvbnN0IG1vY2tVc2VyOiBVc2VyID0ge1xuICAgIGlkOiAxLFxuICAgIHRlbGVncmFtSWQ6ICcxMjM0NTY3ODknLFxuICAgIGZpcnN0TmFtZTogJ1Rlc3QnLFxuICAgIGxhc3ROYW1lOiAnVXNlcicsXG4gICAgdXNlcm5hbWU6ICd0ZXN0dXNlcicsXG4gICAgaXNBY3RpdmU6IHRydWUsXG4gICAgbGFuZ3VhZ2VDb2RlOiAnamEnLFxuICAgIHNldHRpbmdzOiB7XG4gICAgICBub3RpZmljYXRpb25zOiB7IGVuYWJsZWQ6IHRydWUsIHNpbGVudDogZmFsc2UgfSxcbiAgICAgIGxhbmd1YWdlOiAnamEnLFxuICAgIH0sXG4gICAgbGFzdEFjdGl2ZUF0OiBuZXcgRGF0ZSgpLFxuICAgIGNyZWF0ZWRBdDogbmV3IERhdGUoKSxcbiAgICB1cGRhdGVkQXQ6IG5ldyBEYXRlKCksXG4gICAgZnVsbE5hbWU6ICdUZXN0IFVzZXInLFxuICAgIGRpc3BsYXlOYW1lOiAndGVzdHVzZXInLFxuICB9O1xuXG4gIGNvbnN0IG1vY2tUZWxlZ3JhbVVzZXI6IFRlbGVncmFtVXNlciA9IHtcbiAgICBpZDogMTIzNDU2Nzg5LFxuICAgIGlzX2JvdDogZmFsc2UsXG4gICAgZmlyc3RfbmFtZTogJ1Rlc3QnLFxuICAgIGxhc3RfbmFtZTogJ1VzZXInLFxuICAgIHVzZXJuYW1lOiAndGVzdHVzZXInLFxuICAgIGxhbmd1YWdlX2NvZGU6ICdqYScsXG4gIH07XG5cbiAgY29uc3QgbW9ja1VwZGF0ZTogVGVsZWdyYW1VcGRhdGUgPSB7XG4gICAgdXBkYXRlX2lkOiAxLFxuICAgIG1lc3NhZ2U6IHtcbiAgICAgIG1lc3NhZ2VfaWQ6IDEsXG4gICAgICBkYXRlOiBEYXRlLm5vdygpLFxuICAgICAgY2hhdDoge1xuICAgICAgICBpZDogMTIzNDU2Nzg5LFxuICAgICAgICB0eXBlOiAncHJpdmF0ZScsXG4gICAgICB9LFxuICAgICAgZnJvbTogbW9ja1RlbGVncmFtVXNlcixcbiAgICAgIHRleHQ6ICcvc3RhcnQnLFxuICAgIH0sXG4gIH07XG5cbiAgYmVmb3JlRWFjaChhc3luYyAoKSA9PiB7XG4gICAgY29uc3QgbW9ja0F1dGhTZXJ2aWNlID0ge1xuICAgICAgaGFuZGxlU3RhcnRDb21tYW5kOiBqZXN0LmZuKCksXG4gICAgfTtcblxuICAgIGNvbnN0IG1vY2tUZWxlZ3JhbVNlcnZpY2UgPSB7XG4gICAgICBzZW5kTWVzc2FnZTogamVzdC5mbigpLFxuICAgIH07XG5cbiAgICBjb25zdCBtb2R1bGU6IFRlc3RpbmdNb2R1bGUgPSBhd2FpdCBUZXN0LmNyZWF0ZVRlc3RpbmdNb2R1bGUoe1xuICAgICAgY29udHJvbGxlcnM6IFtUZWxlZ3JhbUNvbnRyb2xsZXJdLFxuICAgICAgcHJvdmlkZXJzOiBbXG4gICAgICAgIHsgcHJvdmlkZTogQXV0aFNlcnZpY2UsIHVzZVZhbHVlOiBtb2NrQXV0aFNlcnZpY2UgfSxcbiAgICAgICAgeyBwcm92aWRlOiBUZWxlZ3JhbVNlcnZpY2UsIHVzZVZhbHVlOiBtb2NrVGVsZWdyYW1TZXJ2aWNlIH0sXG4gICAgICBdLFxuICAgIH0pXG4gICAgICAub3ZlcnJpZGVHdWFyZChUZWxlZ3JhbVdlYmhvb2tHdWFyZClcbiAgICAgIC51c2VWYWx1ZSh7IGNhbkFjdGl2YXRlOiAoKSA9PiB0cnVlIH0pXG4gICAgICAub3ZlcnJpZGVHdWFyZChUZWxlZ3JhbUF1dGhHdWFyZClcbiAgICAgIC51c2VWYWx1ZSh7IGNhbkFjdGl2YXRlOiAoKSA9PiB0cnVlIH0pXG4gICAgICAub3ZlcnJpZGVHdWFyZChSYXRlTGltaXRHdWFyZClcbiAgICAgIC51c2VWYWx1ZSh7IGNhbkFjdGl2YXRlOiAoKSA9PiB0cnVlIH0pXG4gICAgICAuY29tcGlsZSgpO1xuXG4gICAgY29udHJvbGxlciA9IG1vZHVsZS5nZXQ8VGVsZWdyYW1Db250cm9sbGVyPihUZWxlZ3JhbUNvbnRyb2xsZXIpO1xuICAgIGF1dGhTZXJ2aWNlID0gbW9kdWxlLmdldChBdXRoU2VydmljZSk7XG4gICAgdGVsZWdyYW1TZXJ2aWNlID0gbW9kdWxlLmdldChUZWxlZ3JhbVNlcnZpY2UpO1xuICB9KTtcblxuICBpdCgnc2hvdWxkIGJlIGRlZmluZWQnLCAoKSA9PiB7XG4gICAgZXhwZWN0KGNvbnRyb2xsZXIpLnRvQmVEZWZpbmVkKCk7XG4gIH0pO1xuXG4gIGRlc2NyaWJlKCdoYW5kbGVVcGRhdGUnLCAoKSA9PiB7XG4gICAgaXQoJ3Nob3VsZCBoYW5kbGUgL3N0YXJ0IGNvbW1hbmQnLCBhc3luYyAoKSA9PiB7XG4gICAgICBhdXRoU2VydmljZS5oYW5kbGVTdGFydENvbW1hbmQubW9ja1Jlc29sdmVkVmFsdWUoe1xuICAgICAgICB1c2VyOiBtb2NrVXNlcixcbiAgICAgICAgaXNOZXdVc2VyOiB0cnVlLFxuICAgICAgICB3ZWxjb21lTWVzc2FnZTogJ+OBr+OBmOOCgeOBvuOBl+OBpu+8gScsXG4gICAgICB9KTtcblxuICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgY29udHJvbGxlci5oYW5kbGVVcGRhdGUoXG4gICAgICAgIG1vY2tVcGRhdGUsXG4gICAgICAgIG1vY2tVc2VyLFxuICAgICAgICBtb2NrVGVsZWdyYW1Vc2VyLFxuICAgICAgICB0cnVlLFxuICAgICAgKTtcblxuICAgICAgZXhwZWN0KHJlc3VsdCkudG9FcXVhbCh7IG9rOiB0cnVlIH0pO1xuICAgICAgZXhwZWN0KGF1dGhTZXJ2aWNlLmhhbmRsZVN0YXJ0Q29tbWFuZCkudG9IYXZlQmVlbkNhbGxlZFdpdGgoXG4gICAgICAgIG1vY2tUZWxlZ3JhbVVzZXIsXG4gICAgICApO1xuICAgICAgZXhwZWN0KHRlbGVncmFtU2VydmljZS5zZW5kTWVzc2FnZSkudG9IYXZlQmVlbkNhbGxlZFdpdGgoXG4gICAgICAgIDEyMzQ1Njc4OSxcbiAgICAgICAgJ+OBr+OBmOOCgeOBvuOBl+OBpu+8gScsXG4gICAgICApO1xuICAgIH0pO1xuXG4gICAgaXQoJ3Nob3VsZCBoYW5kbGUgL2FkZCBjb21tYW5kIHdpdGhvdXQgVVJMJywgYXN5bmMgKCkgPT4ge1xuICAgICAgY29uc3QgdXBkYXRlID0ge1xuICAgICAgICAuLi5tb2NrVXBkYXRlLFxuICAgICAgICBtZXNzYWdlOiB7XG4gICAgICAgICAgLi4uKG1vY2tVcGRhdGUubWVzc2FnZSB8fCB7fSksXG4gICAgICAgICAgdGV4dDogJy9hZGQnLFxuICAgICAgICB9LFxuICAgICAgfSBhcyBUZWxlZ3JhbVVwZGF0ZTtcblxuICAgICAgYXdhaXQgY29udHJvbGxlci5oYW5kbGVVcGRhdGUodXBkYXRlLCBtb2NrVXNlciwgbW9ja1RlbGVncmFtVXNlciwgZmFsc2UpO1xuXG4gICAgICBleHBlY3QodGVsZWdyYW1TZXJ2aWNlLnNlbmRNZXNzYWdlKS50b0hhdmVCZWVuQ2FsbGVkV2l0aChcbiAgICAgICAgMTIzNDU2Nzg5LFxuICAgICAgICBleHBlY3Quc3RyaW5nQ29udGFpbmluZygn5L2/55So5pa55rOVOiAvYWRkIDxVUkw+JyksXG4gICAgICApO1xuICAgIH0pO1xuXG4gICAgaXQoJ3Nob3VsZCBoYW5kbGUgL2FkZCBjb21tYW5kIHdpdGggaW52YWxpZCBVUkwnLCBhc3luYyAoKSA9PiB7XG4gICAgICBjb25zdCB1cGRhdGUgPSB7XG4gICAgICAgIC4uLm1vY2tVcGRhdGUsXG4gICAgICAgIG1lc3NhZ2U6IHtcbiAgICAgICAgICAuLi4obW9ja1VwZGF0ZS5tZXNzYWdlIHx8IHt9KSxcbiAgICAgICAgICB0ZXh0OiAnL2FkZCBpbnZhbGlkLXVybCcsXG4gICAgICAgIH0sXG4gICAgICB9IGFzIFRlbGVncmFtVXBkYXRlO1xuXG4gICAgICBhd2FpdCBjb250cm9sbGVyLmhhbmRsZVVwZGF0ZSh1cGRhdGUsIG1vY2tVc2VyLCBtb2NrVGVsZWdyYW1Vc2VyLCBmYWxzZSk7XG5cbiAgICAgIGV4cGVjdCh0ZWxlZ3JhbVNlcnZpY2Uuc2VuZE1lc3NhZ2UpLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKFxuICAgICAgICAxMjM0NTY3ODksXG4gICAgICAgICfmnInlirnjgapVUkzjgpLlhaXlipvjgZfjgabjgY/jgaDjgZXjgYTjgIInLFxuICAgICAgKTtcbiAgICB9KTtcblxuICAgIGl0KCdzaG91bGQgaGFuZGxlIC9hZGQgY29tbWFuZCB3aXRoIHZhbGlkIFVSTCcsIGFzeW5jICgpID0+IHtcbiAgICAgIGNvbnN0IHVwZGF0ZSA9IHtcbiAgICAgICAgLi4ubW9ja1VwZGF0ZSxcbiAgICAgICAgbWVzc2FnZToge1xuICAgICAgICAgIC4uLihtb2NrVXBkYXRlLm1lc3NhZ2UgfHwge30pLFxuICAgICAgICAgIHRleHQ6ICcvYWRkIGh0dHBzOi8vZXhhbXBsZS5jb20nLFxuICAgICAgICB9LFxuICAgICAgfSBhcyBUZWxlZ3JhbVVwZGF0ZTtcblxuICAgICAgYXdhaXQgY29udHJvbGxlci5oYW5kbGVVcGRhdGUodXBkYXRlLCBtb2NrVXNlciwgbW9ja1RlbGVncmFtVXNlciwgZmFsc2UpO1xuXG4gICAgICBleHBlY3QodGVsZWdyYW1TZXJ2aWNlLnNlbmRNZXNzYWdlKS50b0hhdmVCZWVuQ2FsbGVkV2l0aChcbiAgICAgICAgMTIzNDU2Nzg5LFxuICAgICAgICBleHBlY3Quc3RyaW5nQ29udGFpbmluZygn55uj6KaW44Oq44K544OI44Gr6L+95Yqg44GX44G+44GX44GfJyksXG4gICAgICApO1xuICAgIH0pO1xuXG4gICAgaXQoJ3Nob3VsZCBoYW5kbGUgL2xpc3QgY29tbWFuZCcsIGFzeW5jICgpID0+IHtcbiAgICAgIGNvbnN0IHVwZGF0ZSA9IHtcbiAgICAgICAgLi4ubW9ja1VwZGF0ZSxcbiAgICAgICAgbWVzc2FnZToge1xuICAgICAgICAgIC4uLihtb2NrVXBkYXRlLm1lc3NhZ2UgfHwge30pLFxuICAgICAgICAgIHRleHQ6ICcvbGlzdCcsXG4gICAgICAgIH0sXG4gICAgICB9IGFzIFRlbGVncmFtVXBkYXRlO1xuXG4gICAgICBhd2FpdCBjb250cm9sbGVyLmhhbmRsZVVwZGF0ZSh1cGRhdGUsIG1vY2tVc2VyLCBtb2NrVGVsZWdyYW1Vc2VyLCBmYWxzZSk7XG5cbiAgICAgIGV4cGVjdCh0ZWxlZ3JhbVNlcnZpY2Uuc2VuZE1lc3NhZ2UpLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKFxuICAgICAgICAxMjM0NTY3ODksXG4gICAgICAgIGV4cGVjdC5zdHJpbmdDb250YWluaW5nKCfnm6PoppbkuK3jga5VUkzkuIDopqcnKSxcbiAgICAgICk7XG4gICAgfSk7XG5cbiAgICBpdCgnc2hvdWxkIGhhbmRsZSAvaGVscCBjb21tYW5kJywgYXN5bmMgKCkgPT4ge1xuICAgICAgY29uc3QgdXBkYXRlID0ge1xuICAgICAgICAuLi5tb2NrVXBkYXRlLFxuICAgICAgICBtZXNzYWdlOiB7XG4gICAgICAgICAgLi4uKG1vY2tVcGRhdGUubWVzc2FnZSB8fCB7fSksXG4gICAgICAgICAgdGV4dDogJy9oZWxwJyxcbiAgICAgICAgfSxcbiAgICAgIH0gYXMgVGVsZWdyYW1VcGRhdGU7XG5cbiAgICAgIGF3YWl0IGNvbnRyb2xsZXIuaGFuZGxlVXBkYXRlKHVwZGF0ZSwgbW9ja1VzZXIsIG1vY2tUZWxlZ3JhbVVzZXIsIGZhbHNlKTtcblxuICAgICAgZXhwZWN0KHRlbGVncmFtU2VydmljZS5zZW5kTWVzc2FnZSkudG9IYXZlQmVlbkNhbGxlZFdpdGgoXG4gICAgICAgIDEyMzQ1Njc4OSxcbiAgICAgICAgZXhwZWN0LnN0cmluZ0NvbnRhaW5pbmcoJ+OCs+ODnuODs+ODieS4gOimpycpLFxuICAgICAgKTtcbiAgICB9KTtcblxuICAgIGl0KCdzaG91bGQgaGFuZGxlIHVua25vd24gY29tbWFuZCcsIGFzeW5jICgpID0+IHtcbiAgICAgIGNvbnN0IHVwZGF0ZSA9IHtcbiAgICAgICAgLi4ubW9ja1VwZGF0ZSxcbiAgICAgICAgbWVzc2FnZToge1xuICAgICAgICAgIC4uLihtb2NrVXBkYXRlLm1lc3NhZ2UgfHwge30pLFxuICAgICAgICAgIHRleHQ6ICcvdW5rbm93bicsXG4gICAgICAgIH0sXG4gICAgICB9IGFzIFRlbGVncmFtVXBkYXRlO1xuXG4gICAgICBhd2FpdCBjb250cm9sbGVyLmhhbmRsZVVwZGF0ZSh1cGRhdGUsIG1vY2tVc2VyLCBtb2NrVGVsZWdyYW1Vc2VyLCBmYWxzZSk7XG5cbiAgICAgIGV4cGVjdCh0ZWxlZ3JhbVNlcnZpY2Uuc2VuZE1lc3NhZ2UpLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKFxuICAgICAgICAxMjM0NTY3ODksXG4gICAgICAgICfkuI3mmI7jgarjgrPjg57jg7Pjg4njgafjgZnjgIIvaGVscCDjgafjgrPjg57jg7Pjg4nkuIDopqfjgpLnorroqo3jgZfjgabjgY/jgaDjgZXjgYTjgIInLFxuICAgICAgKTtcbiAgICB9KTtcblxuICAgIGl0KCdzaG91bGQgaWdub3JlIG5vbi10ZXh0IHVwZGF0ZXMnLCBhc3luYyAoKSA9PiB7XG4gICAgICBjb25zdCB1cGRhdGUgPSB7XG4gICAgICAgIC4uLm1vY2tVcGRhdGUsXG4gICAgICAgIG1lc3NhZ2U6IHtcbiAgICAgICAgICAuLi4obW9ja1VwZGF0ZS5tZXNzYWdlIHx8IHt9KSxcbiAgICAgICAgICB0ZXh0OiB1bmRlZmluZWQsXG4gICAgICAgIH0sXG4gICAgICB9IGFzIFRlbGVncmFtVXBkYXRlO1xuXG4gICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBjb250cm9sbGVyLmhhbmRsZVVwZGF0ZShcbiAgICAgICAgdXBkYXRlLFxuICAgICAgICBtb2NrVXNlcixcbiAgICAgICAgbW9ja1RlbGVncmFtVXNlcixcbiAgICAgICAgZmFsc2UsXG4gICAgICApO1xuXG4gICAgICBleHBlY3QocmVzdWx0KS50b0VxdWFsKHsgb2s6IHRydWUgfSk7XG4gICAgICBleHBlY3QodGVsZWdyYW1TZXJ2aWNlLnNlbmRNZXNzYWdlKS5ub3QudG9IYXZlQmVlbkNhbGxlZCgpO1xuICAgIH0pO1xuXG4gICAgaXQoJ3Nob3VsZCBoYW5kbGUgZXJyb3JzIGdyYWNlZnVsbHknLCBhc3luYyAoKSA9PiB7XG4gICAgICBhdXRoU2VydmljZS5oYW5kbGVTdGFydENvbW1hbmQubW9ja1JlamVjdGVkVmFsdWUobmV3IEVycm9yKCdUZXN0IGVycm9yJykpO1xuXG4gICAgICBhd2FpdCBjb250cm9sbGVyLmhhbmRsZVVwZGF0ZShcbiAgICAgICAgbW9ja1VwZGF0ZSxcbiAgICAgICAgbW9ja1VzZXIsXG4gICAgICAgIG1vY2tUZWxlZ3JhbVVzZXIsXG4gICAgICAgIHRydWUsXG4gICAgICApO1xuXG4gICAgICBleHBlY3QodGVsZWdyYW1TZXJ2aWNlLnNlbmRNZXNzYWdlKS50b0hhdmVCZWVuQ2FsbGVkV2l0aChcbiAgICAgICAgMTIzNDU2Nzg5LFxuICAgICAgICAn44Ko44Op44O844GM55m655Sf44GX44G+44GX44Gf44CC44GX44Gw44KJ44GP5b6F44Gj44Gm44GL44KJ5YaN5bqm44GK6Kmm44GX44GP44Gg44GV44GE44CCJyxcbiAgICAgICk7XG4gICAgfSk7XG5cbiAgICBpdCgnc2hvdWxkIGhhbmRsZSAvc3RhdHVzIGNvbW1hbmQnLCBhc3luYyAoKSA9PiB7XG4gICAgICBjb25zdCB1cGRhdGUgPSB7XG4gICAgICAgIC4uLm1vY2tVcGRhdGUsXG4gICAgICAgIG1lc3NhZ2U6IHtcbiAgICAgICAgICAuLi4obW9ja1VwZGF0ZS5tZXNzYWdlIHx8IHt9KSxcbiAgICAgICAgICB0ZXh0OiAnL3N0YXR1cycsXG4gICAgICAgIH0sXG4gICAgICB9IGFzIFRlbGVncmFtVXBkYXRlO1xuXG4gICAgICBhd2FpdCBjb250cm9sbGVyLmhhbmRsZVVwZGF0ZSh1cGRhdGUsIG1vY2tVc2VyLCBtb2NrVGVsZWdyYW1Vc2VyLCBmYWxzZSk7XG5cbiAgICAgIGV4cGVjdCh0ZWxlZ3JhbVNlcnZpY2Uuc2VuZE1lc3NhZ2UpLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKFxuICAgICAgICAxMjM0NTY3ODksXG4gICAgICAgIGV4cGVjdC5zdHJpbmdDb250YWluaW5nKCfnm6Poppbnirbms4EnKSxcbiAgICAgICk7XG4gICAgfSk7XG5cbiAgICBpdCgnc2hvdWxkIGhhbmRsZSAvcmVtb3ZlIGNvbW1hbmQgd2l0aG91dCBpbmRleCcsIGFzeW5jICgpID0+IHtcbiAgICAgIGNvbnN0IHVwZGF0ZSA9IHtcbiAgICAgICAgLi4ubW9ja1VwZGF0ZSxcbiAgICAgICAgbWVzc2FnZToge1xuICAgICAgICAgIC4uLihtb2NrVXBkYXRlLm1lc3NhZ2UgfHwge30pLFxuICAgICAgICAgIHRleHQ6ICcvcmVtb3ZlJyxcbiAgICAgICAgfSxcbiAgICAgIH0gYXMgVGVsZWdyYW1VcGRhdGU7XG5cbiAgICAgIGF3YWl0IGNvbnRyb2xsZXIuaGFuZGxlVXBkYXRlKHVwZGF0ZSwgbW9ja1VzZXIsIG1vY2tUZWxlZ3JhbVVzZXIsIGZhbHNlKTtcblxuICAgICAgZXhwZWN0KHRlbGVncmFtU2VydmljZS5zZW5kTWVzc2FnZSkudG9IYXZlQmVlbkNhbGxlZFdpdGgoXG4gICAgICAgIDEyMzQ1Njc4OSxcbiAgICAgICAgZXhwZWN0LnN0cmluZ0NvbnRhaW5pbmcoJ+S9v+eUqOaWueazlTogL3JlbW92ZSA855Wq5Y+3PicpLFxuICAgICAgKTtcbiAgICB9KTtcblxuICAgIGl0KCdzaG91bGQgaGFuZGxlIC9wYXVzZSBjb21tYW5kIHdpdGggdmFsaWQgaW5kZXgnLCBhc3luYyAoKSA9PiB7XG4gICAgICBjb25zdCB1cGRhdGUgPSB7XG4gICAgICAgIC4uLm1vY2tVcGRhdGUsXG4gICAgICAgIG1lc3NhZ2U6IHtcbiAgICAgICAgICAuLi4obW9ja1VwZGF0ZS5tZXNzYWdlIHx8IHt9KSxcbiAgICAgICAgICB0ZXh0OiAnL3BhdXNlIDEnLFxuICAgICAgICB9LFxuICAgICAgfSBhcyBUZWxlZ3JhbVVwZGF0ZTtcblxuICAgICAgYXdhaXQgY29udHJvbGxlci5oYW5kbGVVcGRhdGUodXBkYXRlLCBtb2NrVXNlciwgbW9ja1RlbGVncmFtVXNlciwgZmFsc2UpO1xuXG4gICAgICBleHBlY3QodGVsZWdyYW1TZXJ2aWNlLnNlbmRNZXNzYWdlKS50b0hhdmVCZWVuQ2FsbGVkV2l0aChcbiAgICAgICAgMTIzNDU2Nzg5LFxuICAgICAgICBleHBlY3Quc3RyaW5nQ29udGFpbmluZygn55uj6KaW44KS5LiA5pmC5YGc5q2i44GX44G+44GX44GfJyksXG4gICAgICApO1xuICAgIH0pO1xuXG4gICAgaXQoJ3Nob3VsZCBoYW5kbGUgL3Jlc3VtZSBjb21tYW5kIHdpdGggaW52YWxpZCBpbmRleCcsIGFzeW5jICgpID0+IHtcbiAgICAgIGNvbnN0IHVwZGF0ZSA9IHtcbiAgICAgICAgLi4ubW9ja1VwZGF0ZSxcbiAgICAgICAgbWVzc2FnZToge1xuICAgICAgICAgIC4uLihtb2NrVXBkYXRlLm1lc3NhZ2UgfHwge30pLFxuICAgICAgICAgIHRleHQ6ICcvcmVzdW1lIGFiYycsXG4gICAgICAgIH0sXG4gICAgICB9IGFzIFRlbGVncmFtVXBkYXRlO1xuXG4gICAgICBhd2FpdCBjb250cm9sbGVyLmhhbmRsZVVwZGF0ZSh1cGRhdGUsIG1vY2tVc2VyLCBtb2NrVGVsZWdyYW1Vc2VyLCBmYWxzZSk7XG5cbiAgICAgIGV4cGVjdCh0ZWxlZ3JhbVNlcnZpY2Uuc2VuZE1lc3NhZ2UpLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKFxuICAgICAgICAxMjM0NTY3ODksXG4gICAgICAgICfnlarlj7fjgpLmraPjgZfjgY/lhaXlipvjgZfjgabjgY/jgaDjgZXjgYTjgIInLFxuICAgICAgKTtcbiAgICB9KTtcbiAgfSk7XG59KTtcbiJdLCJ2ZXJzaW9uIjozfQ==